<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Premium Biosecurity Plan Generator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/autocompleter@6.1.0/dist/autocompleter.min.js"></script>
    <style>
        :root {
            --primary: #2e7d32;
            --secondary: #81c784;
            --light: #f1f8e9;
            --dark: #1b5e20;
            --warning: #ff8f00;
            --danger: #c62828;
            --text-color: #333;
            --bg-color: #f5f5f5;
            --card-bg: white;
            --border-color: #ddd;
            --shadow-color: rgba(0,0,0,0.1);
            --input-bg: white;
            --input-border: #ddd;
            --table-header-bg: #f1f8e9;
            --table-row-even: #f9f9f9;
            --high-risk-bg: #ffebee;
            --sidebar-width: 250px;
        }
        
        /* Dark mode variables */
        [data-theme="dark"] {
            --primary: #4caf50;
            --secondary: #2e7d32;
            --light: #1e1e1e;
            --dark: #81c784;
            --text-color: #e0e0e0;
            --bg-color: #121212;
            --card-bg: #1e1e1e;
            --border-color: #444;
            --shadow-color: rgba(0,0,0,0.3);
            --input-bg: #2d2d2d;
            --input-border: #444;
            --table-header-bg: #2d2d2d;
            --table-row-even: #252525;
            --high-risk-bg: #3a1f1f;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: var(--text-color);
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            transition: background-color 0.3s, color 0.3s;
            display: flex;
            min-height: 100vh;
        }
        
        /* Sidebar Navigation */
        .sidebar {
            width: var(--sidebar-width);
            background-color: var(--dark);
            color: white;
            padding: 20px 0;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            transition: transform 0.3s;
            z-index: 100;
        }
        
        .sidebar-header {
            padding: 0 20px 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .sidebar-nav {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        
        .sidebar-nav li {
            margin: 0;
        }
        
        .sidebar-nav a {
            display: block;
            padding: 12px 20px;
            color: white;
            text-decoration: none;
            transition: background-color 0.3s;
        }
        
        .sidebar-nav a:hover {
            background-color: rgba(255,255,255,0.1);
        }
        
        .sidebar-nav a.active {
            background-color: var(--primary);
            font-weight: bold;
        }
        
        .sidebar-nav a.completed {
            position: relative;
        }
        
        .sidebar-nav a.completed:after {
            content: "‚úì";
            position: absolute;
            right: 20px;
        }
        
        .main-content {
            flex: 1;
            margin-left: var(--sidebar-width);
            padding: 20px;
            max-width: 1000px;
        }
        
        /* Mobile sidebar toggle */
        .sidebar-toggle {
            display: none;
            position: fixed;
            top: 15px;
            left: 15px;
            z-index: 1000;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 20px;
            cursor: pointer;
        }
        
        header {
            background-color: var(--primary);
            color: white;
            padding: 25px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        h1 {
            margin: 0;
            font-size: 2rem;
        }
        
        .wizard-container {
            background-color: var(--card-bg);
            border-radius: 8px;
            box-shadow: 0 2px 15px var(--shadow-color);
            padding: 25px;
            margin-bottom: 20px;
            transition: background-color 0.3s, box-shadow 0.3s;
        }
        
        .step {
            display: none;
            animation: fadeIn 0.3s ease-in;
        }
        
        .step.active {
            display: block;
        }
        
        .question {
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }
        
        label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--dark);
        }
        
        input[type="text"], 
        input[type="number"],
        input[type="email"],
        textarea,
        select {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--input-border);
            border-radius: 4px;
            font-size: 16px;
            transition: border 0.3s;
            background-color: var(--input-bg);
            color: var(--text-color);
        }
        
        input[type="text"]:focus, 
        input[type="number"]:focus,
        input[type="email"]:focus,
        textarea:focus,
        select:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 2px rgba(46, 125, 50, 0.2);
        }
        
        textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        .radio-group, .checkbox-group {
            margin-top: 10px;
        }
        
        .radio-option, .checkbox-option {
            margin-bottom: 10px;
            display: flex;
            align-items: center;
        }
        
        input[type="radio"], input[type="checkbox"] {
            margin-right: 12px;
            width: 18px;
            height: 18px;
        }
        
        .nav-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
        }
        
        button {
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }
        
        .btn-primary {
            background-color: var(--primary);
            color: white;
        }
        
        .btn-primary:hover {
            background-color: var(--dark);
            transform: translateY(-1px);
        }
        
        .btn-secondary {
            background-color: #e0e0e0;
        }
        
        .btn-secondary:hover {
            background-color: #bdbdbd;
            transform: translateY(-1px);
        }
        
        .btn-danger {
            background-color: var(--danger);
            color: white;
        }
        
        .btn-danger:hover {
            background-color: #8e0000;
            transform: translateY(-1px);
        }
        
        .btn-success {
            background-color: var(--primary);
            color: white;
        }
        
        .btn-success:hover {
            background-color: var(--dark);
        }
        
        .progress-container {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .progress-bar {
            height: 8px;
            background-color: #e0e0e0;
            border-radius: 4px;
            flex-grow: 1;
            overflow: hidden;
        }
        
        .progress {
            height: 100%;
            background-color: var(--secondary);
            width: 0%;
            transition: width 0.5s ease;
        }
        
        .progress-text {
            margin-left: 15px;
            font-weight: 600;
            color: var(--primary);
            min-width: 80px;
            text-align: right;
        }
        
        .step-indicator {
            text-align: center;
            margin-bottom: 25px;
            font-weight: 600;
            color: var(--primary);
            font-size: 1.1rem;
        }
        
        .tooltip {
            position: relative;
            display: inline-block;
            margin-left: 5px;
            cursor: help;
        }
        
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 250px;
            background-color: #555;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 8px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -125px;
            opacity: 0;
            transition: opacity 0.3s;
            font-weight: normal;
            font-size: 14px;
        }
        
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
        
        #plan-output {
            display: none;
            padding: 30px;
            background-color: var(--card-bg);
            border-radius: 8px;
            box-shadow: 0 2px 15px var(--shadow-color);
        }
        
        .output-section {
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .output-section h3 {
            color: var(--primary);
            border-bottom: 2px solid var(--secondary);
            padding-bottom: 8px;
            margin-top: 30px;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .required:after {
            content: " *";
            color: var(--danger);
        }
        
        .industry-selection {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
        }
        
        .industry-card {
            border: 2px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            background-color: var(--card-bg);
        }
        
        .industry-card:hover {
            border-color: var(--primary);
            box-shadow: 0 5px 15px var(--shadow-color);
        }
        
        .industry-card.selected {
            border-color: var(--primary);
            background-color: var(--light);
        }
        
        .industry-icon {
            font-size: 24px;
            margin-right: 15px;
            color: var(--primary);
        }
        
        .risk-matrix {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        .risk-matrix th, .risk-matrix td {
            padding: 12px;
            text-align: left;
            border: 1px solid var(--border-color);
        }
        
        .risk-matrix th {
            background-color: var(--table-header-bg);
            font-weight: 600;
        }
        
        .risk-matrix tr:nth-child(even) {
            background-color: var(--table-row-even);
        }
        
        .risk-matrix tr.high-risk {
            background-color: var(--high-risk-bg);
            font-weight: 600;
        }
        
        .risk-score {
            font-weight: 600;
        }
        
        .risk-score.high {
            color: var(--danger);
        }
        
        .risk-score.medium {
            color: var(--warning);
        }
        
        .risk-score.low {
            color: var(--primary);
        }
        
        .chart-container {
            margin: 20px 0;
            height: 300px;
        }
        
        .share-options {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 25px;
            flex-wrap: wrap;
        }
        
        .template-gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .template-card {
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            background-color: var(--card-bg);
        }
        
        .template-card:hover {
            border-color: var(--primary);
            box-shadow: 0 5px 15px var(--shadow-color);
        }
        
        .template-card.selected {
            border-color: var(--primary);
            background-color: var(--light);
        }
        
        .template-icon {
            font-size: 40px;
            color: var(--primary);
            margin-bottom: 10px;
        }
        
        .team-member {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .team-member input {
            flex-grow: 1;
            margin-right: 10px;
        }
        
        .team-member button {
            padding: 8px 12px;
        }
        
        .login-container {
            max-width: 500px;
            margin: 50px auto;
            background: var(--card-bg);
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 15px var(--shadow-color);
        }
        
        .login-container h2 {
            text-align: center;
            color: var(--primary);
            margin-bottom: 25px;
        }
        
        .login-options {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }
        
        .custom-field-container {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .custom-field-container input {
            flex-grow: 1;
        }
        
        .custom-field-container button {
            padding: 8px 12px;
        }
        
        .activity-item, .risk-item, .measure-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .activity-item input, 
        .risk-item input,
        .measure-item input {
            margin-right: 10px;
        }
        
        .activity-item button, 
        .risk-item button,
        .measure-item button {
            margin-left: 10px;
            padding: 4px 8px;
            font-size: 12px;
        }
        
        /* Dark mode toggle */
        .theme-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 100;
            display: flex;
            align-items: center;
            gap: 8px;
            background-color: var(--card-bg);
            padding: 8px 12px;
            border-radius: 20px;
            box-shadow: 0 2px 10px var(--shadow-color);
            cursor: pointer;
        }
        
        .theme-toggle i {
            font-size: 18px;
        }
        
        .theme-toggle span {
            font-weight: 600;
        }
        
        /* Autocomplete */
        .autocomplete-suggestions {
            border: 1px solid var(--border-color);
            background: var(--card-bg);
            overflow: auto;
            z-index: 1000;
        }
        
        .autocomplete-suggestion {
            padding: 10px;
            cursor: pointer;
        }
        
        .autocomplete-suggestion:hover {
            background-color: var(--light);
        }
        
        /* Version history */
        .version-history {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 100;
        }
        
        .version-history-btn {
            background-color: var(--primary);
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 16px;
            cursor: pointer;
            box-shadow: 0 2px 10px var(--shadow-color);
        }
        
        .version-history-panel {
            position: absolute;
            bottom: 50px;
            right: 0;
            width: 300px;
            background-color: var(--card-bg);
            border-radius: 8px;
            box-shadow: 0 2px 15px var(--shadow-color);
            padding: 15px;
            display: none;
        }
        
        .version-history-panel.show {
            display: block;
        }
        
        .version-item {
            padding: 8px 0;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
        }
        
        .version-item:hover {
            background-color: var(--light);
        }
        
        /* Responsive styles */
        @media (max-width: 992px) {
            .sidebar {
                transform: translateX(-100%);
            }
            
            .sidebar.show {
                transform: translateX(0);
            }
            
            .main-content {
                margin-left: 0;
                padding-top: 70px;
            }
            
            .sidebar-toggle {
                display: block;
            }
        }
        
        @media (max-width: 768px) {
            .industry-selection {
                grid-template-columns: 1fr;
            }
            
            .nav-buttons {
                flex-direction: column;
                gap: 10px;
            }
            
            button {
                width: 100%;
            }
            
            .theme-toggle {
                top: 10px;
                right: 10px;
                padding: 6px 10px;
                font-size: 14px;
            }
            
            .version-history-panel {
                width: 250px;
            }
        }
    </style>
    <!-- Font Awesome for theme toggle icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
    <!-- Mobile sidebar toggle button -->
    <button class="sidebar-toggle" id="sidebarToggle">
        <i class="fas fa-bars"></i>
    </button>
    
    <!-- Sidebar Navigation -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h2>Biosecurity Plan</h2>
            <div class="progress-container">
                <div class="progress-bar">
                    <div class="progress" id="sidebar-progress-bar"></div>
                </div>
                <div class="progress-text" id="sidebar-progress-text">0%</div>
            </div>
        </div>
        <ul class="sidebar-nav" id="sidebarNav">
            <li><a href="#step0" class="active">1. Industry</a></li>
            <li><a href="#step1">2. Organization</a></li>
            <li><a href="#step2">3. Project</a></li>
            <li><a href="#step3">4. Activities</a></li>
            <li><a href="#step4">5. Risks</a></li>
            <li><a href="#step5">6. Risk Assessment</a></li>
            <li><a href="#step6">7. Controls</a></li>
            <li><a href="#step7">8. Measures</a></li>
            <li><a href="#step8">9. Team & Review</a></li>
        </ul>
    </div>
    
    <!-- Main Content -->
    <div class="main-content">
        <!-- Dark mode toggle button -->
        <div class="theme-toggle" id="themeToggle">
            <i class="fas fa-moon"></i>
            <span>Dark Mode</span>
        </div>
        
        <!-- Version history button -->
        <div class="version-history">
            <button class="version-history-btn" id="versionHistoryBtn">
                <i class="fas fa-history"></i>
            </button>
            <div class="version-history-panel" id="versionHistoryPanel">
                <h3>Version History</h3>
                <div id="versionHistoryList"></div>
            </div>
        </div>
        
        <header>
            <h1>Premium Biosecurity Plan Generator</h1>
            <p>Create customized biosecurity plans for your organization and industry</p>
        </header>
        
        <div class="wizard-container">
            <div class="progress-container">
                <div class="progress-bar">
                    <div class="progress" id="progress-bar"></div>
                </div>
                <div class="progress-text" id="progress-text">Step 1 of 9</div>
            </div>
            
            <div class="step-indicator" id="step-indicator">Getting Started</div>
            
            <!-- Step 0: Industry Selection -->
            <div class="step active" id="step0">
                <h2>Select Your Industry</h2>
                <p>Choose the industry that best matches your organization to get a customized biosecurity plan.</p>
                
                <div class="question">
                    <label class="required">Primary Industry</label>
                    <div class="industry-selection">
                        <div class="industry-card" onclick="selectIndustry('conservation')" id="industry-card-conservation">
                            <div class="industry-icon">üåø</div>
                            <div>
                                <h3>Conservation and Ecosystem Management</h3>
                                <p>Ecological restoration, habitat rehabilitation, biodiversity management</p>
                            </div>
                        </div>
                        
                        <div class="industry-card" onclick="selectIndustry('horticulture')" id="industry-card-horticulture">
                            <div class="industry-icon">üå∑</div>
                            <div>
                                <h3>Horticulture</h3>
                                <p>Plant cultivation, landscaping, nursery operations</p>
                            </div>
                        </div>
                        
                        <div class="industry-card" onclick="selectIndustry('agriculture')" id="industry-card-agriculture">
                            <div class="industry-icon">üöú</div>
                            <div>
                                <h3>Agriculture</h3>
                                <p>Crop production, livestock farming, agribusiness</p>
                            </div>
                        </div>
                        
                        <div class="industry-card" onclick="selectIndustry('other')" id="industry-card-other">
                            <div class="industry-icon">‚ùì</div>
                            <div>
                                <h3>Other Industry</h3>
                                <p>Specify your industry below</p>
                                <input type="text" id="industry-other-text" placeholder="Enter your industry" style="margin-top: 10px; display: none;">
                            </div>
                        </div>
                    </div>
                    <input type="hidden" id="industry" value="">
                </div>
                
                <div class="nav-buttons">
                    <button type="button" disabled class="btn-secondary">Previous</button>
                    <button type="button" onclick="validateAndContinue()" class="btn-primary">Continue</button>
                </div>
            </div>
            
            <!-- Step 1: Organization Information -->
            <div class="step" id="step1">
                <h2>Organization Information</h2>
                
                <div class="question">
                    <label for="org-name" class="required">Organization Name</label>
                    <input type="text" id="org-name" required>
                </div>
                
                <div class="question">
                    <label for="org-type">Organization Type</label>
                    <select id="org-type">
                        <option value="">Select type...</option>
                        <option value="Government">Government</option>
                        <option value="Non-profit">Non-profit</option>
                        <option value="Private Company">Private Company</option>
                        <option value="Educational">Educational</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                
                <div class="question">
                    <label for="org-size">Organization Size</label>
                    <select id="org-size">
                        <option value="">Select size...</option>
                        <option value="Small (1-10 employees)">Small (1-10 employees)</option>
                        <option value="Medium (11-50 employees)">Medium (11-50 employees)</option>
                        <option value="Large (51-200 employees)">Large (51-200 employees)</option>
                        <option value="Enterprise (200+ employees)">Enterprise (200+ employees)</option>
                    </select>
                </div>
                
                <div class="question">
                    <label for="primary-contact" class="required">Primary Contact</label>
                    <input type="text" id="primary-contact" required>
                </div>
                
                <div class="question">
                    <label for="contact-email" class="required">Contact Email</label>
                    <input type="email" id="contact-email" required>
                </div>
                
                <div class="nav-buttons">
                    <button type="button" onclick="prevStep()" class="btn-secondary">Previous</button>
                    <button type="button" onclick="nextStep()" class="btn-primary">Next</button>
                </div>
            </div>
            
            <!-- Step 2: Project Information -->
            <div class="step" id="step2">
                <h2>Project/Site Information</h2>
                
                <div class="question">
                    <label for="project-name" class="required">Project/Site Name</label>
                    <input type="text" id="project-name" required>
                </div>
                
                <div class="question">
                    <label for="project-location" class="required">Location (address or coordinates)</label>
                    <input type="text" id="project-location" required>
                </div>
                
                <div class="question">
                    <label for="project-size">Site Size</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="number" id="project-size" min="0" step="0.1" style="flex: 1;">
                        <select id="size-unit" style="width: 100px;">
                            <option value="hectares">hectares</option>
                            <option value="acres">acres</option>
                            <option value="sq meters">sq meters</option>
                            <option value="sq feet">sq feet</option>
                        </select>
                    </div>
                </div>
                
                <div class="question">
                    <label for="project-description">Project Description</label>
                    <textarea id="project-description" placeholder="Briefly describe your project or site"></textarea>
                </div>
                
                <div class="nav-buttons">
                    <button type="button" onclick="prevStep()" class="btn-secondary">Previous</button>
                    <button type="button" onclick="nextStep()" class="btn-primary">Next</button>
                </div>
            </div>
            
            <!-- Step 3: Activities -->
            <div class="step" id="step3">
                <h2>Activities</h2>
                <p>Select all activities that apply to your project/site.</p>
                
                <div class="question">
                    <label class="required">Primary Activities</label>
                    <div id="activities-container">
                        <!-- Will be populated dynamically based on industry -->
                    </div>
                    <div class="custom-field-container">
                        <input type="text" id="new-activity" placeholder="Add custom activity">
                        <button type="button" onclick="addCustomActivity()" class="btn-success">Add Activity</button>
                    </div>
                </div>
                
                <div class="question">
                    <label for="activity-frequency">How frequently are these activities conducted?</label>
                    <select id="activity-frequency">
                        <option value="">Select frequency...</option>
                        <option value="Daily">Daily</option>
                        <option value="Weekly">Weekly</option>
                        <option value="Monthly">Monthly</option>
                        <option value="Seasonally">Seasonally</option>
                        <option value="Yearly">Yearly</option>
                        <option value="As needed">As needed</option>
                    </select>
                </div>
                
                <div class="question">
                    <label for="activity-staff">How many staff/volunteers typically participate?</label>
                    <input type="number" id="activity-staff" min="0">
                </div>
                
                <div class="nav-buttons">
                    <button type="button" onclick="prevStep()" class="btn-secondary">Previous</button>
                    <button type="button" onclick="nextStep()" class="btn-primary">Next</button>
                </div>
            </div>
            
            <!-- Step 4: Biosecurity Risks -->
            <div class="step" id="step4">
                <h2>Biosecurity Risks</h2>
                <p>Identify potential biosecurity risks relevant to your activities.</p>
                
                <div class="question">
                    <label class="required">Potential Risks</label>
                    <div id="risks-container">
                        <!-- Will be populated dynamically based on industry -->
                    </div>
                    <div class="custom-field-container">
                        <input type="text" id="new-risk" placeholder="Add custom risk">
                        <button type="button" onclick="addCustomRisk()" class="btn-success">Add Risk</button>
                    </div>
                </div>
                
                <div class="question">
                    <label for="known-issues">Known biosecurity issues in the area</label>
                    <textarea id="known-issues" placeholder="List any known problem species, pathogens, or contamination issues in or near your site"></textarea>
                </div>
                
                <div class="question">
                    <label for="visitor-frequency" class="required">How frequently do visitors access the site?</label>
                    <select id="visitor-frequency" required>
                        <option value="">Select frequency...</option>
                        <option value="Daily">Daily</option>
                        <option value="Weekly">Weekly</option>
                        <option value="Monthly">Monthly</option>
                        <option value="Seasonally">Seasonally</option>
                        <option value="Rarely">Rarely</option>
                    </select>
                </div>
                
                <div class="nav-buttons">
                    <button type="button" onclick="prevStep()" class="btn-secondary">Previous</button>
                    <button type="button" onclick="nextStep()" class="btn-primary">Next</button>
                </div>
            </div>
            
            <!-- Step 5: Risk Assessment Matrix -->
            <div class="step" id="step5">
                <h2>Risk Assessment</h2>
                <p>Assess the likelihood and impact of each identified risk.</p>
                
                <div class="question">
                    <table class="risk-matrix">
                        <thead>
                            <tr>
                                <th>Risk</th>
                                <th>Likelihood</th>
                                <th>Impact</th>
                                <th>Risk Score</th>
                                <th>Priority</th>
                            </tr>
                        </thead>
                        <tbody id="risk-matrix-body">
                            <!-- Will be populated dynamically -->
                        </tbody>
                    </table>
                </div>
                
                <div class="question">
                    <label for="risk-notes">Additional Risk Notes</label>
                    <textarea id="risk-notes" placeholder="Add any additional notes about risk assessment"></textarea>
                </div>
                
                <div class="chart-container">
                    <canvas id="riskChart"></canvas>
                </div>
                
                <div class="nav-buttons">
                    <button type="button" onclick="prevStep()" class="btn-secondary">Previous</button>
                    <button type="button" onclick="nextStep()" class="btn-primary">Next</button>
                </div>
            </div>
            
            <!-- Step 6: Current Controls -->
            <div class="step" id="step6">
                <h2>Current Biosecurity Measures</h2>
                
                <div class="question">
                    <label>Existing Biosecurity Controls</label>
                    <div id="controls-container">
                        <div class="checkbox-option">
                            <input type="checkbox" id="control-cleaning" name="controls" value="Equipment cleaning protocols">
                            <label for="control-cleaning">Equipment cleaning protocols</label>
                        </div>
                        <div class="checkbox-option">
                            <input type="checkbox" id="control-quarantine" name="controls" value="Quarantine areas">
                            <label for="control-quarantine">Quarantine areas</label>
                        </div>
                        <div class="checkbox-option">
                            <input type="checkbox" id="control-monitoring" name="controls" value="Regular monitoring">
                            <label for="control-monitoring">Regular monitoring</label>
                        </div>
                        <div class="checkbox-option">
                            <input type="checkbox" id="control-signage" name="controls" value="Biosecurity signage">
                            <label for="control-signage">Biosecurity signage</label>
                        </div>
                        <div class="checkbox-option">
                            <input type="checkbox" id="control-training" name="controls" value="Staff training">
                            <label for="control-training">Staff training</label>
                        </div>
                        <div class="checkbox-option">
                            <input type="checkbox" id="control-ppe" name="controls" value="Personal protective equipment">
                            <label for="control-ppe">Personal protective equipment</label>
                        </div>
                        <div class="checkbox-option">
                            <input type="checkbox" id="control-visitor" name="controls" value="Visitor management systems">
                            <label for="control-visitor">Visitor management systems</label>
                        </div>
                        <div class="checkbox-option">
                            <input type="checkbox" id="control-waste" name="controls" value="Waste management protocols">
                            <label for="control-waste">Waste management protocols</label>
                        </div>
                    </div>
                    <div class="custom-field-container">
                        <input type="text" id="new-control" placeholder="Add custom control">
                        <button type="button" onclick="addCustomControl()" class="btn-success">Add Control</button>
                    </div>
                </div>
                
                <div class="question">
                    <label for="existing-protocols">Describe existing biosecurity protocols:</label>
                    <textarea id="existing-protocols"></textarea>
                </div>
                
                <div class="question">
                    <label for="challenges">What are your biggest biosecurity challenges?</label>
                    <textarea id="challenges"></textarea>
                </div>
                
                <div class="nav-buttons">
                    <button type="button" onclick="prevStep()" class="btn-secondary">Previous</button>
                    <button type="button" onclick="nextStep()" class="btn-primary">Next</button>
                </div>
            </div>
            
            <!-- Step 7: Proposed Measures -->
            <div class="step" id="step7">
                <h2>Proposed Biosecurity Measures</h2>
                
                <div class="question">
                    <label class="required">Additional Measures to Implement</label>
                    <div id="measures-container">
                        <!-- Will be populated dynamically based on industry -->
                    </div>
                    <div class="custom-field-container">
                        <input type="text" id="new-measure" placeholder="Add custom measure">
                        <button type="button" onclick="addCustomMeasure()" class="btn-success">Add Measure</button>
                    </div>
                </div>
                
                <div class="question">
                    <label for="implementation">Implementation Plan</label>
                    <textarea id="implementation" placeholder="Describe how you will implement these measures"></textarea>
                </div>
                
                <div class="question">
                    <label for="monitoring">Monitoring Approach</label>
                    <textarea id="monitoring" placeholder="Describe how you will monitor biosecurity effectiveness"></textarea>
                </div>
                
                <div class="question">
                    <label for="budget">Estimated Budget for Biosecurity Measures</label>
                    <input type="text" id="budget" placeholder="Enter amount and currency (e.g., $5,000)">
                </div>
                
                <div class="question">
                    <label for="timeline">Implementation Timeline</label>
                    <textarea id="timeline" placeholder="Describe the timeline for implementing these measures"></textarea>
                </div>
                
                <div class="nav-buttons">
                    <button type="button" onclick="prevStep()" class="btn-secondary">Previous</button>
                    <button type="button" onclick="nextStep()" class="btn-primary">Next</button>
                </div>
            </div>
            
            <!-- Step 8: Team & Review -->
            <div class="step" id="step8">
                <h2>Team & Review</h2>
                
                <div class="question">
                    <label>Team Members Responsible</label>
                    <div id="team-members">
                        <div class="team-member">
                            <input type="text" placeholder="Name" class="team-name">
                            <input type="text" placeholder="Role" class="team-role">
                            <button type="button" onclick="removeTeamMember(this)" class="btn-danger">Remove</button>
                        </div>
                    </div>
                    <button type="button" onclick="addTeamMember()" class="btn-secondary" style="margin-top: 10px;">Add Team Member</button>
                </div>
                
                <div class="question">
                    <label for="review-frequency">Plan Review Frequency</label>
                    <select id="review-frequency">
                        <option value="">Select frequency...</option>
                        <option value="Monthly">Monthly</option>
                        <option value="Quarterly">Quarterly</option>
                        <option value="Bi-annually">Bi-annually</option>
                        <option value="Annually">Annually</option>
                        <option value="As needed">As needed</option>
                    </select>
                </div>
                
                <div class="question">
                    <label for="template-select">Plan Template Style</label>
                    <div class="template-gallery">
                        <div class="template-card" onclick="selectTemplate('basic')" id="template-basic">
                            <div class="template-icon">üìÑ</div>
                            <h3>Basic</h3>
                            <p>Simple, straightforward plan</p>
                        </div>
                        <div class="template-card" onclick="selectTemplate('detailed')" id="template-detailed">
                            <div class="template-icon">üìë</div>
                            <h3>Detailed</h3>
                            <p>Comprehensive with sections</p>
                        </div>
                        <div class="template-card" onclick="selectTemplate('certified')" id="template-certified">
                            <div class="template-icon">üèÜ</div>
                            <h3>Certification-Ready</h3>
                            <p>Formal documentation</p>
                        </div>
                    </div>
                    <input type="hidden" id="template" value="basic">
                </div>
                
                <div class="question">
                    <label for="plan-name" class="required">Name for Your Biosecurity Plan</label>
                    <input type="text" id="plan-name" required>
                </div>
                
                <div class="nav-buttons">
                    <button type="button" onclick="prevStep()" class="btn-secondary">Previous</button>
                    <button type="button" onclick="generatePlan()" class="btn-primary">Generate Plan</button>
                </div>
            </div>
        </div>
        
        <div id="plan-output">
            <h2 id="output-title">Biosecurity Plan</h2>
            <div id="output-content"></div>
            <div class="share-options">
                <button type="button" onclick="savePDF()" class="btn-primary">Save as PDF</button>
                <button type="button" onclick="sharePlan('email')" class="btn-secondary">Email Plan</button>
                <button type="button" onclick="sharePlan('link')" class="btn-secondary">Get Shareable Link</button>
                <button type="button" onclick="resetForm()" class="btn-danger">Start New Plan</button>
            </div>
        </div>
    </div>
    
    <script>
        // Global variables
        const totalSteps = 9;
        let currentStep = 0;
        let riskChart = null;
        let customActivities = [];
        let customRisks = [];
        let customControls = [];
        let customMeasures = [];
        
        // Enhanced industry configurations with more detailed data
        const industryConfig = {
            'conservation': {
                name: 'Conservation and Ecosystem Management',
                activities: [
                    'Habitat restoration',
                    'Weed and pest control',
                    'Native species reintroduction',
                    'Erosion control',
                    'Biodiversity monitoring',
                    'Fire management',
                    'Visitor management',
                    'Waterway restoration',
                    'Seed collection and propagation',
                    'Ecological surveys'
                ],
                risks: [
                    'Introduction of invasive species',
                    'Spread of plant pathogens',
                    'Soil and water contamination',
                    'Cross-contamination between sites',
                    'Introduction of pest animals',
                    'Loss of genetic integrity',
                    'Unauthorized species release',
                    'Equipment-mediated contamination',
                    'Visitor-mediated contamination',
                    'Climate change impacts'
                ],
                measures: [
                    'Site-specific hygiene protocols',
                    'Equipment cleaning stations',
                    'Footwear and clothing decontamination',
                    'Plant material quarantine procedures',
                    'Comprehensive staff training programs',
                    'Vehicle washdown facilities',
                    'Pre-activity risk assessments',
                    'Visitor biosecurity briefings',
                    'Pathogen screening protocols',
                    'Wildlife health monitoring'
                ],
                riskFactors: {
                    'Introduction of invasive species': { likelihood: 3, impact: 3 },
                    'Spread of plant pathogens': { likelihood: 2, impact: 3 },
                    'Soil and water contamination': { likelihood: 2, impact: 2 }
                }
            },
            'horticulture': {
                name: 'Horticulture',
                activities: [
                    'Plant propagation',
                    'Landscape construction',
                    'Garden maintenance',
                    'Irrigation system management',
                    'Pest and disease control',
                    'Soil and media preparation',
                    'Plant sales and distribution',
                    'Greenhouse operations',
                    'Turf management',
                    'Arboriculture'
                ],
                risks: [
                    'Plant pathogen outbreaks',
                    'Pest infestations',
                    'Contaminated growing media',
                    'Water system contamination',
                    'Equipment cross-contamination',
                    'Introduction of invasive species',
                    'Pesticide resistance',
                    'Worker exposure to hazards',
                    'Unauthorized plant movement',
                    'Genetic contamination'
                ],
                measures: [
                    'Plant health certification',
                    'Growing media sterilization',
                    'Tool and equipment sanitation',
                    'Pest exclusion systems',
                    'Worker hygiene stations',
                    'Visitor management protocols',
                    'Waste management systems',
                    'Quarantine areas for new plants',
                    'Integrated pest management',
                    'Water treatment systems'
                ],
                riskFactors: {
                    'Plant pathogen outbreaks': { likelihood: 3, impact: 3 },
                    'Pest infestations': { likelihood: 3, impact: 2 },
                    'Contaminated growing media': { likelihood: 2, impact: 3 }
                }
            },
            'agriculture': {
                name: 'Agriculture',
                activities: [
                    'Crop planting and harvesting',
                    'Livestock management',
                    'Irrigation system maintenance',
                    'Pest and disease control',
                    'Soil management',
                    'Equipment operations',
                    'Produce handling and storage',
                    'Feed management',
                    'Pasture management',
                    'Agrochemical application'
                ],
                risks: [
                    'Crop disease outbreaks',
                    'Livestock infections',
                    'Pesticide resistance',
                    'Soil contamination',
                    'Water contamination',
                    'Equipment cross-contamination',
                    'Worker health risks',
                    'Introduction of invasive species',
                    'Feed contamination',
                    'Zoonotic disease transmission'
                ],
                measures: [
                    'Farm biosecurity plan',
                    'Vehicle and equipment wash stations',
                    'Personal protective equipment',
                    'Quarantine areas for new stock',
                    'Pest monitoring systems',
                    'Visitor logbooks',
                    'Staff training programs',
                    'Feed storage protocols',
                    'Water treatment systems',
                    'Vaccination programs'
                ],
                riskFactors: {
                    'Crop disease outbreaks': { likelihood: 3, impact: 3 },
                    'Livestock infections': { likelihood: 2, impact: 3 },
                    'Pesticide resistance': { likelihood: 2, impact: 2 }
                }
            },
            'other': {
                name: 'Other',
                activities: [],
                risks: [],
                measures: [],
                riskFactors: {}
            }
        };
        
        // Step indicators for better UX
        const stepIndicators = [
            "Select Industry",
            "Organization Info",
            "Project Details",
            "Activities",
            "Risk Identification",
            "Risk Assessment",
            "Current Controls",
            "Proposed Measures",
            "Team & Review"
        ];
        
        // Initialize the tool
        document.addEventListener('DOMContentLoaded', function() {
            // Set default industry selection
            selectIndustry('conservation');
            
            // Check for saved theme preference
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                document.documentElement.setAttribute('data-theme', 'dark');
                updateThemeToggle('dark');
            }
            
            // Set up theme toggle
            document.getElementById('themeToggle').addEventListener('click', toggleTheme);
            
            // Set up sidebar toggle for mobile
            document.getElementById('sidebarToggle').addEventListener('click', function() {
                document.getElementById('sidebar').classList.toggle('show');
            });
            
            // Set up version history
            document.getElementById('versionHistoryBtn').addEventListener('click', function() {
                document.getElementById('versionHistoryPanel').classList.toggle('show');
                if (document.getElementById('versionHistoryPanel').classList.contains('show')) {
                    loadVersionHistory();
                }
            });
            
            // Close version history when clicking outside
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.version-history')) {
                    document.getElementById('versionHistoryPanel').classList.remove('show');
                }
                if (!e.target.closest('.sidebar') && !e.target.closest('.sidebar-toggle')) {
                    document.getElementById('sidebar').classList.remove('show');
                }
            });
            
            // Set up sidebar navigation
            document.querySelectorAll('.sidebar-nav a').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const step = parseInt(this.getAttribute('href').replace('#step', ''));
                    if (step <= currentStep || validateStep(currentStep)) {
                        goToStep(step);
                    }
                });
            });
            
            // Load saved progress
            loadProgress();
            updateStepIndicator();
            
            // Set up event listeners for dynamic elements
            document.getElementById('industry-other-text').addEventListener('input', function() {
                if (this.value) {
                    document.getElementById('industry').value = this.value;
                    industryConfig.other.name = this.value;
                }
            });
            
            // Initialize custom arrays from localStorage if they exist
            const savedData = localStorage.getItem('biosecurityPlanData');
            if (savedData) {
                const data = JSON.parse(savedData);
                customActivities = data.customActivities || [];
                customRisks = data.customRisks || [];
                customControls = data.customControls || [];
                customMeasures = data.customMeasures || [];
            }
            
            // Set up autocomplete for organization names
            setupAutocomplete();
            
            // Auto-save when fields change
            setupAutoSave();
        });
        
        // Setup autocomplete for organization names
        function setupAutocomplete() {
            const orgNames = [
                "Department of Conservation",
                "National Parks Service",
                "Wildlife Conservation Society",
                "Nature Conservancy",
                "Local Landcare Group",
                "Regional Environmental Agency",
                "Biodiversity Foundation",
                "Ecosystem Restoration Network",
                "Sustainable Agriculture Initiative",
                "Organic Farmers Cooperative"
            ];
            
            if (typeof autocomplete === 'function') {
                autocomplete({
                    input: document.getElementById("org-name"),
                    minLength: 1,
                    onSelect: function(item) {
                        saveProgress();
                    },
                    fetch: function(text, callback) {
                        const matches = orgNames.filter(name => 
                            name.toLowerCase().includes(text.toLowerCase())
                        );
                        callback(matches);
                    }
                });
            }
        }
        
        // Set up auto-save functionality
        function setupAutoSave() {
            const inputs = document.querySelectorAll('input, textarea, select');
            inputs.forEach(input => {
                input.addEventListener('change', function() {
                    saveProgress();
                    updateSidebarProgress();
                });
                
                // For text fields, save after a delay to avoid too many saves
                if (input.type === 'text' || input.type === 'textarea') {
                    let timeout;
                    input.addEventListener('input', function() {
                        clearTimeout(timeout);
                        timeout = setTimeout(() => {
                            saveProgress();
                            updateSidebarProgress();
                        }, 1000);
                    });
                }
            });
        }
        
        // Load version history
        function loadVersionHistory() {
            const history = JSON.parse(localStorage.getItem('biosecurityPlanHistory') || '[]');
            const container = document.getElementById('versionHistoryList');
            container.innerHTML = '';
            
            if (history.length === 0) {
                container.innerHTML = '<p>No previous versions found</p>';
                return;
            }
            
            history.forEach((version, index) => {
                const item = document.createElement('div');
                item.className = 'version-item';
                item.innerHTML = `
                    <strong>Version ${history.length - index}</strong>
                    <div>${new Date(version.timestamp).toLocaleString()}</div>
                    <small>${version.planName || 'Unnamed plan'}</small>
                `;
                item.addEventListener('click', function() {
                    restoreVersion(version.data);
                });
                container.appendChild(item);
            });
        }
        
        // Restore a previous version
        function restoreVersion(data) {
            if (confirm('Are you sure you want to restore this version? Current changes will be lost.')) {
                localStorage.setItem('biosecurityPlanData', JSON.stringify(data));
                location.reload();
            }
        }
        
        // Save a version to history
        function saveVersionToHistory() {
            const currentData = localStorage.getItem('biosecurityPlanData');
            if (!currentData) return;
            
            const history = JSON.parse(localStorage.getItem('biosecurityPlanHistory') || '[]');
            const planName = JSON.parse(currentData).planName || 'Unnamed plan';
            
            // Keep only the last 5 versions
            if (history.length >= 5) {
                history.shift();
            }
            
            history.push({
                timestamp: new Date().toISOString(),
                data: JSON.parse(currentData),
                planName: planName
            });
            
            localStorage.setItem('biosecurityPlanHistory', JSON.stringify(history));
        }
        
        // Theme toggle functions
        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            if (currentTheme === 'dark') {
                document.documentElement.removeAttribute('data-theme');
                localStorage.setItem('theme', 'light');
                updateThemeToggle('light');
            } else {
                document.documentElement.setAttribute('data-theme', 'dark');
                localStorage.setItem('theme', 'dark');
                updateThemeToggle('dark');
            }
        }
        
        function updateThemeToggle(theme) {
            const toggle = document.getElementById('themeToggle');
            if (theme === 'dark') {
                toggle.innerHTML = '<i class="fas fa-sun"></i><span>Light Mode</span>';
            } else {
                toggle.innerHTML = '<i class="fas fa-moon"></i><span>Dark Mode</span>';
            }
        }
        
        // Navigation functions
        function goToStep(stepNumber) {
            // Validate current step before leaving
            if (stepNumber > currentStep && !validateStep(currentStep)) {
                return false;
            }

            // Hide all steps
            document.querySelectorAll('.step').forEach(step => {
                step.classList.remove('active');
            });
            
            // Show the requested step
            document.getElementById(`step${stepNumber}`).classList.add('active');
            currentStep = stepNumber;
            updateStepIndicator();
            updateSidebarNavigation();
            
            // Special handling for certain steps
            if (currentStep === 3) updateActivities();
            if (currentStep === 4) updateRisks();
            if (currentStep === 5) generateRiskMatrix();
            if (currentStep === 7) updateMeasures();
            
            // Scroll to top of step
            window.scrollTo(0, 0);
            
            return false;
        }

        function nextStep() {
            return goToStep(currentStep + 1);
        }

        function prevStep() {
            return goToStep(currentStep - 1);
        }

        function updateStepIndicator() {
            document.getElementById('step-indicator').textContent = stepIndicators[currentStep];
            document.getElementById('progress-bar').style.width = `${(currentStep / (totalSteps-1)) * 100}%`;
            document.getElementById('progress-text').textContent = `Step ${currentStep+1} of ${totalSteps}`;
            updateSidebarProgress();
        }
        
        function updateSidebarNavigation() {
            const navLinks = document.querySelectorAll('.sidebar-nav a');
            navLinks.forEach((link, index) => {
                link.classList.remove('active', 'completed');
                if (index === currentStep) {
                    link.classList.add('active');
                } else if (index < currentStep) {
                    link.classList.add('completed');
                }
            });
        }
        
        function updateSidebarProgress() {
            const progress = calculateCompletionPercentage();
            document.getElementById('sidebar-progress-bar').style.width = `${progress}%`;
            document.getElementById('sidebar-progress-text').textContent = `${progress}%`;
        }
        
        function calculateCompletionPercentage() {
            const data = JSON.parse(localStorage.getItem('biosecurityPlanData') || '{}');
            let completedFields = 0;
            let totalFields = 0;
            
            // Step 0: Industry
            totalFields += 1;
            if (data.industry) completedFields += 1;
            
            // Step 1: Organization Info
            totalFields += 5;
            if (data.orgName) completedFields += 1;
            if (data.orgType) completedFields += 1;
            if (data.orgSize) completedFields += 1;
            if (data.primaryContact) completedFields += 1;
            if (data.contactEmail) completedFields += 1;
            
            // Step 2: Project Info
            totalFields += 4;
            if (data.projectName) completedFields += 1;
            if (data.projectLocation) completedFields += 1;
            if (data.projectSize) completedFields += 1;
            if (data.projectDescription) completedFields += 1;
            
            // Step 3: Activities
            totalFields += 3;
            if (data.activities && data.activities.length > 0) completedFields += 1;
            if (data.activityFrequency) completedFields += 1;
            if (data.activityStaff) completedFields += 1;
            
            // Step 4: Risks
            totalFields += 3;
            if (data.risks && data.risks.length > 0) completedFields += 1;
            if (data.knownIssues) completedFields += 1;
            if (data.visitorFrequency) completedFields += 1;
            
            // Step 5: Risk Assessment
            totalFields += 2;
            if (data.riskScores && data.riskScores.length > 0) completedFields += 1;
            if (data.riskNotes) completedFields += 1;
            
            // Step 6: Controls
            totalFields += 3;
            if (data.controls && data.controls.length > 0) completedFields += 1;
            if (data.existingProtocols) completedFields += 1;
            if (data.challenges) completedFields += 1;
            
            // Step 7: Measures
            totalFields += 5;
            if (data.measures && data.measures.length > 0) completedFields += 1;
            if (data.implementation) completedFields += 1;
            if (data.monitoring) completedFields += 1;
            if (data.budget) completedFields += 1;
            if (data.timeline) completedFields += 1;
            
            // Step 8: Team & Review
            totalFields += 3;
            if (data.teamMembers && data.teamMembers.length > 0) completedFields += 1;
            if (data.reviewFrequency) completedFields += 1;
            if (data.planName) completedFields += 1;
            
            return Math.round((completedFields / totalFields) * 100);
        }
        
        function validateStep(step) {
            // Simple validation for required fields
            let isValid = true;

            if (step === 0) {
                const industry = document.getElementById('industry').value;
                if (!industry) {
                    alert('Please select an industry');
                    isValid = false;
                } else if (industry === 'other' && !document.getElementById('industry-other-text').value) {
                    alert('Please specify your industry');
                    isValid = false;
                }
            } else if (step === 1) {
                if (!document.getElementById('org-name').value) {
                    alert('Please enter your organization name');
                    isValid = false;
                }
                if (!document.getElementById('primary-contact').value) {
                    alert('Please enter a primary contact');
                    isValid = false;
                }
                if (!document.getElementById('contact-email').value) {
                    alert('Please enter a contact email');
                    isValid = false;
                } else if (!validateEmail(document.getElementById('contact-email').value)) {
                    alert('Please enter a valid email address');
                    isValid = false;
                }
            } else if (step === 2) {
                if (!document.getElementById('project-name').value) {
                    alert('Please enter a project/site name');
                    isValid = false;
                }
                if (!document.getElementById('project-location').value) {
                    alert('Please enter a location');
                    isValid = false;
                }
            } else if (step === 3) {
                const activities = getSelectedCheckboxes('activities');
                if (activities.length === 0) {
                    alert('Please select at least one activity');
                    isValid = false;
                }
            } else if (step === 4) {
                const risks = getSelectedCheckboxes('risks');
                if (risks.length === 0) {
                    alert('Please select at least one risk');
                    isValid = false;
                }
                if (!document.getElementById('visitor-frequency').value) {
                    alert('Please select visitor frequency');
                    isValid = false;
                }
            } else if (step === 7) {
                const measures = getSelectedCheckboxes('measures');
                if (measures.length === 0) {
                    alert('Please select at least one proposed measure');
                    isValid = false;
                }
            } else if (step === 8) {
                if (!document.getElementById('plan-name').value) {
                    alert('Please enter a name for your biosecurity plan');
                    isValid = false;
                }
            }
            
            return isValid;
        }
        
        function validateEmail(email) {
            const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return re.test(email);
        }
        
        // Industry selection functions
        function selectIndustry(industry) {
            // Update UI
            document.querySelectorAll('.industry-card').forEach(card => {
                card.classList.remove('selected');
            });
            document.getElementById(`industry-card-${industry}`).classList.add('selected');
            
            // Set the hidden input value
            document.getElementById('industry').value = industry;
            
            // Handle "Other" case
            const otherText = document.getElementById('industry-other-text');
            if (industry === 'other') {
                otherText.style.display = 'block';
            } else {
                otherText.style.display = 'none';
            }
            
            return false;
        }

        function validateAndContinue() {
            const industry = document.getElementById('industry').value;
            const otherText = document.getElementById('industry-other-text');
            
            if (!industry) {
                alert('Please select an industry');
                return false;
            }
            
            if (industry === 'other' && !otherText.value.trim()) {
                alert('Please specify your industry');
                otherText.focus();
                return false;
            }
            
            // If validation passes, proceed to next step
            return goToStep(1);
        }
        
        // Template selection
        function selectTemplate(template) {
            document.querySelectorAll('.template-card').forEach(card => {
                card.classList.remove('selected');
            });
            document.getElementById(`template-${template}`).classList.add('selected');
            document.getElementById('template').value = template;
            return false;
        }
        
        // Custom field management
        function addCustomActivity() {
            const activityInput = document.getElementById('new-activity');
            const activity = activityInput.value.trim();
            
            if (activity) {
                customActivities.push(activity);
                updateActivities();
                activityInput.value = '';
                saveProgress();
            }
        }
        
        function removeCustomActivity(activity) {
            customActivities = customActivities.filter(a => a !== activity);
            updateActivities();
            saveProgress();
        }
        
        function addCustomRisk() {
            const riskInput = document.getElementById('new-risk');
            const risk = riskInput.value.trim();
            
            if (risk) {
                customRisks.push(risk);
                updateRisks();
                riskInput.value = '';
                saveProgress();
            }
        }
        
        function removeCustomRisk(risk) {
            customRisks = customRisks.filter(r => r !== risk);
            updateRisks();
            saveProgress();
        }
        
        function addCustomControl() {
            const controlInput = document.getElementById('new-control');
            const control = controlInput.value.trim();
            
            if (control) {
                customControls.push(control);
                updateControls();
                controlInput.value = '';
                saveProgress();
            }
        }
        
        function removeCustomControl(control) {
            customControls = customControls.filter(c => c !== control);
            updateControls();
            saveProgress();
        }
        
        function addCustomMeasure() {
            const measureInput = document.getElementById('new-measure');
            const measure = measureInput.value.trim();
            
            if (measure) {
                customMeasures.push(measure);
                updateMeasures();
                measureInput.value = '';
                saveProgress();
            }
        }
        
        function removeCustomMeasure(measure) {
            customMeasures = customMeasures.filter(m => m !== measure);
            updateMeasures();
            saveProgress();
        }
        
        function updateControls() {
            const container = document.getElementById('controls-container');
            
            // Standard controls
            let html = `
                <div class="checkbox-option">
                    <input type="checkbox" id="control-cleaning" name="controls" value="Equipment cleaning protocols">
                    <label for="control-cleaning">Equipment cleaning protocols</label>
                </div>
                <div class="checkbox-option">
                    <input type="checkbox" id="control-quarantine" name="controls" value="Quarantine areas">
                    <label for="control-quarantine">Quarantine areas</label>
                </div>
                <div class="checkbox-option">
                    <input type="checkbox" id="control-monitoring" name="controls" value="Regular monitoring">
                    <label for="control-monitoring">Regular monitoring</label>
                </div>
                <div class="checkbox-option">
                    <input type="checkbox" id="control-signage" name="controls" value="Biosecurity signage">
                    <label for="control-signage">Biosecurity signage</label>
                </div>
                <div class="checkbox-option">
                    <input type="checkbox" id="control-training" name="controls" value="Staff training">
                    <label for="control-training">Staff training</label>
                </div>
                <div class="checkbox-option">
                    <input type="checkbox" id="control-ppe" name="controls" value="Personal protective equipment">
                    <label for="control-ppe">Personal protective equipment</label>
                </div>
                <div class="checkbox-option">
                    <input type="checkbox" id="control-visitor" name="controls" value="Visitor management systems">
                    <label for="control-visitor">Visitor management systems</label>
                </div>
                <div class="checkbox-option">
                    <input type="checkbox" id="control-waste" name="controls" value="Waste management protocols">
                    <label for="control-waste">Waste management protocols</label>
                </div>
            `;
            
            // Add custom controls
            customControls.forEach((control, index) => {
                const id = `control-custom-${index}`;
                html += `
                    <div class="checkbox-option">
                        <input type="checkbox" id="${id}" name="controls" value="${control}">
                        <label for="${id}">${control}</label>
                        <button type="button" onclick="removeCustomControl('${control}')" class="btn-danger">Remove</button>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            
            // Load saved controls if they exist
            const savedData = localStorage.getItem('biosecurityPlanData');
            if (savedData) {
                const data = JSON.parse(savedData);
                setSelectedCheckboxes('controls', data.controls || []);
                document.getElementById('existing-protocols').value = data.existingProtocols || '';
                document.getElementById('challenges').value = data.challenges || '';
            }
        }
        
        // Dynamic content updates based on industry
        function updateActivities() {
            const industry = document.getElementById('industry').value || 'conservation';
            const industryKey = Object.keys(industryConfig).find(key => 
                industryConfig[key].name === industry) || 'conservation';
            const config = industryConfig[industryKey] || industryConfig.conservation;
            
            const container = document.getElementById('activities-container');
            
            // Standard activities
            let html = config.activities.map(activity => `
                <div class="activity-item">
                    <input type="checkbox" id="activity-${activity.toLowerCase().replace(/\s+/g, '-')}" 
                           name="activities" value="${activity}">
                    <label for="activity-${activity.toLowerCase().replace(/\s+/g, '-')}">${activity}</label>
                </div>
            `).join('');
            
            // Add custom activities
            customActivities.forEach((activity, index) => {
                const id = `activity-custom-${index}`;
                html += `
                    <div class="activity-item">
                        <input type="checkbox" id="${id}" name="activities" value="${activity}">
                        <label for="${id}">${activity}</label>
                        <button type="button" onclick="removeCustomActivity('${activity}')" class="btn-danger">Remove</button>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            
            // Load saved activities if they exist
            const savedData = localStorage.getItem('biosecurityPlanData');
            if (savedData) {
                const data = JSON.parse(savedData);
                setSelectedCheckboxes('activities', data.activities || []);
                document.getElementById('activity-frequency').value = data.activityFrequency || '';
                document.getElementById('activity-staff').value = data.activityStaff || '';
            }
        }
        
        function updateRisks() {
            const industry = document.getElementById('industry').value || 'conservation';
            const industryKey = Object.keys(industryConfig).find(key => 
                industryConfig[key].name === industry) || 'conservation';
            const config = industryConfig[industryKey] || industryConfig.conservation;
            
            const container = document.getElementById('risks-container');
            
            // Standard risks
            let html = config.risks.map(risk => `
                <div class="risk-item">
                    <input type="checkbox" id="risk-${risk.toLowerCase().replace(/\s+/g, '-')}" 
                           name="risks" value="${risk}">
                    <label for="risk-${risk.toLowerCase().replace(/\s+/g, '-')}">${risk}</label>
                </div>
            `).join('');
            
            // Add custom risks
            customRisks.forEach((risk, index) => {
                const id = `risk-custom-${index}`;
                html += `
                    <div class="risk-item">
                        <input type="checkbox" id="${id}" name="risks" value="${risk}">
                        <label for="${id}">${risk}</label>
                        <button type="button" onclick="removeCustomRisk('${risk}')" class="btn-danger">Remove</button>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            
            // Load saved risks if they exist
            const savedData = localStorage.getItem('biosecurityPlanData');
            if (savedData) {
                const data = JSON.parse(savedData);
                setSelectedCheckboxes('risks', data.risks || []);
                document.getElementById('known-issues').value = data.knownIssues || '';
                document.getElementById('visitor-frequency').value = data.visitorFrequency || '';
            }
        }
        
        function updateMeasures() {
            const industry = document.getElementById('industry').value || 'conservation';
            const industryKey = Object.keys(industryConfig).find(key => 
                industryConfig[key].name === industry) || 'conservation';
            const config = industryConfig[industryKey] || industryConfig.conservation;
            
            const container = document.getElementById('measures-container');
            
            // Standard measures
            let html = config.measures.map(measure => `
                <div class="measure-item">
                    <input type="checkbox" id="measure-${measure.toLowerCase().replace(/\s+/g, '-')}" 
                           name="measures" value="${measure}">
                    <label for="measure-${measure.toLowerCase().replace(/\s+/g, '-')}">${measure}</label>
                </div>
            `).join('');
            
            // Add custom measures
            customMeasures.forEach((measure, index) => {
                const id = `measure-custom-${index}`;
                html += `
                    <div class="measure-item">
                        <input type="checkbox" id="${id}" name="measures" value="${measure}">
                        <label for="${id}">${measure}</label>
                        <button type="button" onclick="removeCustomMeasure('${measure}')" class="btn-danger">Remove</button>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            
            // Load saved measures if they exist
            const savedData = localStorage.getItem('biosecurityPlanData');
            if (savedData) {
                const data = JSON.parse(savedData);
                setSelectedCheckboxes('measures', data.measures || []);
                document.getElementById('implementation').value = data.implementation || '';
                document.getElementById('monitoring').value = data.monitoring || '';
                document.getElementById('budget').value = data.budget || '';
                document.getElementById('timeline').value = data.timeline || '';
            }
        }
        
        // Risk assessment matrix
        function generateRiskMatrix() {
            const risks = getSelectedCheckboxes('risks');
            const matrixBody = document.getElementById('risk-matrix-body');
            const industry = document.getElementById('industry').value || 'conservation';
            const industryKey = Object.keys(industryConfig).find(key => 
                industryConfig[key].name === industry) || 'conservation';
            const config = industryConfig[industryKey] || industryConfig.conservation;
            
            matrixBody.innerHTML = risks.map(risk => {
                // Get default likelihood and impact if they exist for this risk
                const defaultLikelihood = config.riskFactors[risk]?.likelihood || 1;
                const defaultImpact = config.riskFactors[risk]?.impact || 1;
                
                return `
                    <tr>
                        <td>${risk}</td>
                        <td>
                            <select class="likelihood" onchange="updateRiskScore(this)" value="${defaultLikelihood}">
                                <option value="1" ${defaultLikelihood == 1 ? 'selected' : ''}>Low</option>
                                <option value="2" ${defaultLikelihood == 2 ? 'selected' : ''}>Medium</option>
                                <option value="3" ${defaultLikelihood == 3 ? 'selected' : ''}>High</option>
                            </select>
                        </td>
                        <td>
                            <select class="impact" onchange="updateRiskScore(this)" value="${defaultImpact}">
                                <option value="1" ${defaultImpact == 1 ? 'selected' : ''}>Low</option>
                                <option value="2" ${defaultImpact == 2 ? 'selected' : ''}>Medium</option>
                                <option value="3" ${defaultImpact == 3 ? 'selected' : ''}>High</option>
                            </select>
                        </td>
                        <td class="risk-score">${defaultLikelihood * defaultImpact}</td>
                        <td class="risk-priority">
                            ${defaultLikelihood * defaultImpact >= 6 ? 'High' : 
                              defaultLikelihood * defaultImpact >= 3 ? 'Medium' : 'Low'}
                        </td>
                    </tr>
                `;
            }).join('');
            
            // Apply styling based on initial scores
            document.querySelectorAll('#risk-matrix-body tr').forEach(row => {
                const score = parseInt(row.querySelector('.risk-score').textContent);
                const scoreCell = row.querySelector('.risk-score');
                const priorityCell = row.querySelector('.risk-priority');
                
                if (score >= 6) {
                    row.classList.add('high-risk');
                    scoreCell.className = 'risk-score high';
                } else if (score >= 3) {
                    scoreCell.className = 'risk-score medium';
                } else {
                    scoreCell.className = 'risk-score low';
                }
            });
            
            // Load saved risk scores if they exist
            const savedData = localStorage.getItem('biosecurityPlanData');
            if (savedData) {
                const data = JSON.parse(savedData);
                if (data.riskScores) {
                    data.riskScores.forEach((risk, i) => {
                        const row = document.querySelectorAll('#risk-matrix-body tr')[i];
                        if (row) {
                            row.querySelector('.likelihood').value = risk.likelihood;
                            row.querySelector('.impact').value = risk.impact;
                            updateRiskScore(row.querySelector('.likelihood'));
                        }
                    });
                    document.getElementById('risk-notes').value = data.riskNotes || '';
                }
            }
            
            // Initialize risk chart
            updateRiskChart();
        }
        
        function updateRiskScore(element) {
            const row = element.closest('tr');
            const likelihood = row.querySelector('.likelihood').value;
            const impact = row.querySelector('.impact').value;
            const score = likelihood * impact;
            
            const scoreCell = row.querySelector('.risk-score');
            scoreCell.textContent = score;
            
            // Update priority
            const priorityCell = row.querySelector('.risk-priority');
            let priority = 'Low';
            let priorityClass = 'low';
            
            if (score >= 6) {
                priority = 'High';
                priorityClass = 'high';
                row.classList.add('high-risk');
            } else if (score >= 3) {
                priority = 'Medium';
                priorityClass = 'medium';
                row.classList.remove('high-risk');
            } else {
                priority = 'Low';
                priorityClass = 'low';
                row.classList.remove('high-risk');
            }
            
            priorityCell.textContent = priority;
            scoreCell.className = 'risk-score ' + priorityClass;
            
            // Update chart
            updateRiskChart();
            
            // Save progress
            saveProgress();
        }
        
        function updateRiskChart() {
            const risks = Array.from(document.querySelectorAll('#risk-matrix-body tr')).map(row => ({
                name: row.querySelector('td').textContent,
                score: parseInt(row.querySelector('.risk-score').textContent),
                priority: row.querySelector('.risk-priority').textContent
            }));
            
            const ctx = document.getElementById('riskChart').getContext('2d');
            
            // Destroy previous chart if it exists
            if (riskChart) {
                riskChart.destroy();
            }
            
            if (risks.length > 0) {
                riskChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: risks.map(r => r.name),
                        datasets: [{
                            label: 'Risk Score',
                            data: risks.map(r => r.score),
                            backgroundColor: risks.map(r => 
                                r.priority === 'High' ? 'rgba(198, 40, 40, 0.7)' :
                                r.priority === 'Medium' ? 'rgba(255, 143, 0, 0.7)' :
                                'rgba(46, 125, 50, 0.7)'),
                            borderColor: risks.map(r => 
                                r.priority === 'High' ? 'rgba(198, 40, 40, 1)' :
                                r.priority === 'Medium' ? 'rgba(255, 143, 0, 1)' :
                                'rgba(46, 125, 50, 1)'),
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 9,
                                title: {
                                    display: true,
                                    text: 'Risk Score'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Identified Risks'
                                }
                            }
                        },
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `Score: ${context.raw} (${risks[context.dataIndex].priority} priority)`;
                                    }
                                }
                            },
                            legend: {
                                display: false
                            }
                        }
                    }
                });
            }
        }
        
        // Team management
        function addTeamMember() {
            const container = document.getElementById('team-members');
            const newMember = document.createElement('div');
            newMember.className = 'team-member';
            newMember.innerHTML = `
                <input type="text" placeholder="Name" class="team-name">
                <input type="text" placeholder="Role" class="team-role">
                <button type="button" onclick="removeTeamMember(this)" class="btn-danger">Remove</button>
            `;
            container.appendChild(newMember);
            
            // Set up event listeners for the new inputs
            newMember.querySelectorAll('input').forEach(input => {
                input.addEventListener('change', function() {
                    saveProgress();
                });
            });
            
            return false;
        }
        
        function removeTeamMember(button) {
            if (document.querySelectorAll('.team-member').length > 1) {
                button.closest('.team-member').remove();
                saveProgress();
            } else {
                alert('You need at least one team member');
            }
            return false;
        }
        
        function getTeamMembers() {
            const members = [];
            document.querySelectorAll('.team-member').forEach(member => {
                const name = member.querySelector('.team-name').value;
                const role = member.querySelector('.team-role').value;
                if (name || role) {
                    members.push({ name, role });
                }
            });
            return members;
        }
        
        // Data handling functions
        function saveProgress() {
            const data = {
                industry: document.getElementById('industry').value,
                
                orgName: document.getElementById('org-name').value,
                orgType: document.getElementById('org-type').value,
                orgSize: document.getElementById('org-size').value,
                primaryContact: document.getElementById('primary-contact').value,
                contactEmail: document.getElementById('contact-email').value,
                
                projectName: document.getElementById('project-name').value,
                projectLocation: document.getElementById('project-location').value,
                projectSize: document.getElementById('project-size').value,
                sizeUnit: document.getElementById('size-unit').value,
                projectDescription: document.getElementById('project-description').value,
                
                activities: getSelectedCheckboxes('activities'),
                activityFrequency: document.getElementById('activity-frequency').value,
                activityStaff: document.getElementById('activity-staff').value,
                
                risks: getSelectedCheckboxes('risks'),
                knownIssues: document.getElementById('known-issues').value,
                visitorFrequency: document.getElementById('visitor-frequency').value,
                
                riskScores: getRiskScores(),
                riskNotes: document.getElementById('risk-notes').value,
                
                controls: getSelectedCheckboxes('controls'),
                existingProtocols: document.getElementById('existing-protocols').value,
                challenges: document.getElementById('challenges').value,
                
                measures: getSelectedCheckboxes('measures'),
                implementation: document.getElementById('implementation').value,
                monitoring: document.getElementById('monitoring').value,
                budget: document.getElementById('budget').value,
                timeline: document.getElementById('timeline').value,
                
                teamMembers: getTeamMembers(),
                reviewFrequency: document.getElementById('review-frequency').value,
                template: document.getElementById('template').value,
                planName: document.getElementById('plan-name').value,
                
                // Save custom fields
                customActivities: customActivities,
                customRisks: customRisks,
                customControls: customControls,
                customMeasures: customMeasures,
                
                // Save timestamp
                lastSaved: new Date().toISOString()
            };
            
            localStorage.setItem('biosecurityPlanData', JSON.stringify(data));
            updateSidebarProgress();
        }
        
        function getRiskScores() {
            const risks = [];
            document.querySelectorAll('#risk-matrix-body tr').forEach(row => {
                risks.push({
                    name: row.querySelector('td').textContent,
                    likelihood: row.querySelector('.likelihood').value,
                    impact: row.querySelector('.impact').value,
                    score: row.querySelector('.risk-score').textContent,
                    priority: row.querySelector('.risk-priority').textContent
                });
            });
            return risks;
        }
        
        function loadProgress() {
            const savedData = localStorage.getItem('biosecurityPlanData');
            if (savedData) {
                const data = JSON.parse(savedData);
                
                // Step 0
                if (data.industry) {
                    const industryKey = Object.keys(industryConfig).find(key => 
                        industryConfig[key].name === data.industry) || 'other';
                    selectIndustry(industryKey);
                    if (industryKey === 'other') {
                        document.getElementById('industry-other-text').value = data.industry;
                        document.getElementById('industry-other-text').style.display = 'block';
                    }
                }
                
                // Step 1
                document.getElementById('org-name').value = data.orgName || '';
                document.getElementById('org-type').value = data.orgType || '';
                document.getElementById('org-size').value = data.orgSize || '';
                document.getElementById('primary-contact').value = data.primaryContact || '';
                document.getElementById('contact-email').value = data.contactEmail || '';
                
                // Step 2
                document.getElementById('project-name').value = data.projectName || '';
                document.getElementById('project-location').value = data.projectLocation || '';
                document.getElementById('project-size').value = data.projectSize || '';
                document.getElementById('size-unit').value = data.sizeUnit || 'hectares';
                document.getElementById('project-description').value = data.projectDescription || '';
                
                // Step 3 (will be populated when step is activated)
                
                // Step 4 (will be populated when step is activated)
                
                // Step 5 (will be populated when step is activated)
                
                // Step 6 (will be populated when step is activated)
                
                // Step 7 (will be populated when step is activated)
                
                // Step 8
                if (data.teamMembers && data.teamMembers.length > 0) {
                    const container = document.getElementById('team-members');
                    container.innerHTML = '';
                    data.teamMembers.forEach(member => {
                        const newMember = document.createElement('div');
                        newMember.className = 'team-member';
                        newMember.innerHTML = `
                            <input type="text" placeholder="Name" class="team-name" value="${member.name || ''}">
                            <input type="text" placeholder="Role" class="team-role" value="${member.role || ''}">
                            <button type="button" onclick="removeTeamMember(this)" class="btn-danger">Remove</button>
                        `;
                        container.appendChild(newMember);
                    });
                }
                document.getElementById('review-frequency').value = data.reviewFrequency || '';
                if (data.template) {
                    selectTemplate(data.template);
                }
                document.getElementById('plan-name').value = data.planName || '';
                
                // Load custom fields
                customActivities = data.customActivities || [];
                customRisks = data.customRisks || [];
                customControls = data.customControls || [];
                customMeasures = data.customMeasures || [];
                
                // Update sidebar progress
                updateSidebarProgress();
            }
        }
        
        function getSelectedCheckboxes(name) {
            const checkboxes = document.querySelectorAll(`input[name="${name}"]:checked`);
            return Array.from(checkboxes).map(cb => cb.value);
        }
        
        function setSelectedCheckboxes(name, values) {
            const checkboxes = document.querySelectorAll(`input[name="${name}"]`);
            checkboxes.forEach(cb => {
                cb.checked = values.includes(cb.value);
            });
        }
        
        // Plan generation functions
        function generatePlan() {
            if (!validateStep(8)) return false;
            
            saveProgress();
            saveVersionToHistory();
            const data = JSON.parse(localStorage.getItem('biosecurityPlanData'));
            
            // Set the plan title
            document.getElementById('output-title').textContent = data.planName;
            
            // Generate the plan content based on selected template
            let html = '';
            
            if (data.template === 'basic') {
                html = generateBasicPlan(data);
            } else if (data.template === 'detailed') {
                html = generateDetailedPlan(data);
            } else {
                html = generateCertifiedPlan(data);
            }
            
            document.getElementById('output-content').innerHTML = html;
            
            // Show the output and hide the wizard
            document.querySelector('.wizard-container').style.display = 'none';
            document.getElementById('plan-output').style.display = 'block';
            
            // Update chart for PDF generation
            updateRiskChart();
            return false;
        }
        
        function generateBasicPlan(data) {
            return `
                <div class="output-section">
                    <h3>1. Overview</h3>
                    <p><strong>Organization:</strong> ${data.orgName}</p>
                    <p><strong>Project/Site:</strong> ${data.projectName}</p>
                    <p><strong>Location:</strong> ${data.projectLocation}</p>
                    <p><strong>Primary Contact:</strong> ${data.primaryContact} (${data.contactEmail})</p>
                </div>
                
                <div class="output-section">
                    <h3>2. Key Risks</h3>
                    <ul>
                        ${data.risks.map(r => `<li>${r}</li>`).join('')}
                    </ul>
                </div>
                
                <div class="output-section">
                    <h3>3. Control Measures</h3>
                    <p><strong>Existing Controls:</strong></p>
                    <ul>
                        ${data.controls.length > 0 ? 
                            data.controls.map(c => `<li>${c}</li>`).join('') : 
                            '<li>None reported</li>'}
                    </ul>
                    
                    <p><strong>Additional Measures:</strong></p>
                    <ul>
                        ${data.measures.map(m => `<li>${m}</li>`).join('')}
                    </ul>
                </div>
                
                <div class="output-section">
                    <h3>4. Implementation</h3>
                    <p>${data.implementation || 'Implementation plan not specified.'}</p>
                </div>
                
                <div class="output-section">
                    <p><em>Plan generated on ${new Date().toLocaleDateString()}</em></p>
                </div>
            `;
        }
        
        function generateDetailedPlan(data) {
            return `
                <div class="output-section">
                    <h3>1. Introduction</h3>
                    <p><strong>Purpose:</strong> This biosecurity plan outlines the measures to prevent, control, and manage biosecurity risks at ${data.projectName}.</p>
                    <p><strong>Scope:</strong> This plan applies to all activities conducted at ${data.projectLocation} by ${data.orgName} staff, volunteers, and visitors.</p>
                </div>
                
                <div class="output-section">
                    <h3>2. Site Details</h3>
                    <p><strong>Site Name:</strong> ${data.projectName}</p>
                    <p><strong>Location:</strong> ${data.projectLocation}</p>
                    <p><strong>Size:</strong> ${data.projectSize || 'Not specified'} ${data.sizeUnit || 'hectares'}</p>
                    <p><strong>Description:</strong> ${data.projectDescription || 'Not provided'}</p>
                </div>
                
                <div class="output-section">
                    <h3>3. Activities</h3>
                    <p>Primary activities conducted at the site:</p>
                    <ul>
                        ${data.activities.map(a => `<li>${a}</li>`).join('')}
                    </ul>
                    <p><strong>Frequency:</strong> ${data.activityFrequency || 'Not specified'}</p>
                </div>
                
                <div class="output-section">
                    <h3>4. Risk Assessment</h3>
                    <p>Identified biosecurity risks:</p>
                    <ul>
                        ${data.risks.map(r => `<li>${r}</li>`).join('')}
                    </ul>
                    
                    ${data.riskScores && data.riskScores.length > 0 ? `
                        <p><strong>Risk Prioritization:</strong></p>
                        <table class="risk-matrix" style="margin: 15px 0;">
                            <thead>
                                <tr>
                                    <th>Risk</th>
                                    <th>Score</th>
                                    <th>Priority</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.riskScores.map(r => `
                                    <tr class="${r.priority === 'High' ? 'high-risk' : ''}">
                                        <td>${r.name}</td>
                                        <td class="risk-score ${r.priority.toLowerCase()}">${r.score}</td>
                                        <td>${r.priority}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    ` : ''}
                    
                    <p><strong>Known Issues:</strong> ${data.knownIssues || 'None reported'}</p>
                </div>
                
                <div class="output-section">
                    <h3>5. Current Controls</h3>
                    <p>Existing biosecurity measures in place:</p>
                    <ul>
                        ${data.controls.length > 0 ? 
                            data.controls.map(c => `<li>${c}</li>`).join('') : 
                            '<li>No existing controls reported</li>'}
                    </ul>
                    
                    <p><strong>Challenges:</strong> ${data.challenges || 'None reported'}</p>
                </div>
                
                <div class="output-section">
                    <h3>6. Proposed Measures</h3>
                    <p>Additional biosecurity measures to be implemented:</p>
                    <ul>
                        ${data.measures.map(m => `<li>${m}</li>`).join('')}
                    </ul>
                    
                    <p><strong>Implementation Plan:</strong></p>
                    <p>${data.implementation || 'Not specified'}</p>
                    
                    <p><strong>Monitoring Approach:</strong></p>
                    <p>${data.monitoring || 'Not specified'}</p>
                    
                    <p><strong>Budget:</strong> ${data.budget || 'Not specified'}</p>
                    <p><strong>Timeline:</strong> ${data.timeline || 'Not specified'}</p>
                </div>
                
                <div class="output-section">
                    <h3>7. Responsibilities</h3>
                    <p>Team members responsible for biosecurity:</p>
                    <ul>
                        ${data.teamMembers && data.teamMembers.length > 0 ? 
                            data.teamMembers.map(m => `<li>${m.name}${m.role ? ` (${m.role})` : ''}</li>`).join('') : 
                            '<li>No team members specified</li>'}
                    </ul>
                </div>
                
                <div class="output-section">
                    <h3>8. Review Process</h3>
                    <p>This plan will be reviewed: ${data.reviewFrequency || 'Not specified'}</p>
                </div>
                
                <div class="output-section">
                    <p><em>Plan generated by ${data.primaryContact} on ${new Date().toLocaleDateString()}</em></p>
                </div>
            `;
        }
        
        function generateCertifiedPlan(data) {
            return `
                <div style="text-align: center; margin-bottom: 30px;">
                    <h2>${data.orgName}</h2>
                    <h1>${data.planName}</h1>
                    <p>Biosecurity Management Plan</p>
                </div>
                
                <div class="output-section">
                    <h3>Document Control</h3>
                    <table style="width: 100%; border-collapse: collapse;">
                        <tr>
                            <td style="padding: 8px; border: 1px solid #ddd; width: 30%;"><strong>Document Title:</strong></td>
                            <td style="padding: 8px; border: 1px solid #ddd;">${data.planName}</td>
                        </tr>
                        <tr>
                            <td style="padding: 8px; border: 1px solid #ddd;"><strong>Prepared By:</strong></td>
                            <td style="padding: 8px; border: 1px solid #ddd;">${data.primaryContact}</td>
                        </tr>
                        <tr>
                            <td style="padding: 8px; border: 1px solid #ddd;"><strong>Date Prepared:</strong></td>
                            <td style="padding: 8px; border: 1px solid #ddd;">${new Date().toLocaleDateString()}</td>
                        </tr>
                        <tr>
                            <td style="padding: 8px; border: 1px solid #ddd;"><strong>Review Frequency:</strong></td>
                            <td style="padding: 8px; border: 1px solid #ddd;">${data.reviewFrequency || 'Not specified'}</td>
                        </tr>
                        <tr>
                            <td style="padding: 8px; border: 1px solid #ddd;"><strong>Version:</strong></td>
                            <td style="padding: 8px; border: 1px solid #ddd;">1.0</td>
                        </tr>
                    </table>
                </div>
                
                <div class="output-section">
                    <h3>1. Introduction</h3>
                    <p>This Biosecurity Management Plan has been developed to identify, assess, and manage biosecurity risks associated with operations at ${data.projectName}. The plan outlines the procedures and controls to prevent the introduction and spread of pests, diseases, and other biological threats.</p>
                    
                    <h4>1.1 Scope</h4>
                    <p>This plan applies to all activities conducted by ${data.orgName} at ${data.projectLocation}, including but not limited to:</p>
                    <ul>
                        ${data.activities.map(a => `<li>${a}</li>`).join('')}
                    </ul>
                    
                    <h4>1.2 Objectives</h4>
                    <ul>
                        <li>Identify potential biosecurity risks</li>
                        <li>Implement appropriate control measures</li>
                        <li>Monitor and review biosecurity effectiveness</li>
                        <li>Ensure compliance with relevant regulations</li>
                    </ul>
                </div>
                
                <div class="output-section">
                    <h3>2. Site Description</h3>
                    <table style="width: 100%; border-collapse: collapse; margin-bottom: 15px;">
                        <tr>
                            <td style="padding: 8px; border: 1px solid #ddd; width: 30%;"><strong>Site Name:</strong></td>
                            <td style="padding: 8px; border: 1px solid #ddd;">${data.projectName}</td>
                        </tr>
                        <tr>
                            <td style="padding: 8px; border: 1px solid #ddd;"><strong>Location:</strong></td>
                            <td style="padding: 8px; border: 1px solid #ddd;">${data.projectLocation}</td>
                        </tr>
                        <tr>
                            <td style="padding: 8px; border: 1px solid #ddd;"><strong>Size:</strong></td>
                            <td style="padding: 8px; border: 1px solid #ddd;">${data.projectSize || 'Not specified'} ${data.sizeUnit || 'hectares'}</td>
                        </tr>
                    </table>
                    <p><strong>Description:</strong> ${data.projectDescription || 'Not provided'}</p>
                </div>
                
                <div class="output-section">
                    <h3>3. Risk Assessment</h3>
                    <h4>3.1 Identified Risks</h4>
                    <p>The following biosecurity risks have been identified:</p>
                    <ul>
                        ${data.risks.map(r => `<li>${r}</li>`).join('')}
                    </ul>
                    
                    ${data.riskScores && data.riskScores.length > 0 ? `
                        <h4>3.2 Risk Evaluation</h4>
                        <p>Risks have been evaluated based on likelihood and potential impact:</p>
                        <table class="risk-matrix" style="margin: 15px 0;">
                            <thead>
                                <tr>
                                    <th>Risk</th>
                                    <th>Likelihood</th>
                                    <th>Impact</th>
                                    <th>Score</th>
                                    <th>Priority</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.riskScores.map(r => `
                                    <tr class="${r.priority === 'High' ? 'high-risk' : ''}">
                                        <td>${r.name}</td>
                                        <td>${getLikelihoodText(r.likelihood)}</td>
                                        <td>${getImpactText(r.impact)}</td>
                                        <td class="risk-score ${r.priority.toLowerCase()}">${r.score}</td>
                                        <td>${r.priority}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                        
                        <div class="chart-container" style="height: 400px;">
                            <canvas id="pdfRiskChart"></canvas>
                        </div>
                    ` : ''}
                    
                    <h4>3.3 Known Issues</h4>
                    <p>${data.knownIssues || 'No known biosecurity issues reported in the area.'}</p>
                </div>
                
                <div class="output-section">
                    <h3>4. Control Measures</h3>
                    <h4>4.1 Existing Controls</h4>
                    <p>The following biosecurity measures are currently in place:</p>
                    <ul>
                        ${data.controls.length > 0 ? 
                            data.controls.map(c => `<li>${c}</li>`).join('') : 
                            '<li>No existing controls reported</li>'}
                    </ul>
                    
                    <h4>4.2 Additional Measures</h4>
                    <p>The following additional biosecurity measures will be implemented:</p>
                    <ul>
                        ${data.measures.map(m => `<li>${m}</li>`).join('')}
                    </ul>
                    
                    <h4>4.3 Implementation Plan</h4>
                    <p>${data.implementation || 'Implementation details to be determined.'}</p>
                    
                    <h4>4.4 Monitoring Procedures</h4>
                    <p>${data.monitoring || 'Monitoring procedures to be determined.'}</p>
                </div>
                
                <div class="output-section">
                    <h3>5. Responsibilities</h3>
                    <p>The following personnel are responsible for implementing and maintaining biosecurity measures:</p>
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr>
                                <th style="padding: 8px; border: 1px solid #ddd;">Name</th>
                                <th style="padding: 8px; border: 1px solid #ddd;">Role</th>
                                <th style="padding: 8px; border: 1px solid #ddd;">Responsibilities</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.teamMembers && data.teamMembers.length > 0 ? 
                                data.teamMembers.map(m => `
                                    <tr>
                                        <td style="padding: 8px; border: 1px solid #ddd;">${m.name}</td>
                                        <td style="padding: 8px; border: 1px solid #ddd;">${m.role || '-'}</td>
                                        <td style="padding: 8px; border: 1px solid #ddd;">Implementation and monitoring of biosecurity measures</td>
                                    </tr>
                                `).join('') : `
                                <tr>
                                    <td colspan="3" style="padding: 8px; border: 1px solid #ddd; text-align: center;">No team members specified</td>
                                </tr>
                                `}
                        </tbody>
                    </table>
                </div>
                
                <div class="output-section">
                    <h3>6. Review Process</h3>
                    <p>This biosecurity plan will be reviewed ${data.reviewFrequency || 'periodically'} to ensure its continued effectiveness. The review will consider:</p>
                    <ul>
                        <li>Any biosecurity incidents that have occurred</li>
                        <li>Changes to operations or activities</li>
                        <li>Newly identified risks</li>
                        <li>Effectiveness of current controls</li>
                    </ul>
                </div>
                
                <div class="output-section">
                    <h3>7. Approval</h3>
                    <p>This biosecurity plan has been approved by:</p>
                    <div style="margin-top: 50px;">
                        <p>___________________________</p>
                        <p>Name: ${data.primaryContact}</p>
                        <p>Position: </p>
                        <p>Date: ${new Date().toLocaleDateString()}</p>
                    </div>
                </div>
                
                <script>
                    // This script will be executed when the PDF is generated
                    function generatePDFChart() {
                        const ctx = document.getElementById('pdfRiskChart').getContext('2d');
                        const risks = ${JSON.stringify(data.riskScores || [])};
                        
                        if (risks.length > 0) {
                            new Chart(ctx, {
                                type: 'bar',
                                data: {
                                    labels: risks.map(r => r.name),
                                    datasets: [{
                                        label: 'Risk Score',
                                        data: risks.map(r => r.score),
                                        backgroundColor: risks.map(r => 
                                            r.priority === 'High' ? 'rgba(198, 40, 40, 0.7)' :
                                            r.priority === 'Medium' ? 'rgba(255, 143, 0, 0.7)' :
                                            'rgba(46, 125, 50, 0.7)'),
                                        borderColor: risks.map(r => 
                                            r.priority === 'High' ? 'rgba(198, 40, 40, 1)' :
                                            r.priority === 'Medium' ? 'rgba(255, 143, 0, 1)' :
                                            'rgba(46, 125, 50, 1)'),
                                        borderWidth: 1
                                    }]
                                },
                                options: {
                                    responsive: true,
                                    maintainAspectRatio: false,
                                    scales: {
                                        y: {
                                            beginAtZero: true,
                                            max: 9,
                                            title: {
                                                display: true,
                                                text: 'Risk Score'
                                            }
                                        },
                                        x: {
                                            title: {
                                                display: true,
                                                text: 'Identified Risks'
                                            }
                                        }
                                    },
                                    plugins: {
                                        tooltip: {
                                            callbacks: {
                                                label: function(context) {
                                                    return \`Score: \${context.raw} (\${risks[context.dataIndex].priority} priority)\`;
                                                }
                                            }
                                        },
                                        legend: {
                                            display: false
                                        }
                                    }
                                }
                            });
                        }
                    }
                    
                    // Generate the chart when the page loads
                    window.addEventListener('load', generatePDFChart);
                <\/script>
            `;
        }
        
        function getLikelihoodText(value) {
            switch(value) {
                case '1': return 'Low';
                case '2': return 'Medium';
                case '3': return 'High';
                default: return 'Unknown';
            }
        }
        
        function getImpactText(value) {
            switch(value) {
                case '1': return 'Low';
                case '2': return 'Medium';
                case '3': return 'High';
                default: return 'Unknown';
            }
        }
        
        function savePDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({
                orientation: 'portrait',
                unit: 'mm',
                format: 'a4'
            });
            
            // Add title
            doc.setFontSize(16);
            doc.setTextColor(46, 125, 50);
            doc.text(document.getElementById('output-title').textContent, 105, 20, { align: 'center' });
            
            // Add organization name if available
            const orgName = document.getElementById('org-name').value;
            if (orgName) {
                doc.setFontSize(12);
                doc.setTextColor(0, 0, 0);
                doc.text(orgName, 105, 27, { align: 'center' });
            }
            
            // Add date
            doc.setFontSize(10);
            doc.text(`Generated on ${new Date().toLocaleDateString()}`, 105, 34, { align: 'center' });
            
            // Add content
            const content = document.getElementById('output-content');
            
            // Special handling for certification-ready template
            const template = document.getElementById('template').value;
            if (template === 'certified') {
                // Add page numbers
                const pageCount = doc.internal.getNumberOfPages();
                for(let i = 1; i <= pageCount; i++) {
                    doc.setPage(i);
                    doc.setFontSize(8);
                    doc.setTextColor(150);
                    doc.text(`Page ${i} of ${pageCount}`, 105, 287, { align: 'center' });
                }
            }
            
            html2canvas(content, {
                scale: 2,
                logging: false,
                useCORS: true,
                allowTaint: true,
                scrollY: -window.scrollY
            }).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const imgWidth = doc.internal.pageSize.getWidth() - 20;
                const pageHeight = doc.internal.pageSize.getHeight();
                const imgHeight = canvas.height * imgWidth / canvas.width;
                let heightLeft = imgHeight;
                let position = 40;
                
                doc.addImage(imgData, 'PNG', 10, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;
                
                while (heightLeft >= 0) {
                    position = heightLeft - imgHeight;
                    doc.addPage();
                    doc.addImage(imgData, 'PNG', 10, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                }
                
                doc.save(`${document.getElementById('output-title').textContent}.pdf`);
            });
            return false;
        }
        
        function sharePlan(method) {
            switch(method) {
                case 'email':
                    const email = document.getElementById('contact-email').value || '';
                    const subject = encodeURIComponent(document.getElementById('plan-name').value);
                    const body = encodeURIComponent(`Please find attached the biosecurity plan for ${document.getElementById('project-name').value}.`);
                    window.location.href = `mailto:${email}?subject=${subject}&body=${body}`;
                    break;
                    
                case 'link':
                    saveProgress();
                    const data = localStorage.getItem('biosecurityPlanData');
                    const planName = encodeURIComponent(document.getElementById('plan-name').value);
                    // In a real implementation, you would upload to a server and get a shareable URL
                    alert('In a complete implementation, this would generate a shareable link to your plan. For now, you can save the PDF to share.');
                    break;
            }
            return false;
        }
        
        function resetForm() {
            if (confirm('Are you sure you want to start a new plan? Your current data will be cleared.')) {
                localStorage.removeItem('biosecurityPlanData');
                document.querySelectorAll('input, textarea, select').forEach(el => {
                    if (el.type !== 'button' && el.type !== 'submit') {
                        el.value = '';
                    }
                    if (el.type === 'checkbox' || el.type === 'radio') {
                        el.checked = false;
                    }
                });
                
                // Reset industry selection
                document.querySelectorAll('.industry-card').forEach(card => {
                    card.classList.remove('selected');
                });
                document.getElementById('industry-card-conservation').classList.add('selected');
                document.getElementById('industry').value = 'conservation';
                document.getElementById('industry-other-text').style.display = 'none';
                document.getElementById('industry-other-text').value = '';
                
                // Reset template selection
                document.querySelectorAll('.template-card').forEach(card => {
                    card.classList.remove('selected');
                });
                document.getElementById('template-basic').classList.add('selected');
                document.getElementById('template').value = 'basic';
                
                // Reset team members
                document.getElementById('team-members').innerHTML = `
                    <div class="team-member">
                        <input type="text" placeholder="Name" class="team-name">
                        <input type="text" placeholder="Role" class="team-role">
                        <button type="button" onclick="removeTeamMember(this)" class="btn-danger">Remove</button>
                    </div>
                `;
                
                // Reset custom fields
                customActivities = [];
                customRisks = [];
                customControls = [];
                customMeasures = [];
                
                document.getElementById('plan-output').style.display = 'none';
                document.querySelector('.wizard-container').style.display = 'block';
                currentStep = 0;
                document.querySelectorAll('.step').forEach((step, index) => {
                    step.classList.toggle('active', index === 0);
                });
                updateStepIndicator();
                updateSidebarNavigation();
                updateSidebarProgress();
            }
            return false;
        }
    </script>
</body>
</html>
