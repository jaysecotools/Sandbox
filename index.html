<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Native Ecosystem Maintenance Tool | AHCECR301 Compliance</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css">
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""/>
    <style>
        /* ... (existing styles remain the same) ... */
        
        /* New styles for project management */
        .project-card {
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .project-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        .map-drawing-tools {
            position: absolute;
            bottom: 10px;
            left: 10px;
            z-index: 1000;
            background: white;
            padding: 10px;
            border-radius: 4px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .area-list {
            max-height: 300px;
            overflow-y: auto;
        }
        .area-item {
            border-left: 3px solid transparent;
            transition: all 0.2s ease;
        }
        .area-item:hover {
            background-color: #f8f9fa;
            border-left-color: #007bff;
        }
        .area-item.active {
            background-color: #e9ecef;
            border-left-color: #0d6efd;
        }
    </style>
</head>
<body>
    <!-- Toast container (unchanged) -->
    <div class="toast-container">
        <!-- ... -->
    </div>

    <!-- Project Selection Modal (NEW) -->
    <div class="modal fade" id="projectSelectionModal" tabindex="-1" aria-labelledby="projectSelectionModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="projectSelectionModalLabel">Select Project</h5>
                </div>
                <div class="modal-body">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h5>Your Projects</h5>
                        <button type="button" class="btn btn-success" id="createNewProjectBtn">
                            <i class="bi bi-plus-circle"></i> New Project
                        </button>
                    </div>
                    
                    <div class="row" id="projectsContainer">
                        <!-- Projects will be loaded here -->
                    </div>
                    
                    <div class="mt-4">
                        <h5>Import Project</h5>
                        <div class="input-group">
                            <input type="file" class="form-control" id="importProjectFile" accept=".json">
                            <button class="btn btn-outline-secondary" type="button" id="importProjectBtn">Import</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- New Project Modal (NEW) -->
    <div class="modal fade" id="newProjectModal" tabindex="-1" aria-labelledby="newProjectModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="newProjectModalLabel">Create New Project</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="newProjectForm">
                        <div class="mb-3">
                            <label for="projectName" class="form-label">Project Name *</label>
                            <input type="text" class="form-control" id="projectName" required>
                        </div>
                        <div class="mb-3">
                            <label for="projectDescription" class="form-label">Description</label>
                            <textarea class="form-control" id="projectDescription" rows="3"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="projectLocation" class="form-label">Location</label>
                            <input type="text" class="form-control" id="projectLocation">
                        </div>
                        <div class="mb-3">
                            <label for="projectArea" class="form-label">Area (hectares)</label>
                            <input type="number" class="form-control" id="projectArea" min="0" step="0.1">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveNewProjectBtn">Create Project</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main container (unchanged structure) -->
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar (unchanged) -->
            <div class="col-md-3 col-lg-2 sidebar p-0">
                <!-- ... -->
            </div>

            <!-- Main Content -->
            <div class="col-md-9 col-lg-10 ms-sm-auto main-content">
                <!-- Project Header (NEW) -->
                <div class="d-flex justify-content-between align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <div>
                        <h1 class="h2" id="currentProjectName">Native Ecosystem Maintenance Dashboard</h1>
                        <p class="text-muted mb-0" id="currentProjectDescription"></p>
                    </div>
                    <div class="btn-toolbar">
                        <div class="btn-group me-2">
                            <button type="button" class="btn btn-sm btn-outline-primary" id="exportProjectBtn">
                                <i class="bi bi-download"></i> Export
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" id="manageProjectsBtn">
                                <i class="bi bi-folder2-open"></i> Projects
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Tab content (unchanged structure) -->
                <div class="tab-content">
                    <!-- Dashboard Tab (enhanced with project context) -->
                    <div class="tab-pane fade show active" id="dashboard">
                        <!-- ... (existing content) ... -->
                        
                        <!-- Enhanced Map Section with Drawing Tools -->
                        <div class="row mt-4">
                            <div class="col-md-8">
                                <div class="card">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-center mb-3">
                                            <h5 class="card-title mb-0">Site Map</h5>
                                            <div class="btn-group">
                                                <button type="button" class="btn btn-sm btn-outline-success" id="addAreaBtn">
                                                    <i class="bi bi-pencil-square"></i> Define Area
                                                </button>
                                                <button type="button" class="btn btn-sm btn-outline-info" id="manageAreasBtn">
                                                    <i class="bi bi-list-ul"></i> Manage Areas
                                                </button>
                                            </div>
                                        </div>
                                        <div class="map-container p-3 position-relative">
                                            <div id="map"></div>
                                            <div class="map-controls">
                                                <div class="btn-group-vertical">
                                                    <button id="zoneToggle" class="btn btn-sm btn-outline-primary active">Zones</button>
                                                    <button id="vegetationToggle" class="btn btn-sm btn-outline-success">Vegetation</button>
                                                    <button id="weedsToggle" class="btn btn-sm btn-outline-danger">Weeds</button>
                                                </div>
                                            </div>
                                            <div class="map-drawing-tools" id="drawingTools" style="display: none;">
                                                <div class="btn-group btn-group-sm mb-2">
                                                    <button type="button" class="btn btn-outline-primary" id="drawRectangleBtn">
                                                        <i class="bi bi-square"></i> Rectangle
                                                    </button>
                                                    <button type="button" class="btn btn-outline-primary" id="drawPolygonBtn">
                                                        <i class="bi bi-pentagon"></i> Polygon
                                                    </button>
                                                    <button type="button" class="btn btn-outline-primary" id="drawCircleBtn">
                                                        <i class="bi bi-circle"></i> Circle
                                                    </button>
                                                </div>
                                                <div class="d-grid gap-2">
                                                    <button type="button" class="btn btn-success btn-sm" id="saveAreaBtn">
                                                        <i class="bi bi-check-lg"></i> Save Area
                                                    </button>
                                                    <button type="button" class="btn btn-secondary btn-sm" id="cancelDrawingBtn">
                                                        <i class="bi bi-x-lg"></i> Cancel
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <!-- Areas List Panel (NEW) -->
                                <div class="card">
                                    <div class="card-body">
                                        <h5 class="card-title">Managed Areas</h5>
                                        <div class="area-list" id="areasList">
                                            <!-- Areas will be loaded here -->
                                        </div>
                                        <button class="btn btn-sm btn-outline-primary mt-3 w-100" id="addNewAreaBtn">
                                            <i class="bi bi-plus"></i> Add New Area
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Other tabs (unchanged) -->
                    <!-- ... -->
                </div>
            </div>
        </div>
    </div>

    <!-- Existing Modals (unchanged) -->
    <!-- ... -->

    <!-- New Area Modal (NEW) -->
    <div class="modal fade" id="areaDetailsModal" tabindex="-1" aria-labelledby="areaDetailsModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="areaDetailsModalLabel">Area Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="areaDetailsForm">
                        <div class="mb-3">
                            <label for="areaName" class="form-label">Area Name *</label>
                            <input type="text" class="form-control" id="areaName" required>
                        </div>
                        <div class="mb-3">
                            <label for="areaType" class="form-label">Area Type *</label>
                            <select class="form-select" id="areaType" required>
                                <option value="">Select type...</option>
                                <option value="conservation">Conservation Zone</option>
                                <option value="restoration">Restoration Area</option>
                                <option value="monitoring">Monitoring Plot</option>
                                <option value="research">Research Area</option>
                                <option value="buffer">Buffer Zone</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="areaDescription" class="form-label">Description</label>
                            <textarea class="form-control" id="areaDescription" rows="3"></textarea>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="areaSize" class="form-label">Size (hectares)</label>
                                    <input type="number" class="form-control" id="areaSize" min="0" step="0.01">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="areaColor" class="form-label">Display Color</label>
                                    <input type="color" class="form-control form-control-color" id="areaColor" value="#3d8bfd">
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger me-auto" id="deleteAreaBtn">Delete</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveAreaDetailsBtn">Save</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>
    <!-- Leaflet Drawing Plugins -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />
    
    <script>
        // Enhanced data storage with project management
        const app = {
            currentProject: null,
            projects: JSON.parse(localStorage.getItem('ecoProjects')) || {},
            drawingMode: false,
            drawnItems: new L.FeatureGroup(),
            drawControl: null,
            
            init: function() {
                // Initialize the application
                this.showProjectSelection();
                this.setupEventListeners();
                
                // If there are projects, automatically select the first one
                const projectKeys = Object.keys(this.projects);
                if (projectKeys.length > 0) {
                    this.loadProject(projectKeys[0]);
                    bootstrap.Modal.getInstance(document.getElementById('projectSelectionModal')).hide();
                }
            },
            
            showProjectSelection: function() {
                const projectsContainer = document.getElementById('projectsContainer');
                projectsContainer.innerHTML = '';
                
                const projectKeys = Object.keys(this.projects);
                
                if (projectKeys.length === 0) {
                    projectsContainer.innerHTML = `
                        <div class="col-12 text-center py-5">
                            <i class="bi bi-folder-x display-1 text-muted"></i>
                            <p class="mt-3">No projects found. Create your first project to get started.</p>
                        </div>
                    `;
                } else {
                    projectKeys.forEach(projectId => {
                        const project = this.projects[projectId];
                        const projectCard = document.createElement('div');
                        projectCard.className = 'col-md-6 col-lg-4 mb-3';
                        projectCard.innerHTML = `
                            <div class="card project-card h-100" data-project-id="${projectId}">
                                <div class="card-body">
                                    <h5 class="card-title">${project.name}</h5>
                                    <p class="card-text text-muted">${project.description || 'No description'}</p>
                                    <div class="d-flex justify-content-between align-items-center">
                                        <small class="text-muted">${project.areas ? Object.keys(project.areas).length : 0} areas</small>
                                        <small class="text-muted">${this.formatDate(project.createdAt)}</small>
                                    </div>
                                </div>
                            </div>
                        `;
                        projectsContainer.appendChild(projectCard);
                    });
                }
                
                // Show the project selection modal
                new bootstrap.Modal(document.getElementById('projectSelectionModal')).show();
            },
            
            loadProject: function(projectId) {
                this.currentProject = this.projects[projectId];
                
                // Update UI with project info
                document.getElementById('currentProjectName').textContent = this.currentProject.name;
                document.getElementById('currentProjectDescription').textContent = this.currentProject.description || '';
                
                // Initialize map and other components
                this.initMap();
                this.initCharts();
                this.initCalendar();
                this.loadAreasList();
                this.loadDashboard();
                this.loadAssessments();
                this.loadSpecies();
                this.loadActivities();
                this.loadMonitoring();
                this.loadReports();
                this.loadComplianceChecklist();
                this.loadSettings();
            },
            
            initMap: function() {
                // Initialize the map with project location if available
                const defaultCoords = [-33.4000, 150.3000]; // Blue Mountains
                const coords = this.currentProject.locationCoords || defaultCoords;
                
                window.map = L.map('map').setView(coords, 13);
                
                // Add OpenStreetMap tiles
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                }).addTo(window.map);
                
                // Initialize drawing controls
                this.initDrawingTools();
                
                // Load project areas if any
                this.loadProjectAreas();
            },
            
            initDrawingTools: function() {
                // Remove existing draw control if any
                if (this.drawControl) {
                    window.map.removeControl(this.drawControl);
                }
                
                // Initialize feature group to store drawn items
                this.drawnItems = new L.FeatureGroup();
                window.map.addLayer(this.drawnItems);
                
                // Initialize draw control
                this.drawControl = new L.Control.Draw({
                    position: 'topright',
                    draw: {
                        polygon: {
                            shapeOptions: {
                                color: '#3d8bfd'
                            },
                            allowIntersection: false,
                            drawError: {
                                color: '#dc3545',
                                message: '<strong>Error:</strong> shape edges cannot cross!'
                            },
                            showArea: true,
                            metric: true
                        },
                        polyline: false,
                        circle: {
                            shapeOptions: {
                                color: '#3d8bfd'
                            }
                        },
                        rectangle: {
                            shapeOptions: {
                                color: '#3d8bfd'
                            }
                        },
                        marker: false,
                        circlemarker: false
                    },
                    edit: {
                        featureGroup: this.drawnItems
                    }
                });
                
                // Add draw control to map but hide it initially
                // We'll show it only when in drawing mode
                
                // Event listeners for drawing
                window.map.on(L.Draw.Event.CREATED, (e) => {
                    const type = e.layerType;
                    const layer = e.layer;
                    
                    // Add style to the drawn layer
                    if (type === 'polygon' || type === 'rectangle') {
                        layer.setStyle({
                            color: '#3d8bfd',
                            fillColor: '#3d8bfd',
                            fillOpacity: 0.2,
                            weight: 2
                        });
                    } else if (type === 'circle') {
                        layer.setStyle({
                            color: '#3d8bfd',
                            fillColor: '#3d8bfd',
                            fillOpacity: 0.2,
                            weight: 2
                        });
                    }
                    
                    this.drawnItems.addLayer(layer);
                    
                    // Show the area details modal
                    this.showAreaDetailsModal(layer);
                });
            },
            
            loadProjectAreas: function() {
                // Clear existing areas
                if (this.currentProject.areas) {
                    Object.values(this.currentProject.areas).forEach(area => {
                        this.addAreaToMap(area);
                    });
                }
            },
            
            addAreaToMap: function(area) {
                let layer;
                
                if (area.type === 'polygon') {
                    layer = L.polygon(area.coords, {
                        color: area.color || '#3d8bfd',
                        fillColor: area.color || '#3d8bfd',
                        fillOpacity: 0.3,
                        weight: 2
                    });
                } else if (area.type === 'rectangle') {
                    layer = L.rectangle(area.coords, {
                        color: area.color || '#3d8bfd',
                        fillColor: area.color || '#3d8bfd',
                        fillOpacity: 0.3,
                        weight: 2
                    });
                } else if (area.type === 'circle') {
                    layer = L.circle(area.coords[0], {
                        radius: area.radius,
                        color: area.color || '#3d8bfd',
                        fillColor: area.color || '#3d8bfd',
                        fillOpacity: 0.3,
                        weight: 2
                    });
                }
                
                if (layer) {
                    layer.addTo(window.map);
                    layer.areaId = area.id;
                    layer.bindPopup(`
                        <strong>${area.name}</strong><br>
                        Type: ${area.areaType}<br>
                        Size: ${area.size || 'N/A'} hectares
                    `);
                }
            },
            
            showAreaDetailsModal: function(layer) {
                // Calculate area in hectares (simplified)
                let areaSize = 0;
                if (layer instanceof L.Polygon || layer instanceof L.Rectangle) {
                    areaSize = (L.GeometryUtil.geodesicArea(layer.getLatLngs()[0]) / 10000).toFixed(2);
                } else if (layer instanceof L.Circle) {
                    areaSize = (Math.PI * Math.pow(layer.getRadius(), 2) / 10000).toFixed(2);
                }
                
                document.getElementById('areaSize').value = areaSize;
                
                const modal = new bootstrap.Modal(document.getElementById('areaDetailsModal'));
                modal.show();
                
                // Set up save button
                document.getElementById('saveAreaDetailsBtn').onclick = () => {
                    this.saveArea(layer);
                    modal.hide();
                };
                
                // Set up cancel button
                document.getElementById('cancelDrawingBtn').onclick = () => {
                    window.map.removeLayer(layer);
                    this.hideDrawingTools();
                    modal.hide();
                };
            },
            
            saveArea: function(layer) {
                const areaName = document.getElementById('areaName').value;
                const areaType = document.getElementById('areaType').value;
                const areaDescription = document.getElementById('areaDescription').value;
                const areaSize = document.getElementById('areaSize').value;
                const areaColor = document.getElementById('areaColor').value;
                
                if (!areaName || !areaType) {
                    showToast('Error', 'Please provide a name and type for the area.', 'error');
                    return;
                }
                
                // Create area object
                const areaId = Date.now().toString();
                const area = {
                    id: areaId,
                    name: areaName,
                    areaType: areaType,
                    description: areaDescription,
                    size: parseFloat(areaSize),
                    color: areaColor,
                    createdAt: new Date().toISOString()
                };
                
                // Extract coordinates based on layer type
                if (layer instanceof L.Polygon || layer instanceof L.Rectangle) {
                    area.type = layer instanceof L.Polygon ? 'polygon' : 'rectangle';
                    area.coords = layer.getLatLngs()[0].map(latlng => [latlng.lat, latlng.lng]);
                } else if (layer instanceof L.Circle) {
                    area.type = 'circle';
                    area.coords = [layer.getLatLng().lat, layer.getLatLng().lng];
                    area.radius = layer.getRadius();
                }
                
                // Initialize areas object if it doesn't exist
                if (!this.currentProject.areas) {
                    this.currentProject.areas = {};
                }
                
                // Save area to project
                this.currentProject.areas[areaId] = area;
                
                // Update the layer with the area ID
                layer.areaId = areaId;
                
                // Style the layer with the chosen color
                layer.setStyle({
                    color: areaColor,
                    fillColor: areaColor,
                    fillOpacity: 0.3,
                    weight: 2
                });
                
                // Update the popup content
                layer.bindPopup(`
                    <strong>${area.name}</strong><br>
                    Type: ${area.areaType}<br>
                    Size: ${area.size || 'N/A'} hectares
                `);
                
                // Save the project
                this.saveProjects();
                
                // Update areas list
                this.loadAreasList();
                
                // Hide drawing tools
                this.hideDrawingTools();
                
                showToast('Success', 'Area saved successfully!');
            },
            
            loadAreasList: function() {
                const areasList = document.getElementById('areasList');
                areasList.innerHTML = '';
                
                if (!this.currentProject.areas || Object.keys(this.currentProject.areas).length === 0) {
                    areasList.innerHTML = '<div class="text-center text-muted py-3">No areas defined yet</div>';
                    return;
                }
                
                Object.values(this.currentProject.areas).forEach(area => {
                    const areaItem = document.createElement('div');
                    areaItem.className = 'area-item p-3 border-bottom';
                    areaItem.innerHTML = `
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-0">${area.name}</h6>
                                <small class="text-muted">${area.areaType} â€¢ ${area.size || 'N/A'} ha</small>
                            </div>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-primary view-area-btn" data-area-id="${area.id}">
                                    <i class="bi bi-eye"></i>
                                </button>
                                <button class="btn btn-outline-secondary edit-area-btn" data-area-id="${area.id}">
                                    <i class="bi bi-pencil"></i>
                                </button>
                            </div>
                        </div>
                    `;
                    areasList.appendChild(areaItem);
                });
            },
            
            showDrawingTools: function() {
                document.getElementById('drawingTools').style.display = 'block';
                window.map.addControl(this.drawControl);
                this.drawingMode = true;
            },
            
            hideDrawingTools: function() {
                document.getElementById('drawingTools').style.display = 'none';
                window.map.removeControl(this.drawControl);
                this.drawingMode = false;
            },
            
            createNewProject: function() {
                const projectName = document.getElementById('projectName').value;
                const projectDescription = document.getElementById('projectDescription').value;
                const projectLocation = document.getElementById('projectLocation').value;
                const projectArea = document.getElementById('projectArea').value;
                
                if (!projectName) {
                    showToast('Error', 'Please provide a project name.', 'error');
                    return;
                }
                
                const projectId = Date.now().toString();
                const project = {
                    id: projectId,
                    name: projectName,
                    description: projectDescription,
                    location: projectLocation,
                    area: projectArea ? parseFloat(projectArea) : null,
                    createdAt: new Date().toISOString(),
                    // Initialize empty data structures
                    assessments: [],
                    species: [],
                    activities: [],
                    monitoring: [],
                    reports: [],
                    complianceChecklist: [
                        { id: 1, requirement: "Identified all relevant legislation", compliant: "", evidence: "", notes: "" },
                        { id: 2, requirement: "Assessed impacts on protected matters", compliant: "", evidence: "", notes: "" },
                        { id: 3, requirement: "Obtained necessary permits/approvals", compliant: "", evidence: "", notes: "" },
                        { id: 4, requirement: "Implemented required protections", compliant: "", evidence: "", notes: "" },
                        { id: 5, requirement: "Maintained required records", compliant: "", evidence: "", notes: "" }
                    ],
                    settings: {
                        siteName: projectName,
                        siteLocation: projectLocation,
                        siteArea: projectArea,
                        siteDescription: projectDescription,
                        userProfile: {
                            name: "User",
                            email: "",
                            role: "ecologist"
                        }
                    }
                };
                
                // Save project
                this.projects[projectId] = project;
                this.saveProjects();
                
                // Load the new project
                this.loadProject(projectId);
                
                // Close the modal
                bootstrap.Modal.getInstance(document.getElementById('newProjectModal')).hide();
                
                showToast('Success', 'Project created successfully!');
            },
            
            exportProject: function() {
                if (!this.currentProject) return;
                
                const projectData = JSON.stringify(this.currentProject, null, 2);
                const blob = new Blob([projectData], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = `${this.currentProject.name.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showToast('Success', 'Project exported successfully!');
            },
            
            importProject: function(file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const projectData = JSON.parse(e.target.result);
                        
                        // Validate project structure
                        if (!projectData.id || !projectData.name) {
                            throw new Error('Invalid project file format');
                        }
                        
                        // Use the existing ID or create a new one
                        const projectId = projectData.id || Date.now().toString();
                        this.projects[projectId] = projectData;
                        this.saveProjects();
                        
                        // Load the imported project
                        this.loadProject(projectId);
                        
                        // Close the project selection modal
                        bootstrap.Modal.getInstance(document.getElementById('projectSelectionModal')).hide();
                        
                        showToast('Success', 'Project imported successfully!');
                    } catch (error) {
                        console.error('Error importing project:', error);
                        showToast('Error', 'Failed to import project. Invalid file format.', 'error');
                    }
                };
                reader.readAsText(file);
            },
            
            saveProjects: function() {
                localStorage.setItem('ecoProjects', JSON.stringify(this.projects));
            },
            
            formatDate: function(dateString) {
                if (!dateString) return 'Unknown';
                const options = { year: 'numeric', month: 'short', day: 'numeric' };
                return new Date(dateString).toLocaleDateString(undefined, options);
            },
            
            setupEventListeners: function() {
                // Project selection
                document.getElementById('createNewProjectBtn').addEventListener('click', () => {
                    bootstrap.Modal.getInstance(document.getElementById('projectSelectionModal')).hide();
                    new bootstrap.Modal(document.getElementById('newProjectModal')).show();
                });
                
                document.getElementById('saveNewProjectBtn').addEventListener('click', () => {
                    this.createNewProject();
                });
                
                document.querySelectorAll('.project-card').forEach(card => {
                    card.addEventListener('click', (e) => {
                        const projectId = e.currentTarget.getAttribute('data-project-id');
                        this.loadProject(projectId);
                        bootstrap.Modal.getInstance(document.getElementById('projectSelectionModal')).hide();
                    });
                });
                
                document.getElementById('manageProjectsBtn').addEventListener('click', () => {
                    this.showProjectSelection();
                });
                
                document.getElementById('exportProjectBtn').addEventListener('click', () => {
                    this.exportProject();
                });
                
                document.getElementById('importProjectBtn').addEventListener('click', () => {
                    const fileInput = document.getElementById('importProjectFile');
                    if (fileInput.files.length > 0) {
                        this.importProject(fileInput.files[0]);
                    } else {
                        showToast('Error', 'Please select a project file to import.', 'error');
                    }
                });
                
                // Map drawing tools
                document.getElementById('addAreaBtn').addEventListener('click', () => {
                    this.showDrawingTools();
                });
                
                document.getElementById('cancelDrawingBtn').addEventListener('click', () => {
                    this.drawnItems.clearLayers();
                    this.hideDrawingTools();
                });
                
                document.getElementById('addNewAreaBtn').addEventListener('click', () => {
                    this.showDrawingTools();
                });
            },
            
            // The rest of your existing functions (initCharts, initCalendar, loadDashboard, etc.)
            // would be included here but are omitted for brevity
            // ...
        };

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            app.init();
        });

        // Your existing helper functions and data initialization
        // would be included here but are omitted for brevity
        // ...
    </script>
</body>
</html>
