<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="Native Ecosystem Maintenance Tool for AHCECR301 Compliance" />
  <title>Native Ecosystem Maintenance Tool | AHCECR301 Compliance</title>
  
  <!-- Favicon -->
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸŒ±</text></svg>">
  
  <!-- CSS Dependencies -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css" />
  
  <style>
    :root {
      --primary-color: #2c3e50;
      --secondary-color: #34495e;
      --accent-color: #3498db;
      --success-color: #28a745;
      --danger-color: #dc3545;
      --warning-color: #fd7e14;
      --info-color: #17a2b8;
    }
    
    html, body { 
      height: 100%; 
      margin: 0; 
      font-family: 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
    }
    
    .sidebar { 
      min-height: 100vh; 
      background-color: var(--primary-color); 
      color: white; 
      transition: all 0.3s;
    }
    
    .sidebar .nav-link { 
      color: rgba(255, 255, 255, 0.8); 
      margin-bottom: 5px; 
      border-radius: 4px;
      transition: all 0.2s;
    }
    
    .sidebar .nav-link:hover, 
    .sidebar .nav-link.active { 
      color: white; 
      background-color: var(--secondary-color);
      transform: translateX(3px);
    }
    
    .sidebar .nav-link i { 
      margin-right: 10px; 
      width: 20px;
      text-align: center;
    }
    
    .main-content { 
      background-color: #f8f9fa; 
      padding: 20px; 
      min-height: 100vh;
    }
    
    .card { 
      margin-bottom: 20px; 
      border: none; 
      box-shadow: 0 2px 10px rgba(0,0,0,0.1); 
      transition: transform 0.2s, box-shadow 0.2s;
    }
    
    .card:hover {
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    
    .map-container { 
      height: 400px; 
      background-color: #e9ecef; 
      border-radius: 5px; 
      margin-bottom: 20px; 
    }
    
    .species-card { transition: transform 0.2s; }
    .species-card:hover { transform: translateY(-5px); }
    
    .logo { 
      font-weight: 700; 
      padding: 15px; 
      font-size: 1.2rem; 
      border-bottom: 1px solid rgba(255,255,255,0.1); 
      display: flex;
      align-items: center;
    }
    
    .logo i {
      margin-right: 10px;
      font-size: 1.5rem;
    }
    
    #map, #dashboardMap { 
      height: 100%; 
      width: 100%; 
      border-radius: 5px; 
    }
    
    .map-controls { 
      position: absolute; 
      top: 10px; 
      right: 10px; 
      z-index: 1000; 
    }
    
    .leaflet-top.leaflet-right { margin-top: 50px; }
    
    .chart-container { 
      position: relative; 
      height: 300px; 
      margin-bottom: 2rem; 
    }
    
    .task-completed { 
      text-decoration: line-through; 
      color: #6c757d; 
    }
    
    .is-invalid { border-color: var(--danger-color); }
    .invalid-feedback { color: var(--danger-color); font-size: 0.875em; }
    
    .species-badge { font-size: 0.8em; }
    .species-native { background-color: var(--success-color); }
    .species-weed { background-color: var(--danger-color); }
    .species-introduced { background-color: var(--warning-color); }
    .species-unknown { background-color: #6c757d; }
    
    .table-responsive {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }
    
    .btn-float {
      position: fixed;
      bottom: 30px;
      right: 30px;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      font-size: 24px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      z-index: 100;
    }
    
    .toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1100;
    }
    
    .leaflet-popup-content img {
      max-width: 100%;
      height: auto;
    }
    
    @media (max-width: 768px) {
      .sidebar { 
        min-height: auto; 
        position: sticky;
        top: 0;
        z-index: 1020;
      }
      
      .chart-container { height: 250px; }
      
      .logo {
        justify-content: center;
      }
      
      .nav {
        flex-direction: row !important;
        overflow-x: auto;
        white-space: nowrap;
        flex-wrap: nowrap;
        padding-bottom: 10px;
      }
      
      .nav-link {
        padding: 0.5rem 1rem;
      }
    }
    
    /* Dark mode styles */
    body.dark-mode {
      background-color: #121212;
      color: #e0e0e0;
    }
    
    body.dark-mode .main-content {
      background-color: #1e1e1e;
    }
    
    body.dark-mode .card {
      background-color: #2d2d2d;
      color: #e0e0e0;
      box-shadow: 0 2px 10px rgba(0,0,0,0.3);
    }
    
    body.dark-mode .table {
      color: #e0e0e0;
    }
    
    body.dark-mode .table-striped tbody tr:nth-of-type(odd) {
      background-color: rgba(255, 255, 255, 0.05);
    }
    
    body.dark-mode .form-control,
    body.dark-mode .form-select {
      background-color: #333;
      border-color: #444;
      color: #e0e0e0;
    }
    
    body.dark-mode .text-muted {
      color: #9e9e9e !important;
    }
  </style>
</head>
<body>
  <div class="container-fluid">
    <div class="row">
      <div class="col-md-3 col-lg-2 sidebar p-0">
        <div class="logo">
          <i class="bi bi-tree"></i>
          <span class="d-none d-md-inline">EcoMaintain</span>
        </div>
        <ul class="nav flex-column p-3">
          <li class="nav-item"><a class="nav-link active" href="#dashboard" data-bs-toggle="tab"><i class="bi bi-speedometer2"></i> <span class="d-none d-md-inline">Dashboard</span></a></li>
          <li class="nav-item"><a class="nav-link" href="#site-assessment" data-bs-toggle="tab"><i class="bi bi-clipboard-data"></i> <span class="d-none d-md-inline">Assessment</span></a></li>
          <li class="nav-item"><a class="nav-link" href="#maintenance-plan" data-bs-toggle="tab"><i class="bi bi-calendar-check"></i> <span class="d-none d-md-inline">Maintenance</span></a></li>
          <li class="nav-item"><a class="nav-link" href="#species-register" data-bs-toggle="tab"><i class="bi bi-tree"></i> <span class="d-none d-md-inline">Species</span></a></li>
          <li class="nav-item"><a class="nav-link" href="#monitoring" data-bs-toggle="tab"><i class="bi bi-binoculars"></i> <span class="d-none d-md-inline">Monitoring</span></a></li>
          <li class="nav-item"><a class="nav-link" href="#reports" data-bs-toggle="tab"><i class="bi bi-file-earmark-text"></i> <span class="d-none d-md-inline">Reports</span></a></li>
          <li class="nav-item mt-4"><a class="nav-link" href="#settings" data-bs-toggle="tab"><i class="bi bi-gear"></i> <span class="d-none d-md-inline">Settings</span></a></li>
        </ul>
      </div>

      <div class="col-md-9 col-lg-10 ms-sm-auto main-content">
        <div class="tab-content">
          <!-- Dashboard -->
          <div class="tab-pane fade show active" id="dashboard">
            <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
              <h1 class="h2">Dashboard</h1>
              <div class="btn-toolbar mb-2 mb-md-0">
                <div class="btn-group me-2">
                  <button type="button" class="btn btn-sm btn-outline-secondary" onclick="refreshData()">
                    <i class="bi bi-arrow-clockwise"></i> Refresh
                  </button>
                </div>
              </div>
            </div>
            
            <div class="row mb-4">
              <div class="col-md-3">
                <div class="card text-white bg-primary">
                  <div class="card-body">
                    <h5 class="card-title">Assessments</h5>
                    <h2 class="card-text" id="assessmentCount">0</h2>
                    <p class="card-text"><small>Last: <span id="lastAssessmentDate">Never</span></small></p>
                  </div>
                </div>
              </div>
              <div class="col-md-3">
                <div class="card text-white bg-success">
                  <div class="card-body">
                    <h5 class="card-title">Tasks Completed</h5>
                    <h2 class="card-text" id="completedTasks">0</h2>
                    <p class="card-text"><small>Pending: <span id="pendingTasks">0</span></small></p>
                  </div>
                </div>
              </div>
              <div class="col-md-3">
                <div class="card text-white bg-warning">
                  <div class="card-body">
                    <h5 class="card-title">Species</h5>
                    <h2 class="card-text" id="speciesCount">0</h2>
                    <p class="card-text"><small>Native: <span id="nativeSpecies">0</span></small></p>
                  </div>
                </div>
              </div>
              <div class="col-md-3">
                <div class="card text-white bg-info">
                  <div class="card-body">
                    <h5 class="card-title">Monitoring</h5>
                    <h2 class="card-text" id="monitoringCount">0</h2>
                    <p class="card-text"><small>Last: <span id="lastMonitoringDate">Never</span></small></p>
                  </div>
                </div>
              </div>
            </div>

            <div class="row">
              <div class="col-md-6 mb-4">
                <div class="card">
                  <div class="card-body">
                    <h5 class="card-title">Recent Activity</h5>
                    <div class="list-group" id="recentActivity">
                      <div class="list-group-item text-center text-muted py-4">
                        No recent activity
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-md-6 mb-4">
                <div class="card">
                  <div class="card-body">
                    <h5 class="card-title">Upcoming Tasks</h5>
                    <div class="list-group" id="upcomingTasks">
                      <div class="list-group-item text-center text-muted py-4">
                        No upcoming tasks
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="card">
              <div class="card-body">
                <h5 class="card-title">Site Overview Map</h5>
                <div id="dashboardMap" style="height: 400px;"></div>
                <div class="mt-3 d-flex flex-wrap gap-2">
                  <button class="btn btn-sm btn-outline-primary" onclick="locateUser()">
                    <i class="bi bi-geo-alt"></i> Use My Location
                  </button>
                  <button class="btn btn-sm btn-outline-secondary" onclick="addPhotoMarker()">
                    <i class="bi bi-camera"></i> Add Photo Marker
                  </button>
                  <button class="btn btn-sm btn-outline-success" onclick="addAssessmentMarker()">
                    <i class="bi bi-clipboard-check"></i> Add Assessment
                  </button>
                  <button class="btn btn-sm btn-danger" onclick="clearMapData()">
                    <i class="bi bi-trash"></i> Clear Map Data
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Site Assessment -->
          <div class="tab-pane fade" id="site-assessment">
            <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
              <h1 class="h2">Site Assessment</h1>
              <div class="btn-toolbar mb-2 mb-md-0">
                <button class="btn btn-sm btn-outline-primary" onclick="showAssessmentHelp()">
                  <i class="bi bi-question-circle"></i> Help
                </button>
              </div>
            </div>
            
            <div class="card">
              <div class="card-body">
                <form id="assessmentForm">
                  <div class="row">
                    <div class="col-md-6 mb-3">
                      <label for="assessmentDate" class="form-label">Date</label>
                      <input type="date" class="form-control" id="assessmentDate" required>
                      <div class="invalid-feedback">Please provide a valid date.</div>
                    </div>
                    <div class="col-md-6 mb-3">
                      <label for="assessorName" class="form-label">Assessor</label>
                      <input type="text" class="form-control" id="assessorName" required minlength="2"> 
                      <div class="invalid-feedback">Please provide the assessor's name (at least 2 characters).</div>
                    </div>
                  </div>
                  
                  <div class="mb-3">
                    <label for="siteDescription" class="form-label">Site Description</label>
                    <textarea class="form-control" id="siteDescription" rows="3" required minlength="10"></textarea>
                    <div class="invalid-feedback">Please provide a detailed description (at least 10 characters).</div>
                  </div>
                  
                  <div class="row">
                    <div class="col-md-6 mb-3">
                      <label for="ecosystemHealth" class="form-label">Health Rating</label>
                      <select class="form-select" id="ecosystemHealth" required>
                        <option value="">Select health rating</option>
                        <option value="Excellent">Excellent</option>
                        <option value="Good">Good</option>
                        <option value="Fair">Fair</option>
                        <option value="Poor">Poor</option>
                        <option value="Critical">Critical</option>
                      </select>
                      <div class="invalid-feedback">Please select a health rating.</div>
                    </div>
                    <div class="col-md-6 mb-3">
                      <label for="threats" class="form-label">Identified Threats</label>
                      <select multiple class="form-select" id="threats" required>
                        <option>Weeds</option>
                        <option>Erosion</option>
                        <option>Pests</option>
                        <option>Illegal access</option>
                        <option>Fire damage</option>
                        <option>Drought</option>
                        <option>Flooding</option>
                        <option>Pollution</option>
                      </select>
                      <div class="invalid-feedback">Please select at least one threat.</div>
                      <small class="text-muted">Hold Ctrl/Cmd to select multiple items</small>
                    </div>
                  </div>
                  
                  <div class="mb-3">
                    <label for="recommendations" class="form-label">Recommendations</label>
                    <textarea class="form-control" id="recommendations" rows="2" placeholder="Enter any recommendations for maintenance or improvement"></textarea>
                  </div>
                  
                  <div class="d-flex justify-content-between">
                    <button type="button" class="btn btn-outline-secondary" onclick="this.form.reset()">
                      <i class="bi bi-x-circle"></i> Reset
                    </button>
                    <button type="submit" class="btn btn-primary">
                      <i class="bi bi-save"></i> Save Assessment
                    </button>
                  </div>
                </form>
              </div>
            </div>
            
            <div class="card mt-4">
              <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                  <h5 class="card-title mb-0">Previous Assessments</h5>
                  <div class="input-group" style="width: 250px;">
                    <input type="text" id="assessmentSearch" class="form-control" placeholder="Search assessments...">
                    <button class="btn btn-outline-secondary" type="button" onclick="searchAssessments()">
                      <i class="bi bi-search"></i>
                    </button>
                  </div>
                </div>
                
                <div class="table-responsive">
                  <table class="table table-hover">
                    <thead>
                      <tr>
                        <th>Date</th>
                        <th>Assessor</th>
                        <th>Health</th>
                        <th>Threats</th>
                        <th>Actions</th>
                      </tr>
                    </thead>
                    <tbody id="assessmentTableBody"></tbody>
                  </table>
                </div>
                
                <div class="d-flex justify-content-between align-items-center mt-3">
                  <div class="text-muted" id="assessmentPaginationInfo">Showing all assessments</div>
                  <div class="btn-group">
                    <button class="btn btn-sm btn-outline-secondary" id="prevAssessmentPage" disabled>Previous</button>
                    <button class="btn btn-sm btn-outline-secondary" id="nextAssessmentPage" disabled>Next</button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Maintenance Plan -->
          <div class="tab-pane fade" id="maintenance-plan">
            <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
              <h1 class="h2">Maintenance Plan</h1>
              <div class="btn-toolbar mb-2 mb-md-0">
                <div class="btn-group me-2">
                  <button class="btn btn-sm btn-outline-secondary" onclick="showMaintenanceHelp()">
                    <i class="bi bi-question-circle"></i> Help
                  </button>
                </div>
              </div>
            </div>

            <form id="maintenanceForm" class="row g-3 mb-4">
              <div class="col-md-4">
                <label for="taskName" class="form-label">Task</label>
                <input type="text" class="form-control" id="taskName" required placeholder="Enter task description">
                <div class="invalid-feedback">Please provide a task name.</div>
              </div>
              <div class="col-md-3">
                <label for="taskCategory" class="form-label">Category</label>
                <select class="form-select" id="taskCategory" required>
                  <option value="">Select category</option>
                  <option>Weeding</option>
                  <option>Replanting</option>
                  <option>Track repair</option>
                  <option>Fencing</option>
                  <option>Watering</option>
                  <option>Monitoring</option>
                  <option>Other</option>
                </select>
                <div class="invalid-feedback">Please select a category.</div>
              </div>
              <div class="col-md-3">
                <label for="taskDueDate" class="form-label">Due Date</label>
                <input type="date" class="form-control" id="taskDueDate" required>
                <div class="invalid-feedback">Please select a due date.</div>
              </div>
              <div class="col-md-2 d-flex align-items-end">
                <button type="submit" class="btn btn-success w-100">
                  <i class="bi bi-plus-circle"></i> Add
                </button>
              </div>
              <div class="col-12">
                <label for="taskNotes" class="form-label">Notes (optional)</label>
                <textarea class="form-control" id="taskNotes" rows="1" placeholder="Additional details about the task"></textarea>
              </div>
            </form>

            <div class="card">
              <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                  <h5 class="card-title mb-0">Maintenance Tasks</h5>
                  <div class="btn-group">
                    <button class="btn btn-sm btn-outline-secondary" onclick="filterTasks('all')">All</button>
                    <button class="btn btn-sm btn-outline-secondary" onclick="filterTasks('pending')">Pending</button>
                    <button class="btn btn-sm btn-outline-secondary" onclick="filterTasks('completed')">Completed</button>
                  </div>
                </div>
                
                <div class="table-responsive">
                  <table class="table table-striped align-middle">
                    <thead>
                      <tr>
                        <th>Task</th>
                        <th>Category</th>
                        <th>Due</th>
                        <th>Status</th>
                        <th style="width: 120px;">Actions</th>
                      </tr>
                    </thead>
                    <tbody id="maintenanceTableBody"></tbody>
                  </table>
                </div>
                
                <div class="d-flex justify-content-between align-items-center mt-3">
                  <div class="text-muted" id="taskPaginationInfo">Showing all tasks</div>
                  <div class="btn-group">
                    <button class="btn btn-sm btn-outline-secondary" id="prevTaskPage" disabled>Previous</button>
                    <button class="btn btn-sm btn-outline-secondary" id="nextTaskPage" disabled>Next</button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Species Register -->
          <div class="tab-pane fade" id="species-register">
            <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
              <h1 class="h2">Species Register</h1>
              <div class="btn-toolbar mb-2 mb-md-0">
                <button class="btn btn-sm btn-outline-secondary" onclick="showSpeciesHelp()">
                  <i class="bi bi-question-circle"></i> Help
                </button>
              </div>
            </div>

            <form id="speciesForm" class="row g-3 mb-4">
              <div class="col-md-4">
                <label for="speciesName" class="form-label">Species Name</label>
                <input type="text" class="form-control" id="speciesName" required placeholder="Enter scientific or common name">
                <div class="invalid-feedback">Please provide a species name.</div>
              </div>
              <div class="col-md-3">
                <label for="speciesType" class="form-label">Type</label>
                <select class="form-select" id="speciesType" required>
                  <option value="">Select type</option>
                  <option>Native</option>
                  <option>Weed</option>
                  <option>Introduced</option>
                  <option>Unknown</option>
                </select>
                <div class="invalid-feedback">Please select a species type.</div>
              </div>
              <div class="col-md-3">
                <label for="speciesNotes" class="form-label">Notes</label>
                <input type="text" class="form-control" id="speciesNotes" placeholder="Habitat, threats, etc.">
              </div>
              <div class="col-md-2 d-flex align-items-end">
                <button type="submit" class="btn btn-success w-100">
                  <i class="bi bi-plus-circle"></i> Add
                </button>
              </div>
            </form>

            <div class="card">
              <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                  <h5 class="card-title mb-0">Species List</h5>
                  <div class="btn-group">
                    <button class="btn btn-sm btn-outline-secondary" onclick="filterSpecies('all')">All</button>
                    <button class="btn btn-sm btn-outline-secondary" onclick="filterSpecies('native')">Native</button>
                    <button class="btn btn-sm btn-outline-secondary" onclick="filterSpecies('weed')">Weeds</button>
                  </div>
                </div>
                
                <div class="table-responsive">
                  <table class="table table-striped align-middle">
                    <thead>
                      <tr>
                        <th>Name</th>
                        <th>Type</th>
                        <th>Notes</th>
                        <th style="width: 100px;">Actions</th>
                      </tr>
                    </thead>
                    <tbody id="speciesTableBody"></tbody>
                  </table>
                </div>
                
                <div class="d-flex justify-content-between align-items-center mt-3">
                  <div class="text-muted" id="speciesPaginationInfo">Showing all species</div>
                  <div class="btn-group">
                    <button class="btn btn-sm btn-outline-secondary" id="prevSpeciesPage" disabled>Previous</button>
                    <button class="btn btn-sm btn-outline-secondary" id="nextSpeciesPage" disabled>Next</button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Monitoring -->
          <div class="tab-pane fade" id="monitoring">
            <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
              <h1 class="h2">Monitoring</h1>
              <div class="btn-toolbar mb-2 mb-md-0">
                <button class="btn btn-sm btn-outline-secondary" onclick="showMonitoringHelp()">
                  <i class="bi bi-question-circle"></i> Help
                </button>
              </div>
            </div>

            <form id="monitoringForm" class="row g-3 mb-4">
              <div class="col-md-3">
                <label for="monitoringDate" class="form-label">Date</label>
                <input type="date" class="form-control" id="monitoringDate" required>
                <div class="invalid-feedback">Please provide a date.</div>
              </div>
              <div class="col-md-3">
                <label for="monitoringObserver" class="form-label">Observer</label>
                <input type="text" class="form-control" id="monitoringObserver" required>
                <div class="invalid-feedback">Please provide observer's name.</div>
              </div>
              <div class="col-md-3">
                <label for="monitoringArea" class="form-label">Location / Area</label>
                <input type="text" class="form-control" id="monitoringArea" required placeholder="Enter location">
                <div class="invalid-feedback">Please provide a location.</div>
              </div>
              <div class="col-md-3">
                <label for="monitoringWeather" class="form-label">Weather</label>
                <select class="form-select" id="monitoringWeather">
                  <option value="">Select weather</option>
                  <option>Sunny</option>
                  <option>Cloudy</option>
                  <option>Rainy</option>
                  <option>Windy</option>
                  <option>Stormy</option>
                </select>
              </div>
              <div class="col-12">
                <label for="monitoringNotes" class="form-label">Notes / Observations</label>
                <textarea class="form-control" id="monitoringNotes" rows="3" required 
                  placeholder="Detailed observations of species, threats, changes, etc."></textarea>
                <div class="invalid-feedback">Please provide some observations.</div>
              </div>
              <div class="col-12 d-flex justify-content-end gap-2">
                <button type="button" class="btn btn-outline-secondary" onclick="this.form.reset()">
                  <i class="bi bi-x-circle"></i> Reset
                </button>
                <button type="submit" class="btn btn-success">
                  <i class="bi bi-plus-circle"></i> Save Entry
                </button>
              </div>
            </form>

            <div class="card">
              <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                  <h5 class="card-title mb-0">Monitoring Logs</h5>
                  <div class="input-group" style="width: 250px;">
                    <input type="text" id="monitoringSearch" class="form-control" placeholder="Search logs...">
                    <button class="btn btn-outline-secondary" type="button" onclick="searchMonitoring()">
                      <i class="bi bi-search"></i>
                    </button>
                  </div>
                </div>
                
                <div class="table-responsive">
                  <table class="table table-striped align-middle">
                    <thead>
                      <tr>
                        <th>Date</th>
                        <th>Observer</th>
                        <th>Location</th>
                        <th>Weather</th>
                        <th>Notes</th>
                        <th style="width: 100px;">Actions</th>
                      </tr>
                    </thead>
                    <tbody id="monitoringTableBody"></tbody>
                  </table>
                </div>
                
                <div class="d-flex justify-content-between align-items-center mt-3">
                  <div class="text-muted" id="monitoringPaginationInfo">Showing all logs</div>
                  <div class="btn-group">
                    <button class="btn btn-sm btn-outline-secondary" id="prevMonitoringPage" disabled>Previous</button>
                    <button class="btn btn-sm btn-outline-secondary" id="nextMonitoringPage" disabled>Next</button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Reports -->
          <div class="tab-pane fade" id="reports">
            <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
              <h1 class="h2">Reports</h1>
              <div class="btn-toolbar mb-2 mb-md-0">
                <button class="btn btn-sm btn-outline-secondary" onclick="showReportsHelp()">
                  <i class="bi bi-question-circle"></i> Help
                </button>
              </div>
            </div>

            <div class="mb-3 d-flex flex-wrap gap-2">
              <button class="btn btn-outline-primary" onclick="generateReport()">
                <i class="bi bi-file-earmark-text"></i> Generate Summary
              </button>
              <button class="btn btn-outline-secondary" onclick="exportToCSV()">
                <i class="bi bi-download"></i> Export to CSV
              </button>
              <button class="btn btn-outline-success" onclick="exportToPDF()">
                <i class="bi bi-file-pdf"></i> Export to PDF
              </button>
              <button class="btn btn-outline-dark" onclick="window.print()">
                <i class="bi bi-printer"></i> Print
              </button>
            </div>

            <div id="reportContent" class="bg-white p-4 border rounded shadow-sm mb-4" style="min-height: 200px;">
              <p class="text-muted">Click "Generate Summary" to view a snapshot of your data.</p>
            </div>

            <div class="row">
              <div class="col-md-6 mb-4">
                <div class="card">
                  <div class="card-body">
                    <h5 class="card-title">Maintenance Tasks</h5>
                    <div class="chart-container">
                      <canvas id="maintenanceChart"></canvas>
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-md-6 mb-4">
                <div class="card">
                  <div class="card-body">
                    <h5 class="card-title">Species Distribution</h5>
                    <div class="chart-container">
                      <canvas id="speciesChart"></canvas>
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-md-12 mb-4">
                <div class="card">
                  <div class="card-body">
                    <h5 class="card-title">Monitoring Activity</h5>
                    <div class="chart-container">
                      <canvas id="monitoringChart"></canvas>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Settings -->
          <div class="tab-pane fade" id="settings">
            <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
              <h1 class="h2">Settings</h1>
              <div class="btn-toolbar mb-2 mb-md-0">
                <button class="btn btn-sm btn-outline-secondary" onclick="showSettingsHelp()">
                  <i class="bi bi-question-circle"></i> Help
                </button>
              </div>
            </div>
            
            <div class="row">
              <div class="col-md-6 mb-4">
                <div class="card h-100">
                  <div class="card-body">
                    <h5 class="card-title">Site Information</h5>
                    <form id="siteSettingsForm">
                      <div class="mb-3">
                        <label for="siteName" class="form-label">Site Name</label>
                        <input type="text" class="form-control" id="siteName" placeholder="Enter site name">
                      </div>
                      <div class="mb-3">
                        <label for="siteLocation" class="form-label">Location</label>
                        <input type="text" class="form-control" id="siteLocation" placeholder="Enter location details">
                      </div>
                      <div class="mb-3">
                        <label for="siteDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="siteDescription" rows="3" placeholder="Describe the site characteristics"></textarea>
                      </div>
                      <div class="d-flex justify-content-end">
                        <button type="submit" class="btn btn-primary">
                          <i class="bi bi-save"></i> Save Site Info
                        </button>
                      </div>
                    </form>
                  </div>
                </div>
              </div>
              
              <div class="col-md-6 mb-4">
                <div class="card h-100">
                  <div class="card-body">
                    <h5 class="card-title">User Preferences</h5>
                    <form id="userSettingsForm">
                      <div class="mb-3">
                        <label for="userName" class="form-label">Your Name</label>
                        <input type="text" class="form-control" id="userName" required placeholder="Enter your full name">
                      </div>
                      <div class="mb-3">
                        <label for="userRole" class="form-label">Your Role</label>
                        <input type="text" class="form-control" id="userRole" placeholder="E.g., Ecologist, Ranger">
                      </div>
                      <div class="mb-3 form-check form-switch">
                        <input type="checkbox" class="form-check-input" id="darkMode" onchange="toggleDarkMode()">
                        <label class="form-check-label" for="darkMode">Dark Mode</label>
                      </div>
                      <div class="d-flex justify-content-end">
                        <button type="submit" class="btn btn-primary">
                          <i class="bi bi-save"></i> Save Preferences
                        </button>
                      </div>
                    </form>
                  </div>
                </div>
              </div>
            </div>
            
            <div class="card border-danger">
              <div class="card-body">
                <h5 class="card-title text-danger">Danger Zone</h5>
                <p class="card-text">These actions cannot be undone.</p>
                <div class="d-flex flex-wrap gap-2">
                  <button class="btn btn-outline-danger" onclick="clearData()">
                    <i class="bi bi-trash"></i> Clear All Data
                  </button>
                  <button class="btn btn-outline-secondary" onclick="importData()">
                    <i class="bi bi-upload"></i> Import Data
                  </button>
                  <button class="btn btn-danger" onclick="exportAllData()">
                    <i class="bi bi-download"></i> Export All Data
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Floating action button -->
  <button class="btn btn-primary btn-float d-md-none" onclick="scrollToTop()">
    <i class="bi bi-arrow-up"></i>
  </button>

  <!-- Toast notifications container -->
  <div class="toast-container"></div>

  <!-- JS Dependencies -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" integrity="sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVBC9FhGdlKrxdiJJigb/j/68SIy3Te4Bkz" crossorigin="anonymous"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <!-- Main Script -->
  <script>
    // Initialize data structure with sample data for demonstration
    let ecoData = {
      settings: {
        user: {},
        site: {},
        darkMode: false
      },
      assessments: [],
      maintenance: [],
      species: [],
      monitoring: [],
      mapMarkers: []
    };

    // Pagination variables
    const paginationConfig = {
      assessments: { currentPage: 1, itemsPerPage: 5, filteredData: [] },
      maintenance: { currentPage: 1, itemsPerPage: 5, filteredData: [] },
      species: { currentPage: 1, itemsPerPage: 5, filteredData: [] },
      monitoring: { currentPage: 1, itemsPerPage: 5, filteredData: [] }
    };

    // Load data from localStorage
    function loadData() {
      // Set default observer name if available
const observerField = document.getElementById('monitoringObserver');
if (observerField && ecoData.settings?.user?.name) {
  observerField.value = ecoData.settings.user.name;
}

      }

      const saved = localStorage.getItem("ecoMaintainData");
      if (saved) {
        try { 
          ecoData = JSON.parse(saved); 
          updateDashboardCounts();
          showToast('Data loaded successfully', 'success');
        }
        catch (e) { 
          console.error("Error loading data", e); 
          showToast('Error loading saved data. Starting with fresh data.', 'danger');
        }
      }
      
      // Initialize filtered data for pagination
      paginationConfig.assessments.filteredData = [...ecoData.assessments];
      paginationConfig.maintenance.filteredData = [...ecoData.maintenance];
      paginationConfig.species.filteredData = [...ecoData.species];
      paginationConfig.monitoring.filteredData = [...ecoData.monitoring];
      
      // Apply dark mode if enabled
      if (ecoData.settings.darkMode) {
        document.body.classList.add('dark-mode');
        document.getElementById('darkMode').checked = true;
      }
    }

    // Save data to localStorage
    function saveData() {
      try {
        localStorage.setItem("ecoMaintainData", JSON.stringify(ecoData));
        updateDashboardCounts();
        showToast('Data saved successfully', 'success');
      } catch (e) {
        console.error("Error saving", e);
        showToast('Error saving data. Check console for details.', 'danger');
      }
    }

    // Clear all data
    function clearData() {
      if (confirm("This will permanently delete ALL your data. Are you sure?")) {
        localStorage.removeItem("ecoMaintainData");
        localStorage.removeItem("dashboardMapShapes");
        ecoData = {
          settings: { user: {}, site: {}, darkMode: document.body.classList.contains('dark-mode') },
          assessments: [],
          maintenance: [],
          species: [],
          monitoring: [],
          mapMarkers: []
        };
        saveData();
        location.reload();
      }
    }

    // Import data from file
    function importData() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.json';
      
      input.onchange = e => {
        const file = e.target.files[0];
        const reader = new FileReader();
        
        reader.onload = event => {
          try {
            const importedData = JSON.parse(event.target.result);
            if (confirm("This will overwrite your current data. Continue?")) {
              ecoData = importedData;
              saveData();
              location.reload();
            }
          } catch (err) {
            console.error("Error importing data", err);
            showToast('Invalid data file. Please check the format.', 'danger');
          }
        };
        
        reader.readAsText(file);
      };
      
      input.click();
    }

    // Update dashboard counters with additional stats
    function updateDashboardCounts() {
      document.getElementById("assessmentCount").textContent = ecoData.assessments.length;
      document.getElementById("completedTasks").textContent = ecoData.maintenance.filter(t => t.done).length;
      document.getElementById("pendingTasks").textContent = ecoData.maintenance.filter(t => !t.done).length;
      document.getElementById("speciesCount").textContent = ecoData.species.length;
      document.getElementById("monitoringCount").textContent = ecoData.monitoring.length;
      
      // Native species count
      const nativeCount = ecoData.species.filter(s => s.type === 'Native').length;
      document.getElementById("nativeSpecies").textContent = nativeCount;
      
      // Last assessment date
      if (ecoData.assessments.length > 0) {
        const lastAssessment = [...ecoData.assessments].sort((a, b) => new Date(b.date) - new Date(a.date))[0];
        document.getElementById("lastAssessmentDate").textContent = lastAssessment.date;
      } else {
        document.getElementById("lastAssessmentDate").textContent = 'Never';
      }
      
      // Last monitoring date
      if (ecoData.monitoring.length > 0) {
        const lastMonitoring = [...ecoData.monitoring].sort((a, b) => new Date(b.date) - new Date(a.date))[0];
        document.getElementById("lastMonitoringDate").textContent = lastMonitoring.date;
      } else {
        document.getElementById("lastMonitoringDate").textContent = 'Never';
      }
      
      // Update recent activity
      updateRecentActivity();
      
      // Update upcoming tasks
      updateUpcomingTasks();
    }

    // Update recent activity list
    function updateRecentActivity() {
      const container = document.getElementById("recentActivity");
      container.innerHTML = "";
      
      // Combine different types of activities with timestamps
      const activities = [];
      
      ecoData.assessments.forEach(a => {
        activities.push({
          type: 'assessment',
          date: a.date,
          title: `Assessment by ${a.assessor}`,
          content: `Health: ${a.health}`,
          icon: 'bi-clipboard-data'
        });
      });
      
      ecoData.maintenance.forEach(t => {
        activities.push({
          type: 'task',
          date: t.due,
          title: `Task: ${t.name}`,
          content: `Status: ${t.done ? 'Completed' : 'Pending'}`,
          icon: t.done ? 'bi-check-circle' : 'bi-exclamation-circle'
        });
      });
      
      ecoData.monitoring.forEach(m => {
        activities.push({
          type: 'monitoring',
          date: m.date,
          title: `Monitoring by ${m.observer}`,
          content: `Location: ${m.area || 'Unknown'}`,
          icon: 'bi-binoculars'
        });
      });
      
      // Sort by date (newest first)
      activities.sort((a, b) => new Date(b.date) - new Date(a.date));
      
      // Show only the 5 most recent
      const recentActivities = activities.slice(0, 5);
      
      if (recentActivities.length === 0) {
        container.innerHTML = `
          <div class="list-group-item text-center text-muted py-4">
            No recent activity
          </div>
        `;
        return;
      }
      
      recentActivities.forEach(activity => {
        const item = document.createElement('a');
        item.className = 'list-group-item list-group-item-action';
        item.innerHTML = `
          <div class="d-flex w-100 justify-content-between">
            <h6 class="mb-1"><i class="bi ${activity.icon} me-2"></i>${activity.title}</h6>
            <small class="text-muted">${activity.date}</small>
          </div>
          <p class="mb-1">${activity.content}</p>
        `;
        container.appendChild(item);
      });
    }

    // Update upcoming tasks list
    function updateUpcomingTasks() {
      const container = document.getElementById("upcomingTasks");
      container.innerHTML = "";
      
      // Get upcoming tasks (not completed and due in the next 14 days)
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      
      const futureDate = new Date();
      futureDate.setDate(today.getDate() + 14);
      
      const upcomingTasks = ecoData.maintenance
        .filter(task => !task.done)
        .filter(task => {
          const dueDate = new Date(task.due);
          return dueDate >= today && dueDate <= futureDate;
        })
        .sort((a, b) => new Date(a.due) - new Date(b.due));
      
      if (upcomingTasks.length === 0) {
        container.innerHTML = `
          <div class="list-group-item text-center text-muted py-4">
            No upcoming tasks
          </div>
        `;
        return;
      }
      
      upcomingTasks.slice(0, 5).forEach(task => {
        const dueDate = new Date(task.due);
        const daysDiff = Math.floor((dueDate - today) / (1000 * 60 * 60 * 24));
        
        let badgeClass = 'bg-secondary';
        let dueText = '';
        
        if (daysDiff === 0) {
          badgeClass = 'bg-warning';
          dueText = 'Today';
        } else if (daysDiff < 0) {
          badgeClass = 'bg-danger';
          dueText = `${Math.abs(daysDiff)} day(s) overdue`;
        } else {
          badgeClass = 'bg-info';
          dueText = `In ${daysDiff} day(s)`;
        }
        
        const item = document.createElement('a');
        item.className = 'list-group-item list-group-item-action';
        item.innerHTML = `
          <div class="d-flex w-100 justify-content-between">
            <h6 class="mb-1">${task.name}</h6>
            <span class="badge ${badgeClass}">${dueText}</span>
          </div>
          <p class="mb-1"><small class="text-muted">${task.category} â€¢ Due ${dueDate.toLocaleDateString()}</small></p>
        `;
        container.appendChild(item);
      });
    }

    // Initialize the dashboard map with more features
    function initDashboardMap() {
      const map = L.map("dashboardMap").setView([-42.8821, 147.3272], 13);

      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19,
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
      }).addTo(map);

      // Add different base maps
      const baseLayers = {
        "OpenStreetMap": L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
          maxZoom: 19,
          attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }),
        "Satellite": L.tileLayer("https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}", {
          attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
        }),
        "Topographic": L.tileLayer("https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png", {
          maxZoom: 17,
          attribution: 'Map data: &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, <a href="http://viewfinderpanoramas.org">SRTM</a> | Map style: &copy; <a href="https://opentopomap.org">OpenTopoMap</a> (<a href="https://creativecommons.org/licenses/by-sa/3.0/">CC-BY-SA</a>)'
        })
      };

      baseLayers.OpenStreetMap.addTo(map);

      // Geocoder with more options
      const geocoder = L.Control.geocoder({
        defaultMarkGeocode: false,
        placeholder: "Search for location...",
        errorMessage: "Location not found.",
        geocoder: new L.Control.Geocoder.Nominatim({
          geocodingQueryParams: {
            countrycodes: 'au', // Focus on Australia
            limit: 5
          }
        })
      })
      .on("markgeocode", function (e) {
        const bbox = e.geocode.bbox;
        const poly = L.polygon([
          bbox.getSouthEast(),
          bbox.getNorthEast(),
          bbox.getNorthWest(),
          bbox.getSouthWest()
        ]).addTo(map);
        map.fitBounds(poly.getBounds());
        
        // Add a marker with the location name
        L.marker(e.geocode.center).addTo(map)
          .bindPopup(`<strong>${e.geocode.name}</strong>`)
          .openPopup();
      })
      .addTo(map);

      // Drawing feature layer
      const drawnItems = new L.FeatureGroup();
      map.addLayer(drawnItems);

      // Initialize draw control with more options
      const drawControl = new L.Control.Draw({
        edit: {
          featureGroup: drawnItems,
          remove: true,
          edit: false
        },
        draw: {
          polygon: {
            allowIntersection: false,
            drawError: {
              color: '#b00b00',
              message: '<strong>Error:</strong> polygon edges cannot cross!'
            },
            shapeOptions: {
              color: '#3388ff',
              fillOpacity: 0.2
            },
            showArea: true,
            metric: true
          },
          polyline: false,
          rectangle: {
            shapeOptions: {
              color: '#3388ff',
              fillOpacity: 0.2
            }
          },
          circle: {
            shapeOptions: {
              color: '#3388ff',
              fillOpacity: 0.2
            },
            showRadius: true,
            metric: true
          },
          circlemarker: false,
          marker: {
            icon: L.icon({
              iconUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png',
              shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
              iconSize: [25, 41],
              iconAnchor: [12, 41],
              popupAnchor: [1, -34],
              shadowSize: [41, 41]
            })
          }
        }
      });
      map.addControl(drawControl);

      // Add layer control
      const overlayMaps = {
        "Drawings": drawnItems
      };
      
      L.control.layers(baseLayers, overlayMaps, {
        collapsed: false,
        position: 'topleft'
      }).addTo(map);

      // Load saved shapes
      const savedShapes = localStorage.getItem("dashboardMapShapes");
      if (savedShapes) {
        const geojson = JSON.parse(savedShapes);
        L.geoJSON(geojson, {
          onEachFeature: (feature, layer) => {
            if (feature.properties.type === 'photo') {
              layer.bindPopup(`
                <div class="text-center">
                  <img src="${feature.properties.photo}" style="max-width: 200px; max-height: 150px;" class="img-thumbnail mb-2">
                  <p class="mb-1"><strong>${feature.properties.title || 'Photo'}</strong></p>
                  <small class="text-muted">${feature.properties.date || ''}</small>
                </div>
              `);
            } else if (feature.properties.type === 'assessment') {
              layer.bindPopup(`
                <div>
                  <h6>Assessment Point</h6>
                  <p><strong>Date:</strong> ${feature.properties.date}</p>
                  <p><strong>Assessor:</strong> ${feature.properties.assessor}</p>
                  <p><strong>Health:</strong> <span class="badge ${getHealthBadgeClass(feature.properties.health)}">${feature.properties.health}</span></p>
                  <a href="#site-assessment" class="btn btn-sm btn-primary mt-2" onclick="bootstrap.Tab.getInstance(document.querySelector('#site-assessment-tab')).show()">
                    View Details
                  </a>
                </div>
              `);
            }
            drawnItems.addLayer(layer);
          }
        });
      }

      // Save on draw
      map.on(L.Draw.Event.CREATED, function (e) {
        const layer = e.layer;
        drawnItems.addLayer(layer);
        saveMapShapes();
      });

      // Save on edit/delete
      map.on(L.Draw.Event.EDITED, saveMapShapes);
      map.on(L.Draw.Event.DELETED, saveMapShapes);

      function saveMapShapes() {
        const data = drawnItems.toGeoJSON();
        localStorage.setItem("dashboardMapShapes", JSON.stringify(data));
      }

      window.dashboardMap = map;
      window.drawnItems = drawnItems;
    }

    // Add assessment marker to map
    function addAssessmentMarker() {
      if (ecoData.assessments.length === 0) {
        alert("No assessments available to plot. Please create an assessment first.");
        return;
      }
      
      // Show assessment selector
      const assessmentList = ecoData.assessments
        .map(a => `<option value="${a.date}">${a.date} - ${a.assessor} (${a.health})</option>`)
        .join('');
      
      const assessmentSelect = `
        <div class="mb-3">
          <label for="selectAssessment" class="form-label">Select Assessment</label>
          <select class="form-select" id="selectAssessment">
            ${assessmentList}
          </select>
        </div>
      `;
      
      const modal = new bootstrap.Modal(document.createElement('div'));
      modal._element.innerHTML = `
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">Add Assessment Marker</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              ${assessmentSelect}
              <p class="mt-3">Click on the map to place the marker for the selected assessment.</p>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
              <button type="button" class="btn btn-primary" data-bs-dismiss="modal" id="confirmAssessmentMarker">Confirm</button>
            </div>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal._element);
      modal.show();
      
      document.getElementById('confirmAssessmentMarker').addEventListener('click', function() {
        const selectedDate = document.getElementById('selectAssessment').value;
        const assessment = ecoData.assessments.find(a => a.date === selectedDate);
        
        if (!assessment) return;
        
        window.dashboardMap.once('click', function(e) {
          const marker = L.marker(e.latlng).addTo(window.drawnItems);
          
          // Add custom properties
          marker.feature = {
            type: 'Feature',
            properties: {
              type: 'assessment',
              date: assessment.date,
              assessor: assessment.assessor,
              health: assessment.health,
              description: assessment.description
            },
            geometry: {
              type: 'Point',
              coordinates: [e.latlng.lng, e.latlng.lat]
            }
          };
          
          marker.bindPopup(`
            <div>
              <h6>Assessment Point</h6>
              <p><strong>Date:</strong> ${assessment.date}</p>
              <p><strong>Assessor:</strong> ${assessment.assessor}</p>
              <p><strong>Health:</strong> <span class="badge ${getHealthBadgeClass(assessment.health)}">${assessment.health}</span></p>
              <a href="#site-assessment" class="btn btn-sm btn-primary mt-2" onclick="bootstrap.Tab.getInstance(document.querySelector('#site-assessment-tab')).show()">
                View Details
              </a>
            </div>
          `);
          
          saveMapShapes();
          showToast('Assessment marker added to map', 'success');
        });
        
        alert("Click on the map where you want to place the assessment marker");
      });
      
      // Clean up modal after close
      modal._element.addEventListener('hidden.bs.modal', function() {
        document.body.removeChild(modal._element);
      });
    }

    // Locate user on map with more options
    function locateUser() {
      if (!navigator.geolocation) {
        showToast("Geolocation not supported by your browser.", "warning");
        return;
      }
      
      const map = window.dashboardMap;
      map.locate({setView: true, maxZoom: 16, enableHighAccuracy: true});
      
      map.on('locationfound', function(e) {
        const radius = e.accuracy / 2;
        const marker = L.marker(e.latlng).addTo(map)
          .bindPopup(`You are within ${Math.round(radius)} meters of this point`)
          .openPopup();
          
        L.circle(e.latlng, radius, {
          color: '#3388ff',
          fillColor: '#3388ff',
          fillOpacity: 0.2
        }).addTo(map);
        
        // Add to drawn items for saving
        window.drawnItems.addLayer(marker);
        saveMapShapes();
      });
      
      map.on('locationerror', function(e) {
        showToast("Unable to retrieve your location: " + e.message, "danger");
      });
    }

    // Add photo marker to map with more options
// Add photo marker to map with more options
function addPhotoMarker() {
  const modalEl = document.createElement('div');
  modalEl.classList.add('modal', 'fade');
  modalEl.innerHTML = `
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Add Photo Marker</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="photoUrl" class="form-label">Photo URL</label>
            <input type="text" class="form-control" id="photoUrl" placeholder="Enter image URL">
            <div class="form-text">Leave blank to add a marker without photo</div>
          </div>
          <div class="mb-3">
            <label for="photoTitle" class="form-label">Title</label>
            <input type="text" class="form-control" id="photoTitle" placeholder="Enter marker title">
          </div>
          <div class="mb-3">
            <label for="photoDescription" class="form-label">Description</label>
            <textarea class="form-control" id="photoDescription" rows="2" placeholder="Optional description"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" id="confirmPhotoMarker">Add Marker</button>
        </div>
      </div>
    </div>
  `;

  document.body.appendChild(modalEl);
  const modal = new bootstrap.Modal(modalEl);
  modal.show();

  modalEl.querySelector('#confirmPhotoMarker').addEventListener('click', function () {
    const photoUrl = document.getElementById('photoUrl').value;
    const title = document.getElementById('photoTitle').value || 'Photo Marker';
    const description = document.getElementById('photoDescription').value;
    const date = new Date().toISOString().split('T')[0];

    window.dashboardMap.once('click', function (e) {
      const marker = L.marker(e.latlng).addTo(window.drawnItems);

      // Add custom properties
      marker.feature = {
        type: 'Feature',
        properties: {
          type: 'photo',
          photo: photoUrl,
          title: title,
          description: description,
          date: date
        },
        geometry: {
          type: 'Point',
          coordinates: [e.latlng.lng, e.latlng.lat]
        }
      };

      if (photoUrl) {
        marker.bindPopup(`
          <div class="text-center">
            <img src="${photoUrl}" style="max-width: 200px; max-height: 150px;" class="img-thumbnail mb-2">
            <p class="mb-1"><strong>${title}</strong></p>
            ${description ? `<p class="mb-1">${description}</p>` : ''}
            <small class="text-muted">${date}</small>
          </div>
        `);
      } else {
        marker.bindPopup(`
          <div>
            <strong>${title}</strong>
            ${description ? `<p class="mb-1">${description}</p>` : ''}
            <small>${date}</small>
          </div>
        `);
      }

      saveMapShapes();
      showToast('Photo marker added to map', 'success');
    });

    modal.hide();
    alert("Click on the map where you want to place the marker");
  });

  modalEl.addEventListener('hidden.bs.modal', function () {
    document.body.removeChild(modalEl);
  });
}

// Clear map data with confirmation
function clearMapData() {
  const modalEl = document.createElement('div');
  modalEl.classList.add('modal', 'fade');
  modalEl.innerHTML = `
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Confirm Clear Map</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p>Are you sure you want to clear all map drawings and markers?</p>
          <p class="text-danger">This action cannot be undone.</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-danger" id="confirmClearMap">Clear Map</button>
        </div>
      </div>
    </div>
  `;

  document.body.appendChild(modalEl);
  const modal = new bootstrap.Modal(modalEl);
  modal.show();

  modalEl.querySelector('#confirmClearMap').addEventListener('click', function () {
    localStorage.removeItem("dashboardMapShapes");
    window.drawnItems.clearLayers();
    showToast('Map data cleared', 'success');
    modal.hide();
  });

  modalEl.addEventListener('hidden.bs.modal', function () {
    document.body.removeChild(modalEl);
  });
}

    // Form validation helper with improved feedback
    function validateForm(form) {
      let isValid = true;
      const inputs = form.querySelectorAll('input[required], select[required], textarea[required]');
      
      inputs.forEach(input => {
        // Reset validation state
        input.classList.remove('is-invalid');
        
        // Check required fields
        if (!input.value) {
          input.classList.add('is-invalid');
          isValid = false;
        }
        
        // Check minlength for text inputs
        if (input.minLength > 0 && input.value.length < input.minLength) {
          input.classList.add('is-invalid');
          isValid = false;
        }
        
        // Custom validation for date fields
        if (input.type === 'date') {
          const date = new Date(input.value);
          if (isNaN(date.getTime())) {
            input.classList.add('is-invalid');
            isValid = false;
          }
        }
      });
      
      return isValid;
    }

    // Show toast notification
    function showToast(message, type = 'info') {
      const toastContainer = document.querySelector('.toast-container');
      const toastId = 'toast-' + Date.now();
      
      const toast = document.createElement('div');
      toast.className = `toast show align-items-center text-white bg-${type} border-0`;
      toast.id = toastId;
      toast.setAttribute('role', 'alert');
      toast.setAttribute('aria-live', 'assertive');
      toast.setAttribute('aria-atomic', 'true');
      
      toast.innerHTML = `
        <div class="d-flex">
          <div class="toast-body">
            ${message}
          </div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
      `;
      
      toastContainer.appendChild(toast);
      
      // Auto-remove after 5 seconds
      setTimeout(() => {
        const bsToast = bootstrap.Toast.getInstance(toast);
        if (bsToast) bsToast.hide();
      }, 5000);
      
      // Remove from DOM after hide
      toast.addEventListener('hidden.bs.toast', function() {
        toast.remove();
      });
      
      return new bootstrap.Toast(toast);
    }

    // Render assessments table with pagination
    function renderAssessments() {
      const tableBody = document.getElementById("assessmentTableBody");
      tableBody.innerHTML = "";
      
      const { currentPage, itemsPerPage, filteredData } = paginationConfig.assessments;
      const startIndex = (currentPage - 1) * itemsPerPage;
      const paginatedItems = filteredData.slice(startIndex, startIndex + itemsPerPage);
      
      if (paginatedItems.length === 0) {
        tableBody.innerHTML = `
          <tr>
            <td colspan="5" class="text-center py-4 text-muted">
              No assessments found
            </td>
          </tr>
        `;
      } else {
        paginatedItems.forEach((assessment, index) => {
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${assessment.date}</td>
            <td>${assessment.assessor}</td>
            <td>
              <span class="badge ${getHealthBadgeClass(assessment.health)}">
                ${assessment.health}
              </span>
            </td>
            <td>${assessment.threats?.join(", ") || 'None'}</td>
            <td>
              <button class="btn btn-sm btn-outline-primary me-1" onclick="viewAssessment(${startIndex + index})">
                <i class="bi bi-eye"></i>
              </button>
              <button class="btn btn-sm btn-outline-danger" onclick="deleteAssessment(${startIndex + index})">
                <i class="bi bi-trash"></i>
              </button>
            </td>
          `;
          tableBody.appendChild(row);
        });
      }
      
      // Update pagination info
      document.getElementById("assessmentPaginationInfo").textContent = 
        `Showing ${startIndex + 1}-${Math.min(startIndex + itemsPerPage, filteredData.length)} of ${filteredData.length} assessments`;
      
      // Update pagination buttons
      document.getElementById("prevAssessmentPage").disabled = currentPage === 1;
      document.getElementById("nextAssessmentPage").disabled = 
        currentPage * itemsPerPage >= filteredData.length;
    }

    function getHealthBadgeClass(health) {
      switch(health) {
        case 'Excellent': return 'bg-success';
        case 'Good': return 'bg-primary';
        case 'Fair': return 'bg-warning';
        case 'Poor': return 'bg-danger';
        case 'Critical': return 'bg-dark';
        default: return 'bg-secondary';
      }
    }

    // Search assessments
    function searchAssessments() {
      const searchTerm = document.getElementById("assessmentSearch").value.toLowerCase();
      
      if (!searchTerm) {
        paginationConfig.assessments.filteredData = [...ecoData.assessments];
      } else {
        paginationConfig.assessments.filteredData = ecoData.assessments.filter(a => 
          a.date.toLowerCase().includes(searchTerm) ||
          a.assessor.toLowerCase().includes(searchTerm) ||
          a.health.toLowerCase().includes(searchTerm) ||
          a.threats?.some(t => t.toLowerCase().includes(searchTerm)) ||
          a.description?.toLowerCase().includes(searchTerm) ||
          a.recommendations?.toLowerCase().includes(searchTerm)
        );
      }
      
      paginationConfig.assessments.currentPage = 1;
      renderAssessments();
    }

    // View assessment in modal with more details
    function viewAssessment(index) {
      const assessment = ecoData.assessments[index];
      const modalHtml = `
        <div class="modal fade" id="assessmentModal" tabindex="-1" aria-hidden="true">
          <div class="modal-dialog modal-lg">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">Assessment Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                <div class="row mb-3">
                  <div class="col-md-6">
                    <p><strong>Date:</strong> ${assessment.date}</p>
                    <p><strong>Assessor:</strong> ${assessment.assessor}</p>
                  </div>
                  <div class="col-md-6">
                    <p><strong>Health:</strong> <span class="badge ${getHealthBadgeClass(assessment.health)}">${assessment.health}</span></p>
                    <p><strong>Threats:</strong> ${assessment.threats?.join(", ") || 'None'}</p>
                  </div>
                </div>
                <div class="mb-3">
                  <h6>Site Description</h6>
                  <p>${assessment.description || 'No description provided.'}</p>
                </div>
                ${assessment.recommendations ? `
                <div class="mb-3">
                  <h6>Recommendations</h6>
                  <p>${assessment.recommendations}</p>
                </div>
                ` : ''}
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="editAssessment(${index})">
                  <i class="bi bi-pencil"></i> Edit
                </button>
              </div>
            </div>
          </div>
        </div>
      `;
      
      const modalContainer = document.createElement('div');
      modalContainer.innerHTML = modalHtml;
      document.body.appendChild(modalContainer);
      
      const modal = new bootstrap.Modal(document.getElementById('assessmentModal'));
      modal.show();
      
      // Remove modal from DOM after it's hidden
      document.getElementById('assessmentModal').addEventListener('hidden.bs.modal', function() {
        document.body.removeChild(modalContainer);
      });
    }

    // Edit assessment
    function editAssessment(index) {
      const assessment = ecoData.assessments[index];
      
      // Fill the form with assessment data
      document.getElementById("assessmentDate").value = assessment.date;
      document.getElementById("assessorName").value = assessment.assessor;
      document.getElementById("siteDescription").value = assessment.description || '';
      document.getElementById("ecosystemHealth").value = assessment.health;
      
      // Select threats
      const threatsSelect = document.getElementById("threats");
      Array.from(threatsSelect.options).forEach(option => {
        option.selected = assessment.threats?.includes(option.value) || false;
      });
      
      document.getElementById("recommendations").value = assessment.recommendations || '';
      
      // Remove the assessment from the array
      ecoData.assessments.splice(index, 1);
      saveData();
      renderAssessments();
      
      // Scroll to form and switch tab
      bootstrap.Tab.getInstance(document.querySelector('#site-assessment-tab')).show();
      document.getElementById("assessmentForm").scrollIntoView({ behavior: 'smooth' });
      
      showToast('Assessment loaded for editing', 'info');
    }

    function deleteAssessment(index) {
      const modal = new bootstrap.Modal(document.createElement('div'));
      modal._element.innerHTML = `
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">Confirm Delete</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <p>Are you sure you want to delete this assessment?</p>
              <p class="text-danger">This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
              <button type="button" class="btn btn-danger" data-bs-dismiss="modal" id="confirmDeleteAssessment">Delete</button>
            </div>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal._element);
      modal.show();
      
      document.getElementById('confirmDeleteAssessment').addEventListener('click', function() {
        ecoData.assessments.splice(index, 1);
        saveData();
        renderAssessments();
        showToast('Assessment deleted', 'success');
      });
      
      // Clean up modal after close
      modal._element.addEventListener('hidden.bs.modal', function() {
        document.body.removeChild(modal._element);
      });
    }

    // Filter tasks by status
    function filterTasks(status) {
      switch(status) {
        case 'all':
          paginationConfig.maintenance.filteredData = [...ecoData.maintenance];
          break;
        case 'pending':
          paginationConfig.maintenance.filteredData = ecoData.maintenance.filter(t => !t.done);
          break;
        case 'completed':
          paginationConfig.maintenance.filteredData = ecoData.maintenance.filter(t => t.done);
          break;
      }
      
      paginationConfig.maintenance.currentPage = 1;
      renderMaintenanceTasks();
    }

    // Render maintenance tasks with pagination
    function renderMaintenanceTasks() {
      const tableBody = document.getElementById("maintenanceTableBody");
      tableBody.innerHTML = "";
      
      const { currentPage, itemsPerPage, filteredData } = paginationConfig.maintenance;
      const startIndex = (currentPage - 1) * itemsPerPage;
      const paginatedItems = filteredData.slice(startIndex, startIndex + itemsPerPage);
      
      if (paginatedItems.length === 0) {
        tableBody.innerHTML = `
          <tr>
            <td colspan="5" class="text-center py-4 text-muted">
              No tasks found
            </td>
          </tr>
        `;
      } else {
        // Sort by due date (ascending)
        const sortedTasks = [...paginatedItems].sort((a, b) => new Date(a.due) - new Date(b.due));
        
        sortedTasks.forEach((task, index) => {
          const row = document.createElement("tr");
          if (task.done) row.classList.add("table-secondary");
          
          const dueDate = new Date(task.due);
          const today = new Date();
          today.setHours(0, 0, 0, 0);
          
          let dueBadge = '';
          if (!task.done) {
            if (dueDate < today) {
              dueBadge = '<span class="badge bg-danger ms-2">Overdue</span>';
            } else if (dueDate.toDateString() === today.toDateString()) {
              dueBadge = '<span class="badge bg-warning ms-2">Due Today</span>';
            } else if ((dueDate - today) / (1000 * 60 * 60 * 24) <= 7) {
              dueBadge = '<span class="badge bg-info ms-2">Due Soon</span>';
            }
          }
          
          row.innerHTML = `
            <td class="${task.done ? 'task-completed' : ''}">${task.name}</td>
            <td>${task.category}</td>
            <td>
              ${dueDate.toLocaleDateString()}
              ${dueBadge}
            </td>
            <td>
              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" role="switch" 
                  ${task.done ? "checked" : ""} onchange="toggleTaskStatus(${startIndex + index})">
                <label class="form-check-label">${task.done ? "Completed" : "Pending"}</label>
              </div>
            </td>
            <td>
              <button class="btn btn-sm btn-outline-primary me-1" onclick="editTask(${startIndex + index})">
                <i class="bi bi-pencil"></i>
              </button>
              <button class="btn btn-sm btn-outline-danger" onclick="deleteTask(${startIndex + index})">
                <i class="bi bi-trash"></i>
              </button>
            </td>
          `;
          tableBody.appendChild(row);
        });
      }
      
      // Update pagination info
      document.getElementById("taskPaginationInfo").textContent = 
        `Showing ${startIndex + 1}-${Math.min(startIndex + itemsPerPage, filteredData.length)} of ${filteredData.length} tasks`;
      
      // Update pagination buttons
      document.getElementById("prevTaskPage").disabled = currentPage === 1;
      document.getElementById("nextTaskPage").disabled = 
        currentPage * itemsPerPage >= filteredData.length;
    }

    function toggleTaskStatus(index) {
      ecoData.maintenance[index].done = !ecoData.maintenance[index].done;
      saveData();
      renderMaintenanceTasks();
      showToast(`Task marked as ${ecoData.maintenance[index].done ? 'completed' : 'pending'}`, 'success');
    }

    function editTask(index) {
      const task = ecoData.maintenance[index];
      document.getElementById("taskName").value = task.name;
      document.getElementById("taskCategory").value = task.category;
      document.getElementById("taskDueDate").value = task.due;
      document.getElementById("taskNotes").value = task.notes || '';
      
      // Remove the task from the array
      ecoData.maintenance.splice(index, 1);
      saveData();
      renderMaintenanceTasks();
      
      // Scroll to form and switch tab
      bootstrap.Tab.getInstance(document.querySelector('#maintenance-plan-tab')).show();
      document.getElementById("maintenanceForm").scrollIntoView({ behavior: 'smooth' });
      
      showToast('Task loaded for editing', 'info');
    }

    function deleteTask(index) {
      const modal = new bootstrap.Modal(document.createElement('div'));
      modal._element.innerHTML = `
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">Confirm Delete</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <p>Are you sure you want to delete this task?</p>
              <p class="text-danger">This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
              <button type="button" class="btn btn-danger" data-bs-dismiss="modal" id="confirmDeleteTask">Delete</button>
            </div>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal._element);
      modal.show();
      
      document.getElementById('confirmDeleteTask').addEventListener('click', function() {
        ecoData.maintenance.splice(index, 1);
        saveData();
        renderMaintenanceTasks();
        showToast('Task deleted', 'success');
      });
      
      // Clean up modal after close
      modal._element.addEventListener('hidden.bs.modal', function() {
        document.body.removeChild(modal._element);
      });
    }

    // Filter species by type
    function filterSpecies(type) {
      switch(type) {
        case 'all':
          paginationConfig.species.filteredData = [...ecoData.species];
          break;
        case 'native':
          paginationConfig.species.filteredData = ecoData.species.filter(s => s.type === 'Native');
          break;
        case 'weed':
          paginationConfig.species.filteredData = ecoData.species.filter(s => s.type === 'Weed');
          break;
      }
      
      paginationConfig.species.currentPage = 1;
      renderSpeciesList();
    }

    // Render species list with pagination
    function renderSpeciesList() {
      const body = document.getElementById("speciesTableBody");
      body.innerHTML = "";
      
      const { currentPage, itemsPerPage, filteredData } = paginationConfig.species;
      const startIndex = (currentPage - 1) * itemsPerPage;
      const paginatedItems = filteredData.slice(startIndex, startIndex + itemsPerPage);
      
      if (paginatedItems.length === 0) {
        body.innerHTML = `
          <tr>
            <td colspan="4" class="text-center py-4 text-muted">
              No species found
            </td>
          </tr>
        `;
      } else {
        // Sort alphabetically by name
        const sortedSpecies = [...paginatedItems].sort((a, b) => a.name.localeCompare(b.name));
        
        sortedSpecies.forEach((sp, i) => {
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${sp.name}</td>
            <td>
              <span class="badge species-badge ${getSpeciesBadgeClass(sp.type)}">
                ${sp.type}
              </span>
            </td>
            <td>${sp.notes || "-"}</td>
            <td>
              <button class="btn btn-sm btn-outline-primary me-1" onclick="editSpecies(${startIndex + i})">
                <i class="bi bi-pencil"></i>
              </button>
              <button class="btn btn-sm btn-outline-danger" onclick="deleteSpecies(${startIndex + i})">
                <i class="bi bi-trash"></i>
              </button>
            </td>
          `;
          body.appendChild(row);
        });
      }
      
      // Update pagination info
      document.getElementById("speciesPaginationInfo").textContent = 
        `Showing ${startIndex + 1}-${Math.min(startIndex + itemsPerPage, filteredData.length)} of ${filteredData.length} species`;
      
      // Update pagination buttons
      document.getElementById("prevSpeciesPage").disabled = currentPage === 1;
      document.getElementById("nextSpeciesPage").disabled = 
        currentPage * itemsPerPage >= filteredData.length;
    }

    function getSpeciesBadgeClass(type) {
      switch(type.toLowerCase()) {
        case 'native': return 'species-native';
        case 'weed': return 'species-weed';
        case 'introduced': return 'species-introduced';
        default: return 'species-unknown';
      }
    }

    function editSpecies(index) {
      const species = ecoData.species[index];
      document.getElementById("speciesName").value = species.name;
      document.getElementById("speciesType").value = species.type;
      document.getElementById("speciesNotes").value = species.notes || '';
      
      // Remove the species from the array
      ecoData.species.splice(index, 1);
      saveData();
      renderSpeciesList();
      
      // Scroll to form and switch tab
      bootstrap.Tab.getInstance(document.querySelector('#species-register-tab')).show();
      document.getElementById("speciesForm").scrollIntoView({ behavior: 'smooth' });
      
      showToast('Species loaded for editing', 'info');
    }

    function deleteSpecies(index) {
      const modal = new bootstrap.Modal(document.createElement('div'));
      modal._element.innerHTML = `
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">Confirm Delete</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <p>Are you sure you want to delete this species?</p>
              <p class="text-danger">This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
              <button type="button" class="btn btn-danger" data-bs-dismiss="modal" id="confirmDeleteSpecies">Delete</button>
            </div>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal._element);
      modal.show();
      
      document.getElementById('confirmDeleteSpecies').addEventListener('click', function() {
        ecoData.species.splice(index, 1);
        saveData();
        renderSpeciesList();
        showToast('Species deleted', 'success');
      });
      
      // Clean up modal after close
      modal._element.addEventListener('hidden.bs.modal', function() {
        document.body.removeChild(modal._element);
      });
    }

    // Search monitoring entries
    function searchMonitoring() {
      const searchTerm = document.getElementById("monitoringSearch").value.toLowerCase();
      
      if (!searchTerm) {
        paginationConfig.monitoring.filteredData = [...ecoData.monitoring];
      } else {
        paginationConfig.monitoring.filteredData = ecoData.monitoring.filter(m => 
          m.date.toLowerCase().includes(searchTerm) ||
          m.observer.toLowerCase().includes(searchTerm) ||
          m.area?.toLowerCase().includes(searchTerm) ||
          m.weather?.toLowerCase().includes(searchTerm) ||
          m.notes?.toLowerCase().includes(searchTerm)
        );
      }
      
      paginationConfig.monitoring.currentPage = 1;
      renderMonitoringEntries();
    }

    // Render monitoring entries with pagination
    function renderMonitoringEntries() {
      const body = document.getElementById("monitoringTableBody");
      body.innerHTML = "";
      
      const { currentPage, itemsPerPage, filteredData } = paginationConfig.monitoring;
      const startIndex = (currentPage - 1) * itemsPerPage;
      const paginatedItems = filteredData.slice(startIndex, startIndex + itemsPerPage);
      
      if (paginatedItems.length === 0) {
        body.innerHTML = `
          <tr>
            <td colspan="6" class="text-center py-4 text-muted">
              No monitoring entries found
            </td>
          </tr>
        `;
      } else {
        // Sort by date (newest first)
        const sortedEntries = [...paginatedItems].sort((a, b) => new Date(b.date) - new Date(a.date));
        
        sortedEntries.forEach((entry, i) => {
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${entry.date}</td>
            <td>${entry.observer}</td>
            <td>${entry.area || "-"}</td>
            <td>${entry.weather || "-"}</td>
            <td class="text-truncate" style="max-width: 200px;" title="${entry.notes}">
              ${entry.notes || "-"}
            </td>
            <td>
              <button class="btn btn-sm btn-outline-primary me-1" onclick="viewMonitoringEntry(${startIndex + i})">
                <i class="bi bi-eye"></i>
              </button>
              <button class="btn btn-sm btn-outline-danger" onclick="deleteMonitoringEntry(${startIndex + i})">
                <i class="bi bi-trash"></i>
              </button>
            </td>
          `;
          body.appendChild(row);
        });
      }
      
      // Update pagination info
      document.getElementById("monitoringPaginationInfo").textContent = 
        `Showing ${startIndex + 1}-${Math.min(startIndex + itemsPerPage, filteredData.length)} of ${filteredData.length} entries`;
      
      // Update pagination buttons
      document.getElementById("prevMonitoringPage").disabled = currentPage === 1;
      document.getElementById("nextMonitoringPage").disabled = 
        currentPage * itemsPerPage >= filteredData.length;
    }

    function viewMonitoringEntry(index) {
      const entry = ecoData.monitoring[index];
      const modalHtml = `
        <div class="modal fade" id="monitoringModal" tabindex="-1" aria-hidden="true">
          <div class="modal-dialog modal-lg">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">Monitoring Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                <div class="row mb-3">
                  <div class="col-md-4">
                    <p><strong>Date:</strong> ${entry.date}</p>
                  </div>
                  <div class="col-md-4">
                    <p><strong>Observer:</strong> ${entry.observer}</p>
                  </div>
                  <div class="col-md-4">
                    <p><strong>Weather:</strong> ${entry.weather || 'Not recorded'}</p>
                  </div>
                </div>
                <div class="mb-3">
                  <p><strong>Location:</strong> ${entry.area || 'Not specified'}</p>
                </div>
                <div class="mb-3">
                  <h6>Observations</h6>
                  <p>${entry.notes || 'No observations recorded.'}</p>
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="editMonitoringEntry(${index})">
                  <i class="bi bi-pencil"></i> Edit
                </button>
              </div>
            </div>
          </div>
        </div>
      `;
      
      const modalContainer = document.createElement('div');
      modalContainer.innerHTML = modalHtml;
      document.body.appendChild(modalContainer);
      
      const modal = new bootstrap.Modal(document.getElementById('monitoringModal'));
      modal.show();
      
      // Remove modal from DOM after it's hidden
      document.getElementById('monitoringModal').addEventListener('hidden.bs.modal', function() {
        document.body.removeChild(modalContainer);
      });
    }

    // Edit monitoring entry
    function editMonitoringEntry(index) {
      const entry = ecoData.monitoring[index];
      
      // Fill the form with entry data
      document.getElementById("monitoringDate").value = entry.date;
      document.getElementById("monitoringObserver").value = entry.observer;
      document.getElementById("monitoringArea").value = entry.area || '';
      document.getElementById("monitoringWeather").value = entry.weather || '';
      document.getElementById("monitoringNotes").value = entry.notes;
      
      // Remove the entry from the array
      ecoData.monitoring.splice(index, 1);
      saveData();
      renderMonitoringEntries();
      
      // Scroll to form and switch tab
      bootstrap.Tab.getInstance(document.querySelector('#monitoring-tab')).show();
      document.getElementById("monitoringForm").scrollIntoView({ behavior: 'smooth' });
      
      showToast('Monitoring entry loaded for editing', 'info');
    }

    function deleteMonitoringEntry(index) {
      const modal = new bootstrap.Modal(document.createElement('div'));
      modal._element.innerHTML = `
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">Confirm Delete</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <p>Are you sure you want to delete this monitoring record?</p>
              <p class="text-danger">This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
              <button type="button" class="btn btn-danger" data-bs-dismiss="modal" id="confirmDeleteMonitoring">Delete</button>
            </div>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal._element);
      modal.show();
      
      document.getElementById('confirmDeleteMonitoring').addEventListener('click', function() {
        ecoData.monitoring.splice(index, 1);
        saveData();
        renderMonitoringEntries();
        showToast('Monitoring entry deleted', 'success');
      });
      
      // Clean up modal after close
      modal._element.addEventListener('hidden.bs.modal', function() {
        document.body.removeChild(modal._element);
      });
    }

    // Generate reports with more options
    function generateReport() {
      const report = [];
      const today = new Date().toISOString().split('T')[0];
      
      // Header
      report.push(`
        <div class="report-header mb-4">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h3>Ecosystem Maintenance Report</h3>
              <p class="text-muted">Generated on ${today}</p>
              ${ecoData.settings.site.name ? `<h4>${ecoData.settings.site.name}</h4>` : ''}
              ${ecoData.settings.site.location ? `<p><i class="bi bi-geo-alt"></i> ${ecoData.settings.site.location}</p>` : ''}
            </div>
            <div class="text-end">
              ${ecoData.settings.user.name ? `<p><strong>Prepared by:</strong> ${ecoData.settings.user.name}</p>` : ''}
              ${ecoData.settings.user.role ? `<p><strong>Role:</strong> ${ecoData.settings.user.role}</p>` : ''}
            </div>
          </div>
          <hr>
        </div>
      `);
      
      // Summary Stats
      report.push(`
        <div class="row mb-4">
          <div class="col-md-3">
            <div class="card bg-light">
              <div class="card-body text-center">
                <h5 class="card-title">Assessments</h5>
                <h2 class="card-text">${ecoData.assessments.length}</h2>
                ${ecoData.assessments.length > 0 ? `
                  <small>Last: ${[...ecoData.assessments].sort((a, b) => new Date(b.date) - new Date(a.date))[0].date}</small>
                ` : ''}
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card bg-light">
              <div class="card-body text-center">
                <h5 class="card-title">Tasks</h5>
                <h2 class="card-text">${ecoData.maintenance.length}</h2>
                <small>${ecoData.maintenance.filter(t => t.done).length} completed</small>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card bg-light">
              <div class="card-body text-center">
                <h5 class="card-title">Species</h5>
                <h2 class="card-text">${ecoData.species.length}</h2>
                <small>${ecoData.species.filter(s => s.type === 'Native').length} native</small>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card bg-light">
              <div class="card-body text-center">
                <h5 class="card-title">Monitoring</h5>
                <h2 class="card-text">${ecoData.monitoring.length}</h2>
                ${ecoData.monitoring.length > 0 ? `
                  <small>Last: ${[...ecoData.monitoring].sort((a, b) => new Date(b.date) - new Date(a.date))[0].date}</small>
                ` : ''}
              </div>
            </div>
          </div>
        </div>
      `);
      
      // Site Assessments
      report.push("<h4 class='mt-4'>Site Assessments</h4>");
      if (ecoData.assessments.length) {
        report.push("<div class='table-responsive'><table class='table table-sm'><thead><tr><th>Date</th><th>Assessor</th><th>Health</th><th>Threats</th></tr></thead><tbody>");
        
        // Sort by date (newest first)
        const sortedAssessments = [...ecoData.assessments].sort((a, b) => new Date(b.date) - new Date(a.date));
        
        sortedAssessments.forEach(a => {
          report.push(`
            <tr>
              <td>${a.date}</td>
              <td>${a.assessor}</td>
              <td><span class="badge ${getHealthBadgeClass(a.health)}">${a.health}</span></td>
              <td>${a.threats?.join(', ') || 'None'}</td>
            </tr>
          `);
        });
        report.push("</tbody></table></div>");
        
        // Add health summary
        const healthCounts = {};
        ecoData.assessments.forEach(a => {
          healthCounts[a.health] = (healthCounts[a.health] || 0) + 1;
        });
        
        report.push("<h5 class='mt-3'>Health Summary</h5>");
        report.push("<div class='row'>");
        
        Object.entries(healthCounts).forEach(([health, count]) => {
          const percentage = Math.round((count / ecoData.assessments.length) * 100);
          report.push(`
            <div class="col-md-3 mb-3">
              <div class="card">
                <div class="card-body text-center">
                  <span class="badge ${getHealthBadgeClass(health)} mb-2">${health}</span>
                  <h4>${count}</h4>
                  <small>${percentage}% of assessments</small>
                </div>
              </div>
            </div>
          `);
        });
        
        report.push("</div>");
      } else {
        report.push("<div class='alert alert-info'>No assessments recorded.</div>");
      }
      
      // Maintenance Tasks
      report.push("<h4 class='mt-4'>Maintenance Tasks</h4>");
      if (ecoData.maintenance.length) {
        const completed = ecoData.maintenance.filter(t => t.done).length;
        const pending = ecoData.maintenance.length - completed;
        
        report.push(`
          <div class="mb-3">
            <div class="progress" style="height: 20px;">
              <div class="progress-bar bg-success" role="progressbar" 
                style="width: ${(completed / ecoData.maintenance.length) * 100}%" 
                aria-valuenow="${completed}" aria-valuemin="0" aria-valuemax="${ecoData.maintenance.length}">
                ${completed} completed
              </div>
              <div class="progress-bar bg-warning" role="progressbar" 
                style="width: ${(pending / ecoData.maintenance.length) * 100}%" 
                aria-valuenow="${pending}" aria-valuemin="0" aria-valuemax="${ecoData.maintenance.length}">
                ${pending} pending
              </div>
            </div>
          </div>
        `);
        
        // Tasks by category
        const tasksByCategory = {};
        ecoData.maintenance.forEach(t => {
          tasksByCategory[t.category] = (tasksByCategory[t.category] || 0) + 1;
        });
        
        report.push("<h5 class='mt-3'>Tasks by Category</h5>");
        report.push("<div class='row'>");
        
        Object.entries(tasksByCategory).forEach(([category, count]) => {
          report.push(`
            <div class="col-md-3 mb-3">
              <div class="card">
                <div class="card-body text-center">
                  <h5>${category}</h5>
                  <h3>${count}</h3>
                  <small>${Math.round((count / ecoData.maintenance.length) * 100)}% of tasks</small>
                </div>
              </div>
            </div>
          `);
        });
        
        report.push("</div>");
        
        // Task list
        report.push("<h5 class='mt-3'>Task Details</h5>");
        report.push("<div class='table-responsive'><table class='table table-sm'><thead><tr><th>Task</th><th>Category</th><th>Due</th><th>Status</th></tr></thead><tbody>");
        
        // Sort by due date
        const sortedTasks = [...ecoData.maintenance].sort((a, b) => new Date(a.due) - new Date(b.due));
        
        sortedTasks.forEach(t => {
          report.push(`
            <tr class="${t.done ? 'table-secondary' : ''}">
              <td class="${t.done ? 'task-completed' : ''}">${t.name}</td>
              <td>${t.category}</td>
              <td>${t.due}</td>
              <td><span class="badge ${t.done ? 'bg-success' : 'bg-warning'}">${t.done ? "Completed" : "Pending"}</span></td>
            </tr>
          `);
        });
        report.push("</tbody></table></div>");
      } else {
        report.push("<div class='alert alert-info'>No maintenance tasks added.</div>");
      }
      
      // Species
      report.push("<h4 class='mt-4'>Species Register</h4>");
      if (ecoData.species.length) {
        const speciesByType = {};
        ecoData.species.forEach(s => {
          speciesByType[s.type] = (speciesByType[s.type] || 0) + 1;
        });
        
        // Species distribution
        report.push("<h5 class='mt-3'>Species Distribution</h5>");
        report.push("<div class='row'>");
        
        Object.entries(speciesByType).forEach(([type, count]) => {
          report.push(`
            <div class="col-md-3 mb-3">
              <div class="card">
                <div class="card-body text-center">
                  <span class="badge species-badge ${getSpeciesBadgeClass(type)} mb-2">${type}</span>
                  <h3>${count}</h3>
                  <small>${Math.round((count / ecoData.species.length) * 100)}% of species</small>
                </div>
              </div>
            </div>
          `);
        });
        
        report.push("</div>");
        
        // Species list
        report.push("<h5 class='mt-3'>Species List</h5>");
        report.push("<div class='table-responsive'><table class='table table-sm'><thead><tr><th>Name</th><th>Type</th><th>Notes</th></tr></thead><tbody>");
        
        // Sort alphabetically
        const sortedSpecies = [...ecoData.species].sort((a, b) => a.name.localeCompare(b.name));
        
        sortedSpecies.forEach(s => {
          report.push(`
            <tr>
              <td>${s.name}</td>
              <td><span class="badge species-badge ${getSpeciesBadgeClass(s.type)}">${s.type}</span></td>
              <td>${s.notes || '-'}</td>
            </tr>
          `);
        });
        report.push("</tbody></table></div>");
      } else {
        report.push("<div class='alert alert-info'>No species recorded.</div>");
      }
      
 // Monitoring
report.push("<h4 class='mt-4'>Monitoring Logs</h4>");
if (ecoData.monitoring.length) {
  // Monitoring frequency
  const monitoringByMonth = {};
  ecoData.monitoring.forEach(m => {
    const month = m.date.substring(0, 7); // YYYY-MM
    monitoringByMonth[month] = (monitoringByMonth[month] || 0) + 1;
  });
  
  report.push("<h5 class='mt-3'>Monitoring Frequency</h5>");
  report.push("<div class='row'>");
  
  // Chart visualization
  report.push(`
    <div class="col-md-6 mb-4">
      <div class="card h-100">
        <div class="card-body">
          <canvas id="monitoringChart"></canvas>
        </div>
      </div>
    </div>
  `);
  
  // Monthly counts
  report.push(`
    <div class="col-md-6 mb-4">
      <div class="card h-100">
        <div class="card-body">
          <table class="table table-sm">
            <thead>
              <tr>
                <th>Month</th>
                <th>Count</th>
              </tr>
            </thead>
            <tbody>
  `);
  
  // Sort months chronologically
  const sortedMonths = Object.keys(monitoringByMonth).sort();
  sortedMonths.forEach(month => {
    report.push(`
      <tr>
        <td>${month}</td>
        <td>${monitoringByMonth[month]}</td>
      </tr>
    `);
  });
  
  report.push(`
            </tbody>
          </table>
        </div>
      </div>
    </div>
  `);
  
  report.push("</div>"); // Close row
  
  // Detailed monitoring log
  report.push("<h5 class='mt-3'>Monitoring Details</h5>");
  report.push("<div class='table-responsive'><table class='table table-sm'><thead><tr><th>Date</th><th>Observer</th><th>Type</th><th>Notes</th></tr></thead><tbody>");
  
  // Sort by date (newest first)
  const sortedMonitoring = [...ecoData.monitoring].sort((a, b) => new Date(b.date) - new Date(a.date));
  
  sortedMonitoring.forEach(m => {
    report.push(`
      <tr>
        <td>${m.date}</td>
        <td>${m.observer}</td>
        <td><span class="badge ${getMonitoringTypeBadgeClass(m.type)}">${m.type}</span></td>
        <td>${m.notes || '-'}</td>
      </tr>
    `);
  });
  
  report.push("</tbody></table></div>");
} else {
  report.push("<div class='alert alert-info'>No monitoring data recorded.</div>");
}





                <div class="card h-100">
                  <div class="card-body">
                    <h5 class="card-title">Site Information</h5>
                    <form id="siteSettingsForm">
                      <div class="mb-3">
                        <label for="siteName" class="form-label">Site Name</label>
                        <input type="text" class="form-control" id="siteName" placeholder="Enter site name">
                      </div>
                      <div class="mb-3">
                        <label for="siteLocation" class="form-label">Location</label>
                        <input type="text" class="form-control" id="siteLocation" placeholder="Enter location coordinates or address">
                      </div>
                      <div class="mb-3">
                        <label for="siteDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="siteDescription" rows="3" placeholder="Enter site description"></textarea>
                      </div>
                      <div class="d-grid">
                        <button type="submit" class="btn btn-primary">
                          <i class="bi bi-save"></i> Save Site Info
                        </button>
                      </div>
                    </form>
                  </div>
                </div>
              </div>
              
              <div class="col-md-6 mb-4">
                <div class="card h-100">
                  <div class="card-body">
                    <h5 class="card-title">User Preferences</h5>
                    <form id="userSettingsForm">
                      <div class="mb-3">
                        <label for="userName" class="form-label">Your Name</label>
                        <input type="text" class="form-control" id="userName" required placeholder="Enter your name">
                      </div>
                      <div class="mb-3">
                        <label for="userRole" class="form-label">Your Role</label>
                        <input type="text" class="form-control" id="userRole" placeholder="Enter your role">
                      </div>
                      <div class="mb-3 form-check form-switch">
                        <input type="checkbox" class="form-check-input" id="darkMode" onchange="toggleDarkMode()">
                        <label class="form-check-label" for="darkMode">Dark Mode</label>
                      </div>
                      <div class="d-grid">
                        <button type="submit" class="btn btn-primary">
                          <i class="bi bi-save"></i> Save Preferences
                        </button>
                      </div>
                    </form>
                  </div>
                </div>
              </div>
            </div>
            
            <div class="card border-danger">
              <div class="card-body">
                <h5 class="card-title text-danger">Danger Zone</h5>
                <p class="card-text">These actions cannot be undone.</p>
                <div class="d-flex flex-wrap gap-2">
                  <button class="btn btn-outline-danger" onclick="clearData()">
                    <i class="bi bi-trash"></i> Clear All Data
                  </button>
                  <button class="btn btn-danger" onclick="exportAllData()">
                    <i class="bi bi-download"></i> Export All Data
                  </button>
                  <button class="btn btn-outline-secondary" onclick="importData()">
                    <i class="bi bi-upload"></i> Import Data
                  </button>
                  <input type="file" id="dataImport" style="display: none;" accept=".json" onchange="handleFileImport(this)">
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Floating action button -->
  <button class="btn btn-primary btn-float d-md-none" onclick="scrollToTop()">
    <i class="bi bi-arrow-up"></i>
  </button>

  <!-- Toast notifications -->
  <div class="toast-container">
    <div class="toast align-items-center text-white bg-success" id="successToast" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body">
          <i class="bi bi-check-circle me-2"></i>
          <span id="successToastMessage">Operation completed successfully</span>
        </div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
    </div>
    
    <div class="toast align-items-center text-white bg-danger" id="errorToast" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body">
          <i class="bi bi-exclamation-triangle me-2"></i>
          <span id="errorToastMessage">An error occurred</span>
        </div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
    </div>
  </div>

  <!-- Help Modals -->
  <div class="modal fade" id="helpModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="helpModalTitle">Help</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="helpModalContent">
          <!-- Content will be loaded dynamically -->
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- JS Dependencies -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<!-- Main Script -->
<script>
  // Initialize data structure with sample data for demonstration
  let ecoData = {
    settings: {
      user: {},
      site: {},
      darkMode: false
    },
    assessments: [],
    maintenance: [],
    species: [],
    monitoring: [],
    mapMarkers: []
  };

  // Pagination variables
  const paginationConfig = {
    assessments: { currentPage: 1, itemsPerPage: 5, filteredData: [] },
    maintenance: { currentPage: 1, itemsPerPage: 5, filteredData: [] },
    species: { currentPage: 1, itemsPerPage: 5, filteredData: [] },
    monitoring: { currentPage: 1, itemsPerPage: 5, filteredData: [] }
  };

  // Load data from localStorage
  function loadData() {
      // Set default observer name if available
      const observerField = document.getElementById('monitoringObserver');
      if (observerField && ecoData.settings.user.name) {
        observerField.value = ecoData.settings.user.name;
      }

    const saved = localStorage.getItem("ecoMaintainData");
    if (saved) {
      try { 
        ecoData = JSON.parse(saved); 
        updateDashboardCounts();
        showToast('Data loaded successfully', 'success');
      }
      catch (e) { 
        console.error("Error loading data", e); 
        showToast('Error loading saved data. Starting with fresh data.', 'danger');
      }
    }
    
    // Initialize filtered data for pagination
    paginationConfig.assessments.filteredData = [...ecoData.assessments];
    paginationConfig.maintenance.filteredData = [...ecoData.maintenance];
    paginationConfig.species.filteredData = [...ecoData.species];
    paginationConfig.monitoring.filteredData = [...ecoData.monitoring];
    
    // Apply dark mode if enabled
    if (ecoData.settings.darkMode) {
      document.body.classList.add('dark-mode');
      document.getElementById('darkMode').checked = true;
    }
  }

  // Save data to localStorage
  function saveData() {
    try {
      localStorage.setItem("ecoMaintainData", JSON.stringify(ecoData));
      updateDashboardCounts();
      showToast('Data saved successfully', 'success');
    } catch (e) {
      console.error("Error saving", e);
      showToast('Error saving data. Check console for details.', 'danger');
    }
  }

  // Clear all data
  function clearData() {
    if (confirm("This will permanently delete ALL your data. Are you sure?")) {
      localStorage.removeItem("ecoMaintainData");
      localStorage.removeItem("dashboardMapShapes");
      ecoData = {
        settings: { user: {}, site: {}, darkMode: document.body.classList.contains('dark-mode') },
        assessments: [],
        maintenance: [],
        species: [],
        monitoring: [],
        mapMarkers: []
      };
      saveData();
      location.reload();
    }
  }

  // Import data from file
  function importData() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.json';
    
    input.onchange = e => {
      const file = e.target.files[0];
      const reader = new FileReader();
      
      reader.onload = event => {
        try {
          const importedData = JSON.parse(event.target.result);
          if (confirm("This will overwrite your current data. Continue?")) {
            ecoData = importedData;
            saveData();
            location.reload();
          }
        } catch (err) {
          console.error("Error importing data", err);
          showToast('Invalid data file. Please check the format.', 'danger');
        }
      };
      
      reader.readAsText(file);
    };
    
    input.click();
  }

  // Update dashboard counters with additional stats
  function updateDashboardCounts() {
    document.getElementById("assessmentCount").textContent = ecoData.assessments.length;
    document.getElementById("completedTasks").textContent = ecoData.maintenance.filter(t => t.done).length;
    document.getElementById("pendingTasks").textContent = ecoData.maintenance.filter(t => !t.done).length;
    document.getElementById("speciesCount").textContent = ecoData.species.length;
    document.getElementById("monitoringCount").textContent = ecoData.monitoring.length;
    
    // Native species count
    const nativeCount = ecoData.species.filter(s => s.type === 'Native').length;
    document.getElementById("nativeSpecies").textContent = nativeCount;
    
    // Last assessment date
    if (ecoData.assessments.length > 0) {
      const lastAssessment = [...ecoData.assessments].sort((a, b) => new Date(b.date) - new Date(a.date))[0];
      document.getElementById("lastAssessmentDate").textContent = lastAssessment.date;
    } else {
      document.getElementById("lastAssessmentDate").textContent = 'Never';
    }
    
    // Last monitoring date
    if (ecoData.monitoring.length > 0) {
      const lastMonitoring = [...ecoData.monitoring].sort((a, b) => new Date(b.date) - new Date(a.date))[0];
      document.getElementById("lastMonitoringDate").textContent = lastMonitoring.date;
    } else {
      document.getElementById("lastMonitoringDate").textContent = 'Never';
    }
    
    // Update recent activity
    updateRecentActivity();
    
    // Update upcoming tasks
    updateUpcomingTasks();
  }

  // Update recent activity list
  function updateRecentActivity() {
    const container = document.getElementById("recentActivity");
    container.innerHTML = "";
    
    // Combine different types of activities with timestamps
    const activities = [];
    
    ecoData.assessments.forEach(a => {
      activities.push({
        type: 'assessment',
        date: a.date,
        title: `Assessment by ${a.assessor}`,
        content: `Health: ${a.health}`,
        icon: 'bi-clipboard-data'
      });
    });
    
    ecoData.maintenance.forEach(t => {
      activities.push({
        type: 'task',
        date: t.due,
        title: `Task: ${t.name}`,
        content: `Status: ${t.done ? 'Completed' : 'Pending'}`,
        icon: t.done ? 'bi-check-circle' : 'bi-exclamation-circle'
      });
    });
    
    ecoData.monitoring.forEach(m => {
      activities.push({
        type: 'monitoring',
        date: m.date,
        title: `Monitoring by ${m.observer}`,
        content: `Location: ${m.area || 'Unknown'}`,
        icon: 'bi-binoculars'
      });
    });
    
    // Sort by date (newest first)
    activities.sort((a, b) => new Date(b.date) - new Date(a.date));
    
    // Show only the 5 most recent
    const recentActivities = activities.slice(0, 5);
    
    if (recentActivities.length === 0) {
      container.innerHTML = `
        <div class="list-group-item text-center text-muted py-4">
          No recent activity
        </div>
      `;
      return;
    }
    
    recentActivities.forEach(activity => {
      const item = document.createElement('a');
      item.className = 'list-group-item list-group-item-action';
      item.innerHTML = `
        <div class="d-flex w-100 justify-content-between">
          <h6 class="mb-1"><i class="bi ${activity.icon} me-2"></i>${activity.title}</h6>
          <small class="text-muted">${activity.date}</small>
        </div>
        <p class="mb-1">${activity.content}</p>
      `;
      container.appendChild(item);
    });
  }

  // Update upcoming tasks list
  function updateUpcomingTasks() {
    const container = document.getElementById("upcomingTasks");
    container.innerHTML = "";
    
    // Get upcoming tasks (not completed and due in the next 14 days)
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    const futureDate = new Date();
    futureDate.setDate(today.getDate() + 14);
    
    const upcomingTasks = ecoData.maintenance
      .filter(task => !task.done)
      .filter(task => {
        const dueDate = new Date(task.due);
        return dueDate >= today && dueDate <= futureDate;
      })
      .sort((a, b) => new Date(a.due) - new Date(b.due));
    
    if (upcomingTasks.length === 0) {
      container.innerHTML = `
        <div class="list-group-item text-center text-muted py-4">
          No upcoming tasks
        </div>
      `;
      return;
    }
    
    upcomingTasks.slice(0, 5).forEach(task => {
      const dueDate = new Date(task.due);
      const daysDiff = Math.floor((dueDate - today) / (1000 * 60 * 60 * 24));
      
      let badgeClass = 'bg-secondary';
      let dueText = '';
      
      if (daysDiff === 0) {
        badgeClass = 'bg-warning';
        dueText = 'Today';
      } else if (daysDiff < 0) {
        badgeClass = 'bg-danger';
        dueText = `${Math.abs(daysDiff)} day(s) overdue`;
      } else {
        badgeClass = 'bg-info';
        dueText = `In ${daysDiff} day(s)`;
      }
      
      const item = document.createElement('a');
      item.className = 'list-group-item list-group-item-action';
      item.innerHTML = `
        <div class="d-flex w-100 justify-content-between">
          <h6 class="mb-1">${task.name}</h6>
          <span class="badge ${badgeClass}">${dueText}</span>
        </div>
        <p class="mb-1"><small class="text-muted">${task.category} â€¢ Due ${dueDate.toLocaleDateString()}</small></p>
      `;
      container.appendChild(item);
    });
  }

  // Initialize the dashboard map with more features
  function initDashboardMap() {
    const map = L.map("dashboardMap").setView([-42.8821, 147.3272], 13);

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);

    // Add different base maps
    const baseLayers = {
      "OpenStreetMap": L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19,
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
      }),
      "Satellite": L.tileLayer("https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}", {
        attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
      }),
      "Topographic": L.tileLayer("https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png", {
        maxZoom: 17,
        attribution: 'Map data: &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, <a href="http://viewfinderpanoramas.org">SRTM</a> | Map style: &copy; <a href="https://opentopomap.org">OpenTopoMap</a> (<a href="https://creativecommons.org/licenses/by-sa/3.0/">CC-BY-SA</a>)'
      })
    };

    baseLayers.OpenStreetMap.addTo(map);

    // Geocoder with more options
    const geocoder = L.Control.geocoder({
      defaultMarkGeocode: false,
      placeholder: "Search for location...",
      errorMessage: "Location not found.",
      geocoder: new L.Control.Geocoder.Nominatim({
        geocodingQueryParams: {
          countrycodes: 'au', // Focus on Australia
          limit: 5
        }
      })
    })
    .on("markgeocode", function (e) {
      const bbox = e.geocode.bbox;
      const poly = L.polygon([
        bbox.getSouthEast(),
        bbox.getNorthEast(),
        bbox.getNorthWest(),
        bbox.getSouthWest()
      ]).addTo(map);
      map.fitBounds(poly.getBounds());
      
      // Add a marker with the location name
      L.marker(e.geocode.center).addTo(map)
        .bindPopup(`<strong>${e.geocode.name}</strong>`)
        .openPopup();
    })
    .addTo(map);

    // Drawing feature layer
    const drawnItems = new L.FeatureGroup();
    map.addLayer(drawnItems);

    // Initialize draw control with more options
    const drawControl = new L.Control.Draw({
      edit: {
        featureGroup: drawnItems,
        remove: true,
        edit: false
      },
      draw: {
        polygon: {
          allowIntersection: false,
          drawError: {
            color: '#b00b00',
            message: '<strong>Error:</strong> polygon edges cannot cross!'
          },
          shapeOptions: {
            color: '#3388ff',
            fillOpacity: 0.2
          },
          showArea: true,
          metric: true
        },
        polyline: false,
        rectangle: {
          shapeOptions: {
            color: '#3388ff',
            fillOpacity: 0.2
          }
        },
        circle: {
          shapeOptions: {
            color: '#3388ff',
            fillOpacity: 0.2
          },
          showRadius: true,
          metric: true
        },
        circlemarker: false,
        marker: {
          icon: L.icon({
            iconUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png',
            shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowSize: [41, 41]
          })
        }
      }
    });
    map.addControl(drawControl);

    // Add layer control
    const overlayMaps = {
      "Drawings": drawnItems
    };
    
    L.control.layers(baseLayers, overlayMaps, {
      collapsed: false,
      position: 'topleft'
    }).addTo(map);

    // Load saved shapes
    const savedShapes = localStorage.getItem("dashboardMapShapes");
    if (savedShapes) {
      const geojson = JSON.parse(savedShapes);
      L.geoJSON(geojson, {
        onEachFeature: (feature, layer) => {
          if (feature.properties.type === 'photo') {
            layer.bindPopup(`
              <div class="text-center">
                <img src="${feature.properties.photo}" style="max-width: 200px; max-height: 150px;" class="img-thumbnail mb-2">
                <p class="mb-1"><strong>${feature.properties.title || 'Photo'}</strong></p>
                <small class="text-muted">${feature.properties.date || ''}</small>
              </div>
            `);
          } else if (feature.properties.type === 'assessment') {
            layer.bindPopup(`
              <div>
                <h6>Assessment Point</h6>
                <p><strong>Date:</strong> ${feature.properties.date}</p>
                <p><strong>Assessor:</strong> ${feature.properties.assessor}</p>
                <p><strong>Health:</strong> <span class="badge ${getHealthBadgeClass(feature.properties.health)}">${feature.properties.health}</span></p>
                <a href="#site-assessment" class="btn btn-sm btn-primary mt-2" onclick="bootstrap.Tab.getInstance(document.querySelector('#site-assessment-tab')).show()">
                  View Details
                </a>
              </div>
            `);
          }
          drawnItems.addLayer(layer);
        }
      });
    }

    // Save on draw
    map.on(L.Draw.Event.CREATED, function (e) {
      const layer = e.layer;
      drawnItems.addLayer(layer);
      saveMapShapes();
    });

    // Save on edit/delete
    map.on(L.Draw.Event.EDITED, saveMapShapes);
    map.on(L.Draw.Event.DELETED, saveMapShapes);

    function saveMapShapes() {
      const data = drawnItems.toGeoJSON();
      localStorage.setItem("dashboardMapShapes", JSON.stringify(data));
    }

    window.dashboardMap = map;
    window.drawnItems = drawnItems;
  }

  // Add assessment marker to map
  function addAssessmentMarker() {
    if (ecoData.assessments.length === 0) {
      alert("No assessments available to plot. Please create an assessment first.");
      return;
    }
    
    // Show assessment selector
    const assessmentList = ecoData.assessments
      .map(a => `<option value="${a.date}">${a.date} - ${a.assessor} (${a.health})</option>`)
      .join('');
    
    const assessmentSelect = `
      <div class="mb-3">
        <label for="selectAssessment" class="form-label">Select Assessment</label>
        <select class="form-select" id="selectAssessment">
          ${assessmentList}
        </select>
      </div>
    `;
    
    const modal = new bootstrap.Modal(document.createElement('div'));
    modal._element.innerHTML = `
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Add Assessment Marker</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            ${assessmentSelect}
            <p class="mt-3">Click on the map to place the marker for the selected assessment.</p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-primary" data-bs-dismiss="modal" id="confirmAssessmentMarker">Confirm</button>
          </div>
        </div>
      </div>
    `;
    
    document.body.appendChild(modal._element);
    modal.show();
    
    document.getElementById('confirmAssessmentMarker').addEventListener('click', function() {
      const selectedDate = document.getElementById('selectAssessment').value;
      const assessment = ecoData.assessments.find(a => a.date === selectedDate);
      
      if (!assessment) return;
      
      window.dashboardMap.once('click', function(e) {
        const marker = L.marker(e.latlng).addTo(window.drawnItems);
        
        // Add custom properties
        marker.feature = {
          type: 'Feature',
          properties: {
            type: 'assessment',
            date: assessment.date,
            assessor: assessment.assessor,
            health: assessment.health,
            description: assessment.description
          },
          geometry: {
            type: 'Point',
            coordinates: [e.latlng.lng, e.latlng.lat]
          }
        };
        
        marker.bindPopup(`
          <div>
            <h6>Assessment Point</h6>
            <p><strong>Date:</strong> ${assessment.date}</p>
            <p><strong>Assessor:</strong> ${assessment.assessor}</p>
            <p><strong>Health:</strong> <span class="badge ${getHealthBadgeClass(assessment.health)}">${assessment.health}</span></p>
            <a href="#site-assessment" class="btn btn-sm btn-primary mt-2" onclick="bootstrap.Tab.getInstance(document.querySelector('#site-assessment-tab')).show()">
              View Details
            </a>
          </div>
        `);
        
        saveMapShapes();
        showToast('Assessment marker added to map', 'success');
      });
      
      alert("Click on the map where you want to place the assessment marker");
    });
    
    // Clean up modal after close
    modal._element.addEventListener('hidden.bs.modal', function() {
      document.body.removeChild(modal._element);
    });
  }

  // Locate user on map with more options
  function locateUser() {
    if (!navigator.geolocation) {
      showToast("Geolocation not supported by your browser.", "warning");
      return;
    }
    
    const map = window.dashboardMap;
    map.locate({setView: true, maxZoom: 16, enableHighAccuracy: true});
    
    map.on('locationfound', function(e) {
      const radius = e.accuracy / 2;
      const marker = L.marker(e.latlng).addTo(map)
        .bindPopup(`You are within ${Math.round(radius)} meters of this point`)
        .openPopup();
        
      L.circle(e.latlng, radius, {
        color: '#3388ff',
        fillColor: '#3388ff',
        fillOpacity: 0.2
      }).addTo(map);
      
      // Add to drawn items for saving
      window.drawnItems.addLayer(marker);
      saveMapShapes();
    });
    
    map.on('locationerror', function(e) {
      showToast("Unable to retrieve your location: " + e.message, "danger");
    });
  }

  // Add photo marker to map with more options
  function addPhotoMarker() {
    const modal = new bootstrap.Modal(document.createElement('div'));
    modal._element.innerHTML = `
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Add Photo Marker</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <label for="photoUrl" class="form-label">Photo URL</label>
              <input type="text" class="form-control" id="photoUrl" placeholder="Enter image URL">
              <div class="form-text">Leave blank to add a marker without photo</div>
            </div>
            <div class="mb-3">
              <label for="photoTitle" class="form-label">Title</label>
              <input type="text" class="form-control" id="photoTitle" placeholder="Enter marker title">
            </div>
            <div class="mb-3">
              <label for="photoDescription" class="form-label">Description</label>
              <textarea class="form-control" id="photoDescription" rows="2" placeholder="Optional description"></textarea>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-primary" data-bs-dismiss="modal" id="confirmPhotoMarker">Add Marker</button>
          </div>
        </div>
      </div>
    `;
    
    document.body.appendChild(modal._element);
    modal.show();
    
    document.getElementById('confirmPhotoMarker').addEventListener('click', function() {
      const photoUrl = document.getElementById('photoUrl').value;
      const title = document.getElementById('photoTitle').value || 'Photo Marker';
      const description = document.getElementById('photoDescription').value;
      const date = new Date().toISOString().split('T')[0];
      
      window.dashboardMap.once('click', function(e) {
        const marker = L.marker(e.latlng).addTo(window.drawnItems);
        
        // Add custom properties
        marker.feature = {
          type: 'Feature',
          properties: {
            type: 'photo',
            photo: photoUrl,
            title: title,
            description: description,
            date: date
          },
          geometry: {
            type: 'Point',
            coordinates: [e.latlng.lng, e.latlng.lat]
          }
        };
        
        if (photoUrl) {
          marker.bindPopup(`
            <div class="text-center">
              <img src="${photoUrl}" style="max-width: 200px; max-height: 150px;" class="img-thumbnail mb-2">
              <p class="mb-1"><strong>${title}</strong></p>
              ${description ? `<p class="mb-1">${description}</p>` : ''}
              <small class="text-muted">${date}</small>
            </div>
          `);
        } else {
          marker.bindPopup(`
            <div>
              <strong>${title}</strong>
              ${description ? `<p class="mb-1">${description}</p>` : ''}
              <small>${date}</small>
            </div>
          `);
        }
        
        saveMapShapes();
        showToast('Photo marker added to map', 'success');
      });
      
      alert("Click on the map where you want to place the marker");
    });
    
    // Clean up modal after close
    modal._element.addEventListener('hidden.bs.modal', function() {
      document.body.removeChild(modal._element);
    });
  }

  // Clear map data with confirmation
  function clearMapData() {
    const modal = new bootstrap.Modal(document.createElement('div'));
    modal._element.innerHTML = `
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Confirm Clear Map</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <p>Are you sure you want to clear all map drawings and markers?</p>
            <p class="text-danger">This action cannot be undone.</p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-danger" data-bs-dismiss="modal" id="confirmClearMap">Clear Map</button>
          </div>
        </div>
      </div>
    `;
    
    document.body.appendChild(modal._element);
    modal.show();
    
    document.getElementById('confirmClearMap').addEventListener('click', function() {
      localStorage.removeItem("dashboardMapShapes");
      window.drawnItems.clearLayers();
      showToast('Map data cleared', 'success');
    });
    
    // Clean up modal after close
    modal._element.addEventListener('hidden.bs.modal', function() {
      document.body.removeChild(modal._element);
    });
  }

  // Form validation helper with improved feedback
  function validateForm(form) {
    let isValid = true;
    const inputs = form.querySelectorAll('input[required], select[required], textarea[required]');
    
    inputs.forEach(input => {
      // Reset validation state
      input.classList.remove('is-invalid');
      
      // Check required fields
      if (!input.value) {
        input.classList.add('is-invalid');
        isValid = false;
      }
      
      // Check minlength for text inputs
      if (input.minLength > 0 && input.value.length < input.minLength) {
        input.classList.add('is-invalid');
        isValid = false;
      }
      
      // Custom validation for date fields
      if (input.type === 'date') {
        const date = new Date(input.value);
        if (isNaN(date.getTime())) {
          input.classList.add('is-invalid');
          isValid = false;
        }
      }
    });
    
    return isValid;
  }

  // Show toast notification
  function showToast(message, type = 'info') {
    const toastContainer = document.querySelector('.toast-container');
    const toastId = 'toast-' + Date.now();
    
    const toast = document.createElement('div');
    toast.className = `toast show align-items-center text-white bg-${type} border-0`;
    toast.id = toastId;
    toast.setAttribute('role', 'alert');
    toast.setAttribute('aria-live', 'assertive');
    toast.setAttribute('aria-atomic', 'true');
    
    toast.innerHTML = `
      <div class="d-flex">
        <div class="toast-body">
          ${message}
        </div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
    `;
    
    toastContainer.appendChild(toast);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
      const bsToast = bootstrap.Toast.getInstance(toast);
      if (bsToast) bsToast.hide();
    }, 5000);
    
    // Remove from DOM after hide
    toast.addEventListener('hidden.bs.toast', function() {
      toast.remove();
    });
    
    return new bootstrap.Toast(toast);
  }

  // Render assessments table with pagination
  function renderAssessments() {
    const tableBody = document.getElementById("assessmentTableBody");
    tableBody.innerHTML = "";
    
    const { currentPage, itemsPerPage, filteredData } = paginationConfig.assessments;
    const startIndex = (currentPage - 1) * itemsPerPage;
    const paginatedItems = filteredData.slice(startIndex, startIndex + itemsPerPage);
    
    if (paginatedItems.length === 0) {
      tableBody.innerHTML = `
        <tr>
          <td colspan="5" class="text-center py-4 text-muted">
            No assessments found
          </td>
        </tr>
      `;
    } else {
      paginatedItems.forEach((assessment, index) => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${assessment.date}</td>
          <td>${assessment.assessor}</td>
          <td>
            <span class="badge ${getHealthBadgeClass(assessment.health)}">
              ${assessment.health}
            </span>
          </td>
          <td>${assessment.threats?.join(", ") || 'None'}</td>
          <td>
            <button class="btn btn-sm btn-outline-primary me-1" onclick="viewAssessment(${startIndex + index})">
              <i class="bi bi-eye"></i>
            </button>
            <button class="btn btn-sm btn-outline-danger" onclick="deleteAssessment(${startIndex + index})">
              <i class="bi bi-trash"></i>
            </button>
          </td>
        `;
        tableBody.appendChild(row);
      });
    }
    
    // Update pagination info
    document.getElementById("assessmentPaginationInfo").textContent = 
      `Showing ${startIndex + 1}-${Math.min(startIndex + itemsPerPage, filteredData.length)} of ${filteredData.length} assessments`;
    
    // Update pagination buttons
    document.getElementById("prevAssessmentPage").disabled = currentPage === 1;
    document.getElementById("nextAssessmentPage").disabled = 
      currentPage * itemsPerPage >= filteredData.length;
  }

  function getHealthBadgeClass(health) {
    switch(health) {
      case 'Excellent': return 'bg-success';
      case 'Good': return 'bg-primary';
      case 'Fair': return 'bg-warning';
      case 'Poor': return 'bg-danger';
      case 'Critical': return 'bg-dark';
      default: return 'bg-secondary';
    }
  }

  // Search assessments
  function searchAssessments() {
    const searchTerm = document.getElementById("assessmentSearch").value.toLowerCase();
    
    if (!searchTerm) {
      paginationConfig.assessments.filteredData = [...ecoData.assessments];
    } else {
      paginationConfig.assessments.filteredData = ecoData.assessments.filter(a => 
        a.date.toLowerCase().includes(searchTerm) ||
        a.assessor.toLowerCase().includes(searchTerm) ||
        a.health.toLowerCase().includes(searchTerm) ||
        a.threats?.some(t => t.toLowerCase().includes(searchTerm)) ||
        a.description?.toLowerCase().includes(searchTerm) ||
        a.recommendations?.toLowerCase().includes(searchTerm)
      );
    }
    
    paginationConfig.assessments.currentPage = 1;
    renderAssessments();
  }

  // View assessment in modal with more details
  function viewAssessment(index) {
    const assessment = ecoData.assessments[index];
    const modalHtml = `
      <div class="modal fade" id="assessmentModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">Assessment Details</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <div class="row mb-3">
                <div class="col-md-6">
                  <p><strong>Date:</strong> ${assessment.date}</p>
                  <p><strong>Assessor:</strong> ${assessment.assessor}</p>
                </div>
                <div class="col-md-6">
                  <p><strong>Health:</strong> <span class="badge ${getHealthBadgeClass(assessment.health)}">${assessment.health}</span></p>
                  <p><strong>Threats:</strong> ${assessment.threats?.join(", ") || 'None'}</p>
                </div>
              </div>
              <div class="mb-3">
                <h6>Site Description</h6>
                <p>${assessment.description || 'No description provided.'}</p>
              </div>
              ${assessment.recommendations ? `
              <div class="mb-3">
                <h6>Recommendations</h6>
                <p>${assessment.recommendations}</p>
              </div>
              ` : ''}
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
              <button type="button" class="btn btn-primary" onclick="editAssessment(${index})">
                <i class="bi bi-pencil"></i> Edit
              </button>
            </div>
          </div>
        </div>
      </div>
    `;
    
    const modalContainer = document.createElement('div');
    modalContainer.innerHTML = modalHtml;
    document.body.appendChild(modalContainer);
    
    const modal = new bootstrap.Modal(document.getElementById('assessmentModal'));
    modal.show();
    
    // Remove modal from DOM after it's hidden
    document.getElementById('assessmentModal').addEventListener('hidden.bs.modal', function() {
      document.body.removeChild(modalContainer);
    });
  }

  // Edit assessment
  function editAssessment(index) {
    const assessment = ecoData.assessments[index];
    
    // Fill the form with assessment data
    document.getElementById("assessmentDate").value = assessment.date;
    document.getElementById("assessorName").value = assessment.assessor;
    document.getElementById("siteDescription").value = assessment.description || '';
    document.getElementById("ecosystemHealth").value = assessment.health;
    
    // Select threats
    const threatsSelect = document.getElementById("threats");
    Array.from(threatsSelect.options).forEach(option => {
      option.selected = assessment.threats?.includes(option.value) || false;
    });
    
    document.getElementById("recommendations").value = assessment.recommendations || '';
    
    // Remove the assessment from the array
    ecoData.assessments.splice(index, 1);
    saveData();
    renderAssessments();
    
    // Scroll to form and switch tab
    bootstrap.Tab.getInstance(document.querySelector('#site-assessment-tab')).show();
    document.getElementById("assessmentForm").scrollIntoView({ behavior: 'smooth' });
    
    showToast('Assessment loaded for editing', 'info');
  }

  function deleteAssessment(index) {
    const modal = new bootstrap.Modal(document.createElement('div'));
    modal._element.innerHTML = `
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Confirm Delete</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <p>Are you sure you want to delete this assessment?</p>
            <p class="text-danger">This action cannot be undone.</p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-danger" data-bs-dismiss="modal" id="confirmDeleteAssessment">Delete</button>
          </div>
        </div>
      </div>
    `;
    
    document.body.appendChild(modal._element);
    modal.show();
    
    document.getElementById('confirmDeleteAssessment').addEventListener('click', function() {
      ecoData.assessments.splice(index, 1);
      saveData();
      renderAssessments();
      showToast('Assessment deleted', 'success');
    });
    
    // Clean up modal after close
    modal._element.addEventListener('hidden.bs.modal', function() {
      document.body.removeChild(modal._element);
    });
  }

  // Filter tasks by status
  function filterTasks(status) {
    switch(status) {
      case 'all':
        paginationConfig.maintenance.filteredData = [...ecoData.maintenance];
        break;
      case 'pending':
        paginationConfig.maintenance.filteredData = ecoData.maintenance.filter(t => !t.done);
        break;
      case 'completed':
        paginationConfig.maintenance.filteredData = ecoData.maintenance.filter(t => t.done);
        break;
    }
    
    paginationConfig.maintenance.currentPage = 1;
    renderMaintenanceTasks();
  }

  // Render maintenance tasks with pagination
  function renderMaintenanceTasks() {
    const tableBody = document.getElementById("maintenanceTableBody");
    tableBody.innerHTML = "";
    
    const { currentPage, itemsPerPage, filteredData } = paginationConfig.maintenance;
    const startIndex = (currentPage - 1) * itemsPerPage;
    const paginatedItems = filteredData.slice(startIndex, startIndex + itemsPerPage);
    
    if (paginatedItems.length === 0) {
      tableBody.innerHTML = `
        <tr>
          <td colspan="5" class="text-center py-4 text-muted">
            No tasks found
          </td>
        </tr>
      `;
    } else {
      // Sort by due date (ascending)
      const sortedTasks = [...paginatedItems].sort((a, b) => new Date(a.due) - new Date(b.due));
      
      sortedTasks.forEach((task, index) => {
        const row = document.createElement("tr");
        if (task.done) row.classList.add("table-secondary");
        
        const dueDate = new Date(task.due);
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        let dueBadge = '';
        if (!task.done) {
          if (dueDate < today) {
            dueBadge = '<span class="badge bg-danger ms-2">Overdue</span>';
          } else if (dueDate.toDateString() === today.toDateString()) {
            dueBadge = '<span class="badge bg-warning ms-2">Due Today</span>';
          } else if ((dueDate - today) / (1000 * 60 * 60 * 24) <= 7) {
            dueBadge = '<span class="badge bg-info ms-2">Due Soon</span>';
          }
        }
        
        row.innerHTML = `
          <td class="${task.done ? 'task-completed' : ''}">${task.name}</td>
          <td>${task.category}</td>
          <td>
            ${dueDate.toLocaleDateString()}
            ${dueBadge}
          </td>
          <td>
            <div class="form-check form-switch">
              <input class="form-check-input" type="checkbox" role="switch" 
                ${task.done ? "checked" : ""} onchange="toggleTaskStatus(${startIndex + index})">
              <label class="form-check-label">${task.done ? "Completed" : "Pending"}</label>
            </div>
          </td>
          <td>
            <button class="btn btn-sm btn-outline-primary me-1" onclick="editTask(${startIndex + index})">
              <i class="bi bi-pencil"></i>
            </button>
            <button class="btn btn-sm btn-outline-danger" onclick="deleteTask(${startIndex + index})">
              <i class="bi bi-trash"></i>
            </button>
          </td>
        `;
        tableBody.appendChild(row);
      });
    }
    
    // Update pagination info
    document.getElementById("taskPaginationInfo").textContent = 
      `Showing ${startIndex + 1}-${Math.min(startIndex + itemsPerPage, filteredData.length)} of ${filteredData.length} tasks`;
    
    // Update pagination buttons
    document.getElementById("prevTaskPage").disabled = currentPage === 1;
    document.getElementById("nextTaskPage").disabled = 
      currentPage * itemsPerPage >= filteredData.length;
  }

  function toggleTaskStatus(index) {
    ecoData.maintenance[index].done = !ecoData.maintenance[index].done;
    saveData();
    renderMaintenanceTasks();
    showToast(`Task marked as ${ecoData.maintenance[index].done ? 'completed' : 'pending'}`, 'success');
  }

  function editTask(index) {
    const task = ecoData.maintenance[index];
    document.getElementById("taskName").value = task.name;
    document.getElementById("taskCategory").value = task.category;
    document.getElementById("taskDueDate").value = task.due;
    document.getElementById("taskNotes").value = task.notes || '';
    
    // Remove the task from the array
    ecoData.maintenance.splice(index, 1);
    saveData();
    renderMaintenanceTasks();
    
    // Scroll to form and switch tab
    bootstrap.Tab.getInstance(document.querySelector('#maintenance-plan-tab')).show();
    document.getElementById("maintenanceForm").scrollIntoView({ behavior: 'smooth' });
    
    showToast('Task loaded for editing', 'info');
  }

  function deleteTask(index) {
    const modal = new bootstrap.Modal(document.createElement('div'));
    modal._element.innerHTML = `
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Confirm Delete</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <p>Are you sure you want to delete this task?</p>
            <p class="text-danger">This action cannot be undone.</p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-danger" data-bs-dismiss="modal" id="confirmDeleteTask">Delete</button>
          </div>
        </div>
      </div>
    `;
    
    document.body.appendChild(modal._element);
    modal.show();
    
    document.getElementById('confirmDeleteTask').addEventListener('click', function() {
      ecoData.maintenance.splice(index, 1);
      saveData();
      renderMaintenanceTasks();
      showToast('Task deleted', 'success');
    });
    
    // Clean up modal after close
    modal._element.addEventListener('hidden.bs.modal', function() {
      document.body.removeChild(modal._element);
    });
  }

  // Filter species by type
  function filterSpecies(type) {
    switch(type) {
      case 'all':
        paginationConfig.species.filteredData = [...ecoData.species];
        break;
      case 'native':
        paginationConfig.species.filteredData = ecoData.species.filter(s => s.type === 'Native');
        break;
      case 'weed':
        paginationConfig.species.filteredData = ecoData.species.filter(s => s.type === 'Weed');
        break;
    }
    
    paginationConfig.species.currentPage = 1;
    renderSpeciesList();
  }

  // Render species list with pagination
  function renderSpeciesList() {
    const body = document.getElementById("speciesTableBody");
    body.innerHTML = "";
    
    const { currentPage, itemsPerPage, filteredData } = paginationConfig.species;
    const startIndex = (currentPage - 1) * itemsPerPage;
    const paginatedItems = filteredData.slice(startIndex, startIndex + itemsPerPage);
    
    if (paginatedItems.length === 0) {
      body.innerHTML = `
        <tr>
          <td colspan="4" class="text-center py-4 text-muted">
            No species found
          </td>
        </tr>
      `;
    } else {
      // Sort alphabetically by name
      const sortedSpecies = [...paginatedItems].sort((a, b) => a.name.localeCompare(b.name));
      
      sortedSpecies.forEach((sp, i) => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${sp.name}</td>
          <td>
            <span class="badge species-badge ${getSpeciesBadgeClass(sp.type)}">
              ${sp.type}
            </span>
          </td>
          <td>${sp.notes || "-"}</td>
          <td>
            <button class="btn btn-sm btn-outline-primary me-1" onclick="editSpecies(${startIndex + i})">
              <i class="bi bi-pencil"></i>
            </button>
            <button class="btn btn-sm btn-outline-danger" onclick="deleteSpecies(${startIndex + i})">
              <i class="bi bi-trash"></i>
            </button>
          </td>
        `;
        body.appendChild(row);
      });
    }
    
    // Update pagination info
    document.getElementById("speciesPaginationInfo").textContent = 
      `Showing ${startIndex + 1}-${Math.min(startIndex + itemsPerPage, filteredData.length)} of ${filteredData.length} species`;
    
    // Update pagination buttons
    document.getElementById("prevSpeciesPage").disabled = currentPage === 1;
    document.getElementById("nextSpeciesPage").disabled = 
      currentPage * itemsPerPage >= filteredData.length;
  }

  function getSpeciesBadgeClass(type) {
    switch(type.toLowerCase()) {
      case 'native': return 'species-native';
      case 'weed': return 'species-weed';
      case 'introduced': return 'species-introduced';
      default: return 'species-unknown';
    }
  }

  function editSpecies(index) {
    const species = ecoData.species[index];
    document.getElementById("speciesName").value = species.name;
    document.getElementById("speciesType").value = species.type;
    document.getElementById("speciesNotes").value = species.notes || '';
    
    // Remove the species from the array
    ecoData.species.splice(index, 1);
    saveData();
    renderSpeciesList();
    
    // Scroll to form and switch tab
    bootstrap.Tab.getInstance(document.querySelector('#species-register-tab')).show();
    document.getElementById("speciesForm").scrollIntoView({ behavior: 'smooth' });
    
    showToast('Species loaded for editing', 'info');
  }

  function deleteSpecies(index) {
    const modal = new bootstrap.Modal(document.createElement('div'));
    modal._element.innerHTML = `
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Confirm Delete</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <p>Are you sure you want to delete this species?</p>
            <p class="text-danger">This action cannot be undone.</p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-danger" data-bs-dismiss="modal" id="confirmDeleteSpecies">Delete</button>
          </div>
        </div>
      </div>
    `;
    
    document.body.appendChild(modal._element);
    modal.show();
    
    document.getElementById('confirmDeleteSpecies').addEventListener('click', function() {
      ecoData.species.splice(index, 1);
      saveData();
      renderSpeciesList();
      showToast('Species deleted', 'success');
    });
    
    // Clean up modal after close
    modal._element.addEventListener('hidden.bs.modal', function() {
      document.body.removeChild(modal._element);
    });
  }

  // Search monitoring entries
  function searchMonitoring() {
    const searchTerm = document.getElementById("monitoringSearch").value.toLowerCase();
    
    if (!searchTerm) {
      paginationConfig.monitoring.filteredData = [...ecoData.monitoring];
    } else {
      paginationConfig.monitoring.filteredData = ecoData.monitoring.filter(m => 
        m.date.toLowerCase().includes(searchTerm) ||
        m.observer.toLowerCase().includes(searchTerm) ||
        m.area?.toLowerCase().includes(searchTerm) ||
        m.weather?.toLowerCase().includes(searchTerm) ||
        m.notes?.toLowerCase().includes(searchTerm)
      );
    }
    
    paginationConfig.monitoring.currentPage = 1;
    renderMonitoringEntries();
  }

  // Render monitoring entries with pagination
  function renderMonitoringEntries() {
    const body = document.getElementById("monitoringTableBody");
    body.innerHTML = "";
    
    const { currentPage, itemsPerPage, filteredData } = paginationConfig.monitoring;
    const startIndex = (currentPage - 1) * itemsPerPage;
    const paginatedItems = filteredData.slice(startIndex, startIndex + itemsPerPage);
    
    if (paginatedItems.length === 0) {
      body.innerHTML = `
        <tr>
          <td colspan="6" class="text-center py-4 text-muted">
            No monitoring entries found
          </td>
        </tr>
      `;
    } else {
      // Sort by date (newest first)
      const sortedEntries = [...paginatedItems].sort((a, b) => new Date(b.date) - new Date(a.date));
      
      sortedEntries.forEach((entry, i) => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${entry.date}</td>
          <td>${entry.observer}</td>
          <td>${entry.area || "-"}</td>
          <td>${entry.weather || "-"}</td>
          <td class="text-truncate" style="max-width: 200px;" title="${entry.notes}">
            ${entry.notes || "-"}
          </td>
          <td>
            <button class="btn btn-sm btn-outline-primary me-1" onclick="viewMonitoringEntry(${startIndex + i})">
              <i class="bi bi-eye"></i>
            </button>
            <button class="btn btn-sm btn-outline-danger" onclick="deleteMonitoringEntry(${startIndex + i})">
              <i class="bi bi-trash"></i>
            </button>
          </td>
        `;
        body.appendChild(row);
      });
    }
    
    // Update pagination info
    document.getElementById("monitoringPaginationInfo").textContent = 
      `Showing ${startIndex + 1}-${Math.min(startIndex + itemsPerPage, filteredData.length)} of ${filteredData.length} entries`;
    
    // Update pagination buttons
    document.getElementById("prevMonitoringPage").disabled = currentPage === 1;
    document.getElementById("nextMonitoringPage").disabled = 
      currentPage * itemsPerPage >= filteredData.length;
  }

  function viewMonitoringEntry(index) {
    const entry = ecoData.monitoring[index];
    const modalHtml = `
      <div class="modal fade" id="monitoringModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">Monitoring Details</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <div class="row mb-3">
                <div class="col-md-4">
                  <p><strong>Date:</strong> ${entry.date}</p>
                </div>
                <div class="col-md-4">
                  <p><strong>Observer:</strong> ${entry.observer}</p>
                </div>
                <div class="col-md-4">
                  <p><strong>Weather:</strong> ${entry.weather || 'Not recorded'}</p>
                </div>
              </div>
              <div class="mb-3">
                <p><strong>Location:</strong> ${entry.area || 'Not specified'}</p>
              </div>
              <div class="mb-3">
                <h6>Observations</h6>
                <p>${entry.notes || 'No observations recorded.'}</p>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
              <button type="button" class="btn btn-primary" onclick="editMonitoringEntry(${index})">
                <i class="bi bi-pencil"></i> Edit
              </button>
            </div>
          </div>
        </div>
      </div>
    `;
    
    const modalContainer = document.createElement('div');
    modalContainer.innerHTML = modalHtml;
    document.body.appendChild(modalContainer);
    
    const modal = new bootstrap.Modal(document.getElementById('monitoringModal'));
    modal.show();
    
    // Remove modal from DOM after it's hidden
    document.getElementById('monitoringModal').addEventListener('hidden.bs.modal', function() {
      document.body.removeChild(modalContainer);
    });
  }

  // Edit monitoring entry
  function editMonitoringEntry(index) {
    const entry = ecoData.monitoring[index];
    
    // Fill the form with entry data
    document.getElementById("monitoringDate").value = entry.date;
    document.getElementById("monitoringObserver").value = entry.observer;
    document.getElementById("monitoringArea").value = entry.area || '';
    document.getElementById("monitoringWeather").value = entry.weather || '';
    document.getElementById("monitoringNotes").value = entry.notes;
    
    // Remove the entry from the array
    ecoData.monitoring.splice(index, 1);
    saveData();
    renderMonitoringEntries();
    
    // Scroll to form and switch tab
    bootstrap.Tab.getInstance(document.querySelector('#monitoring-tab')).show();
    document.getElementById("monitoringForm").scrollIntoView({ behavior: 'smooth' });
    
    showToast('Monitoring entry loaded for editing', 'info');
  }

  function deleteMonitoringEntry(index) {
    const modal = new bootstrap.Modal(document.createElement('div'));
    modal._element.innerHTML = `
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Confirm Delete</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <p>Are you sure you want to delete this monitoring record?</p>
            <p class="text-danger">This action cannot be undone.</p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-danger" data-bs-dismiss="modal" id="confirmDeleteMonitoring">Delete</button>
          </div>
        </div>
      </div>
    `;
    
    document.body.appendChild(modal._element);
    modal.show();
    
    document.getElementById('confirmDeleteMonitoring').addEventListener('click', function() {
      ecoData.monitoring.splice(index, 1);
      saveData();
      renderMonitoringEntries();
      showToast('Monitoring entry deleted', 'success');
    });
    
    // Clean up modal after close
    modal._element.addEventListener('hidden.bs.modal', function() {
      document.body.removeChild(modal._element);
    });
  }

  // Generate reports with more options
  function generateReport() {
    const report = [];
    const today = new Date().toISOString().split('T')[0];
    
    // Header
    report.push(`
      <div class="report-header mb-4">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <h3>Ecosystem Maintenance Report</h3>
            <p class="text-muted">Generated on ${today}</p>
            ${ecoData.settings.site.name ? `<h4>${ecoData.settings.site.name}</h4>` : ''}
            ${ecoData.settings.site.location ? `<p><i class="bi bi-geo-alt"></i> ${ecoData.settings.site.location}</p>` : ''}
          </div>
          <div class="text-end">
            ${ecoData.settings.user.name ? `<p><strong>Prepared by:</strong> ${ecoData.settings.user.name}</p>` : ''}
            ${ecoData.settings.user.role ? `<p><strong>Role:</strong> ${ecoData.settings.user.role}</p>` : ''}
          </div>
        </div>
        <hr>
      </div>
    `);
    
    // Summary Stats
    report.push(`
      <div class="row mb-4">
        <div class="col-md-3">
          <div class="card bg-light">
            <div class="card-body text-center">
              <h5 class="card-title">Assessments</h5>
              <h2 class="card-text">${ecoData.assessments.length}</h2>
              ${ecoData.assessments.length > 0 ? `
                <small>Last: ${[...ecoData.assessments].sort((a, b) => new Date(b.date) - new Date(a.date))[0].date}</small>
              ` : ''}
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card bg-light">
            <div class="card-body text-center">
              <h5 class="card-title">Tasks</h5>
              <h2 class="card-text">${ecoData.maintenance.length}</h2>
              <small>${ecoData.maintenance.filter(t => t.done).length} completed</small>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card bg-light">
            <div class="card-body text-center">
              <h5 class="card-title">Species</h5>
              <h2 class="card-text">${ecoData.species.length}</h2>
              <small>${ecoData.species.filter(s => s.type === 'Native').length} native</small>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card bg-light">
            <div class="card-body text-center">
              <h5 class="card-title">Monitoring</h5>
              <h2 class="card-text">${ecoData.monitoring.length}</h2>
              ${ecoData.monitoring.length > 0 ? `
                <small>Last: ${[...ecoData.monitoring].sort((a, b) => new Date(b.date) - new Date(a.date))[0].date}</small>
              ` : ''}
            </div>
          </div>
        </div>
      </div>
    `);
    
    // Site Assessments
    report.push("<h4 class='mt-4'>Site Assessments</h4>");
    if (ecoData.assessments.length) {
      report.push("<div class='table-responsive'><table class='table table-sm'><thead><tr><th>Date</th><th>Assessor</th><th>Health</th><th>Threats</th></tr></thead><tbody>");
      
      // Sort by date (newest first)
      const sortedAssessments = [...ecoData.assessments].sort((a, b) => new Date(b.date) - new Date(a.date));
      
      sortedAssessments.forEach(a => {
        report.push(`
          <tr>
            <td>${a.date}</td>
            <td>${a.assessor}</td>
            <td><span class="badge ${getHealthBadgeClass(a.health)}">${a.health}</span></td>
            <td>${a.threats?.join(', ') || 'None'}</td>
          </tr>
        `);
      });
      report.push("</tbody></table></div>");
      
      // Add health summary
      const healthCounts = {};
      ecoData.assessments.forEach(a => {
        healthCounts[a.health] = (healthCounts[a.health] || 0) + 1;
      });
      
      report.push("<h5 class='mt-3'>Health Summary</h5>");
      report.push("<div class='row'>");
      
      Object.entries(healthCounts).forEach(([health, count]) => {
        const percentage = Math.round((count / ecoData.assessments.length) * 100);
        report.push(`
          <div class="col-md-3 mb-3">
            <div class="card">
              <div class="card-body text-center">
                <span class="badge ${getHealthBadgeClass(health)} mb-2">${health}</span>
                <h4>${count}</h4>
                <small>${percentage}% of assessments</small>
              </div>
            </div>
          </div>
        `);
      });
      
      report.push("</div>");
    } else {
      report.push("<div class='alert alert-info'>No assessments recorded.</div>");
    }
    
    // Maintenance Tasks
    report.push("<h4 class='mt-4'>Maintenance Tasks</h4>");
    if (ecoData.maintenance.length) {
      const completed = ecoData.maintenance.filter(t => t.done).length;
      const pending = ecoData.maintenance.length - completed;
      
      report.push(`
        <div class="mb-3">
          <div class="progress" style="height: 20px;">
            <div class="progress-bar bg-success" role="progressbar" 
              style="width: ${(completed / ecoData.maintenance.length) * 100}%" 
              aria-valuenow="${completed}" aria-valuemin="0" aria-valuemax="${ecoData.maintenance.length}">
              ${completed} completed
            </div>
            <div class="progress-bar bg-warning" role="progressbar" 
              style="width: ${(pending / ecoData.maintenance.length) * 100}%" 
              aria-valuenow="${pending}" aria-valuemin="0" aria-valuemax="${ecoData.maintenance.length}">
              ${pending} pending
            </div>
          </div>
        </div>
      `);
      
      // Tasks by category
      const tasksByCategory = {};
      ecoData.maintenance.forEach(t => {
        tasksByCategory[t.category] = (tasksByCategory[t.category] || 0) + 1;
      });
      
      report.push("<h5 class='mt-3'>Tasks by Category</h5>");
      report.push("<div class='row'>");
      
      Object.entries(tasksByCategory).forEach(([category, count]) => {
        report.push(`
          <div class="col-md-3 mb-3">
            <div class="card">
              <div class="card-body text-center">
                <h5>${category}</h5>
                <h3>${count}</h3>
                <small>${Math.round((count / ecoData.maintenance.length) * 100)}% of tasks</small>
              </div>
            </div>
          </div>
        `);
      });
      
      report.push("</div>");
      
      // Task list
      report.push("<h5 class='mt-3'>Task Details</h5>");
      report.push("<div class='table-responsive'><table class='table table-sm'><thead><tr><th>Task</th><th>Category</th><th>Due</th><th>Status</th></tr></thead><tbody>");
      
      // Sort by due date
      const sortedTasks = [...ecoData.maintenance].sort((a, b) => new Date(a.due) - new Date(b.due));
      
      sortedTasks.forEach(t => {
        report.push(`
          <tr class="${t.done ? 'table-secondary' : ''}">
            <td class="${t.done ? 'task-completed' : ''}">${t.name}</td>
            <td>${t.category}</td>
            <td>${t.due}</td>
            <td><span class="badge ${t.done ? 'bg-success' : 'bg-warning'}">${t.done ? "Completed" : "Pending"}</span></td>
          </tr>
        `);
      });
      report.push("</tbody></table></div>");
    } else {
      report.push("<div class='alert alert-info'>No maintenance tasks added.</div>");
    }
    
    // Species
    report.push("<h4 class='mt-4'>Species Register</h4>");
    if (ecoData.species.length) {
      const speciesByType = {};
      ecoData.species.forEach(s => {
        speciesByType[s.type] = (speciesByType[s.type] || 0) + 1;
      });
      
      // Species distribution
      report.push("<h5 class='mt-3'>Species Distribution</h5>");
      report.push("<div class='row'>");
      
      Object.entries(speciesByType).forEach(([type, count]) => {
        report.push(`
          <div class="col-md-3 mb-3">
            <div class="card">
              <div class="card-body text-center">
                <span class="badge species-badge ${getSpeciesBadgeClass(type)} mb-2">${type}</span>
                <h3>${count}</h3>
                <small>${Math.round((count / ecoData.species.length) * 100)}% of species</small>
              </div>
            </div>
          </div>
        `);
      });
      
      report.push("</div>");
      
      // Species list
      report.push("<h5 class='mt-3'>Species List</h5>");
      report.push("<div class='table-responsive'><table class='table table-sm'><thead><tr><th>Name</th><th>Type</th><th>Notes</th></tr></thead><tbody>");
      
      // Sort alphabetically
      const sortedSpecies = [...ecoData.species].sort((a, b) => a.name.localeCompare(b.name));
      
      sortedSpecies.forEach(s => {
        report.push(`
          <tr>
            <td>${s.name}</td>
            <td><span class="badge species-badge ${getSpeciesBadgeClass(s.type)}">${s.type}</span></td>
            <td>${s.notes || '-'}</td>
          </tr>
        `);
      });
      report.push("</tbody></table></div>");
    } else {
      report.push("<div class='alert alert-info'>No species recorded.</div>");
    }
    
    // Monitoring
    report.push("<h4 class='mt-4'>Monitoring Logs</h4>");
    if (ecoData.monitoring.length) {
      // Monitoring frequency
      const monitoringByMonth = {};
      ecoData.monitoring.forEach(m => {
        const month = m.date.substring(0, 7); // YYYY-MM
        monitoringByMonth[month] = (monitoringByMonth[month] || 0) + 1;
      });
      
      const sortedMonths = Object.keys(monitoringByMonth).sort();
      
      report.push("<h5 class='mt-3'>Monitoring Frequency</h5>");
      report.push("<div class='row'>");
      
      sortedMonths.forEach(month => {
        report.push(`
          <div class="col-md-2 mb-3">
            <div class="card">
              <div class="card-body text-center">
                <h5>${month}</h5>
                <h3>${monitoringByMonth[month]}</h3>
                <small>entries</small>
              </div>
            </div>
          </div>
        `);
      });
      
      report.push("</div>");
      
      // Monitoring list
      report.push("<h5 class='mt-3'>Monitoring Details</h5>");
      report.push("<div class='table-responsive'><table class='table table-sm'><thead><tr><th>Date</th><th>Observer</th><th>Location</th><th>Weather</th><th>Notes</th></tr></thead><tbody>");
      
      // Sort by date (newest first)
      const sortedMonitoring = [...ecoData.monitoring].sort((a, b) => new Date(b.date) - new Date(a.date));
      
      sortedMonitoring.forEach(m => {
        report.push(`
          <tr>
            <td>${m.date}</td>
            <td>${m.observer}</td>
            <td>${m.area || '-'}</td>
            <td>${m.weather || '-'}</td>
            <td style="max-width: 300px; white-space: pre-wrap;">${m.notes || '-'}</td>
          </tr>
        `);
      });
      report.push("</tbody></table></div>");
    } else {
      report.push("<div class='alert alert-info'>No monitoring records yet.</div>");
    }
    
    document.getElementById("reportContent").innerHTML = report.join("");
    
    // Render charts for the report
    renderCharts();
    
    showToast('Report generated successfully', 'success');
  }

  // Render charts for the report
  function renderCharts() {
    // Destroy existing charts if they exist
    const chartIds = ['maintenanceChart', 'speciesChart', 'monitoringChart'];
    chartIds.forEach(id => {
      const chart = Chart.getChart(id);
      if (chart) chart.destroy();
    });

    // Maintenance Tasks Chart
    if (ecoData.maintenance.length > 0) {
      const ctx = document.getElementById('maintenanceChart').getContext('2d');
      const completed = ecoData.maintenance.filter(t => t.done).length;
      const pending = ecoData.maintenance.length - completed;
      
      new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: ['Completed', 'Pending'],
          datasets: [{
            data: [completed, pending],
            backgroundColor: ['#28a745', '#ffc107'],
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              position: 'bottom',
            },
            title: {
              display: true,
              text: 'Task Completion'
            }
          }
        }
      });
    }

    // Species Distribution Chart
    if (ecoData.species.length > 0) {
      const ctx = document.getElementById('speciesChart').getContext('2d');
      const speciesCounts = {};
      
      ecoData.species.forEach(s => {
        speciesCounts[s.type] = (speciesCounts[s.type] || 0) + 1;
      });
      
      const labels = Object.keys(speciesCounts);
      const data = Object.values(speciesCounts);
      const backgroundColors = labels.map(type => {
        switch(type.toLowerCase()) {
          case 'native': return '#28a745';
          case 'weed': return '#dc3545';
          case 'introduced': return '#fd7e14';
          default: return '#6c757d';
        }
      });
      
      new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'Species Count',
            data: data,
            backgroundColor: backgroundColors,
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              display: false
            },
            title: {
              display: true,
              text: 'Species Distribution'
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                precision: 0
              }
            }
          }
        }
      });
    }

    // Monitoring Activity Chart
    if (ecoData.monitoring.length > 0) {
      const ctx = document.getElementById('monitoringChart').getContext('2d');
      const monitoringByMonth = {};
      
      ecoData.monitoring.forEach(m => {
        const month = m.date.substring(0, 7); // YYYY-MM
        monitoringByMonth[month] = (monitoringByMonth[month] || 0) + 1;
      });
      
      const sortedMonths = Object.keys(monitoringByMonth).sort();
      const counts = sortedMonths.map(month => monitoringByMonth[month]);
      
      new Chart(ctx, {
        type: 'line',
        data: {
          labels: sortedMonths,
          datasets: [{
            label: 'Monitoring Entries',
            data: counts,
            fill: false,
            backgroundColor: '#007bff',
            borderColor: '#007bff',
            tension: 0.1
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              display: false
            },
            title: {
              display: true,
              text: 'Monitoring Activity Over Time'
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                precision: 0
              }
            }
          }
        }
      });
    }
  }

  // Export data to CSV
  function exportToCSV() {
    let csvContent = "data:text/csv;charset=utf-8,";
    
    // Export assessments
    csvContent += "Assessments\n";
    csvContent += "Date,Assessor,Health,Threats,Description,Recommendations\n";
    ecoData.assessments.forEach(a => {
      csvContent += `${a.date},${a.assessor},${a.health},"${(a.threats || []).join(', ')}","${a.description || ''}","${a.recommendations || ''}"\n`;
    });
    
    // Export maintenance tasks
    csvContent += "\nMaintenance Tasks\n";
    csvContent += "Name,Category,Due,Done,Notes\n";
    ecoData.maintenance.forEach(t => {
      csvContent += `${t.name},${t.category},${t.due},${t.done},"${t.notes || ''}"\n`;
    });
    
    // Export species
    csvContent += "\nSpecies\n";
    csvContent += "Name,Type,Notes\n";
    ecoData.species.forEach(s => {
      csvContent += `${s.name},${s.type},"${s.notes || ''}"\n`;
    });
    
    // Export monitoring
    csvContent += "\nMonitoring\n";
    csvContent += "Date,Observer,Area,Weather,Notes\n";
    ecoData.monitoring.forEach(m => {
      csvContent += `${m.date},${m.observer},${m.area || ''},${m.weather || ''},"${m.notes || ''}"\n`;
    });
    
    // Create download link
    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", `ecosystem_data_${new Date().toISOString().split('T')[0]}.csv`);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    showToast('Data exported to CSV successfully', 'success');
  }

  // Export report to PDF
  function exportToPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('p', 'pt', 'a4');
    
    // Add title
    doc.setFontSize(20);
    doc.text('Ecosystem Maintenance Report', 40, 40);
    
    // Add date
    doc.setFontSize(12);
    const today = new Date().toISOString().split('T')[0];
    doc.text(`Generated on: ${today}`, 40, 60);
    
    // Add site information if available
    if (ecoData.settings.site.name) {
      doc.setFontSize(14);
      doc.text(`Site: ${ecoData.settings.site.name}`, 40, 80);
    }
    if (ecoData.settings.site.location) {
      doc.text(`Location: ${ecoData.settings.site.location}`, 40, 100);
    }
    
    // Add summary statistics
    doc.setFontSize(12);
    doc.text('Summary Statistics', 40, 140);
    doc.setFontSize(10);
    
    let yPosition = 160;
    doc.text(`Assessments: ${ecoData.assessments.length}`, 40, yPosition);
    yPosition += 20;
    doc.text(`Maintenance Tasks: ${ecoData.maintenance.length} (${ecoData.maintenance.filter(t => t.done).length} completed)`, 40, yPosition);
    yPosition += 20;
    doc.text(`Species: ${ecoData.species.length} (${ecoData.species.filter(s => s.type === 'Native').length} native)`, 40, yPosition);
    yPosition += 20;
    doc.text(`Monitoring Entries: ${ecoData.monitoring.length}`, 40, yPosition);
    
    // Add charts (simplified versions)
    yPosition += 40;
    if (ecoData.maintenance.length > 0) {
      doc.setFontSize(12);
      doc.text('Maintenance Task Status', 40, yPosition);
      yPosition += 20;
      
      const completed = ecoData.maintenance.filter(t => t.done).length;
      const pending = ecoData.maintenance.length - completed;
      
      doc.setFontSize(10);
      doc.text(`Completed: ${completed} (${Math.round((completed / ecoData.maintenance.length) * 100)}%)`, 60, yPosition);
      yPosition += 20;
      doc.text(`Pending: ${pending} (${Math.round((pending / ecoData.maintenance.length) * 100)}%)`, 60, yPosition);
      yPosition += 30;
    }
    
    if (ecoData.species.length > 0) {
      doc.setFontSize(12);
      doc.text('Species Distribution', 40, yPosition);
      yPosition += 20;
      
      const speciesCounts = {};
      ecoData.species.forEach(s => {
        speciesCounts[s.type] = (speciesCounts[s.type] || 0) + 1;
      });
      
      doc.setFontSize(10);
      Object.entries(speciesCounts).forEach(([type, count]) => {
        doc.text(`${type}: ${count} (${Math.round((count / ecoData.species.length) * 100)}%)`, 60, yPosition);
        yPosition += 20;
      });
      yPosition += 10;
    }
    
    // Add detailed data sections
    doc.addPage();
    yPosition = 40;
    
    // Assessments
    if (ecoData.assessments.length > 0) {
      doc.setFontSize(14);
      doc.text('Site Assessments', 40, yPosition);
      yPosition += 20;
      
      doc.setFontSize(10);
      ecoData.assessments.forEach(a => {
        doc.text(`${a.date} - ${a.assessor} (${a.health})`, 40, yPosition);
        yPosition += 15;
        doc.text(`Threats: ${(a.threats || []).join(', ') || 'None'}`, 60, yPosition);
        yPosition += 15;
        
        if (yPosition > doc.internal.pageSize.height - 40) {
          doc.addPage();
          yPosition = 40;
        }
      });
      yPosition += 20;
    }
    
    // Maintenance Tasks
    if (ecoData.maintenance.length > 0) {
      doc.setFontSize(14);
      doc.text('Maintenance Tasks', 40, yPosition);
      yPosition += 20;
      
      doc.setFontSize(10);
      ecoData.maintenance.forEach(t => {
        const status = t.done ? 'Completed' : 'Pending';
        doc.text(`${t.name} (${t.category}) - Due: ${t.due} - ${status}`, 40, yPosition);
        yPosition += 15;
        
        if (yPosition > doc.internal.pageSize.height - 40) {
          doc.addPage();
          yPosition = 40;
        }
      });
      yPosition += 20;
    }
    
    // Save the PDF
    doc.save(`ecosystem_report_${today}.pdf`);
    showToast('Report exported to PDF successfully', 'success');
  }

  // Export all data as JSON
  function exportAllData() {
    const dataStr = JSON.stringify(ecoData, null, 2);
    const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
    
    const exportName = `ecosystem_data_${new Date().toISOString().split('T')[0]}.json`;
    
    const linkElement = document.createElement('a');
    linkElement.setAttribute('href', dataUri);
    linkElement.setAttribute('download', exportName);
    linkElement.click();
    
    showToast('All data exported as JSON', 'success');
  }

  // Initialize the application
  document.addEventListener("DOMContentLoaded", function() {
    loadData();
    initDashboardMap();
    
    // Initialize all data tables
    renderAssessments();
    renderMaintenanceTasks();
    renderSpeciesList();
    renderMonitoringEntries();
    
    // Set up form submissions
    document.getElementById("assessmentForm").addEventListener("submit", function(e) {
      e.preventDefault();
      if (!validateForm(this)) return;
      
      const newAssessment = {
        date: document.getElementById("assessmentDate").value,
        assessor: document.getElementById("assessorName").value,
        description: document.getElementById("siteDescription").value,
        health: document.getElementById("ecosystemHealth").value,
        threats: Array.from(document.getElementById("threats").selectedOptions).map(o => o.value),
        recommendations: document.getElementById("recommendations").value || undefined
      };
      
      ecoData.assessments.push(newAssessment);
      saveData();
      renderAssessments();
      updateRecentActivity();
      this.reset();
    });
    
    document.getElementById("maintenanceForm").addEventListener("submit", function(e) {
      e.preventDefault();
      if (!validateForm(this)) return;
      
      const newTask = {
        name: document.getElementById("taskName").value,
        category: document.getElementById("taskCategory").value,
        due: document.getElementById("taskDueDate").value,
        notes: document.getElementById("taskNotes").value || undefined,
        done: false
      };
      
      ecoData.maintenance.push(newTask);
      saveData();
      renderMaintenanceTasks();
      updateUpcomingTasks();
      this.reset();
    });
    
    document.getElementById("speciesForm").addEventListener("submit", function(e) {
      e.preventDefault();
      if (!validateForm(this)) return;
      
      const newSpecies = {
        name: document.getElementById("speciesName").value,
        type: document.getElementById("speciesType").value,
        notes: document.getElementById("speciesNotes").value || undefined
      };
      
      ecoData.species.push(newSpecies);
      saveData();
      renderSpeciesList();
      this.reset();
    });
    
    document.getElementById("monitoringForm").addEventListener("submit", function(e) {
      e.preventDefault();
      if (!validateForm(this)) return;
      
      const newMonitoring = {
        date: document.getElementById("monitoringDate").value,
        observer: document.getElementById("monitoringObserver").value,
        area: document.getElementById("monitoringArea").value || undefined,
        weather: document.getElementById("monitoringWeather").value || undefined,
        notes: document.getElementById("monitoringNotes").value
      };
      
      ecoData.monitoring.push(newMonitoring);
      saveData();
      renderMonitoringEntries();
      updateRecentActivity();
      this.reset();
    });
    
    // Set up settings forms
    document.getElementById("siteSettingsForm").addEventListener("submit", function(e) {
      e.preventDefault();
      ecoData.settings.site = {
        name: document.getElementById("siteName").value || undefined,
        location: document.getElementById("siteLocation").value || undefined,
        description: document.getElementById("siteDescription").value || undefined
      };
      saveData();
      showToast('Site settings saved', 'success');
    });
    
    document.getElementById("userSettingsForm").addEventListener("submit", function(e) {
      e.preventDefault();
      ecoData.settings.user = {
        name: document.getElementById("userName").value,
        role: document.getElementById("userRole").value || undefined,
        darkMode: document.getElementById("darkMode").checked
      };
      ecoData.settings.darkMode = document.getElementById("darkMode").checked;
      document.body.classList.toggle('dark-mode', ecoData.settings.darkMode);
      saveData();
      showToast('User settings saved', 'success');
    });
    
    // Set up pagination controls
    document.getElementById("prevAssessmentPage").addEventListener("click", function() {
      if (paginationConfig.assessments.currentPage > 1) {
        paginationConfig.assessments.currentPage--;
        renderAssessments();
      }
    });
    
    document.getElementById("nextAssessmentPage").addEventListener("click", function() {
      const { currentPage, itemsPerPage, filteredData } = paginationConfig.assessments;
      if (currentPage * itemsPerPage < filteredData.length) {
        paginationConfig.assessments.currentPage++;
        renderAssessments();
      }
    });
    
    document.getElementById("prevTaskPage").addEventListener("click", function() {
      if (paginationConfig.maintenance.currentPage > 1) {
        paginationConfig.maintenance.currentPage--;
        renderMaintenanceTasks();
      }
    });
    
    document.getElementById("nextTaskPage").addEventListener("click", function() {
      const { currentPage, itemsPerPage, filteredData } = paginationConfig.maintenance;
      if (currentPage * itemsPerPage < filteredData.length) {
        paginationConfig.maintenance.currentPage++;
        renderMaintenanceTasks();
      }
    });
    
    document.getElementById("prevSpeciesPage").addEventListener("click", function() {
      if (paginationConfig.species.currentPage > 1) {
        paginationConfig.species.currentPage--;
        renderSpeciesList();
      }
    });
    
    document.getElementById("nextSpeciesPage").addEventListener("click", function() {
      const { currentPage, itemsPerPage, filteredData } = paginationConfig.species;
      if (currentPage * itemsPerPage < filteredData.length) {
        paginationConfig.species.currentPage++;
        renderSpeciesList();
      }
    });
    
    document.getElementById("prevMonitoringPage").addEventListener("click", function() {
      if (paginationConfig.monitoring.currentPage > 1) {
        paginationConfig.monitoring.currentPage--;
        renderMonitoringEntries();
      }
    });
    
    document.getElementById("nextMonitoringPage").addEventListener("click", function() {
      const { currentPage, itemsPerPage, filteredData } = paginationConfig.monitoring;
      if (currentPage * itemsPerPage < filteredData.length) {
        paginationConfig.monitoring.currentPage++;
        renderMonitoringEntries();
      }
    });
    
    // Set up search functionality
    document.getElementById("assessmentSearch").addEventListener("input", searchAssessments);
    document.getElementById("monitoringSearch").addEventListener("input", searchMonitoring);
    
    // Set up filter buttons
    document.querySelectorAll(".task-filter").forEach(button => {
      button.addEventListener("click", function() {
        filterTasks(this.dataset.filter);
      });
    });
    
    document.querySelectorAll(".species-filter").forEach(button => {
      button.addEventListener("click", function() {
        filterSpecies(this.dataset.filter);
      });
    });
    
    // Set up report export buttons
    document.getElementById("exportCSV").addEventListener("click", exportToCSV);
    document.getElementById("exportPDF").addEventListener("click", exportToPDF);
    document.getElementById("exportJSON").addEventListener("click", exportAllData);
    
    // Set up floating action button
    document.querySelector(".btn-float").addEventListener("click", function() {
      window.scrollTo({
        top: 0,
        behavior: "smooth"
      });
    });
    
    // Show/hide floating button based on scroll position
    window.addEventListener("scroll", function() {
      const floatBtn = document.querySelector(".btn-float");
      if (window.pageYOffset > 300) {
        floatBtn.style.display = "block";
      } else {
        floatBtn.style.display = "none";
      }
    });
  });
</script>
</body>
</html>
