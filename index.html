<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Native Ecosystem Maintenance Tool | AHCECR301 Compliance</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css">
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""/>
    <!-- Leaflet Draw CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css"/>
    <style>
        .sidebar {
            min-height: 100vh;
            background-color: #2c3e50;
            color: white;
        }
        .sidebar .nav-link {
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 5px;
        }
        .sidebar .nav-link:hover, .sidebar .nav-link.active {
            color: white;
            background-color: #34495e;
        }
        .sidebar .nav-link i {
            margin-right: 10px;
        }
        .main-content {
            background-color: #f8f9fa;
            padding: 20px;
        }
        .card {
            margin-bottom: 20px;
            border: none;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        .map-container {
            height: 400px;
            background-color: #e9ecef;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .species-card {
            transition: transform 0.2s;
        }
        .species-card:hover {
            transform: translateY(-5px);
        }
        .risk-indicator {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
        }
        .risk-low {
            background-color: #28a745;
        }
        .risk-medium {
            background-color: #ffc107;
        }
        .risk-high {
            background-color: #dc3545;
        }
        .logo {
            font-weight: 700;
            padding: 15px;
            font-size: 1.2rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        #mapid { 
            height: 100%;
            width: 100%;
            border-radius: 5px;
        }
        .map-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
        }
        .leaflet-top.leaflet-right {
            margin-top: 50px;
        }
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1100;
        }
        .form-control.is-invalid {
            background-image: none;
            padding-right: 0.75rem;
        }
        .form-control.is-valid {
            background-image: none;
            padding-right: 0.75rem;
        }
        .fc-event {
            cursor: pointer;
        }
        .species-image-preview {
            max-width: 100%;
            max-height: 200px;
            margin-top: 10px;
            display: none;
        }
        .assessment-image-preview {
            max-width: 100%;
            max-height: 150px;
            margin-top: 10px;
        }
        .image-preview-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }
        .image-thumbnail {
            max-width: 100px;
            max-height: 100px;
            object-fit: cover;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .fc-event-title {
            white-space: normal;
        }
        .fc-daygrid-event-dot {
            display: none;
        }
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }
        .leaflet-draw-toolbar {
            margin-top: 12px;
        }
        .project-card {
            transition: all 0.3s ease;
        }
        .project-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        .leaflet-draw-toolbar a {
            background-image: none;
        }
        .leaflet-draw-toolbar a:first-child {
            border-top-left-radius: 4px;
            border-bottom-left-radius: 4px;
        }
        .leaflet-draw-toolbar a:last-child {
            border-top-right-radius: 4px;
            border-bottom-right-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="toast-container">
        <div id="liveToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header">
                <strong class="me-auto" id="toast-title">Notification</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body" id="toast-message">
                Operation completed successfully.
            </div>
        </div>
    </div>

    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-3 col-lg-2 sidebar px-0">
                <div class="logo">EcoManager</div>
                <ul class="nav flex-column">
                    <li class="nav-item">
                        <a class="nav-link active" href="#" data-bs-target="dashboard">
                            <i class="bi bi-speedometer2"></i> Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-bs-target="projects">
                            <i class="bi bi-folder"></i> Projects
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-bs-target="map">
                            <i class="bi bi-map"></i> Interactive Map
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-bs-target="assessments">
                            <i class="bi bi-clipboard-check"></i> Site Assessments
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-bs-target="species">
                            <i class="bi bi-flower1"></i> Species Database
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-bs-target="activities">
                            <i class="bi bi-calendar-event"></i> Activities
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-bs-target="monitoring">
                            <i class="bi bi-binoculars"></i> Monitoring
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-bs-target="reports">
                            <i class="bi bi-graph-up"></i> Reports
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-bs-target="compliance">
                            <i class="bi bi-shield-check"></i> Compliance
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-bs-target="settings">
                            <i class="bi bi-gear"></i> Settings
                        </a>
                    </li>
                </ul>
            </div>

            <!-- Main Content -->
            <div class="col-md-9 col-lg-10 main-content">
                <!-- Dashboard Section -->
                <div id="dashboard" class="content-section">
                    <h2 class="mb-4">Ecosystem Management Dashboard</h2>
                    
                    <div class="row">
                        <div class="col-md-3">
                            <div class="card text-center">
                                <div class="card-body">
                                    <h5 class="card-title">Site Health</h5>
                                    <div class="display-4 text-success">78%</div>
                                    <p class="card-text">Overall ecosystem health score</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card text-center">
                                <div class="card-body">
                                    <h5 class="card-title">Activities</h5>
                                    <div class="display-4 text-primary">12</div>
                                    <p class="card-text">Active tasks this month</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card text-center">
                                <div class="card-body">
                                    <h5 class="card-title">Species</h5>
                                    <div class="display-4 text-info">42</div>
                                    <p class="card-text">Recorded species</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card text-center">
                                <div class="card-body">
                                    <h5 class="card-title">Compliance</h5>
                                    <div class="display-4 text-warning">92%</div>
                                    <p class="card-text">AHCECR301 compliance rate</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row mt-4">
                        <div class="col-md-8">
                            <div class="card">
                                <div class="card-header">
                                    <h5>Health Indicators</h5>
                                </div>
                                <div class="card-body">
                                    <div class="chart-container">
                                        <canvas id="healthChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-header">
                                    <h5>Threats Overview</h5>
                                </div>
                                <div class="card-body">
                                    <div class="chart-container">
                                        <canvas id="threatsChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row mt-4">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h5>Overdue Activities</h5>
                                    <button class="btn btn-sm btn-outline-primary" id="viewAllActivities">View All</button>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-hover">
                                            <thead>
                                                <tr>
                                                    <th>Activity</th>
                                                    <th>Type</th>
                                                    <th>Due Date</th>
                                                    <th>Location</th>
                                                    <th>Assigned To</th>
                                                    <th>Status</th>
                                                    <th>Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody id="overdueActivitiesTable">
                                                <!-- Will be populated by JavaScript -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Projects Section -->
                <div id="projects" class="content-section d-none">
                    <h2 class="mb-4">Project Management</h2>
                    
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5>Create New Project</h5>
                        </div>
                        <div class="card-body">
                            <form id="projectForm">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="projectName" class="form-label">Project Name</label>
                                            <input type="text" class="form-control" id="projectName" required>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="projectCode" class="form-label">Project Code</label>
                                            <input type="text" class="form-control" id="projectCode" required>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="projectStartDate" class="form-label">Start Date</label>
                                            <input type="date" class="form-control" id="projectStartDate" required>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="projectEndDate" class="form-label">End Date</label>
                                            <input type="date" class="form-control" id="projectEndDate">
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="projectDescription" class="form-label">Description</label>
                                    <textarea class="form-control" id="projectDescription" rows="3"></textarea>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="projectStatus" class="form-label">Status</label>
                                            <select class="form-select" id="projectStatus" required>
                                                <option value="planning">Planning</option>
                                                <option value="active" selected>Active</option>
                                                <option value="on-hold">On Hold</option>
                                                <option value="completed">Completed</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="projectManager" class="form-label">Project Manager</label>
                                            <input type="text" class="form-control" id="projectManager">
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="projectLocation" class="form-label">Location</label>
                                    <input type="text" class="form-control" id="projectLocation">
                                </div>
                                
                                <button type="submit" class="btn btn-primary">Create Project</button>
                            </form>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5>Current Projects</h5>
                            <input type="text" class="form-control form-control-sm d-inline-block w-auto" placeholder="Search projects..." id="projectSearch">
                        </div>
                        <div class="card-body">
                            <div class="row" id="projectsList">
                                <!-- Will be populated by JavaScript -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Interactive Map Section -->
                <div id="map" class="content-section d-none">
                    <h2 class="mb-4">Interactive Ecosystem Map</h2>
                    
                    <div class="card mb-4">
                        <div class="card-body">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <div class="btn-group" role="group">
                                        <button type="button" class="btn btn-outline-primary" id="drawMarker">
                                            <i class="bi bi-geo-alt"></i> Add Marker
                                        </button>
                                        <button type="button" class="btn btn-outline-success" id="drawPolygon">
                                            <i class="bi bi-pentagon"></i> Draw Zone
                                        </button>
                                        <button type="button" class="btn btn-outline-info" id="drawLine">
                                            <i class="bi bi-signpost"></i> Draw Path
                                        </button>
                                        <button type="button" class="btn btn-outline-warning" id="editFeatures">
                                            <i class="bi bi-pencil"></i> Edit Features
                                        </button>
                                        <button type="button" class="btn btn-outline-danger" id="deleteFeatures">
                                            <i class="bi bi-trash"></i> Delete
                                        </button>
                                    </div>
                                </div>
                                <div class="col-md-6 text-end">
                                    <div class="btn-group" role="group">
                                        <button type="button" class="btn btn-outline-secondary" id="showVegetation">
                                            <i class="bi bi-tree"></i> Vegetation
                                        </button>
                                        <button type="button" class="btn btn-outline-secondary" id="showWeeds">
                                            <i class="bi bi-shield-exclamation"></i> Weeds
                                        </button>
                                        <button type="button" class="btn btn-outline-secondary" id="showWater">
                                            <i class="bi bi-droplet"></i> Water Sources
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="map-container">
                                <div id="mapid"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h5>Map Legend</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-3">
                                    <div class="d-flex align-items-center mb-2">
                                        <div style="width: 20px; height: 20px; background-color: #28a745; border-radius: 50%; margin-right: 10px;"></div>
                                        <span>Native Vegetation</span>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="d-flex align-items-center mb-2">
                                        <div style="width: 20px; height: 20px; background-color: #dc3545; border-radius: 50%; margin-right: 10px;"></div>
                                        <span>Weed Infestation</span>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="d-flex align-items-center mb-2">
                                        <div style="width: 20px; height: 20px; background-color: #007bff; border-radius: 50%; margin-right: 10px;"></div>
                                        <span>Water Source</span>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="d-flex align-items-center mb-2">
                                        <div style="width: 20px; height: 20px; background-color: #ffc107; border-radius: 50%; margin-right: 10px;"></div>
                                        <span>Restoration Area</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Assessments Section -->
                <div id="assessments" class="content-section d-none">
                    <h2 class="mb-4">Site Assessments</h2>
                    
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5>New Assessment</h5>
                        </div>
                        <div class="card-body">
                            <form id="assessmentForm">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="assessmentDate" class="form-label">Assessment Date</label>
                                            <input type="date" class="form-control" id="assessmentDate" required>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="assessor" class="form-label">Assessor</label>
                                            <input type="text" class="form-control" id="assessor" required>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="assessmentDescription" class="form-label">Description</label>
                                    <textarea class="form-control" id="assessmentDescription" rows="3" required></textarea>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Assessment Components</label>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" value="flora" id="componentFlora">
                                        <label class="form-check-label" for="componentFlora">
                                            Flora
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" value="fauna" id="componentFauna">
                                        <label class="form-check-label" for="componentFauna">
                                            Fauna
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" value="soil" id="componentSoil">
                                        <label class="form-check-label" for="componentSoil">
                                            Soil
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" value="water" id="componentWater">
                                        <label class="form-check-label" for="componentWater">
                                            Water Quality
                                        </label>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="healthStatus" class="form-label">Health Status</label>
                                            <select class="form-select" id="healthStatus" required>
                                                <option value="">Select status...</option>
                                                <option value="excellent">Excellent</option>
                                                <option value="good">Good</option>
                                                <option value="fair">Fair</option>
                                                <option value="poor">Poor</option>
                                                <option value="degraded">Degraded</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="threats" class="form-label">Threats Identified</label>
                                            <select class="form-select" id="threats" multiple>
                                                <option value="weeds">Weeds</option>
                                                <option value="erosion">Erosion</option>
                                                <option value="pests">Pests</option>
                                                <option value="fire">Fire Risk</option>
                                                <option value="water">Water Quality</option>
                                                <option value="access">Unauthorized Access</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="assessmentImages" class="form-label">Upload Images</label>
                                    <input class="form-control" type="file" id="assessmentImages" multiple accept="image/*">
                                    <div class="image-preview-container" id="assessmentImagePreview"></div>
                                </div>
                                
                                <button type="submit" class="btn btn-primary">Save Assessment</button>
                            </form>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5>Recent Assessments</h5>
                            <button class="btn btn-sm btn-outline-primary" id="exportAssessments">Export</button>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>Assessor</th>
                                            <th>Health Status</th>
                                            <th>Threats</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="assessmentsTable">
                                        <!-- Will be populated by JavaScript -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Species Section -->
                <div id="species" class="content-section d-none">
                    <h2 class="mb-4">Species Database</h2>
                    
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5>Add New Species</h5>
                        </div>
                        <div class="card-body">
                            <form id="speciesForm">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="speciesName" class="form-label">Species Name</label>
                                            <input type="text" class="form-control" id="speciesName" required>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="scientificName" class="form-label">Scientific Name</label>
                                            <input type="text" class="form-control" id="scientificName">
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            <label for="speciesType" class="form-label">Type</label>
                                            <select class="form-select" id="speciesType" required>
                                                <option value="">Select type...</option>
                                                <option value="plant">Plant</option>
                                                <option value="animal">Animal</option>
                                                <option value="bird">Bird</option>
                                                <option value="insect">Insect</option>
                                                <option value="reptile">Reptile</option>
                                                <option value="amphibian">Amphibian</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            <label for="speciesStatus" class="form-label">Conservation Status</label>
                                            <select class="form-select" id="speciesStatus" required>
                                                <option value="">Select status...</option>
                                                <option value="native">Native</option>
                                                <option value="introduced">Introduced</option>
                                                <option value="weed">Weed</option>
                                                <option value="pest">Pest</option>
                                                <option value="endangered">Endangered</option>
                                                <option value="vulnerable">Vulnerable</option>
                                                <option value="threatened">Threatened</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            <label for="riskLevel" class="form-label">Risk Level</label>
                                            <select class="form-select" id="riskLevel">
                                                <option value="">Select risk level...</option>
                                                <option value="low">Low</option>
                                                <option value="medium">Medium</option>
                                                <option value="high">High</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="speciesDescription" class="form-label">Description</label>
                                    <textarea class="form-control" id="speciesDescription" rows="3"></textarea>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="speciesHabitat" class="form-label">Habitat</label>
                                    <textarea class="form-control" id="speciesHabitat" rows="2"></textarea>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="speciesImage" class="form-label">Species Image</label>
                                    <input class="form-control" type="file" id="speciesImage" accept="image/*">
                                    <img id="speciesImagePreview" class="species-image-preview" src="#" alt="Image preview">
                                </div>
                                
                                <button type="submit" class="btn btn-primary">Add Species</button>
                            </form>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5>Species List</h5>
                            <div>
                                <input type="text" class="form-control form-control-sm d-inline-block w-auto" placeholder="Search species..." id="speciesSearch">
                                <button class="btn btn-sm btn-outline-primary ms-2" id="exportSpecies">Export</button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="row" id="speciesList">
                                <!-- Will be populated by JavaScript -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Activities Section -->
                <div id="activities" class="content-section d-none">
                    <h2 class="mb-4">Activities & Calendar</h2>
                    
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5>Schedule New Activity</h5>
                        </div>
                        <div class="card-body">
                            <form id="activityForm">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="activityTitle" class="form-label">Activity Title</label>
                                            <input type="text" class="form-control" id="activityTitle" required>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="activityType" class="form-label">Activity Type</label>
                                            <select class="form-select" id="activityType" required>
                                                <option value="">Select type...</option>
                                                <option value="weed-control">Weed Control</option>
                                                <option value="revegetation">Revegetation</option>
                                                <option value="erosion-control">Erosion Control</option>
                                                <option value="fauna-survey">Fauna Survey</option>
                                                <option value="vegetation-survey">Vegetation Survey</option>
                                                <option value="water-quality">Water Quality Testing</option>
                                                <option value="other">Other</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            <label for="startDate" class="form-label">Start Date</label>
                                            <input type="datetime-local" class="form-control" id="startDate" required>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            <label for="endDate" class="form-label">End Date</label>
                                            <input type="datetime-local" class="form-control" id="endDate">
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            <label for="activityStatus" class="form-label">Status</label>
                                            <select class="form-select" id="activityStatus" required>
                                                <option value="planned">Planned</option>
                                                <option value="in-progress">In Progress</option>
                                                <option value="completed">Completed</option>
                                                <option value="cancelled">Cancelled</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="location" class="form-label">Location</label>
                                            <input type="text" class="form-control" id="location">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="assignedTo" class="form-label">Assigned To</label>
                                            <input type="text" class="form-control" id="assignedTo">
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="activityDescription" class="form-label">Description</label>
                                    <textarea class="form-control" id="activityDescription" rows="3"></textarea>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="activityNotes" class="form-label">Notes</label>
                                    <textarea class="form-control" id="activityNotes" rows="2"></textarea>
                                </div>
                                
                                <button type="submit" class="btn btn-primary">Schedule Activity</button>
                            </form>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h5>Activity Calendar</h5>
                        </div>
                        <div class="card-body">
                            <div id="calendar"></div>
                        </div>
                    </div>
                </div>

                <!-- Monitoring Section -->
                <div id="monitoring" class="content-section d-none">
                    <h2 class="mb-4">Monitoring Data</h2>
                    
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5>Add Monitoring Data</h5>
                        </div>
                        <div class="card-body">
                            <form id="monitoringForm">
                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            <label for="monitoringDate" class="form-label">Date</label>
                                            <input type="date" class="form-control" id="monitoringDate" required>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            <label for="monitoringType" class="form-label">Monitoring Type</label>
                                            <select class="form-select" id="monitoringType" required>
                                                <option value="">Select type...</option>
                                                <option value="vegetation">Vegetation Health</option>
                                                <option value="water">Water Quality</option>
                                                <option value="wildlife">Wildlife Activity</option>
                                                <option value="soil">Soil Quality</option>
                                                <option value="weed">Weed Spread</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            <label for="monitoringLocation" class="form-label">Location</label>
                                            <input type="text" class="form-control" id="monitoringLocation" required>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="monitoringData" class="form-label">Data</label>
                                    <textarea class="form-control" id="monitoringData" rows="3" required></textarea>
                                    <div class="form-text">Enter monitoring data in key:value format, one per line (e.g., pH:7.2, Temperature:22.5)</div>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="monitoringObservations" class="form-label">Observations</label>
                                    <textarea class="form-control" id="monitoringObservations" rows="3"></textarea>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="monitoringImages" class="form-label">Upload Images</label>
                                    <input class="form-control" type="file" id="monitoringImages" multiple accept="image/*">
                                    <div class="image-preview-container" id="monitoringImagePreview"></div>
                                </div>
                                
                                <button type="submit" class="btn btn-primary">Save Monitoring Data</button>
                            </form>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5>Monitoring Records</h5>
                            <button class="btn btn-sm btn-outline-primary" id="exportMonitoring">Export</button>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>Type</th>
                                            <th>Location</th>
                                            <th>Key Metrics</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="monitoringTable">
                                        <!-- Will be populated by JavaScript -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Reports Section -->
                <div id="reports" class="content-section d-none">
                    <h2 class="mb-4">Reports & Analytics</h2>
                    
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5>Generate Report</h5>
                        </div>
                        <div class="card-body">
                            <form id="reportForm">
                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            <label for="reportType" class="form-label">Report Type</label>
                                            <select class="form-select" id="reportType" required>
                                                <option value="">Select report type...</option>
                                                <option value="assessment">Site Assessments</option>
                                                <option value="activity">Activities</option>
                                                <option value="species">Species</option>
                                                <option value="monitoring">Monitoring Data</option>
                                                <option value="compliance">Compliance</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            <label for="reportStartDate" class="form-label">Start Date</label>
                                            <input type="date" class="form-control" id="reportStartDate">
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="mb-3">
                            <label for="reportEndDate" class="form-label">End Date</label>
                            <input type="date" class="form-control" id="reportEndDate">
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label for="reportFormat" class="form-label">Format</label>
                            <select class="form-select" id="reportFormat" required>
                                <option value="html">HTML</option>
                                <option value="pdf">PDF</option>
                                <option value="csv">CSV</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-8">
                        <div class="mb-3">
                            <label class="form-label">Include Charts</label>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="includeCharts" checked>
                                <label class="form-check-label" for="includeCharts">Include charts in report</label>
                            </div>
                        </div>
                    </div>
                </div>
                
                <button type="submit" class="btn btn-primary">Generate Report</button>
            </form>
        </div>
    </div>
    
    <div class="card">
        <div class="card-header">
            <h5>Report Preview</h5>
        </div>
        <div class="card-body">
            <div id="reportPreview" class="p-3 border rounded">
                <p class="text-center text-muted">Generate a report to see the preview here.</p>
            </div>
        </div>
    </div>
</div>

<!-- Compliance Section -->
<div id="compliance" class="content-section d-none">
    <h2 class="mb-4">AHCECR301 Compliance</h2>
    
    <div class="card mb-4">
        <div class="card-header">
            <h5>Compliance Checklist</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-bordered">
                    <thead class="table-light">
                        <tr>
                            <th width="5%">#</th>
                            <th width="65%">Requirement</th>
                            <th width="15%">Compliant</th>
                            <th width="15%">Evidence</th>
                        </tr>
                    </thead>
                    <tbody id="complianceChecklistTable">
                        <!-- Will be populated by JavaScript -->
                    </tbody>
                </table>
            </div>
            <button class="btn btn-primary mt-3" id="saveCompliance">Save Compliance Data</button>
        </div>
    </div>
    
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5>Compliance Report</h5>
            <button class="btn btn-sm btn-outline-primary" id="generateComplianceReport">Generate Report</button>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <div class="card bg-light">
                        <div class="card-body text-center">
                            <h6>Compliance Status</h6>
                            <div class="display-4" id="compliancePercentage">0%</div>
                            <div class="progress mt-3" style="height: 20px;">
                                <div class="progress-bar" id="complianceProgress" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card bg-light">
                        <div class="card-body">
                            <h6 class="text-center">Compliance Breakdown</h6>
                            <canvas id="complianceChart" height="160"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Settings Section -->
<div id="settings" class="content-section d-none">
    <h2 class="mb-4">Settings</h2>
    
    <div class="card mb-4">
        <div class="card-header">
            <h5>User Profile</h5>
        </div>
        <div class="card-body">
            <form id="userProfileForm">
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="userName" class="form-label">Name</label>
                            <input type="text" class="form-control" id="userName" required>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="userEmail" class="form-label">Email</label>
                            <input type="email" class="form-control" id="userEmail" required>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="userRole" class="form-label">Role</label>
                            <input type="text" class="form-control" id="userRole" required>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="userOrganization" class="form-label">Organization</label>
                            <input type="text" class="form-control" id="userOrganization">
                        </div>
                    </div>
                </div>
                
                <div class="mb-3">
                    <label for="userBio" class="form-label">Bio</label>
                    <textarea class="form-control" id="userBio" rows="3"></textarea>
                </div>
                
                <button type="submit" class="btn btn-primary">Update Profile</button>
            </form>
        </div>
    </div>
    
    <div class="card mb-4">
        <div class="card-header">
            <h5>Change Password</h5>
        </div>
        <div class="card-body">
            <form id="changePasswordForm">
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="currentPassword" class="form-label">Current Password</label>
                            <input type="password" class="form-control" id="currentPassword" required>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="newPassword" class="form-label">New Password</label>
                            <input type="password" class="form-control" id="newPassword" required>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="confirmPassword" class="form-label">Confirm Password</label>
                            <input type="password" class="form-control" id="confirmPassword" required>
                        </div>
                    </div>
                </div>
                
                <button type="submit" class="btn btn-primary">Change Password</button>
            </form>
        </div>
    </div>
    
    <div class="card mb-4">
        <div class="card-header">
            <h5>Site Settings</h5>
        </div>
        <div class="card-body">
            <form id="siteSettingsForm">
                <div class="mb-3">
                    <label for="siteName" class="form-label">Site Name</label>
                    <input type="text" class="form-control" id="siteName" required>
                </div>
                
                <div class="mb-3">
                    <label for="siteLocation" class="form-label">Location</label>
                    <input type="text" class="form-control" id="siteLocation" required>
                </div>
                
                <div class="mb-3">
                    <label for="siteArea" class="form-label">Area (hectares)</label>
                    <input type="number" class="form-control" id="siteArea" step="0.01" required>
                </div>
                
                <div class="mb-3">
                    <label for="siteDescription" class="form-label">Description</label>
                    <textarea class="form-control" id="siteDescription" rows="3"></textarea>
                </div>
                
                <div class="form-check form-switch mb-3">
                    <input class="form-check-input" type="checkbox" id="enableNotifications" checked>
                    <label class="form-check-label" for="enableNotifications">Enable Email Notifications</label>
                </div>
                
                <div class="form-check form-switch mb-3">
                    <input class="form-check-input" type="checkbox" id="enableReminders" checked>
                    <label class="form-check-label" for="enableReminders">Enable Activity Reminders</label>
                </div>
                
                <button type="submit" class="btn btn-primary">Save Settings</button>
            </form>
        </div>
    </div>
    
    <div class="card">
        <div class="card-header">
            <h5>Data Management</h5>
        </div>
        <div class="card-body">
            <div class="d-grid gap-2 d-md-block">
                <button class="btn btn-outline-primary me-2" id="exportAllData">Export All Data</button>
                <button class="btn btn-outline-success me-2" id="backupDatabase">Backup Database</button>
                <button class="btn btn-outline-danger" id="resetTestData">Reset Test Data</button>
            </div>
        </div>
    </div>
</div>
</div>
</div>
</div>

<!-- Assessment Modal -->
<div class="modal fade" id="assessmentModal" tabindex="-1" aria-labelledby="assessmentModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="assessmentModalLabel">Assessment Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="assessmentModalBody">
                <!-- Assessment details will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Species Modal -->
<div class="modal fade" id="speciesModal" tabindex="-1" aria-labelledby="speciesModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="speciesModalLabel">Species Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="speciesModalBody">
                <!-- Species details will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Activity Modal -->
<div class="modal fade" id="activityModal" tabindex="-1" aria-labelledby="activityModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="activityModalLabel">Activity Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="activityModalBody">
                <!-- Activity details will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="editActivityBtn">Edit</button>
            </div>
        </div>
    </div>
</div>

<!-- Monitoring Modal -->
<div class="modal fade" id="monitoringModal" tabindex="-1" aria-labelledby="monitoringModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="monitoringModalLabel">Monitoring Data Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="monitoringModalBody">
                <!-- Monitoring details will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Project Modal -->
<div class="modal fade" id="projectModal" tabindex="-1" aria-labelledby="projectModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="projectModalLabel">Project Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="projectModalBody">
                <!-- Project details will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript Libraries -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
        crossorigin=""></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    // Database structure
    let db = {
        projects: [],
        assessments: [],
        species: [],
        activities: [],
        monitoring: [],
        complianceChecklist: [],
        settings: {
            userProfile: {},
            siteSettings: {}
        },
        mapData: {
            markers: [],
            polygons: [],
            polylines: []
        }
    };

    // Load data from localStorage
    function loadData() {
        const savedData = localStorage.getItem('ecosystemManagerData');
        if (savedData) {
            db = JSON.parse(savedData);
        } else {
            // Add sample data if no data exists
            addSampleData();
        }
    }

    // Save data to localStorage
    function saveData() {
        localStorage.setItem('ecosystemManagerData', JSON.stringify(db));
    }

    // Show toast notification
    function showToast(title, message, type = 'success') {
        const toast = document.getElementById('liveToast');
        const toastTitle = document.getElementById('toast-title');
        const toastMessage = document.getElementById('toast-message');
        
        toastTitle.textContent = title;
        toastMessage.textContent = message;
        
        // Set background color based on type
        const header = toast.querySelector('.toast-header');
        if (type === 'error') {
            header.classList.add('bg-danger', 'text-white');
            header.classList.remove('bg-success', 'bg-warning');
        } else if (type === 'warning') {
            header.classList.add('bg-warning', 'text-dark');
            header.classList.remove('bg-success', 'bg-danger');
        } else {
            header.classList.add('bg-success', 'text-white');
            header.classList.remove('bg-danger', 'bg-warning');
        }
        
        const bsToast = new bootstrap.Toast(toast);
        bsToast.show();
    }

    // Add sample data to the database
    function addSampleData() {
        // Sample projects
        db.projects = [
            {
                id: generateId(),
                name: 'Northern Creek Restoration',
                code: 'NCR-2023',
                startDate: new Date('2023-01-15').toISOString(),
                endDate: new Date('2023-12-15').toISOString(),
                description: 'Restoration of the northern creekline to improve water quality and habitat value.',
                status: 'active',
                manager: 'Dr. Jane Smith',
                location: 'Northern Reserve',
                createdAt: new Date('2023-01-10').toISOString()
            },
            {
                id: generateId(),
                name: 'Woodland Biodiversity Survey',
                code: 'WBS-2023',
                startDate: new Date('2023-03-01').toISOString(),
                endDate: new Date('2023-11-30').toISOString(),
                description: 'Comprehensive survey of flora and fauna in the woodland ecosystem.',
                status: 'active',
                manager: 'John Davis',
                location: 'Eastern Woodlands',
                createdAt: new Date('2023-02-15').toISOString()
            },
            {
                id: generateId(),
                name: 'Weed Management Program',
                code: 'WMP-2023',
                startDate: new Date('2023-02-01').toISOString(),
                endDate: new Date('2023-10-31').toISOString(),
                description: 'Control and eradication of invasive weed species across the reserve.',
                status: 'active',
                manager: 'Sarah Wilson',
                location: 'Entire Reserve',
                createdAt: new Date('2023-01-20').toISOString()
            }
        ];

        // Sample assessments
        db.assessments = [
            {
                id: generateId(),
                date: new Date('2023-06-15').toISOString(),
                assessor: 'Dr. Jane Smith',
                description: 'Initial assessment of the northern woodland area. Found healthy native vegetation with some weed infestation.',
                components: ['flora', 'fauna', 'soil'],
                health: 'good',
                threats: ['weeds', 'erosion'],
                images: [],
                createdAt: new Date('2023-06-15').toISOString()
            },
            {
                id: generateId(),
                date: new Date('2023-08-22').toISOString(),
                assessor: 'John Davis',
                description: 'Follow-up assessment after revegetation efforts. Significant improvement in native species coverage.',
                components: ['flora', 'water'],
                health: 'excellent',
                threats: ['pests'],
                images: [],
                createdAt: new Date('2023-08-22').toISOString()
            },
            {
                id: generateId(),
                date: new Date('2023-11-05').toISOString(),
                assessor: 'Sarah Wilson',
                description: 'Post-fire assessment. Some areas show recovery but others need intervention.',
                components: ['flora', 'soil', 'fauna'],
                health: 'fair',
                threats: ['fire', 'erosion'],
                images: [],
                createdAt: new Date('2023-11-05').toISOString()
            }
        ];

        // Sample species
        db.species = [
            {
                id: generateId(),
                name: 'River Red Gum',
                scientificName: 'Eucalyptus camaldulensis',
                type: 'plant',
                status: 'native',
                riskLevel: 'low',
                description: 'Large tree found along watercourses. Important habitat for many bird and mammal species.',
                habitat: 'Riverbanks and floodplains',
                image: '',
                createdAt: new Date('2023-05-10').toISOString()
            },
            {
                id: generateId(),
                name: 'Kangaroo Grass',
                scientificName: 'Themeda triandra',
                type: 'plant',
                status: 'native',
                riskLevel: 'low',
                description: 'Perennial tussock grass that is a key component of native grasslands.',
                habitat: 'Open woodlands and grasslands',
                image: '',
                createdAt: new Date('2023-05-12').toISOString()
            },
            {
                id: generateId(),
                name: 'Blackberry',
                scientificName: 'Rubus fruticosus',
                type: 'plant',
                status: 'weed',
                riskLevel: 'high',
                description: 'Invasive shrub that forms dense thickets, outcompeting native vegetation.',
                habitat: 'Disturbed areas, riverbanks',
                image: '',
                createdAt: new Date('2023-05-15').toISOString()
            },
            {
                id: generateId(),
                name: 'Eastern Grey Kangaroo',
                scientificName: 'Macropus giganteus',
                type: 'animal',
                status: 'native',
                riskLevel: 'low',
                description: 'Large marsupial commonly found in woodland areas.',
                habitat: 'Woodlands, grasslands',
                image: '',
                createdAt: new Date('2023-05-18').toISOString()
            },
            {
                id: generateId(),
                name: 'Superb Fairy-wren',
                scientificName: 'Malurus cyaneus',
                type: 'bird',
                status: 'native',
                riskLevel: 'low',
                description: 'Small bird with bright blue plumage in breeding males. Often found in dense vegetation.',
                habitat: 'Dense understorey vegetation',
                image: '',
                createdAt: new Date('2023-05-20').toISOString()
            },
            {
                id: generateId(),
                name: 'European Rabbit',
                scientificName: 'Oryctolagus cuniculus',
                type: 'animal',
                status: 'pest',
                riskLevel: 'high',
                description: 'Introduced species that causes significant damage through grazing and burrowing.',
                habitat: 'Various, particularly grasslands',
                image: '',
                createdAt: new Date('2023-05-22').toISOString()
            }
        ];

        // Sample activities
        const today = new Date();
        const nextWeek = new Date(today);
        nextWeek.setDate(today.getDate() + 7);
        
        const twoWeeks = new Date(today);
        twoWeeks.setDate(today.getDate() + 14);
        
        db.activities = [
            {
                id: generateId(),
                title: 'Weed Control - Blackberry',
                type: 'weed-control',
                startDate: new Date('2023-09-10').toISOString(),
                endDate: new Date('2023-09-12').toISOString(),
                status: 'completed',
                location: 'Northern Creekline',
                assignedTo: 'Volunteer Team A',
                description: 'Manual removal and herbicide treatment of blackberry infestation along creekline.',
                notes: 'Need to follow up in 3 months to check for regrowth',
                createdAt: new Date('2023-08-25').toISOString()
            },
            {
                id: generateId(),
                title: 'Native Planting Day',
                type: 'revegetation',
                startDate: nextWeek.toISOString(),
                endDate: nextWeek.toISOString(),
                status: 'planned',
                location: 'Eastern Slope',
                assignedTo: 'Community Volunteers',
                description: 'Planting of 500 native seedlings including wattles, gums and groundcovers.',
                notes: 'Ensure all volunteers have gloves and water',
                createdAt: new Date('2023-10-01').toISOString()
            },
            {
                id: generateId(),
                title: 'Water Quality Testing',
                type: 'water-quality',
                startDate: twoWeeks.toISOString(),
                endDate: twoWeeks.toISOString(),
                status: 'planned',
                location: 'Main Dam',
                assignedTo: 'Sarah Wilson',
                description: 'Monthly water quality testing for pH, turbidity, and nutrient levels.',
                notes: 'Take samples from 3 different points',
                createdAt: new Date('2023-10-05').toISOString()
            },
            {
                id: generateId(),
                title: 'Bird Survey',
                type: 'fauna-survey',
                startDate: new Date('2023-07-15').toISOString(),
                endDate: new Date('2023-07-15').toISOString(),
                status: 'completed',
                location: 'Whole Site',
                assignedTo: 'Bird Watching Group',
                description: 'Annual bird survey to monitor population changes and species diversity.',
                notes: 'Record all sightings using the eBird app',
                createdAt: new Date('2023-06-20').toISOString()
            }
        ];

        // Sample monitoring data
        db.monitoring = [
            {
                id: generateId(),
                date: new Date('2023-10-01').toISOString(),
                type: 'water',
                location: 'Main Dam',
                data: {
                    pH: '7.2',
                    temperature: '18.5C',
                    turbidity: '5 NTU',
                    dissolvedOxygen: '8.2 mg/L'
                },
                observations: 'Water quality good. Slight algal bloom on northern edge.',
                images: [],
                createdAt: new Date('2023-10-01').toISOString()
            },
            {
                id: generateId(),
                date: new Date('2023-09-15').toISOString(),
                type: 'vegetation',
                location: 'Revegetation Area 2',
                data: {
                    survivalRate: '85%',
                    heightIncrease: '25 cm',
                    weedCover: '5%'
                },
                observations: 'Excellent survival rate. Minimal weed competition.',
                images: [],
                createdAt: new Date('2023-09-15').toISOString()
            },
            {
                id: generateId(),
                date: new Date('2023-08-20').toISOString(),
                type: 'wildlife',
                location: 'Northern Woodland',
                data: {
                    kangarooCount: '12',
                    birdSpecies: '23',
                    reptileSightings: '5'
                },
                observations: 'Increased bird diversity compared to last survey.',
                images: [],
                createdAt: new Date('2023-08-20').toISOString()
            }
        ];

        // Sample compliance checklist
        db.complianceChecklist = [
            { id: 1, requirement: 'Identify native species', compliant: 'Yes', evidence: 'Species database maintained' },
            { id: 2, requirement: 'Monitor ecosystem health', compliant: 'Yes', evidence: 'Regular assessments conducted' },
            { id: 3, requirement: 'Control invasive species', compliant: 'Yes', evidence: 'Weed management program in place' },
            { id: 4, requirement: 'Maintain water quality', compliant: 'Yes', evidence: 'Monthly testing records' },
            { id: 5, requirement: 'Protect habitat values', compliant: 'Yes', evidence: 'Habitat restoration activities documented' },
            { id: 6, requirement: 'Record keeping', compliant: 'Yes', evidence: 'Digital records maintained' },
            { id: 7, requirement: 'Report incidents', compliant: 'No', evidence: 'No incident reporting system' },
            { id: 8, requirement: 'Community engagement', compliant: 'Partial', evidence: 'Volunteer events but no formal program' }
        ];

        // Sample settings
        db.settings = {
            userProfile: {
                name: 'Ecosystem Manager',
                email: 'manager@ecosystem.org',
                role: 'Site Manager',
                organization: 'Conservation Trust',
                bio: 'Responsible for managing the native ecosystem restoration project.'
            },
            siteSettings: {
                siteName: 'Northern Reserve',
                location: '123 Conservation Rd, Bushland',
                area: 45.2,
                description: 'Mixed woodland with creekline and grassland areas. Important habitat for native species.',
                enableNotifications: true,
                enableReminders: true
            }
        };

        // Sample map data
        db.mapData = {
            markers: [
                { id: generateId(), lat: -37.8136, lng: 144.9631, title: 'Main Entrance', description: 'Primary access point', type: 'entrance' },
                { id: generateId(), lat: -37.8140, lng: 144.9625, title: 'Bird Hide', description: 'Observation point for bird watching', type: 'facility' },
                { id: generateId(), lat: -37.8128, lng: 144.9642, title: 'Weed Infestation', description: 'Area requiring treatment', type: 'issue' }
            ],
            polygons: [
                { 
                    id: generateId(), 
                    points: [
                        [-37.8136, 144.9631],
                        [-37.8140, 144.9625],
                        [-37.8128, 144.9642],
                        [-37.8132, 144.9648]
                    ], 
                    title: 'Revegetation Area', 
                    description: 'Zone 1 - Native planting completed 2022', 
                    type: 'vegetation' 
                }
            ],
            polylines: [
                { 
                    id: generateId(), 
                    points: [
                        [-37.8136, 144.9631],
                        [-37.8140, 144.9625],
                        [-37.8128, 144.9642]
                    ], 
                    title: 'Walking Trail', 
                    description: 'Main access path through reserve', 
                    type: 'path' 
                }
            ]
        };

        saveData();
    }

    // Initialize the application
    function initApp() {
        loadData();
        setupEventListeners();
        loadDashboard();
        loadProjects();
        loadAssessments();
        loadSpecies();
        loadActivities();
        loadMonitoring();
        loadReports();
        loadComplianceChecklist();
        loadSettings();
        initMap();
        initCharts();
    }

    // Load dashboard data
    function loadDashboard() {
        // Overdue activities
        const overdueTable = document.getElementById('overdueActivitiesTable');
        overdueTable.innerHTML = '';

        const today = new Date();
        today.setHours(0, 0, 0, 0);

        const overdueActivities = db.activities
            .filter(a => (a.status === 'planned' || a.status === 'in-progress') && new Date(a.startDate) < today)
            .sort((a, b) => new Date(a.startDate) - new Date(b.startDate));

        if (overdueActivities.length === 0) {
            overdueTable.innerHTML = '<tr><td colspan="7" class="text-center">No overdue activities</td></tr>';
        } else {
            overdueActivities.forEach(activity => {
                const row = overdueTable.insertRow();
                row.innerHTML = `
                    <td>${activity.title}</td>
                    <td>${formatActivityType(activity.type)}</td>
                    <td>${formatDate(activity.startDate)}</td>
                    <td>${activity.location}</td>
                    <td>${activity.assignedTo}</td>
                    <td><span class="badge ${getStatusBadgeClass(activity.status)}">${capitalizeFirstLetter(activity.status)}</span></td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary view-activity" data-id="${activity.id}">Details</button>
                        <button class="btn btn-sm btn-outline-warning reschedule-activity" data-id="${activity.id}">Reschedule</button>
                    </td>
                `;
            });
        }

        // Add event listeners to overdue activity buttons
        document.querySelectorAll('.view-activity').forEach(btn => {
            btn.addEventListener('click', function() {
                const activityId = this.getAttribute('data-id');
                const activity = db.activities.find(a => a.id == activityId);
                if (activity) {
                    showActivityDetails(activity);
                }
            });
        });

        document.querySelectorAll('.reschedule-activity').forEach(btn => {
            btn.addEventListener('click', function() {
                const activityId = this.getAttribute('data-id');
                const activity = db.activities.find(a => a.id == activityId);
                if (activity) {
                    rescheduleActivity(activity);
                }
            });
        });
    }

    // Load projects
    function loadProjects() {
        const projectsList = document.getElementById('projectsList');
        projectsList.innerHTML = '';

        if (db.projects.length === 0) {
            projectsList.innerHTML = '<div class="col-12 text-center">No projects created yet</div>';
        } else {
            db.projects.forEach(project => {
                const col = document.createElement('div');
                col.className = 'col-md-6 col-lg-4 mb-4';
                col.innerHTML = `
                    <div class="card project-card h-100">
                        <div class="card-body">
                            <h5 class="card-title">${project.name}</h5>
                            <h6 class="card-subtitle mb-2 text-muted">${project.code}</h6>
                            <div class="mb-2">
                                <span class="badge ${getProjectStatusBadgeClass(project.status)} me-1">${capitalizeFirstLetter(project.status)}</span>
                            </div>
                            <p class="card-text">${project.description.substring(0, 100)}...</p>
                            <p class="card-text"><small class="text-muted">Manager: ${project.manager}</small></p>
                            <p class="card-text"><small class="text-muted">Location: ${project.location}</small></p>
                        </div>
                        <div class="card-footer bg-transparent">
                            <button class="btn btn-sm btn-outline-primary view-project" data-id="${project.id}">View Details</button>
                            <button class="btn btn-sm btn-outline-danger delete-project" data-id="${project.id}">Delete</button>
                        </div>
                    </div>
                `;
                projectsList.appendChild(col);
            });
        }

        // Add event listeners to project buttons
        document.querySelectorAll('.view-project').forEach(btn => {
            btn.addEventListener('click', function() {
                const projectId = this.getAttribute('data-id');
                const project = db.projects.find(p => p.id == projectId);
                if (project) {
                    showProjectDetails(project);
                }
            });
        });

        document.querySelectorAll('.delete-project').forEach(btn => {
            btn.addEventListener('click', function() {
                const projectId = this.getAttribute('data-id');
                if (confirm('Are you sure you want to delete this project?')) {
                    db.projects = db.projects.filter(p => p.id != projectId);
                    saveData();
                    loadProjects();
                    showToast('Success', 'Project deleted successfully');
                }
            });
        });

        // Add search functionality
        const projectSearch = document.getElementById('projectSearch');
        if (projectSearch) {
            projectSearch.addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                const projectCards = document.querySelectorAll('.project-card');
                
                projectCards.forEach(card => {
                    const title = card.querySelector('.card-title').textContent.toLowerCase();
                    const subtitle = card.querySelector('.card-subtitle').textContent.toLowerCase();
                    const text = card.querySelector('.card-text').textContent.toLowerCase();
                    
                    if (title.includes(searchTerm) || subtitle.includes(searchTerm) || text.includes(searchTerm)) {
                        card.parentElement.style.display = 'block';
                    } else {
                        card.parentElement.style.display = 'none';
                    }
                });
            });
        }
    }

    // Load assessments
    function loadAssessments() {
        const assessmentsTable = document.getElementById('assessmentsTable');
        assessmentsTable.innerHTML = '';

        if (db.assessments.length === 0) {
            assessmentsTable.innerHTML = '<tr><td colspan="5" class="text-center">No assessments recorded</td></tr>';
        } else {
            db.assessments.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(assessment => {
                const row = assessmentsTable.insertRow();
                row.innerHTML = `
                    <td>${formatDate(assessment.date)}</td>
                    <td>${assessment.assessor}</td>
                    <td><span class="badge ${getHealthBadgeClass(assessment.health)}">${capitalizeFirstLetter(assessment.health)}</span></td>
                    <td>${assessment.threats.map(t => capitalizeFirstLetter(t)).join(', ')}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary view-assessment" data-id="${assessment.id}">View</button>
                        <button class="btn btn-sm btn-outline-danger delete-assessment" data-id="${assessment.id}">Delete</button>
                    </td>
                `;
            });
        }

        // Add event listeners to assessment buttons
        document.querySelectorAll('.view-assessment').forEach(btn => {
            btn.addEventListener('click', function() {
                const assessmentId = this.getAttribute('data-id');
                const assessment = db.assessments.find(a => a.id == assessmentId);
                if (assessment) {
                    showAssessmentDetails(assessment);
                }
            });
        });

        document.querySelectorAll('.delete-assessment').forEach(btn => {
            btn.addEventListener('click', function() {
                const assessmentId = this.getAttribute('data-id');
                if (confirm('Are you sure you want to delete this assessment?')) {
                    db.assessments = db.assessments.filter(a => a.id != assessmentId);
                    saveData();
                    loadAssessments();
                    showToast('Success', 'Assessment deleted successfully');
                }
            });
        });
    }

    // Load species
    function loadSpecies() {
        const speciesList = document.getElementById('speciesList');
        speciesList.innerHTML = '';

        if (db.species.length === 0) {
            speciesList.innerHTML = '<div class="col-12 text-center">No species recorded</div>';
        } else {
            db.species.forEach(species => {
                const col = document.createElement('div');
                col.className = 'col-md-6 col-lg-4 mb-4';
                col.innerHTML = `
                    <div class="card species-card h-100">
                        <div class="card-body">
                            <h5 class="card-title">${species.name}</h5>
                            <h6 class="card-subtitle mb-2 text-muted">${species.scientificName}</h6>
                            <div class="mb-2">
                                <span class="badge ${getSpeciesStatusBadgeClass(species.status)} me-1">${capitalizeFirstLetter(species.status)}</span>
                                ${species.riskLevel ? `<span class="risk-indicator risk-${species.riskLevel}"></span>` : ''}
                            </div>
                            <p class="card-text">${species.description.substring(0, 100)}...</p>
                        </div>
                        <div class="card-footer bg-transparent">
                            <button class="btn btn-sm btn-outline-primary view-species" data-id="${species.id}">View Details</button>
                            <button class="btn btn-sm btn-outline-danger delete-species" data-id="${species.id}">Delete</button>
                        </div>
                    </div>
                `;
                speciesList.appendChild(col);
            });
        }

        // Add event listeners to species buttons
        document.querySelectorAll('.view-species').forEach(btn => {
            btn.addEventListener('click', function() {
                const speciesId = this.getAttribute('data-id');
                const species = db.species.find(s => s.id == speciesId);
                if (species) {
                    showSpeciesDetails(species);
                }
            });
        });

        document.querySelectorAll('.delete-species').forEach(btn => {
            btn.addEventListener('click', function() {
                const speciesId = this.getAttribute('data-id');
                if (confirm('Are you sure you want to delete this species?')) {
                    db.species = db.species.filter(s => s.id != speciesId);
                    saveData();
                    loadSpecies();
                    showToast('Success', 'Species deleted successfully');
                }
            });
        });

        // Add search functionality
        const speciesSearch = document.getElementById('speciesSearch');
        if (speciesSearch) {
            speciesSearch.addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                const speciesCards = document.querySelectorAll('.species-card');
                
                speciesCards.forEach(card => {
                    const title = card.querySelector('.card-title').textContent.toLowerCase();
                    const subtitle = card.querySelector('.card-subtitle').textContent.toLowerCase();
                    const text = card.querySelector('.card-text').textContent.toLowerCase();
                    
                    if (title.includes(searchTerm) || subtitle.includes(searchTerm) || text.includes(searchTerm)) {
                        card.parentElement.style.display = 'block';
                    } else {
                        card.parentElement.style.display = 'none';
                    }
                });
            });
        }
    }

    // Load activities and initialize calendar
    function loadActivities() {
        // Initialize calendar
        const calendarEl = document.getElementById('calendar');
        if (calendarEl) {
            // Clear any existing calendar
            calendarEl.innerHTML = '';
            
            const calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay'
                },
                events: db.activities.map(activity => ({
                    id: activity.id,
                    title: activity.title,
                    start: activity.startDate,
                    end: activity.endDate || activity.startDate,
                    extendedProps: {
                        type: activity.type,
                        status: activity.status,
                        location: activity.location,
                        assignedTo: activity.assignedTo,
                        description: activity.description,
                        notes: activity.notes
                    },
                    backgroundColor: getActivityColor(activity.type),
                    borderColor: getActivityColor(activity.type),
                    textColor: '#fff'
                })),
                eventClick: function(info) {
                    const activity = db.activities.find(a => a.id === info.event.id);
                    if (activity) {
                        showActivityDetails(activity);
                    }
                }
            });
            calendar.render();
        }
    }

    // Load monitoring data
    function loadMonitoring() {
        const monitoringTable = document.getElementById('monitoringTable');
        monitoringTable.innerHTML = '';

        if (db.monitoring.length === 0) {
            monitoringTable.innerHTML = '<tr><td colspan="5" class="text-center">No monitoring data recorded</td></tr>';
        } else {
            db.monitoring.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(monitoring => {
                const row = monitoringTable.insertRow();
                row.innerHTML = `
                    <td>${formatDate(monitoring.date)}</td>
                    <td>${capitalizeFirstLetter(monitoring.type)}</td>
                    <td>${monitoring.location}</td>
                    <td>${Object.entries(monitoring.data).map(([key, value]) => `${key}: ${value}`).join(', ')}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary view-monitoring" data-id="${monitoring.id}">View</button>
                        <button class="btn btn-sm btn-outline-danger delete-monitoring" data-id="${monitoring.id}">Delete</button>
                    </td>
                `;
            });
        }

        // Add event listeners to monitoring buttons
        document.querySelectorAll('.view-monitoring').forEach(btn => {
            btn.addEventListener('click', function() {
                const monitoringId = this.getAttribute('data-id');
                const monitoring = db.monitoring.find(m => m.id == monitoringId);
                if (monitoring) {
                    showMonitoringDetails(monitoring);
                }
            });
        });

        document.querySelectorAll('.delete-monitoring').forEach(btn => {
            btn.addEventListener('click', function() {
                const monitoringId = this.getAttribute('data-id');
                if (confirm('Are you sure you want to delete this monitoring data?')) {
                    db.monitoring = db.monitoring.filter(m => m.id != monitoringId);
                    saveData();
                    loadMonitoring();
                    showToast('Success', 'Monitoring data deleted successfully');
                }
            });
        });
    }

    // Load reports
    function loadReports() {
        // Reports are generated on demand, so no initial loading needed
    }

    // Load compliance checklist
    function loadComplianceChecklist() {
        const checklistTable = document.getElementById('complianceChecklistTable');
        checklistTable.innerHTML = '';

        db.complianceChecklist.forEach(item => {
            const row = checklistTable.insertRow();
            row.innerHTML = `
                <td>${item.id}</td>
                <td>${item.requirement}</td>
                <td>
                    <select class="form-select form-select-sm compliant-select" data-id="${item.id}">
                        <option value="Yes" ${item.compliant === 'Yes' ? 'selected' : ''}>Yes</option>
                        <option value="No" ${item.compliant === 'No' ? 'selected' : ''}>No</option>
                        <option value="Partial" ${item.compliant === 'Partial' ? 'selected' : ''}>Partial</option>
                    </select>
                </td>
                <td>
                    <input type="text" class="form-control form-control-sm evidence-input" data-id="${item.id}" value="${item.evidence || ''}">
                </td>
            `;
        });

        // Add event listeners to compliance inputs
        document.querySelectorAll('.compliant-select').forEach(select => {
            select.addEventListener('change', function() {
                const id = this.getAttribute('data-id');
                const item = db.complianceChecklist.find(i => i.id == id);
                if (item) {
                    item.compliant = this.value;
                    saveData();
                }
            });
        });

        document.querySelectorAll('.evidence-input').forEach(input => {
            input.addEventListener('change', function() {
                const id = this.getAttribute('data-id');
                const item = db.complianceChecklist.find(i => i.id == id);
                if (item) {
                    item.evidence = this.value;
                    saveData();
                }
            });
        });

        // Update compliance percentage
        updateCompliancePercentage();
    }

    // Load settings
    function loadSettings() {
        // Load user profile
        if (db.settings.userProfile) {
            document.getElementById('userName').value = db.settings.userProfile.name || '';
            document.getElementById('userEmail').value = db.settings.userProfile.email || '';
            document.getElementById('userRole').value = db.settings.userProfile.role || '';
            document.getElementById('userOrganization').value = db.settings.userProfile.organization || '';
            document.getElementById('userBio').value = db.settings.userProfile.bio || '';
        }

        // Load site settings
        if (db.settings.siteSettings) {
            document.getElementById('siteName').value = db.settings.siteSettings.siteName || '';
            document.getElementById('siteLocation').value = db.settings.siteSettings.location || '';
            document.getElementById('siteArea').value = db.settings.siteSettings.area || '';
            document.getElementById('siteDescription').value = db.settings.siteSettings.description || '';
            document.getElementById('enableNotifications').checked = db.settings.siteSettings.enableNotifications || false;
            document.getElementById('enableReminders').checked = db.settings.siteSettings.enableReminders || false;
        }
    }

    // Initialize map
    function initMap() {
        // Create map centered on a default location (Melbourne)
        const map = L.map('mapid').setView([-37.8136, 144.9631], 15);
        
        // Add base tile layer
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);
        
        // Initialize the feature group to store editable layers
        const drawnItems = new L.FeatureGroup();
        map.addLayer(drawnItems);
        
        // Initialize the draw control and pass it the FeatureGroup of editable layers
        const drawControl = new L.Control.Draw({
            edit: {
                featureGroup: drawnItems
            },
            draw: {
                polygon: true,
                polyline: true,
                marker: true,
                circle: false,
                rectangle: false,
                circlemarker: false
            }
        });
        map.addControl(drawControl);
        
        // Add sample data to map
        addMapSampleData(map, drawnItems);
        
        // Event listeners for drawing actions
        map.on(L.Draw.Event.CREATED, function (e) {
            const type = e.layerType;
            const layer = e.layer;
            
            // Assign an ID to the layer
            layer._id = generateId();
            
            // Add popup with layer details
            if (type === 'marker') {
                layer.bindPopup(`
                    <b>Marker</b><br>
                    Latitude: ${layer.getLatLng().lat.toFixed(6)}<br>
                    Longitude: ${layer.getLatLng().lng.toFixed(6)}<br>
                    <button class="btn btn-sm btn-primary mt-2 edit-feature" data-id="${layer._id}">Edit Details</button>
                `);
                
                // Save to database
                db.mapData.markers.push({
                    id: layer._id,
                    lat: layer.getLatLng().lat,
                    lng: layer.getLatLng().lng,
                    title: 'New Marker',
                    description: '',
                    type: 'marker'
                });
            } else if (type === 'polygon') {
                const latlngs = layer.getLatLngs()[0].map(latlng => [latlng.lat, latlng.lng]);
                layer.bindPopup(`
                    <b>Polygon</b><br>
                    Area: ${L.GeometryUtil.geodesicArea(latlngs).toFixed(2)} sq meters<br>
                    <button class="btn btn-sm btn-primary mt-2 edit-feature" data-id="${layer._id}">Edit Details</button>
                `);
                
                // Save to database
                db.mapData.polygons.push({
                    id: layer._id,
                    points: latlngs,
                    title: 'New Polygon',
                    description: '',
                    type: 'polygon'
                });
            } else if (type === 'polyline') {
                const latlngs = layer.getLatLngs().map(latlng => [latlng.lat, latlng.lng]);
                layer.bindPopup(`
                    <b>Polyline</b><br>
                    Length: ${L.GeometryUtil.length(latlngs).toFixed(2)} meters<br>
                    <button class="btn btn-sm btn-primary mt-2 edit-feature" data-id="${layer._id}">Edit Details</button>
                `);
                
                // Save to database
                db.mapData.polylines.push({
                    id: layer._id,
                    points: latlngs,
                    title: 'New Polyline',
                    description: '',
                    type: 'polyline'
                });
            }
            
            drawnItems.addLayer(layer);
            saveData();
            showToast('Success', 'Map feature added successfully');
        });
        
        map.on(L.Draw.Event.EDITED, function (e) {
            const layers = e.layers;
            layers.eachLayer(function(layer) {
                // Update database with edited layer
                if (layer instanceof L.Marker) {
                    const marker = db.mapData.markers.find(m => m.id === layer._id);
                    if (marker) {
                        marker.lat = layer.getLatLng().lat;
                        marker.lng = layer.getLatLng().lng;
                    }
                } else if (layer instanceof L.Polygon) {
                    const polygon = db.mapData.polygons.find(p => p.id === layer._id);
                    if (polygon) {
                        polygon.points = layer.getLatLngs()[0].map(latlng => [latlng.lat, latlng.lng]);
                    }
                } else if (layer instanceof L.Polyline) {
                    const polyline = db.mapData.polylines.find(p => p.id === layer._id);
                    if (polyline) {
                        polyline.points = layer.getLatLngs().map(latlng => [latlng.lat, latlng.lng]);
                    }
                }
            });
            saveData();
            showToast('Success', 'Map features updated successfully');
        });
        
        map.on(L.Draw.Event.DELETED, function (e) {
            const layers = e.layers;
            layers.eachLayer(function(layer) {
                // Remove from database
                if (layer instanceof L.Marker) {
                    db.mapData.markers = db.mapData.markers.filter(m => m.id !== layer._id);
                } else if (layer instanceof L.Polygon) {
                    db.mapData.polygons = db.mapData.polygons.filter(p => p.id !== layer._id);
                } else if (layer instanceof L.Polyline) {
                    db.mapData.polylines = db.mapData.polylines.filter(p => p.id !== layer._id);
                }
            });
            saveData();
            showToast('Success', 'Map features deleted successfully');
        });
        
        // Add custom controls
        document.getElementById('drawMarker').addEventListener('click', function() {
            new L.Draw.Marker(map, drawControl.options.draw.marker).enable();
        });
        
        document.getElementById('drawPolygon').addEventListener('click', function() {
            new L.Draw.Polygon(map, drawControl.options.draw.polygon).enable();
        });
        
        document.getElementById('drawLine').addEventListener('click', function() {
            new L.Draw.Polyline(map, drawControl.options.draw.polyline).enable();
        });
        
        document.getElementById('editFeatures').addEventListener('click', function() {
            drawControl._toolbars.edit._modes.edit.handler.enable();
        });
        
        document.getElementById('deleteFeatures').addEventListener('click', function() {
            drawControl._toolbars.edit._modes.remove.handler.enable();
        });
        
        // Layer visibility toggles
        document.getElementById('showVegetation').addEventListener('click', function() {
            alert('Vegetation layer would be toggled in a real implementation');
        });
        
        document.getElementById('showWeeds').addEventListener('click', function() {
            alert('Weed infestation layer would be toggled in a real implementation');
        });
        
        document.getElementById('showWater').addEventListener('click', function() {
            alert('Water sources layer would be toggled in a real implementation');
        });
        
        // Store map and drawnItems in global scope for later access
        window.map = map;
        window.drawnItems = drawnItems;
    }

    // Add sample data to the map
    function addMapSampleData(map, drawnItems) {
        // Add markers
        db.mapData.markers.forEach(markerData => {
            const marker = L.marker([markerData.lat, markerData.lng]);
            marker._id = markerData.id;
            marker.bindPopup(`
                <b>${markerData.title}</b><br>
                ${markerData.description}<br>
                <button class="btn btn-sm btn-primary mt-2 edit-feature" data-id="${markerData.id}">Edit Details</button>
            `);
            drawnItems.addLayer(marker);
        });
        
        // Add polygons
        db.mapData.polygons.forEach(polygonData => {
            const polygon = L.polygon(polygonData.points, {color: 'blue'});
            polygon._id = polygonData.id;
            polygon.bindPopup(`
                <b>${polygonData.title}</b><br>
                ${polygonData.description}<br>
                <button class="btn btn-sm btn-primary mt-2 edit-feature" data-id="${polygonData.id}">Edit Details</button>
            `);
            drawnItems.addLayer(polygon);
        });
        
        // Add polylines
        db.mapData.polylines.forEach(polylineData => {
            const polyline = L.polyline(polylineData.points, {color: 'red'});
            polyline._id = polylineData.id;
            polyline.bindPopup(`
                <b>${polylineData.title}</b><br>
                ${polylineData.description}<br>
                <button class="btn btn-sm btn-primary mt-2 edit-feature" data-id="${polylineData.id}">Edit Details</button>
            `);
            drawnItems.addLayer(polyline);
        });
    }

    // Initialize charts
    function initCharts() {
        // Health indicator chart
        const healthCtx = document.getElementById('healthChart').getContext('2d');
        window.healthChart = new Chart(healthCtx, {
            type: 'line',
            data: {
                labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
                datasets: [{
                    label: 'Ecosystem Health Score',
                    data: [65, 68, 72, 75, 78, 76, 74, 78, 82, 85, 83, 80],
                    borderColor: '#28a745',
                    backgroundColor: 'rgba(40, 167, 69, 0.1)',
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: false,
                        min: 50,
                        max: 100
                    }
                }
            }
        });
        
        // Threats chart
        const threatsCtx = document.getElementById('threatsChart').getContext('2d');
        window.threatsChart = new Chart(threatsCtx, {
            type: 'doughnut',
            data: {
                labels: ['Weeds', 'Erosion', 'Pests', 'Water Quality', 'Other'],
                datasets: [{
                    data: [45, 25, 15, 10, 5],
                    backgroundColor: [
                        '#dc3545',
                        '#fd7e14',
                        '#ffc107',
                        '#007bff',
                        '#6c757d'
                    ]
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false
            }
        });
        
        // Compliance chart
        const complianceCtx = document.getElementById('complianceChart').getContext('2d');
        window.complianceChart = new Chart(complianceCtx, {
            type: 'bar',
            data: {
                labels: db.complianceChecklist.map(item => `Req ${item.id}`),
                datasets: [{
                    label: 'Compliance Score',
                    data: db.complianceChecklist.map(item => {
                        if (item.compliant === 'Yes') return 100;
                        if (item.compliant === 'Partial') return 50;
                        return 0;
                    }),
                    backgroundColor: db.complianceChecklist.map(item => {
                        if (item.compliant === 'Yes') return '#28a745';
                        if (item.compliant === 'Partial') return '#ffc107';
                        return '#dc3545';
                    })
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        ticks: {
                            callback: function(value) {
                                return value + '%';
                            }
                        }
                    }
                }
            }
        });
    }

    // Update compliance percentage
    function updateCompliancePercentage() {
        const completedItems = db.complianceChecklist.filter(item => item.compliant === 'Yes').length;
        const partialItems = db.complianceChecklist.filter(item => item.compliant === 'Partial').length;
        const totalItems = db.complianceChecklist.length;
        const progressPercentage = Math.round(((completedItems + (partialItems * 0.5)) / totalItems) * 100);
        
        document.getElementById('compliancePercentage').textContent = `${progressPercentage}%`;
        document.getElementById('complianceProgress').style.width = `${progressPercentage}%`;
        document.getElementById('complianceProgress').setAttribute('aria-valuenow', progressPercentage);
        
        // Update compliance chart
        if (window.complianceChart) {
            window.complianceChart.data.datasets[0].data = db.complianceChecklist.map(item => {
                if (item.compliant === 'Yes') return 100;
                if (item.compliant === 'Partial') return 50;
                return 0;
            });
            
            window.complianceChart.data.datasets[0].backgroundColor = db.complianceChecklist.map(item => {
                if (item.compliant === 'Yes') return '#28a745';
                if (item.compliant === 'Partial') return '#ffc107';
                return '#dc3545';
            });
            
            window.complianceChart.update();
        }
    }

    // Setup event listeners
    function setupEventListeners() {
        // Navigation
        document.querySelectorAll('.sidebar .nav-link').forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                
                // Update active state
                document.querySelectorAll('.sidebar .nav-link').forEach(l => l.classList.remove('active'));
                this.classList.add('active');
                
                // Show the corresponding section
                const target = this.getAttribute('data-bs-target');
                document.querySelectorAll('.content-section').forEach(section => {
                    section.classList.add('d-none');
                });
                document.getElementById(target).classList.remove('d-none');
            });
        });
        
        // Form submissions
        document.getElementById('projectForm').addEventListener('submit', handleProjectSubmit);
        document.getElementById('assessmentForm').addEventListener('submit', handleAssessmentSubmit);
        document.getElementById('activityForm').addEventListener('submit', handleActivitySubmit);
        document.getElementById('speciesForm').addEventListener('submit', handleSpeciesSubmit);
        document.getElementById('monitoringForm').addEventListener('submit', handleMonitoringSubmit);
        document.getElementById('userProfileForm').addEventListener('submit', handleUserProfileSubmit);
        document.getElementById('changePasswordForm').addEventListener('submit', handleChangePasswordSubmit);
        document.getElementById('siteSettingsForm').addEventListener('submit', handleSiteSettingsSubmit);
        document.getElementById('reportForm').addEventListener('submit', handleReportSubmit);
        
        // Image previews
        document.getElementById('speciesImage').addEventListener('change', function() {
            previewImage(this, document.getElementById('speciesImagePreview'));
        });
        
        document.getElementById('assessmentImages').addEventListener('change', function() {
            previewMultipleImages(this, 'assessmentImagePreview');
        });
        
        document.getElementById('monitoringImages').addEventListener('change', function() {
            previewMultipleImages(this, 'monitoringImagePreview');
        });
        
        // Buttons
        document.getElementById('saveCompliance').addEventListener('click', saveComplianceChecklist);
        document.getElementById('generateComplianceReport').addEventListener('click', generateComplianceReport);
        document.getElementById('exportAllData').addEventListener('click', exportAllData);
        document.getElementById('backupDatabase').addEventListener('click', backupDatabase);
        document.getElementById('resetTestData').addEventListener('click', resetTestData);
        document.getElementById('viewAllActivities').addEventListener('click', function() {
            document.querySelector('[data-bs-target="activities"]').click();
        });
        
        // Export buttons
        document.getElementById('exportAssessments').addEventListener('click', function() {
            exportTableToCSV('assessments.csv', db.assessments);
        });
        
        document.getElementById('exportSpecies').addEventListener('click', function() {
            exportTableToCSV('species.csv', db.species);
        });
        
        document.getElementById('exportMonitoring').addEventListener('click', function() {
            exportTableToCSV('monitoring.csv', db.monitoring);
        });
    }

    // Image preview functions
    function previewImage(input, previewElement) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                previewElement.src = e.target.result;
                previewElement.style.display = 'block';
            };
            reader.readAsDataURL(input.files[0]);
        }
    }

    function previewMultipleImages(input, previewContainerId) {
        const previewContainer = document.getElementById(previewContainerId);
        previewContainer.innerHTML = '';
        
        if (input.files) {
            Array.from(input.files).forEach(file => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.className = 'image-thumbnail';
                    previewContainer.appendChild(img);
                };
                reader.readAsDataURL(file);
            });
        }
    }

    // Form handlers
    function handleProjectSubmit(e) {
        e.preventDefault();
        
        if (!validateForm('projectForm')) {
            showToast('Error', 'Please fill all required fields', 'error');
            return;
        }
        
        const project = {
            id: generateId(),
            name: document.getElementById('projectName').value,
            code: document.getElementById('projectCode').value,
            startDate: document.getElementById('projectStartDate').value,
            endDate: document.getElementById('projectEndDate').value || '',
            description: document.getElementById('projectDescription').value,
            status: document.getElementById('projectStatus').value,
            manager: document.getElementById('projectManager').value || '',
            location: document.getElementById('projectLocation').value || '',
            createdAt: new Date().toISOString()
        };
        
        db.projects.push(project);
        saveData();
        loadProjects();
        
        // Reset form
        e.target.reset();
        
        showToast('Success', 'Project created successfully');
    }

    function handleAssessmentSubmit(e) {
        e.preventDefault();
        
        if (!validateForm('assessmentForm')) {
            showToast('Error', 'Please fill all required fields', 'error');
            return;
        }
        
        const components = [];
        if (document.getElementById('componentFlora').checked) components.push('flora');
        if (document.getElementById('componentFauna').checked) components.push('fauna');
        if (document.getElementById('componentSoil').checked) components.push('soil');
        if (document.getElementById('componentWater').checked) components.push('water');
        
        const threats = Array.from(document.getElementById('threats').selectedOptions).map(option => option.value);
        
        const assessment = {
            id: generateId(),
            date: document.getElementById('assessmentDate').value,
            assessor: document.getElementById('assessor').value,
            description: document.getElementById('assessmentDescription').value,
            components: components,
            health: document.getElementById('healthStatus').value,
            threats: threats,
            images: [], // In a real app, you would upload and store images
            createdAt: new Date().toISOString()
        };
        
        db.assessments.push(assessment);
        saveData();
        loadAssessments();
        
        // Reset form
        e.target.reset();
        document.getElementById('assessmentImagePreview').innerHTML = '';
        
        showToast('Success', 'Assessment saved successfully');
    }

    function handleActivitySubmit(e) {
        e.preventDefault();
        
        if (!validateForm('activityForm')) {
            showToast('Error', 'Please fill all required fields', 'error');
            return;
        }
        
        const activity = {
            id: generateId(),
            title: document.getElementById('activityTitle').value,
            type: document.getElementById('activityType').value,
            startDate: document.getElementById('startDate').value,
            endDate: document.getElementById('endDate').value || document.getElementById('startDate').value,
            status: document.getElementById('activityStatus').value,
            location: document.getElementById('location').value,
            assignedTo: document.getElementById('assignedTo').value,
            description: document.getElementById('activityDescription').value,
            notes: document.getElementById('activityNotes').value,
            createdAt: new Date().toISOString()
        };
        
        db.activities.push(activity);
        saveData();
        loadActivities();
        
        // Reset form
        e.target.reset();
        
        showToast('Success', 'Activity scheduled successfully');
    }

    function handleSpeciesSubmit(e) {
        e.preventDefault();
        
        if (!validateForm('speciesForm')) {
            showToast('Error', 'Please fill all required fields', 'error');
            return;
        }
        
        const species = {
            id: generateId(),
            name: document.getElementById('speciesName').value,
            scientificName: document.getElementById('scientificName').value,
            type: document.getElementById('speciesType').value,
            status: document.getElementById('speciesStatus').value,
            riskLevel: document.getElementById('riskLevel').value,
            description: document.getElementById('speciesDescription').value,
            habitat: document.getElementById('speciesHabitat').value,
            image: '', // In a real app, you would upload and store the image
            createdAt: new Date().toISOString()
        };
        
        db.species.push(species);
        saveData();
        loadSpecies();
        
        // Reset form
        e.target.reset();
        document.getElementById('speciesImagePreview').style.display = 'none';
        
        showToast('Success', 'Species added successfully');
    }

    function handleMonitoringSubmit(e) {
        e.preventDefault();
        
        if (!validateForm('monitoringForm')) {
            showToast('Error', 'Please fill all required fields', 'error');
            return;
        }
        
        // Parse data from textarea (key:value format)
        const dataText = document.getElementById('monitoringData').value;
        const data = {};
        dataText.split('\n').forEach(line => {
            const parts = line.split(':');
            if (parts.length >= 2) {
                const key = parts[0].trim();
                const value = parts.slice(1).join(':').trim();
                data[key] = value;
            }
        });
        
        const monitoring = {
            id: generateId(),
            date: document.getElementById('monitoringDate').value,
            type: document.getElementById('monitoringType').value,
            location: document.getElementById('monitoringLocation').value,
            data: data,
            observations: document.getElementById('monitoringObservations').value,
            images: [], // In a real app, you would upload and store images
            createdAt: new Date().toISOString()
        };
        
        db.monitoring.push(monitoring);
        saveData();
        loadMonitoring();
        
        // Reset form
        e.target.reset();
        document.getElementById('monitoringImagePreview').innerHTML = '';
        
        showToast('Success', 'Monitoring data saved successfully');
    }

    function handleUserProfileSubmit(e) {
        e.preventDefault();
        
        if (!validateForm('userProfileForm')) {
            showToast('Error', 'Please fill all required fields', 'error');
            return;
        }
        
        db.settings.userProfile = {
            name: document.getElementById('userName').value,
            email: document.getElementById('userEmail').value,
            role: document.getElementById('userRole').value,
            organization: document.getElementById('userOrganization').value,
            bio: document.getElementById('userBio').value
        };
        
        saveData();
        showToast('Success', 'Profile updated successfully');
    }

    function handleChangePasswordSubmit(e) {
        e.preventDefault();
        
        if (!validateForm('changePasswordForm')) {
            showToast('Error', 'Please fill all required fields', 'error');
            return;
        }
        
        const currentPassword = document.getElementById('currentPassword').value;
        const newPassword = document.getElementById('newPassword').value;
        const confirmPassword = document.getElementById('confirmPassword').value;
        
        if (newPassword !== confirmPassword) {
            showToast('Error', 'New passwords do not match', 'error');
            return;
        }
        
        // In a real app, you would verify the current password and update it
        // For this demo, we'll just show a success message
        e.target.reset();
        showToast('Success', 'Password changed successfully');
    }

    function handleSiteSettingsSubmit(e) {
        e.preventDefault();
        
        if (!validateForm('siteSettingsForm')) {
            showToast('Error', 'Please fill all required fields', 'error');
            return;
        }
        
        db.settings.siteSettings = {
            siteName: document.getElementById('siteName').value,
            location: document.getElementById('siteLocation').value,
            area: parseFloat(document.getElementById('siteArea').value),
            description: document.getElementById('siteDescription').value,
            enableNotifications: document.getElementById('enableNotifications').checked,
            enableReminders: document.getElementById('enableReminders').checked
        };
        
        saveData();
        showToast('Success', 'Site settings saved successfully');
    }

    function handleReportSubmit(e) {
        e.preventDefault();
        
        if (!validateForm('reportForm')) {
            showToast('Error', 'Please fill all required fields', 'error');
            return;
        }
        
        const reportType = document.getElementById('reportType').value;
        const startDate = document.getElementById('reportStartDate').value;
        const endDate = document.getElementById('reportEndDate').value;
        const format = document.getElementById('reportFormat').value;
        const includeCharts = document.getElementById('includeCharts').checked;
        
        generateReport(reportType, startDate, endDate, format, includeCharts);
    }

    // Form validation
    function validateForm(formId) {
        const form = document.getElementById(formId);
        let isValid = true;
        
        const requiredFields = form.querySelectorAll('[required]');
        requiredFields.forEach(field => {
            if (!field.value.trim()) {
                field.classList.add('is-invalid');
                isValid = false;
            } else {
                field.classList.remove('is-invalid');
            }
        });
        
        return isValid;
    }

    // Detail view functions
    function showProjectDetails(project) {
        const modalBody = document.getElementById('projectModalBody');
        
        modalBody.innerHTML = `
            <div class="row">
                <div class="col-md-6">
                    <p><strong>Name:</strong> ${project.name}</p>
                    <p><strong>Code:</strong> ${project.code}</p>
                    <p><strong>Status:</strong> <span class="badge ${getProjectStatusBadgeClass(project.status)}">${capitalizeFirstLetter(project.status)}</span></p>
                </div>
                <div class="col-md-6">
                    <p><strong>Start Date:</strong> ${formatDate(project.startDate)}</p>
                    <p><strong>End Date:</strong> ${project.endDate ? formatDate(project.endDate) : 'Not specified'}</p>
                    <p><strong>Manager:</strong> ${project.manager || 'Not specified'}</p>
                </div>
            </div>
            <div class="row mt-3">
                <div class="col-12">
                    <p><strong>Location:</strong> ${project.location || 'Not specified'}</p>
                </div>
            </div>
            <div class="row mt-3">
                <div class="col-12">
                    <p><strong>Description:</strong></p>
                    <p>${project.description}</p>
                </div>
            </div>
        `;
        
        const modal = new bootstrap.Modal(document.getElementById('projectModal'));
        modal.show();
    }

    function showAssessmentDetails(assessment) {
        const modalBody = document.getElementById('assessmentModalBody');
        
        modalBody.innerHTML = `
            <div class="row">
                <div class="col-md-6">
                    <p><strong>Date:</strong> ${formatDate(assessment.date)}</p>
                    <p><strong>Assessor:</strong> ${assessment.assessor}</p>
                    <p><strong>Health Status:</strong> <span class="badge ${getHealthBadgeClass(assessment.health)}">${capitalizeFirstLetter(assessment.health)}</span></p>
                </div>
                <div class="col-md-6">
                    <p><strong>Components:</strong> ${assessment.components.map(c => capitalizeFirstLetter(c)).join(', ')}</p>
                    <p><strong>Threats:</strong> ${assessment.threats.map(t => capitalizeFirstLetter(t)).join(', ')}</p>
                </div>
            </div>
            <div class="row mt-3">
                <div class="col-12">
                    <p><strong>Description:</strong></p>
                    <p>${assessment.description}</p>
                </div>
            </div>
            ${assessment.images && assessment.images.length > 0 ? `
            <div class="row mt-3">
                <div class="col-12">
                    <p><strong>Images:</strong></p>
                    <div class="image-preview-container">
                        ${assessment.images.map(img => `<img src="${img}" class="image-thumbnail" alt="Assessment image">`).join('')}
                    </div>
                </div>
            </div>
            ` : ''}
        `;
        
        const modal = new bootstrap.Modal(document.getElementById('assessmentModal'));
        modal.show();
    }

    function showSpeciesDetails(species) {
        const modalBody = document.getElementById('speciesModalBody');
        
        modalBody.innerHTML = `
            <div class="row">
                <div class="col-md-6">
                    <p><strong>Name:</strong> ${species.name}</p>
                    <p><strong>Scientific Name:</strong> ${species.scientificName || 'Not specified'}</p>
                    <p><strong>Type:</strong> ${capitalizeFirstLetter(species.type)}</p>
                </div>
                <div classcol-md-6">
                    <p><strong>Status:</strong> <span class="badge ${getSpeciesStatusBadgeClass(species.status)}">${capitalizeFirstLetter(species.status)}</span></p>
                    <p><strong>Risk Level:</strong> ${species.riskLevel ? `<span class="risk-indicator risk-${species.riskLevel}"></span>${capitalizeFirstLetter(species.riskLevel)}` : 'Not specified'}</p>
                </div>
            </div>
            <div class="row mt-3">
                <div class="col-12">
                    <p><strong>Description:</strong></p>
                    <p>${species.description}</p>
                </div>
            </div>
            <div class="row mt-3">
                <div class="col-12">
                    <p><strong>Habitat:</strong></p>
                    <p>${species.habitat}</p>
                </div>
            </div>
            ${species.image ? `
            <div class="row mt-3">
                <div class="col-12">
                    <p><strong>Image:</strong></p>
                    <img src="${species.image}" class="img-fluid" alt="${species.name}">
                </div>
            </div>
            ` : ''}
        `;
        
        const modal = new bootstrap.Modal(document.getElementById('speciesModal'));
        modal.show();
    }

    function showActivityDetails(activity) {
        const modalBody = document.getElementById('activityModalBody');
        
        modalBody.innerHTML = `
            <div class="row">
                <div class="col-md-6">
                    <p><strong>Title:</strong> ${activity.title}</p>
                    <p><strong>Type:</strong> ${formatActivityType(activity.type)}</p>
                    <p><strong>Status:</strong> <span class="badge ${getStatusBadgeClass(activity.status)}">${capitalizeFirstLetter(activity.status)}</span></p>
                </div>
                <div class="col-md-6">
                    <p><strong>Start Date:</strong> ${formatDateTime(activity.startDate)}</p>
                    <p><strong>End Date:</strong> ${activity.endDate ? formatDateTime(activity.endDate) : 'Not specified'}</p>
                    <p><strong>Location:</strong> ${activity.location || 'Not specified'}</p>
                </div>
            </div>
            <div class="row mt-3">
                <div class="col-12">
                    <p><strong>Assigned To:</strong> ${activity.assignedTo || 'Not assigned'}</p>
                </div>
            </div>
            <div class="row mt-3">
                <div class="col-12">
                    <p><strong>Description:</strong></p>
                    <p>${activity.description || 'No description provided'}</p>
                </div>
            </div>
            <div class="row mt-3">
                <div class="col-12">
                    <p><strong>Notes:</strong></p>
                    <p>${activity.notes || 'No notes provided'}</p>
                </div>
            </div>
        `;
        
        // Set up edit button
        document.getElementById('editActivityBtn').onclick = function() {
            editActivity(activity);
        };
        
        const modal = new bootstrap.Modal(document.getElementById('activityModal'));
        modal.show();
    }

    function showMonitoringDetails(monitoring) {
        const modalBody = document.getElementById('monitoringModalBody');
        
        modalBody.innerHTML = `
            <div class="row">
                <div class="col-md-6">
                    <p><strong>Date:</strong> ${formatDate(monitoring.date)}</p>
                    <p><strong>Type:</strong> ${capitalizeFirstLetter(monitoring.type)}</p>
                    <p><strong>Location:</strong> ${monitoring.location}</p>
                </div>
            </div>
            <div class="row mt-3">
                <div class="col-12">
                    <p><strong>Data:</strong></p>
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Parameter</th>
                                <th>Value</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${Object.entries(monitoring.data).map(([key, value]) => `
                                <tr>
                                    <td>${key}</td>
                                    <td>${value}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="row mt-3">
                <div class="col-12">
                    <p><strong>Observations:</strong></p>
                    <p>${monitoring.observations || 'No observations provided'}</p>
                </div>
            </div>
            ${monitoring.images && monitoring.images.length > 0 ? `
            <div class="row mt-3">
                <div class="col-12">
                    <p><strong>Images:</strong></p>
                    <div class="image-preview-container">
                        ${monitoring.images.map(img => `<img src="${img}" class="image-thumbnail" alt="Monitoring image">`).join('')}
                    </div>
                </div>
            </div>
            ` : ''}
        `;
        
        const modal = new bootstrap.Modal(document.getElementById('monitoringModal'));
        modal.show();
    }

    // Other functionality
    function rescheduleActivity(activity) {
        const newDate = prompt('Enter new date for this activity (YYYY-MM-DD):');
        if (newDate) {
            // Validate date format
            if (!isValidDate(newDate)) {
                showToast('Error', 'Invalid date format. Please use YYYY-MM-DD', 'error');
                return;
            }
            
            activity.startDate = new Date(newDate).toISOString();
            saveData();
            loadDashboard();
            loadActivities();
            showToast('Success', 'Activity rescheduled successfully');
        }
    }

    function editActivity(activity) {
        // Populate the form with activity data
        document.getElementById('activityTitle').value = activity.title;
        document.getElementById('activityType').value = activity.type;
        document.getElementById('startDate').value = formatDateTimeLocal(activity.startDate);
        document.getElementById('endDate').value = activity.endDate ? formatDateTimeLocal(activity.endDate) : '';
        document.getElementById('activityStatus').value = activity.status;
        document.getElementById('location').value = activity.location || '';
        document.getElementById('assignedTo').value = activity.assignedTo || '';
        document.getElementById('activityDescription').value = activity.description || '';
        document.getElementById('activityNotes').value = activity.notes || '';
        
        // Remove the activity from the list
        db.activities = db.activities.filter(a => a.id !== activity.id);
        saveData();
        
        // Close the modal
        bootstrap.Modal.getInstance(document.getElementById('activityModal')).hide();
        
        // Scroll to the form
        document.querySelector('[data-bs-target="activities"]').click();
        document.getElementById('activityForm').scrollIntoView();
        
        showToast('Info', 'Activity loaded into form for editing');
    }

    function saveComplianceChecklist() {
        saveData();
        updateCompliancePercentage();
        showToast('Success', 'Compliance checklist saved successfully');
    }

    function generateComplianceReport() {
        const completedItems = db.complianceChecklist.filter(item => item.compliant === 'Yes').length;
        const partialItems = db.complianceChecklist.filter(item => item.compliant === 'Partial').length;
        const totalItems = db.complianceChecklist.length;
        const progressPercentage = Math.round(((completedItems + (partialItems * 0.5)) / totalItems) * 100);
        
        const nonCompliantItems = db.complianceChecklist.filter(item => item.compliant === 'No');
        
        let reportHTML = `
            <h3>Compliance Report</h3>
            <p><strong>Generated:</strong> ${new Date().toLocaleString()}</p>
            <div class="alert alert-${progressPercentage >= 80 ? 'success' : progressPercentage >= 60 ? 'warning' : 'danger'}">
                <h4>Overall Compliance: ${progressPercentage}%</h4>
            </div>
            
            <h4>Compliance Breakdown</h4>
            <table class="table table-bordered">
                <thead>
                    <tr>
                        <th>Requirement</th>
                        <th>Status</th>
                        <th>Evidence</th>
                    </tr>
                </thead>
                <tbody>
        `;
        
        db.complianceChecklist.forEach(item => {
            reportHTML += `
                <tr class="${item.compliant === 'Yes' ? 'table-success' : item.compliant === 'Partial' : 'table-warning' : 'table-danger'}">
                    <td>${item.requirement}</td>
                    <td>${item.compliant}</td>
                    <td>${item.evidence || 'No evidence provided'}</td>
                </tr>
            `;
        });
        
        reportHTML += `
                </tbody>
            </table>
        `;
        
        if (nonCompliantItems.length > 0) {
            reportHTML += `
                <h4>Areas Needing Improvement</h4>
                <ul>
            `;
            
            nonCompliantItems.forEach(item => {
                reportHTML += `<li>${item.requirement}</li>`;
            });
            
            reportHTML += `</ul>`;
        }
        
        document.getElementById('reportPreview').innerHTML = reportHTML;
        showToast('Success', 'Compliance report generated');
    }

    function generateReport(type, startDate, endDate, format, includeCharts) {
        let reportData = [];
        let title = '';
        
        switch (type) {
            case 'assessment':
                reportData = db.assessments;
                title = 'Site Assessments';
                break;
            case 'activity':
                reportData = db.activities;
                title = 'Activities';
                break;
            case 'species':
                reportData = db.species;
                title = 'Species';
                break;
            case 'monitoring':
                reportData = db.monitoring;
                title = 'Monitoring Data';
                break;
            case 'compliance':
                reportData = db.complianceChecklist;
                title = 'Compliance';
                break;
        }
        
        // Filter by date if provided
        if (startDate) {
            const start = new Date(startDate);
            reportData = reportData.filter(item => new Date(item.date || item.startDate || item.createdAt) >= start);
        }
        
        if (endDate) {
            const end = new Date(endDate);
            end.setHours(23, 59, 59, 999); // End of the day
            reportData = reportData.filter(item => new Date(item.date || item.startDate || item.createdAt) <= end);
        }
        
        if (format === 'csv') {
            exportTableToCSV(`${type}-report.csv`, reportData);
            return;
        }
        
        let reportHTML = `
            <h3>${title} Report</h3>
            <p><strong>Date Range:</strong> ${startDate ? formatDate(startDate) : 'All dates'} - ${endDate ? formatDate(endDate) : 'All dates'}</p>
            <p><strong>Generated:</strong> ${new Date().toLocaleString()}</p>
            <p><strong>Records:</strong> ${reportData.length}</p>
        `;
        
        if (includeCharts && reportData.length > 0) {
            // Add a simple chart based on report type
            if (type === 'assessment') {
                const healthCounts = {
                    excellent: 0,
                    good: 0,
                    fair: 0,
                    poor: 0,
                    degraded: 0
                };
                
                reportData.forEach(assessment => {
                    if (healthCounts.hasOwnProperty(assessment.health)) {
                        healthCounts[assessment.health]++;
                    }
                });
                
                reportHTML += `
                    <h4>Health Status Distribution</h4>
                    <div class="chart-container" style="height: 200px;">
                        <canvas id="reportChart"></canvas>
                    </div>
                `;
            }
        }
        
        // Add data table
        reportHTML += `<h4>Data</h4>`;
        
        if (reportData.length === 0) {
            reportHTML += `<p>No data found for the selected criteria.</p>`;
        } else {
            reportHTML += `<div class="table-responsive"><table class="table table-striped table-sm">`;
            
            // Table headers
            reportHTML += `<thead><tr>`;
            Object.keys(reportData[0]).forEach(key => {
                if (key !== 'id' && key !== 'createdAt' && key !== 'images') {
                    reportHTML += `<th>${capitalizeFirstLetter(key)}</th>`;
                }
            });
            reportHTML += `</tr></thead>`;
            
            // Table body
            reportHTML += `<tbody>`;
            reportData.forEach(item => {
                reportHTML += `<tr>`;
                Object.entries(item).forEach(([key, value]) => {
                    if (key !== 'id' && key !== 'createdAt' && key !== 'images') {
                        if (key === 'health') {
                            reportHTML += `<td><span class="badge ${getHealthBadgeClass(value)}">${capitalizeFirstLetter(value)}</span></td>`;
                        } else if (key === 'status' && (type === 'activity' || type === 'species')) {
                            if (type === 'activity') {
                                reportHTML += `<td><span class="badge ${getStatusBadgeClass(value)}">${capitalizeFirstLetter(value)}</span></td>`;
                            } else {
                                reportHTML += `<td><span class="badge ${getSpeciesStatusBadgeClass(value)}">${capitalizeFirstLetter(value)}</span></td>`;
                            }
                        } else if (typeof value === 'object' && value !== null) {
                            reportHTML += `<td>${Object.entries(value).map(([k, v]) => `${k}: ${v}`).join(', ')}</td>`;
                        } else {
                            reportHTML += `<td>${value}</td>`;
                        }
                    }
                });
                reportHTML += `</tr>`;
            });
            reportHTML += `</tbody></table></div>`;
        }
        
        document.getElementById('reportPreview').innerHTML = reportHTML;
        
        // Initialize chart if needed
        if (includeCharts && reportData.length > 0 && type === 'assessment') {
            setTimeout(() => {
                const healthCounts = {
                    excellent: 0,
                    good: 0,
                    fair: 0,
                    poor: 0,
                    degraded: 0
                };
                
                reportData.forEach(assessment => {
                    if (healthCounts.hasOwnProperty(assessment.health)) {
                        healthCounts[assessment.health]++;
                    }
                });
                
                const ctx = document.getElementById('reportChart').getContext('2d');
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: Object.keys(healthCounts).map(k => capitalizeFirstLetter(k)),
                        datasets: [{
                            label: 'Number of Assessments',
                            data: Object.values(healthCounts),
                            backgroundColor: [
                                '#28a745',
                                '#20c997',
                                '#ffc107',
                                '#fd7e14',
                                '#dc3545'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false
                    }
                });
            }, 100);
        }
        
        showToast('Success', `${title} report generated`);
    }

    function exportAllData() {
        const dataStr = JSON.stringify(db, null, 2);
        const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
        
        const exportFileDefaultName = 'ecosystem-manager-backup.json';
        
        const linkElement = document.createElement('a');
        linkElement.setAttribute('href', dataUri);
        linkElement.setAttribute('download', exportFileDefaultName);
        linkElement.click();
        
        showToast('Success', 'All data exported successfully');
    }

    function exportTableToCSV(filename, data) {
        if (data.length === 0) {
            showToast('Error', 'No data to export', 'error');
            return;
        }
        
        // Extract headers
        const headers = Object.keys(data[0]).filter(key => key !== 'images');
        
        // Create CSV content
        let csvContent = headers.join(',') + '\n';
        
        data.forEach(item => {
            const row = headers.map(header => {
                let value = item[header];
                
                if (typeof value === 'object' && value !== null) {
                    value = Object.entries(value).map(([k, v]) => `${k}: ${v}`).join('; ');
                }
                
                // Escape quotes and wrap in quotes if contains commas
                if (typeof value === 'string' && value.includes(',')) {
                    value = `"${value.replace(/"/g, '""')}"`;
                }
                
                return value || '';
            }).join(',');
            
            csvContent += row + '\n';
        });
        
        // Create download link
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.setAttribute('href', url);
        link.setAttribute('download', filename);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        showToast('Success', `Data exported to ${filename}`);
    }

    function backupDatabase() {
        // In a real app, this would backup to a server or cloud storage
        exportAllData(); // For now, just export the data
        showToast('Backup Created', 'Database backup has been created successfully');
    }

    function resetTestData() {
        if (confirm('Are you sure you want to reset all test data? This action cannot be undone.')) {
            localStorage.clear();
            location.reload();
        }
    }

    // Utility functions
    function formatDate(dateString) {
        if (!dateString) return 'Not specified';
        const date = new Date(dateString);
        return date.toLocaleDateString('en-AU', { day: '2-digit', month: '2-digit', year: 'numeric' });
    }

    function formatDateTime(dateString) {
        if (!dateString) return 'Not specified';
        const date = new Date(dateString);
        return date.toLocaleString('en-AU', { 
            day: '2-digit', 
            month: '2-digit', 
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
    }

    function formatDateTimeLocal(dateString) {
        if (!dateString) return '';
        const date = new Date(dateString);
        const year = date.getFullYear();
        const month = (date.getMonth() + 1).toString().padStart(2, '0');
        const day = date.getDate().toString().padStart(2, '0');
        const hours = date.getHours().toString().padStart(2, '0');
        const minutes = date.getMinutes().toString().padStart(2, '0');
        
        return `${year}-${month}-${day}T${hours}:${minutes}`;
    }

    function formatActivityType(type) {
        const typeMap = {
            'weed-control': 'Weed Control',
            'revegetation': 'Revegetation',
            'erosion-control': 'Erosion Control',
            'fauna-survey': 'Fauna Survey',
            'vegetation-survey': 'Vegetation Survey',
            'water-quality': 'Water Quality Testing',
            'other': 'Other'
        };
        return typeMap[type] || type;
    }

    function getStatusBadgeClass(status) {
        const statusMap = {
            'planned': 'bg-secondary',
            'in-progress': 'bg-primary',
            'completed': 'bg-success',
            'cancelled': 'bg-danger'
        };
        return statusMap[status] || 'bg-secondary';
    }

    function getProjectStatusBadgeClass(status) {
        const statusMap = {
            'planning': 'bg-info',
            'active': 'bg-success',
            'on-hold': 'bg-warning',
            'completed': 'bg-secondary'
        };
        return statusMap[status] || 'bg-secondary';
    }

    function getHealthBadgeClass(health) {
        const healthMap = {
            'excellent': 'bg-success',
            'good': 'bg-info',
            'fair': 'bg-warning',
            'poor': 'bg-danger',
            'degraded': 'bg-dark'
        };
        return healthMap[health] || 'bg-secondary';
    }

    function getSpeciesStatusBadgeClass(status) {
        const statusMap = {
            'native': 'bg-success',
            'introduced': 'bg-secondary',
            'weed': 'bg-danger',
            'pest': 'bg-warning',
            'endangered': 'bg-danger',
            'vulnerable': 'bg-warning',
            'threatened': 'bg-warning'
        };
        return statusMap[status] || 'bg-secondary';
    }

    function getActivityColor(type) {
        const colorMap = {
            'weed-control': '#dc3545',
            'revegetation': '#28a745',
            'erosion-control': '#fd7e14',
            'fauna-survey': '#17a2b8',
            'vegetation-survey': '#20c997',
            'water-quality': '#007bff',
            'other': '#6c757d'
        };
        return colorMap[type] || '#6c757d';
    }

    function capitalizeFirstLetter(string) {
        return string.charAt(0).toUpperCase() + string.slice(1);
    }

    function generateId() {
        return Date.now().toString(36) + Math.random().toString(36).substr(2);
    }

    function isValidDate(dateString) {
        const regEx = /^\d{4}-\d{2}-\d{2}$/;
        if (!dateString.match(regEx)) return false;
        const d = new Date(dateString);
        return d instanceof Date && !isNaN(d);
    }

    // Initialize the application when the DOM is loaded
    document.addEventListener('DOMContentLoaded', initApp);
</script>
</body>
</html>


















// JavaScript Libraries
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
        crossorigin=""></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    // Database structure
    let db = {
        projects: [],
        assessments: [],
        species: [],
        activities: [],
        monitoring: [],
        complianceChecklist: [],
        settings: {
            userProfile: {},
            siteSettings: {}
        },
        mapData: {
            markers: [],
            polygons: [],
            polylines: []
        }
    };

    // Load data from localStorage
    function loadData() {
        const savedData = localStorage.getItem('ecosystemManagerData');
        if (savedData) {
            db = JSON.parse(savedData);
        } else {
            // Add sample data if no data exists
            addSampleData();
        }
    }

    // Save data to localStorage
    function saveData() {
        localStorage.setItem('ecosystemManagerData', JSON.stringify(db));
    }

    // Show toast notification
    function showToast(title, message, type = 'success') {
        const toast = document.getElementById('liveToast');
        const toastTitle = document.getElementById('toast-title');
        const toastMessage = document.getElementById('toast-message');
        
        toastTitle.textContent = title;
        toastMessage.textContent = message;
        
        // Set background color based on type
        const header = toast.querySelector('.toast-header');
        if (type === 'error') {
            header.classList.add('bg-danger', 'text-white');
            header.classList.remove('bg-success', 'bg-warning');
        } else if (type === 'warning') {
            header.classList.add('bg-warning', 'text-dark');
            header.classList.remove('bg-success', 'bg-danger');
        } else {
            header.classList.add('bg-success', 'text-white');
            header.classList.remove('bg-danger', 'bg-warning');
        }
        
        const bsToast = new bootstrap.Toast(toast);
        bsToast.show();
    }

    // Add sample data to the database
    function addSampleData() {
        // Sample projects
        db.projects = [
            {
                id: generateId(),
                name: 'Northern Creek Restoration',
                code: 'NCR-2023',
                startDate: new Date('2023-01-15').toISOString(),
                endDate: new Date('2023-12-15').toISOString(),
                description: 'Restoration of the northern creekline to improve water quality and habitat value.',
                status: 'active',
                manager: 'Dr. Jane Smith',
                location: 'Northern Reserve',
                createdAt: new Date('2023-01-10').toISOString()
            },
            {
                id: generateId(),
                name: 'Woodland Biodiversity Survey',
                code: 'WBS-2023',
                startDate: new Date('2023-03-01').toISOString(),
                endDate: new Date('2023-11-30').toISOString(),
                description: 'Comprehensive survey of flora and fauna in the woodland ecosystem.',
                status: 'active',
                manager: 'John Davis',
                location: 'Eastern Woodlands',
                createdAt: new Date('2023-02-15').toISOString()
            },
            {
                id: generateId(),
                name: 'Weed Management Program',
                code: 'WMP-2023',
                startDate: new Date('2023-02-01').toISOString(),
                endDate: new Date('2023-10-31').toISOString(),
                description: 'Control and eradication of invasive weed species across the reserve.',
                status: 'active',
                manager: 'Sarah Wilson',
                location: 'Entire Reserve',
                createdAt: new Date('2023-01-20').toISOString()
            }
        ];

        // Sample assessments
        db.assessments = [
            {
                id: generateId(),
                date: new Date('2023-06-15').toISOString(),
                assessor: 'Dr. Jane Smith',
                description: 'Initial assessment of the northern woodland area. Found healthy native vegetation with some weed infestation.',
                components: ['flora', 'fauna', 'soil'],
                health: 'good',
                threats: ['weeds', 'erosion'],
                images: [],
                createdAt: new Date('2023-06-15').toISOString()
            },
            {
                id: generateId(),
                date: new Date('2023-08-22').toISOString(),
                assessor: 'John Davis',
                description: 'Follow-up assessment after revegetation efforts. Significant improvement in native species coverage.',
                components: ['flora', 'water'],
                health: 'excellent',
                threats: ['pests'],
                images: [],
                createdAt: new Date('2023-08-22').toISOString()
            },
            {
                id: generateId(),
                date: new Date('2023-11-05').toISOString(),
                assessor: 'Sarah Wilson',
                description: 'Post-fire assessment. Some areas show recovery but others need intervention.',
                components: ['flora', 'soil', 'fauna'],
                health: 'fair',
                threats: ['fire', 'erosion'],
                images: [],
                createdAt: new Date('2023-11-05').toISOString()
            }
        ];

        // Sample species
        db.species = [
            {
                id: generateId(),
                name: 'River Red Gum',
                scientificName: 'Eucalyptus camaldulensis',
                type: 'plant',
                status: 'native',
                riskLevel: 'low',
                description: 'Large tree found along watercourses. Important habitat for many bird and mammal species.',
                habitat: 'Riverbanks and floodplains',
                image: '',
                createdAt: new Date('2023-05-10').toISOString()
            },
            {
                id: generateId(),
                name: 'Kangaroo Grass',
                scientificName: 'Themeda triandra',
                type: 'plant',
                status: 'native',
                riskLevel: 'low',
                description: 'Perennial tussock grass that is a key component of native grasslands.',
                habitat: 'Open woodlands and grasslands',
                image: '',
                createdAt: new Date('2023-05-12').toISOString()
            },
            {
                id: generateId(),
                name: 'Blackberry',
                scientificName: 'Rubus fruticosus',
                type: 'plant',
                status: 'weed',
                riskLevel: 'high',
                description: 'Invasive shrub that forms dense thickets, outcompeting native vegetation.',
                habitat: 'Disturbed areas, riverbanks',
                image: '',
                createdAt: new Date('2023-05-15').toISOString()
            },
            {
                id: generateId(),
                name: 'Eastern Grey Kangaroo',
                scientificName: 'Macropus giganteus',
                type: 'animal',
                status: 'native',
                riskLevel: 'low',
                description: 'Large marsupial commonly found in woodland areas.',
                habitat: 'Woodlands, grasslands',
                image: '',
                createdAt: new Date('2023-05-18').toISOString()
            },
            {
                id: generateId(),
                name: 'Superb Fairy-wren',
                scientificName: 'Malurus cyaneus',
                type: 'bird',
                status: 'native',
                riskLevel: 'low',
                description: 'Small bird with bright blue plumage in breeding males. Often found in dense vegetation.',
                habitat: 'Dense understorey vegetation',
                image: '',
                createdAt: new Date('2023-05-20').toISOString()
            },
            {
                id: generateId(),
                name: 'European Rabbit',
                scientificName: 'Oryctolagus cuniculus',
                type: 'animal',
                status: 'pest',
                riskLevel: 'high',
                description: 'Introduced species that causes significant damage through grazing and burrowing.',
                habitat: 'Various, particularly grasslands',
                image: '',
                createdAt: new Date('2023-05-22').toISOString()
            }
        ];

        // Sample activities
        const today = new Date();
        const nextWeek = new Date(today);
        nextWeek.setDate(today.getDate() + 7);
        
        const twoWeeks = new Date(today);
        twoWeeks.setDate(today.getDate() + 14);
        
        db.activities = [
            {
                id: generateId(),
                title: 'Weed Control - Blackberry',
                type: 'weed-control',
                startDate: new Date('2023-09-10').toISOString(),
                endDate: new Date('2023-09-12').toISOString(),
                status: 'completed',
                location: 'Northern Creekline',
                assignedTo: 'Volunteer Team A',
                description: 'Manual removal and herbicide treatment of blackberry infestation along creekline.',
                notes: 'Need to follow up in 3 months to check for regrowth',
                createdAt: new Date('2023-08-25').toISOString()
            },
            {
                id: generateId(),
                title: 'Native Planting Day',
                type: 'revegetation',
                startDate: nextWeek.toISOString(),
                endDate: nextWeek.toISOString(),
                status: 'planned',
                location: 'Eastern Slope',
                assignedTo: 'Community Volunteers',
                description: 'Planting of 500 native seedlings including wattles, gums and groundcovers.',
                notes: 'Ensure all volunteers have gloves and water',
                createdAt: new Date('2023-10-01').toISOString()
            },
            {
                id: generateId(),
                title: 'Water Quality Testing',
                type: 'water-quality',
                startDate: twoWeeks.toISOString(),
                endDate: twoWeeks.toISOString(),
                status: 'planned',
                location: 'Main Dam',
                assignedTo: 'Sarah Wilson',
                description: 'Monthly water quality testing for pH, turbidity, and nutrient levels.',
                notes: 'Take samples from 3 different points',
                createdAt: new Date('2023-10-05').toISOString()
            },
            {
                id: generateId(),
                title: 'Bird Survey',
                type: 'fauna-survey',
                startDate: new Date('2023-07-15').toISOString(),
                endDate: new Date('2023-07-15').toISOString(),
                status: 'completed',
                location: 'Whole Site',
                assignedTo: 'Bird Watching Group',
                description: 'Annual bird survey to monitor population changes and species diversity.',
                notes: 'Record all sightings using the eBird app',
                createdAt: new Date('2023-06-20').toISOString()
            }
        ];

        // Sample monitoring data
        db.monitoring = [
            {
                id: generateId(),
                date: new Date('2023-10-01').toISOString(),
                type: 'water',
                location: 'Main Dam',
                data: {
                    pH: '7.2',
                    temperature: '18.5C',
                    turbidity: '5 NTU',
                    dissolvedOxygen: '8.2 mg/L'
                },
                observations: 'Water quality good. Slight algal bloom on northern edge.',
                images: [],
                createdAt: new Date('2023-10-01').toISOString()
            },
            {
                id: generateId(),
                date: new Date('2023-09-15').toISOString(),
                type: 'vegetation',
                location: 'Revegetation Area 2',
                data: {
                    survivalRate: '85%',
                    heightIncrease: '25 cm',
                    weedCover: '5%'
                },
                observations: 'Excellent survival rate. Minimal weed competition.',
                images: [],
                createdAt: new Date('2023-09-15').toISOString()
            },
            {
                id: generateId(),
                date: new Date('2023-08-20').toISOString(),
                type: 'wildlife',
                location: 'Northern Woodland',
                data: {
                    kangarooCount: '12',
                    birdSpecies: '23',
                    reptileSightings: '5'
                },
                observations: 'Increased bird diversity compared to last survey.',
                images: [],
                createdAt: new Date('2023-08-20').toISOString()
            }
        ];

        // Sample compliance checklist
        db.complianceChecklist = [
            { id: 1, requirement: 'Identify native species', compliant: 'Yes', evidence: 'Species database maintained' },
            { id: 2, requirement: 'Monitor ecosystem health', compliant: 'Yes', evidence: 'Regular assessments conducted' },
            { id: 3, requirement: 'Control invasive species', compliant: 'Yes', evidence: 'Weed management program in place' },
            { id: 4, requirement: 'Maintain water quality', compliant: 'Yes', evidence: 'Monthly testing records' },
            { id: 5, requirement: 'Protect habitat values', compliant: 'Yes', evidence: 'Habitat restoration activities documented' },
            { id: 6, requirement: 'Record keeping', compliant: 'Yes', evidence: 'Digital records maintained' },
            { id: 7, requirement: 'Report incidents', compliant: 'No', evidence: 'No incident reporting system' },
            { id: 8, requirement: 'Community engagement', compliant: 'Partial', evidence: 'Volunteer events but no formal program' }
        ];

        // Sample settings
        db.settings = {
            userProfile: {
                name: 'Ecosystem Manager',
                email: 'manager@ecosystem.org',
                role: 'Site Manager',
                organization: 'Conservation Trust',
                bio: 'Responsible for managing the native ecosystem restoration project.'
            },
            siteSettings: {
                siteName: 'Northern Reserve',
                location: '123 Conservation Rd, Bushland',
                area: 45.2,
                description: 'Mixed woodland with creekline and grassland areas. Important habitat for native species.',
                enableNotifications: true,
                enableReminders: true
            }
        };

        // Sample map data
        db.mapData = {
            markers: [
                { id: generateId(), lat: -37.8136, lng: 144.9631, title: 'Main Entrance', description: 'Primary access point', type: 'entrance' },
                { id: generateId(), lat: -37.8140, lng: 144.9625, title: 'Bird Hide', description: 'Observation point for bird watching', type: 'facility' },
                { id: generateId(), lat: -37.8128, lng: 144.9642, title: 'Weed Infestation', description: 'Area requiring treatment', type: 'issue' }
            ],
            polygons: [
                { 
                    id: generateId(), 
                    points: [
                        [-37.8136, 144.9631],
                        [-37.8140, 144.9625],
                        [-37.8128, 144.9642],
                        [-37.8132, 144.9648]
                    ], 
                    title: 'Revegetation Area', 
                    description: 'Zone 1 - Native planting completed 2022', 
                    type: 'vegetation' 
                }
            ],
            polylines: [
                { 
                    id: generateId(), 
                    points: [
                        [-37.8136, 144.9631],
                        [-37.8140, 144.9625],
                        [-37.8128, 144.9642]
                    ], 
                    title: 'Walking Trail', 
                    description: 'Main access path through reserve', 
                    type: 'path' 
                }
            ]
        };

        saveData();
    }

    // Initialize the application
    function initApp() {
        loadData();
        setupEventListeners();
        loadDashboard();
        loadProjects();
        loadAssessments();
        loadSpecies();
        loadActivities();
        loadMonitoring();
        loadReports();
        loadComplianceChecklist();
        loadSettings();
        initMap();
        initCharts();
    }

    // Load dashboard data
    function loadDashboard() {
        // Overdue activities
        const overdueTable = document.getElementById('overdueActivitiesTable');
        overdueTable.innerHTML = '';

        const today = new Date();
        today.setHours(0, 0, 0, 0);

        const overdueActivities = db.activities
            .filter(a => (a.status === 'planned' || a.status === 'in-progress') && new Date(a.startDate) < today)
            .sort((a, b) => new Date(a.startDate) - new Date(b.startDate));

        if (overdueActivities.length === 0) {
            overdueTable.innerHTML = '<tr><td colspan="7" class="text-center">No overdue activities</td></tr>';
        } else {
            overdueActivities.forEach(activity => {
                const row = overdueTable.insertRow();
                row.innerHTML = `
                    <td>${activity.title}</td>
                    <td>${formatActivityType(activity.type)}</td>
                    <td>${formatDate(activity.startDate)}</td>
                    <td>${activity.location}</td>
                    <td>${activity.assignedTo}</td>
                    <td><span class="badge ${getStatusBadgeClass(activity.status)}">${capitalizeFirstLetter(activity.status)}</span></td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary view-activity" data-id="${activity.id}">Details</button>
                        <button class="btn btn-sm btn-outline-warning reschedule-activity" data-id="${activity.id}">Reschedule</button>
                    </td>
                `;
            });
        }

        // Add event listeners to overdue activity buttons
        document.querySelectorAll('.view-activity').forEach(btn => {
            btn.addEventListener('click', function() {
                const activityId = this.getAttribute('data-id');
                const activity = db.activities.find(a => a.id == activityId);
                if (activity) {
                    showActivityDetails(activity);
                }
            });
        });

        document.querySelectorAll('.reschedule-activity').forEach(btn => {
            btn.addEventListener('click', function() {
                const activityId = this.getAttribute('data-id');
                const activity = db.activities.find(a => a.id == activityId);
                if (activity) {
                    rescheduleActivity(activity);
                }
            });
        });
    }

    // Load projects
    function loadProjects() {
        const projectsList = document.getElementById('projectsList');
        projectsList.innerHTML = '';

        if (db.projects.length === 0) {
            projectsList.innerHTML = '<div class="col-12 text-center">No projects created yet</div>';
        } else {
            db.projects.forEach(project => {
                const col = document.createElement('div');
                col.className = 'col-md-6 col-lg-4 mb-4';
                col.innerHTML = `
                    <div class="card project-card h-100">
                        <div class="card-body">
                            <h5 class="card-title">${project.name}</h5>
                            <h6 class="card-subtitle mb-2 text-muted">${project.code}</h6>
                            <div class="mb-2">
                                <span class="badge ${getProjectStatusBadgeClass(project.status)} me-1">${capitalizeFirstLetter(project.status)}</span>
                            </div>
                            <p class="card-text">${project.description.substring(0, 100)}...</p>
                            <p class="card-text"><small class="text-muted">Manager: ${project.manager}</small></p>
                            <p class="card-text"><small class="text-muted">Location: ${project.location}</small></p>
                        </div>
                        <div class="card-footer bg-transparent">
                            <button class="btn btn-sm btn-outline-primary view-project" data-id="${project.id}">View Details</button>
                            <button class="btn btn-sm btn-outline-danger delete-project" data-id="${project.id}">Delete</button>
                        </div>
                    </div>
                `;
                projectsList.appendChild(col);
            });
        }

        // Add event listeners to project buttons
        document.querySelectorAll('.view-project').forEach(btn => {
            btn.addEventListener('click', function() {
                const projectId = this.getAttribute('data-id');
                const project = db.projects.find(p => p.id == projectId);
                if (project) {
                    showProjectDetails(project);
                }
            });
        });

        document.querySelectorAll('.delete-project').forEach(btn => {
            btn.addEventListener('click', function() {
                const projectId = this.getAttribute('data-id');
                if (confirm('Are you sure you want to delete this project?')) {
                    db.projects = db.projects.filter(p => p.id != projectId);
                    saveData();
                    loadProjects();
                    showToast('Success', 'Project deleted successfully');
                }
            });
        });

        // Add search functionality
        const projectSearch = document.getElementById('projectSearch');
        if (projectSearch) {
            projectSearch.addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                const projectCards = document.querySelectorAll('.project-card');
                
                projectCards.forEach(card => {
                    const title = card.querySelector('.card-title').textContent.toLowerCase();
                    const subtitle = card.querySelector('.card-subtitle').textContent.toLowerCase();
                    const text = card.querySelector('.card-text').textContent.toLowerCase();
                    
                    if (title.includes(searchTerm) || subtitle.includes(searchTerm) || text.includes(searchTerm)) {
                        card.parentElement.style.display = 'block';
                    } else {
                        card.parentElement.style.display = 'none';
                    }
                });
            });
        }
    }

    // Load assessments
    function loadAssessments() {
        const assessmentsTable = document.getElementById('assessmentsTable');
        assessmentsTable.innerHTML = '';

        if (db.assessments.length === 0) {
            assessmentsTable.innerHTML = '<tr><td colspan="5" class="text-center">No assessments recorded</td></tr>';
        } else {
            db.assessments.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(assessment => {
                const row = assessmentsTable.insertRow();
                row.innerHTML = `
                    <td>${formatDate(assessment.date)}</td>
                    <td>${assessment.assessor}</td>
                    <td><span class="badge ${getHealthBadgeClass(assessment.health)}">${capitalizeFirstLetter(assessment.health)}</span></td>
                    <td>${assessment.threats.map(t => capitalizeFirstLetter(t)).join(', ')}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary view-assessment" data-id="${assessment.id}">View</button>
                        <button class="btn btn-sm btn-outline-danger delete-assessment" data-id="${assessment.id}">Delete</button>
                    </td>
                `;
            });
        }

        // Add event listeners to assessment buttons
        document.querySelectorAll('.view-assessment').forEach(btn => {
            btn.addEventListener('click', function() {
                const assessmentId = this.getAttribute('data-id');
                const assessment = db.assessments.find(a => a.id == assessmentId);
                if (assessment) {
                    showAssessmentDetails(assessment);
                }
            });
        });

        document.querySelectorAll('.delete-assessment').forEach(btn => {
            btn.addEventListener('click', function() {
                const assessmentId = this.getAttribute('data-id');
                if (confirm('Are you sure you want to delete this assessment?')) {
                    db.assessments = db.assessments.filter(a => a.id != assessmentId);
                    saveData();
                    loadAssessments();
                    showToast('Success', 'Assessment deleted successfully');
                }
            });
        });
    }

    // Load species
    function loadSpecies() {
        const speciesList = document.getElementById('speciesList');
        speciesList.innerHTML = '';

        if (db.species.length === 0) {
            speciesList.innerHTML = '<div class="col-12 text-center">No species recorded</div>';
        } else {
            db.species.forEach(species => {
                const col = document.createElement('div');
                col.className = 'col-md-6 col-lg-4 mb-4';
                col.innerHTML = `
                    <div class="card species-card h-100">
                        <div class="card-body">
                            <h5 class="card-title">${species.name}</h5>
                            <h6 class="card-subtitle mb-2 text-muted">${species.scientificName}</h6>
                            <div class="mb-2">
                                <span class="badge ${getSpeciesStatusBadgeClass(species.status)} me-1">${capitalizeFirstLetter(species.status)}</span>
                                ${species.riskLevel ? `<span class="risk-indicator risk-${species.riskLevel}"></span>` : ''}
                            </div>
                            <p class="card-text">${species.description.substring(0, 100)}...</p>
                        </div>
                        <div class="card-footer bg-transparent">
                            <button class="btn btn-sm btn-outline-primary view-species" data-id="${species.id}">View Details</button>
                            <button class="btn btn-sm btn-outline-danger delete-species" data-id="${species.id}">Delete</button>
                        </div>
                    </div>
                `;
                speciesList.appendChild(col);
            });
        }

        // Add event listeners to species buttons
        document.querySelectorAll('.view-species').forEach(btn => {
            btn.addEventListener('click', function() {
                const speciesId = this.getAttribute('data-id');
                const species = db.species.find(s => s.id == speciesId);
                if (species) {
                    showSpeciesDetails(species);
                }
            });
        });

        document.querySelectorAll('.delete-species').forEach(btn => {
            btn.addEventListener('click', function() {
                const speciesId = this.getAttribute('data-id');
                if (confirm('Are you sure you want to delete this species?')) {
                    db.species = db.species.filter(s => s.id != speciesId);
                    saveData();
                    loadSpecies();
                    showToast('Success', 'Species deleted successfully');
                }
            });
        });

        // Add search functionality
        const speciesSearch = document.getElementById('speciesSearch');
        if (speciesSearch) {
            speciesSearch.addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                const speciesCards = document.querySelectorAll('.species-card');
                
                speciesCards.forEach(card => {
                    const title = card.querySelector('.card-title').textContent.toLowerCase();
                    const subtitle = card.querySelector('.card-subtitle').textContent.toLowerCase();
                    const text = card.querySelector('.card-text').textContent.toLowerCase();
                    
                    if (title.includes(searchTerm) || subtitle.includes(searchTerm) || text.includes(searchTerm)) {
                        card.parentElement.style.display = 'block';
                    } else {
                        card.parentElement.style.display = 'none';
                    }
                });
            });
        }
    }

    // Load activities and initialize calendar
    function loadActivities() {
        // Initialize calendar
        const calendarEl = document.getElementById('calendar');
        if (calendarEl) {
            // Clear any existing calendar
            calendarEl.innerHTML = '';
            
            const calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay'
                },
                events: db.activities.map(activity => ({
                    id: activity.id,
                    title: activity.title,
                    start: activity.startDate,
                    end: activity.endDate || activity.startDate,
                    extendedProps: {
                        type: activity.type,
                        status: activity.status,
                        location: activity.location,
                        assignedTo: activity.assignedTo,
                        description: activity.description,
                        notes: activity.notes
                    },
                    backgroundColor: getActivityColor(activity.type),
                    borderColor: getActivityColor(activity.type),
                    textColor: '#fff'
                })),
                eventClick: function(info) {
                    const activity = db.activities.find(a => a.id === info.event.id);
                    if (activity) {
                        showActivityDetails(activity);
                    }
                }
            });
            calendar.render();
        }
    }

    // Load monitoring data
    function loadMonitoring() {
        const monitoringTable = document.getElementById('monitoringTable');
        monitoringTable.innerHTML = '';

        if (db.monitoring.length === 0) {
            monitoringTable.innerHTML = '<tr><td colspan="5" class="text-center">No monitoring data recorded</td></tr>';
        } else {
            db.monitoring.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(monitoring => {
                const row = monitoringTable.insertRow();
                row.innerHTML = `
                    <td>${formatDate(monitoring.date)}</td>
                    <td>${capitalizeFirstLetter(monitoring.type)}</td>
                    <td>${monitoring.location}</td>
                    <td>${Object.entries(monitoring.data).map(([key, value]) => `${key}: ${value}`).join(', ')}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary view-monitoring" data-id="${monitoring.id}">View</button>
                        <button class="btn btn-sm btn-outline-danger delete-monitoring" data-id="${monitoring.id}">Delete</button>
                    </td>
                `;
            });
        }

        // Add event listeners to monitoring buttons
        document.querySelectorAll('.view-monitoring').forEach(btn => {
            btn.addEventListener('click', function() {
                const monitoringId = this.getAttribute('data-id');
                const monitoring = db.monitoring.find(m => m.id == monitoringId);
                if (monitoring) {
                    showMonitoringDetails(monitoring);
                }
            });
        });

        document.querySelectorAll('.delete-monitoring').forEach(btn => {
            btn.addEventListener('click', function() {
                const monitoringId = this.getAttribute('data-id');
                if (confirm('Are you sure you want to delete this monitoring data?')) {
                    db.monitoring = db.monitoring.filter(m => m.id != monitoringId);
                    saveData();
                    loadMonitoring();
                    showToast('Success', 'Monitoring data deleted successfully');
                }
            });
        });
    }

    // Load reports
    function loadReports() {
        // Reports are generated on demand, so no initial loading needed
    }

    // Load compliance checklist
    function loadComplianceChecklist() {
        const checklistTable = document.getElementById('complianceChecklistTable');
        checklistTable.innerHTML = '';

        db.complianceChecklist.forEach(item => {
            const row = checklistTable.insertRow();
            row.innerHTML = `
                <td>${item.id}</td>
                <td>${item.requirement}</td>
                <td>
                    <select class="form-select form-select-sm compliant-select" data-id="${item.id}">
                        <option value="Yes" ${item.compliant === 'Yes' ? 'selected' : ''}>Yes</option>
                        <option value="No" ${item.compliant === 'No' ? 'selected' : ''}>No</option>
                        <option value="Partial" ${item.compliant === 'Partial' ? 'selected' : ''}>Partial</option>
                    </select>
                </td>
                <td>
                    <input type="text" class="form-control form-control-sm evidence-input" data-id="${item.id}" value="${item.evidence || ''}">
                </td>
            `;
        });

        // Add event listeners to compliance inputs
        document.querySelectorAll('.compliant-select').forEach(select => {
            select.addEventListener('change', function() {
                const id = this.getAttribute('data-id');
                const item = db.complianceChecklist.find(i => i.id == id);
                if (item) {
                    item.compliant = this.value;
                    saveData();
                }
            });
        });

        document.querySelectorAll('.evidence-input').forEach(input => {
            input.addEventListener('change', function() {
                const id = this.getAttribute('data-id');
                const item = db.complianceChecklist.find(i => i.id == id);
                if (item) {
                    item.evidence = this.value;
                    saveData();
                }
            });
        });

        // Update compliance percentage
        updateCompliancePercentage();
    }

    // Load settings
    function loadSettings() {
        // Load user profile
        if (db.settings.userProfile) {
            document.getElementById('userName').value = db.settings.userProfile.name || '';
            document.getElementById('userEmail').value = db.settings.userProfile.email || '';
            document.getElementById('userRole').value = db.settings.userProfile.role || '';
            document.getElementById('userOrganization').value = db.settings.userProfile.organization || '';
            document.getElementById('userBio').value = db.settings.userProfile.bio || '';
        }

        // Load site settings
        if (db.settings.siteSettings) {
            document.getElementById('siteName').value = db.settings.siteSettings.siteName || '';
            document.getElementById('siteLocation').value = db.settings.siteSettings.location || '';
            document.getElementById('siteArea').value = db.settings.siteSettings.area || '';
            document.getElementById('siteDescription').value = db.settings.siteSettings.description || '';
            document.getElementById('enableNotifications').checked = db.settings.siteSettings.enableNotifications || false;
            document.getElementById('enableReminders').checked = db.settings.siteSettings.enableReminders || false;
        }
    }

    // Initialize map
    function initMap() {
        // Create map centered on a default location (Melbourne)
        const map = L.map('mapid').setView([-37.8136, 144.9631], 15);
        
        // Add base tile layer
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);
        
        // Initialize the feature group to store editable layers
        const drawnItems = new L.FeatureGroup();
        map.addLayer(drawnItems);
        
        // Initialize the draw control and pass it the FeatureGroup of editable layers
        const drawControl = new L.Control.Draw({
            edit: {
                featureGroup: drawnItems
            },
            draw: {
                polygon: true,
                polyline: true,
                marker: true,
                circle: false,
                rectangle: false,
                circlemarker: false
            }
        });
        map.addControl(drawControl);
        
        // Add sample data to map
        addMapSampleData(map, drawnItems);
        
        // Event listeners for drawing actions
        map.on(L.Draw.Event.CREATED, function (e) {
            const type = e.layerType;
            const layer = e.layer;
            
            // Assign an ID to the layer
            layer._id = generateId();
            
            // Add popup with layer details
            if (type === 'marker') {
                layer.bindPopup(`
                    <b>Marker</b><br>
                    Latitude: ${layer.getLatLng().lat.toFixed(6)}<br>
                    Longitude: ${layer.getLatLng().lng.toFixed(6)}<br>
                    <button class="btn btn-sm btn-primary mt-2 edit-feature" data-id="${layer._id}">Edit Details</button>
                `);
                
                // Save to database
                db.mapData.markers.push({
                    id: layer._id,
                    lat: layer.getLatLng().lat,
                    lng: layer.getLatLng().lng,
                    title: 'New Marker',
                    description: '',
                    type: 'marker'
                });
            } else if (type === 'polygon') {
                const latlngs = layer.getLatLngs()[0].map(latlng => [latlng.lat, latlng.lng]);
                layer.bindPopup(`
                    <b>Polygon</b><br>
                    Area: ${L.GeometryUtil.geodesicArea(latlngs).toFixed(2)} sq meters<br>
                    <button class="btn btn-sm btn-primary mt-2 edit-feature" data-id="${layer._id}">Edit Details</button>
                `);
                
                // Save to database
                db.mapData.polygons.push({
                    id: layer._id,
                    points: latlngs,
                    title: 'New Polygon',
                    description: '',
                    type: 'polygon'
                });
            } else if (type === 'polyline') {
                const latlngs = layer.getLatLngs().map(latlng => [latlng.lat, latlng.lng]);
                layer.bindPopup(`
                    <b>Polyline</b><br>
                    Length: ${L.GeometryUtil.length(latlngs).toFixed(2)} meters<br>
                    <button class="btn btn-sm btn-primary mt-2 edit-feature" data-id="${layer._id}">Edit Details</button>
                `);
                
                // Save to database
                db.mapData.polylines.push({
                    id: layer._id,
                    points: latlngs,
                    title: 'New Polyline',
                    description: '',
                    type: 'polyline'
                });
            }
            
            drawnItems.addLayer(layer);
            saveData();
            showToast('Success', 'Map feature added successfully');
        });
        
        map.on(L.Draw.Event.EDITED, function (e) {
            const layers = e.layers;
            layers.eachLayer(function(layer) {
                // Update database with edited layer
                if (layer instanceof L.Marker) {
                    const marker = db.mapData.markers.find(m => m.id === layer._id);
                    if (marker) {
                        marker.lat = layer.getLatLng().lat;
                        marker.lng = layer.getLatLng().lng;
                    }
                } else if (layer instanceof L.Polygon) {
                    const polygon = db.mapData.polygons.find(p => p.id === layer._id);
                    if (polygon) {
                        polygon.points = layer.getLatLngs()[0].map(latlng => [latlng.lat, latlng.lng]);
                    }
                } else if (layer instanceof L.Polyline) {
                    const polyline = db.mapData.polylines.find(p => p.id === layer._id);
                    if (polyline) {
                        polyline.points = layer.getLatLngs().map(latlng => [latlng.lat, latlng.lng]);
                    }
                }
            });
            saveData();
            showToast('Success', 'Map features updated successfully');
        });
        
        map.on(L.Draw.Event.DELETED, function (e) {
            const layers = e.layers;
            layers.eachLayer(function(layer) {
                // Remove from database
                if (layer instanceof L.Marker) {
                    db.mapData.markers = db.mapData.markers.filter(m => m.id !== layer._id);
                } else if (layer instanceof L.Polygon) {
                    db.mapData.polygons = db.mapData.polygons.filter(p => p.id !== layer._id);
                } else if (layer instanceof L.Polyline) {
                    db.mapData.polylines = db.mapData.polylines.filter(p => p.id !== layer._id);
                }
            });
            saveData();
            showToast('Success', 'Map features deleted successfully');
        });
        
        // Store map and drawnItems in global scope for later access
        window.map = map;
        window.drawnItems = drawnItems;
        window.drawControl = drawControl;
    }

    // Add sample data to the map
    function addMapSampleData(map, drawnItems) {
        // Add markers
        db.mapData.markers.forEach(markerData => {
            const marker = L.marker([markerData.lat, markerData.lng]);
            marker._id = markerData.id;
            marker.bindPopup(`
                <b>${markerData.title}</b><br>
                ${markerData.description}<br>
                <button class="btn btn-sm btn-primary mt-2 edit-feature" data-id="${markerData.id}">Edit Details</button>
            `);
            drawnItems.addLayer(marker);
        });
        
        // Add polygons
        db.mapData.polygons.forEach(polygonData => {
            const polygon = L.polygon(polygonData.points, {color: 'blue'});
            polygon._id = polygonData.id;
            polygon.bindPopup(`
                <b>${polygonData.title}</b><br>
                ${polygonData.description}<br>
                <button class="btn btn-sm btn-primary mt-2 edit-feature" data-id="${polygonData.id}">Edit Details</button>
            `);
            drawnItems.addLayer(polygon);
        });
        
        // Add polylines
        db.mapData.polylines.forEach(polylineData => {
            const polyline = L.polyline(polylineData.points, {color: 'red'});
            polyline._id = polylineData.id;
            polyline.bindPopup(`
                <b>${polylineData.title}</b><br>
                ${polylineData.description}<br>
                <button class="btn btn-sm btn-primary mt-2 edit-feature" data-id="${polylineData.id}">Edit Details</button>
            `);
            drawnItems.addLayer(polyline);
        });
    }

    // Initialize charts
    function initCharts() {
        // Health indicator chart
        const healthCtx = document.getElementById('healthChart').getContext('2d');
        window.healthChart = new Chart(healthCtx, {
            type: 'line',
            data: {
                labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
                datasets: [{
                    label: 'Ecosystem Health Score',
                    data: [65, 68, 72, 75, 78, 76, 74, 78, 82, 85, 83, 80],
                    borderColor: '#28a745',
                    backgroundColor: 'rgba(40, 167, 69, 0.1)',
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: false,
                        min: 50,
                        max: 100
                    }
                }
            }
        });
        
        // Threats chart
        const threatsCtx = document.getElementById('threatsChart').getContext('2d');
        window.threatsChart = new Chart(threatsCtx, {
            type: 'doughnut',
            data: {
                labels: ['Weeds', 'Erosion', 'Pests', 'Water Quality', 'Other'],
                datasets: [{
                    data: [45, 25, 15, 10, 5],
                    backgroundColor: [
                        '#dc3545',
                        '#fd7e14',
                        '#ffc107',
                        '#007bff',
                        '#6c757d'
                    ]
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false
            }
        });
        
        // Compliance chart
        const complianceCtx = document.getElementById('complianceChart').getContext('2d');
        window.complianceChart = new Chart(complianceCtx, {
            type: 'bar',
            data: {
                labels: db.complianceChecklist.map(item => `Req ${item.id}`),
                datasets: [{
                    label: 'Compliance Score',
                    data: db.complianceChecklist.map(item => {
                        if (item.compliant === 'Yes') return 100;
                        if (item.compliant === 'Partial') return 50;
                        return 0;
                    }),
                    backgroundColor: db.complianceChecklist.map(item => {
                        if (item.compliant === 'Yes') return '#28a745';
                        if (item.compliant === 'Partial') return '#ffc107';
                        return '#dc3545';
                    })
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        ticks: {
                            callback: function(value) {
                                return value + '%';
                            }
                        }
                    }
                }
            }
        });
    }

    // Update compliance percentage
    function updateCompliancePercentage() {
        const completedItems = db.complianceChecklist.filter(item => item.compliant === 'Yes').length;
        const partialItems = db.complianceChecklist.filter(item => item.compliant === 'Partial').length;
        const totalItems = db.complianceChecklist.length;
        const progressPercentage = Math.round(((completedItems + (partialItems * 0.5)) / totalItems) * 100);
        
        document.getElementById('compliancePercentage').textContent = `${progressPercentage}%`;
        document.getElementById('complianceProgress').style.width = `${progressPercentage}%`;
        document.getElementById('complianceProgress').setAttribute('aria-valuenow', progressPercentage);
        
        // Update compliance chart
        if (window.complianceChart) {
            window.complianceChart.data.datasets[0].data = db.complianceChecklist.map(item => {
                if (item.compliant === 'Yes') return 100;
                if (item.compliant === 'Partial') return 50;
                return 0;
            });
            
            window.complianceChart.data.datasets[0].backgroundColor = db.complianceChecklist.map(item => {
                if (item.compliant === 'Yes') return '#28a745';
                if (item.compliant === 'Partial') return '#ffc107';
                return '#dc3545';
            });
            
            window.complianceChart.update();
        }
    }

    // Setup event listeners
    function setupEventListeners() {
        // Navigation - FIXED: Use event delegation for sidebar navigation
        document.addEventListener('click', function(e) {
            // Handle sidebar navigation
            if (e.target.matches('.sidebar .nav-link')) {
                e.preventDefault();
                
                // Update active state
                document.querySelectorAll('.sidebar .nav-link').forEach(l => l.classList.remove('active'));
                e.target.classList.add('active');
                
                // Show the corresponding section
                const target = e.target.getAttribute('data-bs-target');
                document.querySelectorAll('.content-section').forEach(section => {
                    section.classList.add('d-none');
                });
                document.getElementById(target).classList.remove('d-none');
            }
            
            // Handle map control buttons using event delegation
            if (e.target.matches('#drawMarker, #drawPolygon, #drawLine, #editFeatures, #deleteFeatures')) {
                if (!window.map) return; // Make sure map is initialized
                
                if (e.target.id === 'drawMarker') {
                    new L.Draw.Marker(window.map, window.drawControl.options.draw.marker).enable();
                } else if (e.target.id === 'drawPolygon') {
                    new L.Draw.Polygon(window.map, window.drawControl.options.draw.polygon).enable();
                } else if (e.target.id === 'drawLine') {
                    new L.Draw.Polyline(window.map, window.drawControl.options.draw.polyline).enable();
                } else if (e.target.id === 'editFeatures') {
                    window.drawControl._toolbars.edit._modes.edit.handler.enable();
                } else if (e.target.id === 'deleteFeatures') {
                    window.drawControl._toolbars.edit._modes.remove.handler.enable();
                }
            }
            
            // Handle layer visibility toggles
            if (e.target.matches('#showVegetation, #showWeeds, #showWater')) {
                alert(e.target.textContent.trim() + ' layer would be toggled in a real implementation');
            }
        });
        
        // Form submissions
        document.getElementById('projectForm').addEventListener('submit', handleProjectSubmit);
        document.getElementById('assessmentForm').addEventListener('submit', handleAssessmentSubmit);
        document.getElementById('activityForm').addEventListener('submit', handleActivitySubmit);
        document.getElementById('speciesForm').addEventListener('submit', handleSpeciesSubmit);
        document.getElementById('monitoringForm').addEventListener('submit', handleMonitoringSubmit);
        document.getElementById('userProfileForm').addEventListener('submit', handleUserProfileSubmit);
        document.getElementById('changePasswordForm').addEventListener('submit', handleChangePasswordSubmit);
        document.getElementById('siteSettingsForm').addEventListener('submit', handleSiteSettingsSubmit);
        document.getElementById('reportForm').addEventListener('submit', handleReportSubmit);
        
        // Image previews
        document.getElementById('speciesImage').addEventListener('change', function() {
            previewImage(this, document.getElementById('speciesImagePreview'));
        });
        
        document.getElementById('assessmentImages').addEventListener('change', function() {
            previewMultipleImages(this, 'assessmentImagePreview');
        });
        
        document.getElementById('monitoringImages').addEventListener('change', function() {
            previewMultipleImages(this, 'monitoringImagePreview');
        });
        
        // Buttons
        document.getElementById('saveCompliance').addEventListener('click', saveComplianceChecklist);
        document.getElementById('generateComplianceReport').addEventListener('click', generateComplianceReport);
        document.getElementById('exportAllData').addEventListener('click', exportAllData);
        document.getElementById('backupDatabase').addEventListener('click', backupDatabase);
        document.getElementById('resetTestData').addEventListener('click', resetTestData);
        document.getElementById('viewAllActivities').addEventListener('click', function() {
            document.querySelector('[data-bs-target="activities"]').click();
        });
        
        // Export buttons
        document.getElementById('exportAssessments').addEventListener('click', function() {
            exportTableToCSV('assessments.csv', db.assessments);
        });
        
        document.getElementById('exportSpecies').addEventListener('click', function() {
            exportTableToCSV('species.csv', db.species);
        });
        
        document.getElementById('exportMonitoring').addEventListener('click', function() {
            exportTableToCSV('monitoring.csv', db.monitoring);
        });
    }

    // Image preview functions
    function previewImage(input, previewElement) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                previewElement.src = e.target.result;
                previewElement.style.display = 'block';
            };
            reader.readAsDataURL(input.files[0]);
        }
    }

    function previewMultipleImages(input, previewContainerId) {
        const previewContainer = document.getElementById(previewContainerId);
        previewContainer.innerHTML = '';
        
        if (input.files) {
            Array.from(input.files).forEach(file => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.className = 'image-thumbnail';
                    previewContainer.appendChild(img);
                };
                reader.readAsDataURL(file);
            });
        }
    }

    // Form handlers
    function handleProjectSubmit(e) {
        e.preventDefault();
        
        if (!validateForm('projectForm')) {
            showToast('Error', 'Please fill all required fields', 'error');
            return;
        }
        
        const project = {
            id: generateId(),
            name: document.getElementById('projectName').value,
            code: document.getElementById('projectCode').value,
            startDate: document.getElementById('projectStartDate').value,
            endDate: document.getElementById('projectEndDate').value || '',
            description: document.getElementById('projectDescription').value,
            status: document.getElementById('projectStatus').value,
            manager: document.getElementById('projectManager').value || '',
            location: document.getElementById('projectLocation').value || '',
            createdAt: new Date().toISOString()
        };
        
        db.projects.push(project);
        saveData();
        loadProjects();
        
        // Reset form
        e.target.reset();
        
        showToast('Success', 'Project created successfully');
    }

    function handleAssessmentSubmit(e) {
        e.preventDefault();
        
        if (!validateForm('assessmentForm')) {
            showToast('Error', 'Please fill all required fields', 'error');
            return;
        }
        
        const components = [];
        if (document.getElementById('componentFlora').checked) components.push('flora');
        if (document.getElementById('componentFauna').checked) components.push('fauna');
        if (document.getElementById('componentSoil').checked) components.push('soil');
        if (document.getElementById('componentWater').checked) components.push('water');
        
        const threats = Array.from(document.getElementById('threats').selectedOptions).map(option => option.value);
        
        const assessment = {
            id: generateId(),
            date: document.getElementById('assessmentDate').value,
            assessor: document.getElementById('assessor').value,
            description: document.getElementById('assessmentDescription').value,
            components: components,
            health: document.getElementById('healthStatus').value,
            threats: threats,
            images: [], // In a real app, you would upload and store images
            createdAt: new Date().toISOString()
        };
        
        db.assessments.push(assessment);
        saveData();
        loadAssessments();
        
        // Reset form
        e.target.reset();
        document.getElementById('assessmentImagePreview').innerHTML = '';
        
        showToast('Success', 'Assessment saved successfully');
    }

    function handleActivitySubmit(e) {
        e.preventDefault();
        
        if (!validateForm('activityForm')) {
            showToast('Error', 'Please fill all required fields', 'error');
            return;
        }
        
        const activity = {
            id: generateId(),
            title: document.getElementById('activityTitle').value,
            type: document.getElementById('activityType').value,
            startDate: document.getElementById('startDate').value,
            endDate: document.getElementById('endDate').value || document.getElementById('startDate').value,
            status: document.getElementById('activityStatus').value,
            location: document.getElementById('location').value,
            assignedTo: document.getElementById('assignedTo').value,
            description: document.getElementById('activityDescription').value,
            notes: document.getElementById('activityNotes').value,
            createdAt: new Date().toISOString()
        };
        
        db.activities.push(activity);
        saveData();
        loadActivities();
        
        // Reset form
        e.target.reset();
        
        showToast('Success', 'Activity scheduled successfully');
    }

    function handleSpeciesSubmit(e) {
        e.preventDefault();
        
        if (!validateForm('speciesForm')) {
            showToast('Error', 'Please fill all required fields', 'error');
            return;
        }
        
        const species = {
            id: generateId(),
            name: document.getElementById('speciesName').value,
            scientificName: document.getElementById('scientificName').value,
            type: document.getElementById('speciesType').value,
            status: document.getElementById('speciesStatus').value,
            riskLevel: document.getElementById('riskLevel').value,
            description: document.getElementById('speciesDescription').value,
            habitat: document.getElementById('speciesHabitat').value,
            image: '', // In a real app, you would upload and store the image
            createdAt: new Date().toISOString()
        };
        
        db.species.push(species);
        saveData();
        loadSpecies();
        
        // Reset form
        e.target.reset();
        document.getElementById('speciesImagePreview').style.display = 'none';
        
        showToast('Success', 'Species added successfully');
    }

    function handleMonitoringSubmit(e) {
        e.preventDefault();
        
        if (!validateForm('monitoringForm')) {
            showToast('Error', 'Please fill all required fields', 'error');
            return;
        }
        
        // Parse data from textarea (key:value format)
        const dataText = document.getElementById('monitoringData').value;
        const data = {};
        dataText.split('\n').forEach(line => {
            const parts = line.split(':');
            if (parts.length >= 2) {
                const key = parts[0].trim();
                const value = parts.slice(1).join(':').trim();
                data[key] = value;
            }
        });
        
        const monitoring = {
            id: generateId(),
            date: document.getElementById('monitoringDate').value,
            type: document.getElementById('monitoringType').value,
            location: document.getElementById('monitoringLocation').value,
            data: data,
            observations: document.getElementById('monitoringObservations').value,
            images: [], // In a real app, you would upload and store images
            createdAt: new Date().toISOString()
        };
        
        db.monitoring.push(monitoring);
        saveData();
        loadMonitoring();
        
        // Reset form
        e.target.reset();
        document.getElementById('monitoringImagePreview').innerHTML = '';
        
        showToast('Success', 'Monitoring data saved successfully');
    }

    function handleUserProfileSubmit(e) {
        e.preventDefault();
        
        if (!validateForm('userProfileForm')) {
            showToast('Error', 'Please fill all required fields', 'error');
            return;
        }
        
        db.settings.userProfile = {
            name: document.getElementById('userName').value,
            email: document.getElementById('userEmail').value,
            role: document.getElementById('userRole').value,
            organization: document.getElementById('userOrganization').value,
            bio: document.getElementById('userBio').value
        };
        
        saveData();
        showToast('Success', 'Profile updated successfully');
    }

    function handleChangePasswordSubmit(e) {
        e.preventDefault();
        
        if (!validateForm('changePasswordForm')) {
            showToast('Error', 'Please fill all required fields', 'error');
            return;
        }
        
        const currentPassword = document.getElementById('currentPassword').value;
        const newPassword = document.getElementById('newPassword').value;
        const confirmPassword = document.getElementById('confirmPassword').value;
        
        if (newPassword !== confirmPassword) {
            showToast('Error', 'New passwords do not match', 'error');
            return;
        }
        
        // In a real app, you would verify the current password and update it
        // For this demo, we'll just show a success message
        e.target.reset();
        showToast('Success', 'Password changed successfully');
    }

    function handleSiteSettingsSubmit(e) {
        e.preventDefault();
        
        if (!validateForm('siteSettingsForm')) {
            showToast('Error', 'Please fill all required fields', 'error');
            return;
        }
        
        db.settings.siteSettings = {
            siteName: document.getElementById('siteName').value,
            location: document.getElementById('siteLocation').value,
            area: parseFloat(document.getElementById('siteArea').value),
            description: document.getElementById('siteDescription').value,
            enableNotifications: document.getElementById('enableNotifications').checked,
            enableReminders: document.getElementById('enableReminders').checked
        };
        
        saveData();
        showToast('Success', 'Site settings saved successfully');
    }

    function handleReportSubmit(e) {
        e.preventDefault();
        
        if (!validateForm('reportForm')) {
            showToast('Error', 'Please fill all required fields', 'error');
            return;
        }
        
        const reportType = document.getElementById('reportType').value;
        const startDate = document.getElementById('reportStartDate').value;
        const endDate = document.getElementById('reportEndDate').value;
        const format = document.getElementById('reportFormat').value;
        const includeCharts = document.getElementById('includeCharts').checked;
        
        generateReport(reportType, startDate, endDate, format, includeCharts);
    }

    // Form validation
    function validateForm(formId) {
        const form = document.getElementById(formId);
        let isValid = true;
        
        const requiredFields = form.querySelectorAll('[required]');
        requiredFields.forEach(field => {
            if (!field.value.trim()) {
                field.classList.add('is-invalid');
                isValid = false;
            } else {
                field.classList.remove('is-invalid');
            }
        });
        
        return isValid;
    }

    // Detail view functions
    function showProjectDetails(project) {
        const modalBody = document.getElementById('projectModalBody');
        
        modalBody.innerHTML = `
            <div class="row">
                <div class="col-md-6">
                    <p><strong>Name:</strong> ${project.name}</p>
                    <p><strong>Code:</strong> ${project.code}</p>
                    <p><strong>Status:</strong> <span class="badge ${getProjectStatusBadgeClass(project.status)}">${capitalizeFirstLetter(project.status)}</span></p>
                </div>
                <div class="col-md-6">
                    <p><strong>Start Date:</strong> ${formatDate(project.startDate)}</p>
                    <p><strong>End Date:</strong> ${project.endDate ? formatDate(project.endDate) : 'Not specified'}</p>
                    <p><strong>Manager:</strong> ${project.manager || 'Not specified'}</p>
                </div>
            </div>
            <div class="row mt-3">
                <div class="col-12">
                    <p><strong>Location:</strong> ${project.location || 'Not specified'}</p>
                </div>
            </div>
            <div class="row mt-3">
                <div class="col-12">
                    <p><strong>Description:</strong></p>
                    <p>${project.description}</p>
                </div>
            </div>
        `;
        
        const modal = new bootstrap.Modal(document.getElementById('projectModal'));
        modal.show();
    }

    function showAssessmentDetails(assessment) {
        const modalBody = document.getElementById('assessmentModalBody');
        
        modalBody.innerHTML = `
            <div class="row">
                <div class="col-md-6">
                    <p><strong>Date:</strong> ${formatDate(assessment.date)}</p>
                    <p><strong>Assessor:</strong> ${assessment.assessor}</p>
                    <p><strong>Health Status:</strong> <span class="badge ${getHealthBadgeClass(assessment.health)}">${capitalizeFirstLetter(assessment.health)}</span></p>
                </div>
                <div class="col-md-6">
                    <p><strong>Components:</strong> ${assessment.components.map(c => capitalizeFirstLetter(c)).join(', ')}</p>
                    <p><strong>Threats:</strong> ${assessment.threats.map(t => capitalizeFirstLetter(t)).join(', ')}</p>
                </div>
            </div>
            <div class="row mt-3">
                <div class="col-12">
                    <p><strong>Description:</strong></p>
                    <p>${assessment.description}</p>
                </div>
            </div>
            ${assessment.images && assessment.images.length > 0 ? `
            <div class="row mt-3">
                <div class="col-12">
                    <p><strong>Images:</strong></p>
                    <div class="image-preview-container">
                        ${assessment.images.map(img => `<img src="${img}" class="image-thumbnail" alt="Assessment image">`).join('')}
                    </div>
                </div>
            </div>
            ` : ''}
        `;
        
        const modal = new bootstrap.Modal(document.getElementById('assessmentModal'));
        modal.show();
    }

    function showSpeciesDetails(species) {
        const modalBody = document.getElementById('speciesModalBody');
        
        modalBody.innerHTML = `
            <div class="row">
                <div class="col-md-6">
                    <p><strong>Name:</strong> ${species.name}</p>
                    <p><strong>Scientific Name:</strong> ${species.scientificName || 'Not specified'}</p>
                    <p><strong>Type:</strong> ${capitalizeFirstLetter(species.type)}</p>
                </div>
                <div classcol-md-6">
                    <p><strong>Status:</strong> <span class="badge ${getSpeciesStatusBadgeClass(species.status)}">${capitalizeFirstLetter(species.status)}</span></p>
                    <p><strong>Risk Level:</strong> ${species.riskLevel ? `<span class="risk-indicator risk-${species.riskLevel}"></span>${capitalizeFirstLetter(species.riskLevel)}` : 'Not specified'}</p>
                </div>
            </div>
            <div class="row mt-3">
                <div class="col-12">
                    <p><strong>Description:</strong></p>
                    <p>${species.description}</p>
                </div>
            </div>
            <div class="row mt-3">
                <div class="col-12">
                    <p><strong>Habitat:</strong></p>
                    <p>${species.habitat}</p>
                </div>
            </div>
            ${species.image ? `
            <div class="row mt-3">
                <div class="col-12">
                    <p><strong>Image:</strong></p>
                    <img src="${species.image}" class="img-fluid" alt="${species.name}">
                </div>
            </div>
            ` : ''}
        `;
        
        const modal = new bootstrap.Modal(document.getElementById('speciesModal'));
        modal.show();
    }

    function showActivityDetails(activity) {
        const modalBody = document.getElementById('activityModalBody');
        
        modalBody.innerHTML = `
            <div class="row">
                <div class="col-md-6">
                    <p><strong>Title:</strong> ${activity.title}</p>
                    <p><strong>Type:</strong> ${formatActivityType(activity.type)}</p>
                    <p><strong>Status:</strong> <span class="badge ${getStatusBadgeClass(activity.status)}">${capitalizeFirstLetter(activity.status)}</span></p>
                </div>
                <div class="col-md-6">
                    <p><strong>Start Date:</strong> ${formatDateTime(activity.startDate)}</p>
                    <p><strong>End Date:</strong> ${activity.endDate ? formatDateTime(activity.endDate) : 'Not specified'}</p>
                    <p><strong>Location:</strong> ${activity.location || 'Not specified'}</p>
                </div>
            </div>
            <div class="row mt-3">
                <div class="col-12">
                    <p><strong>Assigned To:</strong> ${activity.assignedTo || 'Not assigned'}</p>
                </div>
            </div>
            <div class="row mt-3">
                <div class="col-12">
                    <p><strong>Description:</strong></p>
                    <p>${activity.description || 'No description provided'}</p>
                </div>
            </div>
            <div class="row mt-3">
                <div class="col-12">
                    <p><strong>Notes:</strong></p>
                    <p>${activity.notes || 'No notes provided'}</p>
                </div>
            </div>
        `;
        
        // Set up edit button
        document.getElementById('editActivityBtn').onclick = function() {
            editActivity(activity);
        };
        
        const modal = new bootstrap.Modal(document.getElementById('activityModal'));
        modal.show();
    }

    function showMonitoringDetails(monitoring) {
        const modalBody = document.getElementById('monitoringModalBody');
        
        modalBody.innerHTML = `
            <div class="row">
                <div class="col-md-6">
                    <p><strong>Date:</strong> ${formatDate(monitoring.date)}</p>
                    <p><strong>Type:</strong> ${capitalizeFirstLetter(monitoring.type)}</p>
                    <p><strong>Location:</strong> ${monitoring.location}</p>
                </div>
            </div>
            <div class="row mt-3">
                <div
